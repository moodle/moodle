function _typeof(obj){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}define("tool_usertours/usertours",["exports","./tour","core/templates","core/log","core/notification","./repository","core/pending","./events"],(function(_exports,_tour,_templates,_log,_notification,tourRepository,_pending,_events){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.resetTourState=_exports.init=void 0,_tour=_interopRequireDefault(_tour),_templates=_interopRequireDefault(_templates),_log=_interopRequireDefault(_log),_notification=_interopRequireDefault(_notification),tourRepository=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!==_typeof(obj)&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(tourRepository),_pending=_interopRequireDefault(_pending);var _systemImportTransformerGlobalIdentifier="undefined"!=typeof window?window:"undefined"!=typeof self?self:"undefined"!=typeof global?global:{};function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))}}var _ref,currentTour=null,tourId=null,findMatchingTour=function(tourDetails,filters){return tourDetails.find((function(tour){return filters.some((function(filter){return!filter||!filter.filterMatches||filter.filterMatches(tour)}))}))},init=(_ref=_asyncToGenerator(regeneratorRuntime.mark((function _callee(tourDetails,filters){var requirements,filterPlugins,matchingTour,startTour;return regeneratorRuntime.wrap((function(_context){for(;;)switch(_context.prev=_context.next){case 0:return requirements=[],filters.forEach((function(filter){requirements.push("function"==typeof _systemImportTransformerGlobalIdentifier.define&&_systemImportTransformerGlobalIdentifier.define.amd?new Promise((function(resolve,reject){_systemImportTransformerGlobalIdentifier.require(["tool_usertours/filter_".concat(filter)],resolve,reject)})):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&_systemImportTransformerGlobalIdentifier.require&&"component"===_systemImportTransformerGlobalIdentifier.require.loader?Promise.resolve(require("tool_usertours/filter_".concat(filter))):Promise.resolve(_systemImportTransformerGlobalIdentifier["tool_usertours/filter_".concat(filter)]))})),_context.next=4,Promise.all(requirements);case 4:if(filterPlugins=_context.sent,matchingTour=findMatchingTour(tourDetails,filterPlugins)){_context.next=8;break}return _context.abrupt("return");case 8:tourId=matchingTour.tourId,void 0===(startTour=matchingTour.startTour)&&(startTour=!0),startTour&&fetchTour(tourId),addResetLink(),document.querySelector("body").addEventListener("click",(function(e){e.target.closest("#resetpagetour")&&(e.preventDefault(),resetTourState(tourId))}));case 14:case"end":return _context.stop()}}),_callee)}))),function(_x,_x2){return _ref.apply(this,arguments)});_exports.init=init;var _ref2,fetchTour=(_ref2=_asyncToGenerator(regeneratorRuntime.mark((function _callee2(tourId){var pendingPromise,response,_yield$Templates$rend,html;return regeneratorRuntime.wrap((function(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:return pendingPromise=new _pending.default("admin_usertour_fetchTour:".concat(tourId)),_context2.prev=1,_context2.next=4,tourRepository.fetchTour(tourId);case 4:return(response=_context2.sent).hasOwnProperty("tourconfig")||pendingPromise.resolve(),_context2.next=8,_templates.default.renderForPromise("tool_usertours/tourstep",response.tourconfig);case 8:_yield$Templates$rend=_context2.sent,html=_yield$Templates$rend.html,startBootstrapTour(tourId,html,response.tourconfig),pendingPromise.resolve(),_context2.next=18;break;case 14:_context2.prev=14,_context2.t0=_context2.catch(1),pendingPromise.resolve(),_notification.default.exception(_context2.t0);case 18:case"end":return _context2.stop()}}),_callee2,null,[[1,14]])}))),function(_x3){return _ref2.apply(this,arguments)}),addResetLink=function(){var pendingPromise=new _pending.default("admin_usertour_addResetLink");_templates.default.render("tool_usertours/resettour",{}).then((function(html,js){var location;_templates.default.appendNodeContents((location=document.querySelector(".tool_usertours-resettourcontainer"))||((location=document.querySelector(".logininfo"))?location:(location=document.querySelector("footer"))||document.body),html,js)})).catch().then(pendingPromise.resolve).catch()},startBootstrapTour=function(tourId,template,tourConfig){return currentTour&&currentTour.tourRunning&&(currentTour.endTour(),currentTour=null),document.addEventListener(_events.eventTypes.tourEnded,markTourComplete),document.addEventListener(_events.eventTypes.stepRenderer,markStepShown),tourConfig.tourName=tourConfig.name,delete tourConfig.name,tourConfig.template=template,tourConfig.steps=tourConfig.steps.map((function(step){return void 0!==step.element&&(step.target=step.element,delete step.element),void 0!==step.reflex&&(step.moveOnClick=!!step.reflex,delete step.reflex),void 0!==step.content&&(step.body=step.content,delete step.content),step})),(currentTour=new _tour.default(tourConfig)).startTour()},markStepShown=function(e){var tour=e.detail.tour,stepConfig=tour.getStepConfig(tour.getCurrentStepNumber());tourRepository.markStepShown(stepConfig.stepid,tourId,tour.getCurrentStepNumber()).catch(_log.default.error)},markTourComplete=function markTourComplete(e){document.removeEventListener(_events.eventTypes.tourEnded,markTourComplete),document.removeEventListener(_events.eventTypes.stepRenderer,markStepShown);var tour=e.detail.tour,stepConfig=tour.getStepConfig(tour.getCurrentStepNumber());tourRepository.markTourComplete(stepConfig.stepid,tourId,tour.getCurrentStepNumber()).catch(_log.default.error)},resetTourState=function(tourId){return tourRepository.resetTourState(tourId).then((function(response){response.startTour&&fetchTour(response.startTour)})).catch(_notification.default.exception)};_exports.resetTourState=resetTourState}));

//# sourceMappingURL=usertours.min.js.map