{"version":3,"sources":["../src/usertours.js"],"names":["currentTour","tourId","findMatchingTour","tourDetails","filters","find","tour","some","filter","filterMatches","init","requirements","forEach","push","Promise","all","filterPlugins","matchingTour","startTour","fetchTour","addResetLink","document","querySelector","addEventListener","e","resetLink","target","closest","preventDefault","resetTourState","pendingPromise","Pending","tourRepository","response","hasOwnProperty","resolve","Templates","renderForPromise","tourconfig","html","startBootstrapTour","notification","exception","getPreferredResetLocation","location","body","render","then","js","appendNodeContents","catch","template","tourConfig","tourRunning","endTour","eventTypes","tourEnded","markTourComplete","stepRenderer","markStepShown","tourName","name","steps","map","step","element","reflex","moveOnClick","content","BootstrapTour","detail","stepConfig","getStepConfig","getCurrentStepNumber","stepid","log","error","removeEventListener"],"mappings":"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","sourcesContent":["/**\n * User tour control library.\n *\n * @module     tool_usertours/usertours\n * @copyright  2016 Andrew Nicols <andrew@nicols.co.uk>\n */\nimport BootstrapTour from './tour';\nimport Templates from 'core/templates';\nimport log from 'core/log';\nimport notification from 'core/notification';\nimport * as tourRepository from './repository';\nimport Pending from 'core/pending';\nimport {eventTypes} from './events';\n\nlet currentTour = null;\nlet tourId = null;\n\n/**\n * Find the first matching tour.\n *\n * @param {object[]} tourDetails\n * @param {object[]} filters\n * @returns {null|object}\n */\nconst findMatchingTour = (tourDetails, filters) => {\n    return tourDetails.find(tour => filters.some(filter => {\n        if (filter && filter.filterMatches) {\n            return filter.filterMatches(tour);\n        }\n\n        return true;\n    }));\n};\n\n/**\n * Initialise the user tour for the current page.\n *\n * @method  init\n * @param   {Array}    tourDetails      The matching tours for this page.\n * @param   {Array}    filters          The names of all client side filters.\n */\nexport const init = async(tourDetails, filters) => {\n    const requirements = [];\n    filters.forEach(filter => {\n        requirements.push(import(`tool_usertours/filter_${filter}`));\n    });\n\n    const filterPlugins = await Promise.all(requirements);\n\n    const matchingTour = findMatchingTour(tourDetails, filterPlugins);\n    if (!matchingTour) {\n        return;\n    }\n\n    // Only one tour per page is allowed.\n    tourId = matchingTour.tourId;\n\n    let startTour = matchingTour.startTour;\n    if (typeof startTour === 'undefined') {\n        startTour = true;\n    }\n\n    if (startTour) {\n        // Fetch the tour configuration.\n        fetchTour(tourId);\n    }\n\n    addResetLink();\n\n    // Watch for the reset link.\n    document.querySelector('body').addEventListener('click', e => {\n        const resetLink = e.target.closest('[data-action=\"tool_usertours/resetpagetour\"]');\n        if (resetLink) {\n            e.preventDefault();\n            resetTourState(tourId);\n        }\n    });\n};\n\n/**\n * Fetch the configuration specified tour, and start the tour when it has been fetched.\n *\n * @method  fetchTour\n * @param   {Number}    tourId      The ID of the tour to start.\n */\nconst fetchTour = async tourId => {\n    const pendingPromise = new Pending(`admin_usertour_fetchTour:${tourId}`);\n\n    try {\n        const response = await tourRepository.fetchTour(tourId);\n        if (!response.hasOwnProperty('tourconfig')) {\n            pendingPromise.resolve();\n        }\n\n        const {html} = await Templates.renderForPromise('tool_usertours/tourstep', response.tourconfig);\n        startBootstrapTour(tourId, html, response.tourconfig);\n\n        pendingPromise.resolve();\n    } catch (error) {\n        pendingPromise.resolve();\n        notification.exception(error);\n    }\n};\n\nconst getPreferredResetLocation = () => {\n    let location = document.querySelector('.tool_usertours-resettourcontainer');\n    if (location) {\n        return location;\n    }\n\n    location = document.querySelector('.logininfo');\n    if (location) {\n        return location;\n    }\n\n    location = document.querySelector('footer');\n    if (location) {\n        return location;\n    }\n\n    return document.body;\n};\n\n/**\n * Add a reset link to the page.\n *\n * @method  addResetLink\n */\nconst addResetLink = () => {\n    const pendingPromise = new Pending('admin_usertour_addResetLink');\n\n    Templates.render('tool_usertours/resettour', {})\n    .then(function(html, js) {\n        // Append the link to the most suitable place on the page with fallback to legacy selectors and finally the body if\n        // there is no better place.\n        Templates.appendNodeContents(getPreferredResetLocation(), html, js);\n\n        return;\n    })\n    .catch()\n    .then(pendingPromise.resolve)\n    .catch();\n};\n\n/**\n * Start the specified tour.\n *\n * @method  startBootstrapTour\n * @param   {Number}    tourId      The ID of the tour to start.\n * @param   {String}    template    The template to use.\n * @param   {Object}    tourConfig  The tour configuration.\n * @return  {Object}\n */\nconst startBootstrapTour = (tourId, template, tourConfig) => {\n    if (currentTour && currentTour.tourRunning) {\n        // End the current tour.\n        currentTour.endTour();\n        currentTour = null;\n    }\n\n    document.addEventListener(eventTypes.tourEnded, markTourComplete);\n    document.addEventListener(eventTypes.stepRenderer, markStepShown);\n\n    // Sort out the tour name.\n    tourConfig.tourName = tourConfig.name;\n    delete tourConfig.name;\n\n    // Add the template to the configuration.\n    // This enables translations of the buttons.\n    tourConfig.template = template;\n\n    tourConfig.steps = tourConfig.steps.map(function(step) {\n        if (typeof step.element !== 'undefined') {\n            step.target = step.element;\n            delete step.element;\n        }\n\n        if (typeof step.reflex !== 'undefined') {\n            step.moveOnClick = !!step.reflex;\n            delete step.reflex;\n        }\n\n        if (typeof step.content !== 'undefined') {\n            step.body = step.content;\n            delete step.content;\n        }\n\n        return step;\n    });\n\n    currentTour = new BootstrapTour(tourConfig);\n    return currentTour.startTour();\n};\n\n/**\n * Mark the specified step as being shownd by the user.\n *\n * @method  markStepShown\n * @param   {Event} e\n */\nconst markStepShown = e => {\n    const tour = e.detail.tour;\n    const stepConfig = tour.getStepConfig(tour.getCurrentStepNumber());\n    tourRepository.markStepShown(\n        stepConfig.stepid,\n        tourId,\n        tour.getCurrentStepNumber()\n    ).catch(log.error);\n};\n\n/**\n * Mark the specified tour as being completed by the user.\n *\n * @method  markTourComplete\n * @param   {Event} e\n * @listens tool_usertours/stepRendered\n */\nconst markTourComplete = e => {\n    document.removeEventListener(eventTypes.tourEnded, markTourComplete);\n    document.removeEventListener(eventTypes.stepRenderer, markStepShown);\n\n    const tour = e.detail.tour;\n    const stepConfig = tour.getStepConfig(tour.getCurrentStepNumber());\n    tourRepository.markTourComplete(\n        stepConfig.stepid,\n        tourId,\n        tour.getCurrentStepNumber()\n    ).catch(log.error);\n};\n\n/**\n * Reset the state, and restart the the tour on the current page.\n *\n * @method  resetTourState\n * @param   {Number}    tourId      The ID of the tour to start.\n * @returns {Promise}\n */\nexport const resetTourState = tourId => tourRepository.resetTourState(tourId)\n.then(response => {\n    if (response.startTour) {\n        fetchTour(response.startTour);\n    }\n    return;\n}).catch(notification.exception);\n"],"file":"usertours.min.js"}