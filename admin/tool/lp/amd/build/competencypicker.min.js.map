{"version":3,"sources":["../src/competencypicker.js"],"names":["define","$","Notification","Ajax","Templates","Dialogue","Str","Tree","Pending","Picker","pageContextId","singleFramework","pageContextIncludes","multiSelect","self","_eventNode","_frameworks","_reset","_pageContextId","_pageContextIncludes","_multiSelect","_frameworkId","_singleFramework","prototype","_competencies","_disallowedCompetencyIDs","_popup","_searchText","_selectedCompetencies","_onlyVisible","_afterRender","tree","_find","show","on","evt","params","selected","preventDefault","validIds","each","index","item","compId","data","valid","i","id","push","length","attr","removeAttr","change","e","target","val","_loadCompetencies","then","_refresh","bind","catch","exception","click","always","close","pendingPromise","_trigger","competencyIds","competencyId","resolve","currentItems","slice","node","toggleItem","updateFocus","display","when","get_string","_render","title","render","_fetchCompetencies","frameworkId","searchText","call","methodname","args","searchtext","competencyframeworkid","done","competencies","addCompetencyChildren","parent","parentid","haschildren","children","comp","fail","selector","getContent","find","_getFramework","fid","frm","f","_loadFrameworks","promise","framework","sort","context","contextid","includes","onlyvisible","frameworks","type","handler","_preRender","html","replaceWith","search","setDisallowedCompetencyIDs","ids","trigger"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Competency picker.\n *\n * To handle 'save' events use: picker.on('save')\n * This will receive a object with either a single 'competencyId', or an array in 'competencyIds'\n * depending on the value of multiSelect.\n *\n * @module     tool_lp/competencypicker\n * @copyright  2015 Frédéric Massart - FMCorz.net\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery',\n        'core/notification',\n        'core/ajax',\n        'core/templates',\n        'tool_lp/dialogue',\n        'core/str',\n        'tool_lp/tree',\n        'core/pending'\n        ],\n        function($, Notification, Ajax, Templates, Dialogue, Str, Tree, Pending) {\n\n    /**\n     * Competency picker class.\n     * @param {Number} pageContextId The page context ID.\n     * @param {Number|false} singleFramework The ID of the framework when limited to one.\n     * @param {String} pageContextIncludes One of 'children', 'parents', 'self'.\n     * @param {Boolean} multiSelect Support multi-select in the tree.\n     */\n    var Picker = function(pageContextId, singleFramework, pageContextIncludes, multiSelect) {\n        var self = this;\n        self._eventNode = $('<div></div>');\n        self._frameworks = [];\n        self._reset();\n\n        self._pageContextId = pageContextId;\n        self._pageContextIncludes = pageContextIncludes || 'children';\n        self._multiSelect = (typeof multiSelect === 'undefined' || multiSelect === true);\n        if (singleFramework) {\n            self._frameworkId = singleFramework;\n            self._singleFramework = true;\n        }\n    };\n\n    /** @property {Array} The competencies fetched. */\n    Picker.prototype._competencies = null;\n    /** @property {Array} The competencies that cannot be picked. */\n    Picker.prototype._disallowedCompetencyIDs = null;\n    /** @property {Node} The node we attach the events to. */\n    Picker.prototype._eventNode = null;\n    /** @property {Array} The list of frameworks fetched. */\n    Picker.prototype._frameworks = null;\n    /** @property {Number} The current framework ID. */\n    Picker.prototype._frameworkId = null;\n    /** @property {Number} The page context ID. */\n    Picker.prototype._pageContextId = null;\n    /** @property {Number} Relevant contexts inclusion. */\n    Picker.prototype._pageContextIncludes = null;\n    /** @property {Dialogue} The reference to the dialogue. */\n    Picker.prototype._popup = null;\n    /** @property {String} The string we filter the competencies with. */\n    Picker.prototype._searchText = '';\n    /** @property {Object} The competency that was selected. */\n    Picker.prototype._selectedCompetencies = null;\n    /** @property {Boolean} Whether we can browse frameworks or not. */\n    Picker.prototype._singleFramework = false;\n    /** @property {Boolean} Do we allow multi select? */\n    Picker.prototype._multiSelect = true;\n    /** @property {Boolean} Do we allow to display hidden framework? */\n    Picker.prototype._onlyVisible = true;\n\n    /**\n     * Hook to executed after the view is rendered.\n     *\n     * @method _afterRender\n     */\n    Picker.prototype._afterRender = function() {\n        var self = this;\n\n        // Initialise the tree.\n        var tree = new Tree(self._find('[data-enhance=linktree]'), self._multiSelect);\n\n        // To prevent jiggling we only show the tree after it is enhanced.\n        self._find('[data-enhance=linktree]').show();\n\n        tree.on('selectionchanged', function(evt, params) {\n            var selected = params.selected;\n            evt.preventDefault();\n            var validIds = [];\n            $.each(selected, function(index, item) {\n                var compId = $(item).data('id'),\n                    valid = true;\n\n                if (typeof compId === 'undefined') {\n                    // Do not allow picking nodes with no id.\n                    valid = false;\n                } else {\n                    $.each(self._disallowedCompetencyIDs, function(i, id) {\n                        if (id == compId) {\n                            valid = false;\n                        }\n                    });\n                }\n                if (valid) {\n                    validIds.push(compId);\n                }\n            });\n\n            self._selectedCompetencies = validIds;\n\n            // TODO Implement disabling of nodes in the tree module somehow.\n            if (!self._selectedCompetencies.length) {\n                self._find('[data-region=\"competencylinktree\"] [data-action=\"add\"]').attr('disabled', 'disabled');\n            } else {\n                self._find('[data-region=\"competencylinktree\"] [data-action=\"add\"]').removeAttr('disabled');\n            }\n        });\n\n        // Add listener for framework change.\n        if (!self._singleFramework) {\n            self._find('[data-action=\"chooseframework\"]').change(function(e) {\n                self._frameworkId = $(e.target).val();\n                self._loadCompetencies().then(self._refresh.bind(self)).catch(Notification.exception);\n            });\n        }\n\n        // Add listener for search.\n        self._find('[data-region=\"filtercompetencies\"] button').click(function(e) {\n            e.preventDefault();\n            $(e.target).attr('disabled', 'disabled');\n            self._searchText = self._find('[data-region=\"filtercompetencies\"] input').val() || '';\n            return self._refresh().always(function() {\n                $(e.target).removeAttr('disabled');\n            });\n        });\n\n        // Add listener for cancel.\n        self._find('[data-region=\"competencylinktree\"] [data-action=\"cancel\"]').click(function(e) {\n            e.preventDefault();\n            self.close();\n        });\n\n        // Add listener for add.\n        self._find('[data-region=\"competencylinktree\"] [data-action=\"add\"]').click(function(e) {\n            e.preventDefault();\n            var pendingPromise = new Pending();\n            if (!self._selectedCompetencies.length) {\n                return;\n            }\n\n            if (self._multiSelect) {\n                self._trigger('save', {competencyIds: self._selectedCompetencies});\n            } else {\n                // We checked above that the array has at least one value.\n                self._trigger('save', {competencyId: self._selectedCompetencies[0]});\n            }\n\n            // The dialogue here is a YUI dialogue and doesn't support Promises at all.\n            // However, it is typically synchronous so this shoudl suffice.\n            self.close();\n            pendingPromise.resolve();\n        });\n\n        // The list of selected competencies will be modified while looping (because of the listeners above).\n        var currentItems = self._selectedCompetencies.slice(0);\n\n        $.each(currentItems, function(index, id) {\n            var node = self._find('[data-id=' + id + ']');\n            if (node.length) {\n                tree.toggleItem(node);\n                tree.updateFocus(node);\n            }\n        });\n\n    };\n\n    /**\n     * Close the dialogue.\n     *\n     * @method close\n     */\n    Picker.prototype.close = function() {\n        var self = this;\n        self._popup.close();\n        self._reset();\n    };\n\n    /**\n     * Opens the picker.\n     *\n     * @method display\n     * @return {Promise}\n     */\n    Picker.prototype.display = function() {\n        var self = this;\n        return $.when(Str.get_string('competencypicker', 'tool_lp'), self._render())\n        .then(function(title, render) {\n            self._popup = new Dialogue(\n                title,\n                render[0],\n                self._afterRender.bind(self)\n            );\n            return;\n        }).catch(Notification.exception);\n    };\n\n    /**\n     * Fetch the competencies.\n     *\n     * @param {Number} frameworkId The frameworkId.\n     * @param {String} searchText Limit the competencies to those matching the text.\n     * @method _fetchCompetencies\n     * @return {Promise}\n     */\n    Picker.prototype._fetchCompetencies = function(frameworkId, searchText) {\n        var self = this;\n\n        return Ajax.call([\n            {methodname: 'core_competency_search_competencies', args: {\n                searchtext: searchText,\n                competencyframeworkid: frameworkId\n            }}\n        ])[0].done(function(competencies) {\n          /**\n           * @param {Object} parent\n           * @param {Array} competencies\n           */\n            function addCompetencyChildren(parent, competencies) {\n                for (var i = 0; i < competencies.length; i++) {\n                    if (competencies[i].parentid == parent.id) {\n                        parent.haschildren = true;\n                        competencies[i].children = [];\n                        competencies[i].haschildren = false;\n                        parent.children[parent.children.length] = competencies[i];\n                        addCompetencyChildren(competencies[i], competencies);\n                    }\n                }\n            }\n\n            // Expand the list of competencies into a tree.\n            var i, comp;\n            var tree = [];\n            for (i = 0; i < competencies.length; i++) {\n                comp = competencies[i];\n                if (comp.parentid == \"0\") { // Loose check for now, because WS returns a string.\n                    comp.children = [];\n                    comp.haschildren = 0;\n                    tree[tree.length] = comp;\n                    addCompetencyChildren(comp, competencies);\n                }\n            }\n\n            self._competencies = tree;\n\n        }).fail(Notification.exception);\n    };\n\n    /**\n     * Find a node in the dialogue.\n     *\n     * @param {String} selector\n     * @return {JQuery}\n     * @method _find\n     */\n    Picker.prototype._find = function(selector) {\n        return $(this._popup.getContent()).find(selector);\n    };\n\n    /**\n     * Convenience method to get a framework object.\n     *\n     * @param {Number} fid The framework ID.\n     * @return {Object}\n     * @method _getFramework\n     */\n    Picker.prototype._getFramework = function(fid) {\n        var frm;\n        $.each(this._frameworks, function(i, f) {\n            if (f.id == fid) {\n                frm = f;\n                return;\n            }\n        });\n        return frm;\n    };\n\n    /**\n     * Load the competencies.\n     *\n     * @method _loadCompetencies\n     * @return {Promise}\n     */\n    Picker.prototype._loadCompetencies = function() {\n        return this._fetchCompetencies(this._frameworkId, this._searchText);\n    };\n\n    /**\n     * Load the frameworks.\n     *\n     * @method _loadFrameworks\n     * @return {Promise}\n     */\n    Picker.prototype._loadFrameworks = function() {\n        var promise,\n            self = this;\n\n        // Quit early because we already have the data.\n        if (self._frameworks.length > 0) {\n            return $.when();\n        }\n\n        if (self._singleFramework) {\n            promise = Ajax.call([\n                {methodname: 'core_competency_read_competency_framework', args: {\n                    id: this._frameworkId\n                }}\n            ])[0].then(function(framework) {\n                return [framework];\n            });\n        } else {\n            promise = Ajax.call([\n                {methodname: 'core_competency_list_competency_frameworks', args: {\n                    sort: 'shortname',\n                    context: {contextid: self._pageContextId},\n                    includes: self._pageContextIncludes,\n                    onlyvisible: self._onlyVisible\n                }}\n            ])[0];\n        }\n\n        return promise.done(function(frameworks) {\n            self._frameworks = frameworks;\n        }).fail(Notification.exception);\n    };\n\n    /**\n     * Register an event listener.\n     *\n     * @param {String} type The event type.\n     * @param {Function} handler The event listener.\n     * @method on\n     */\n    Picker.prototype.on = function(type, handler) {\n        this._eventNode.on(type, handler);\n    };\n\n    /**\n     * Hook to executed before render.\n     *\n     * @method _preRender\n     * @return {Promise}\n     */\n    Picker.prototype._preRender = function() {\n        var self = this;\n        return self._loadFrameworks().then(function() {\n            if (!self._frameworkId && self._frameworks.length > 0) {\n                self._frameworkId = self._frameworks[0].id;\n            }\n\n            // We could not set a framework ID, that probably means there are no frameworks accessible.\n            if (!self._frameworkId) {\n                self._frameworks = [];\n                return $.when();\n            }\n\n            return self._loadCompetencies();\n        });\n    };\n\n    /**\n     * Refresh the view.\n     *\n     * @method _refresh\n     * @return {Promise}\n     */\n    Picker.prototype._refresh = function() {\n        var self = this;\n        return self._render().then(function(html) {\n            self._find('[data-region=\"competencylinktree\"]').replaceWith(html);\n            self._afterRender();\n            return;\n        });\n    };\n\n    /**\n     * Render the dialogue.\n     *\n     * @method _render\n     * @return {Promise}\n     */\n    Picker.prototype._render = function() {\n        var self = this;\n        return self._preRender().then(function() {\n\n            if (!self._singleFramework) {\n                $.each(self._frameworks, function(i, framework) {\n                    if (framework.id == self._frameworkId) {\n                        framework.selected = true;\n                    } else {\n                        framework.selected = false;\n                    }\n                });\n            }\n\n            var context = {\n                competencies: self._competencies,\n                framework: self._getFramework(self._frameworkId),\n                frameworks: self._frameworks,\n                search: self._searchText,\n                singleFramework: self._singleFramework,\n            };\n\n            return Templates.render('tool_lp/competency_picker', context);\n        });\n    };\n\n    /**\n     * Reset the dialogue properties.\n     *\n     * This does not reset everything, just enough to reset the UI.\n     *\n     * @method _reset\n     */\n    Picker.prototype._reset = function() {\n        this._competencies = [];\n        this._disallowedCompetencyIDs = [];\n        this._popup = null;\n        this._searchText = '';\n        this._selectedCompetencies = [];\n    };\n\n    /**\n     * Set what competencies cannot be picked.\n     *\n     * This needs to be set after reset/close.\n     *\n     * @param {Number[]} ids The IDs.\n     * @method _setDisallowedCompetencyIDs\n     */\n    Picker.prototype.setDisallowedCompetencyIDs = function(ids) {\n        this._disallowedCompetencyIDs = ids;\n    };\n\n    /**\n     * Trigger an event.\n     *\n     * @param {String} type The type of event.\n     * @param {Object} data The data to pass to the listeners.\n     * @method _reset\n     */\n    Picker.prototype._trigger = function(type, data) {\n        this._eventNode.trigger(type, [data]);\n    };\n\n    return Picker;\n\n});\n"],"file":"competencypicker.min.js"}