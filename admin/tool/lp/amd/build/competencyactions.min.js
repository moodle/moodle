define ("tool_lp/competencyactions",["jquery","core/url","core/templates","core/notification","core/str","core/ajax","tool_lp/dragdrop-reorder","tool_lp/tree","tool_lp/dialogue","tool_lp/menubar","tool_lp/competencypicker","tool_lp/competency_outcomes","tool_lp/competencyruleconfig"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n=null,o=null,p=null,q,r,s,t,u,v,w=null,x=function(){var c=a("[data-region=\"competencyactions\"]").data("competency"),f={competencyframeworkid:n.getCompetencyFrameworkId(),pagecontextid:q};if(null!==c){f.parentid=c.id}var g=function(){var c=a.param(f);window.location=b.relativeUrl("/admin/tool/lp/editcompetency.php?"+c)};if(null!==c&&n.hasRule(c.id)){e.get_strings([{key:"confirm",component:"moodle"},{key:"addingcompetencywillresetparentrule",component:"tool_lp",param:c.shortname},{key:"yes",component:"core"},{key:"no",component:"core"}]).done(function(a){d.confirm(a[0],a[1],a[2],a[3],g)}).fail(d.exception)}else{g()}},y=function(){var b=a("[data-region=\"filtercompetencies\"]").data("frameworkid"),c=f.call([{methodname:"core_competency_set_parent_competency",args:{competencyid:o,parentid:p}},{methodname:"tool_lp_data_for_competencies_manage_page",args:{competencyframeworkid:b,search:a("[data-region=\"filtercompetencies\"] input").val()}}]);c[1].done(E).fail(d.exception)},z=function(){p="undefined"==typeof p?0:p;if(p==o){return}var a=n.getCompetency(p)||{},b=n.getCompetency(o)||{},c="movecompetencywillresetrules",f=!1;if(b.parentid==p){return}if(a.path&&0<=a.path.indexOf("/"+b.id+"/")){c="movecompetencytochildofselfwillresetrules";f=f||n.hasRule(b.id)}f=f||n.hasRule(a.id)||n.hasRule(b.parentid);if(f){e.get_strings([{key:"confirm",component:"moodle"},{key:c,component:"tool_lp"},{key:"yes",component:"moodle"},{key:"no",component:"moodle"}]).done(function(a){d.confirm(a[0],a[1],a[2],a[3],y)}).fail(d.exception)}else{y()}},A=function(b){var c=a(b.getContent()),d=c.find("[data-enhance=movetree]"),e=new h(d,!1);e.on("selectionchanged",function(b,c){var d=c.selected;p=a(d).data("id")});d.show();c.on("click","[data-action=\"move\"]",function(){b.close();z()});c.on("click","[data-action=\"cancel\"]",function(){b.close()})},B=function(a,b){var c;for(c=0;c<b.length;c++){if(b[c].parentid==a.id){a.haschildren=!0;b[c].children=[];b[c].haschildren=!1;a.children[a.children.length]=b[c];B(b[c],b)}}},C=function(b){b.preventDefault();var g=a("[data-region=\"competencyactions\"]").data("competency");o=g.id;var h=f.call([{methodname:"core_competency_search_competencies",args:{competencyframeworkid:g.competencyframeworkid,searchtext:""}},{methodname:"core_competency_read_competency_framework",args:{id:g.competencyframeworkid}}]);a.when.apply(null,h).done(function(a,b){var f,h=[];for(f=0;f<a.length;f++){var j=a[f];if("0"==j.parentid){j.children=[];j.haschildren=0;h[h.length]=j;B(j,a)}}e.get_strings([{key:"movecompetency",component:"tool_lp",param:g.shortname},{key:"move",component:"tool_lp"},{key:"cancel",component:"moodle"}]).done(function(a){c.render("tool_lp/competencies_move_tree",{framework:b,competencies:h}).done(function(b){new i(a[0],b,A)}).fail(d.exception)}).fail(d.exception)}).fail(d.exception)},D=function(){var c=a("[data-region=\"competencyactions\"]").data("competency"),d={competencyframeworkid:n.getCompetencyFrameworkId(),id:c.id,parentid:c.parentid,pagecontextid:q},e=a.param(d);window.location=b.relativeUrl("/admin/tool/lp/editcompetency.php?"+e)},E=function(b){c.render("tool_lp/manage_competencies_page",b).done(function(b,d){a("[data-region=\"managecompetencies\"]").replaceWith(b);c.runTemplateJS(d)}).fail(d.exception)},F=function(b){b.preventDefault();var c=a("[data-region=\"filtercompetencies\"]").data("frameworkid"),e=f.call([{methodname:"tool_lp_data_for_competencies_manage_page",args:{competencyframeworkid:c,search:a("[data-region=\"filtercompetencies\"] input").val()}}]);e[0].done(E).fail(d.exception)},G=function(){var b=a("[data-region=\"competencyactions\"]").data("competency"),c=f.call([{methodname:"core_competency_move_up_competency",args:{id:b.id}},{methodname:"tool_lp_data_for_competencies_manage_page",args:{competencyframeworkid:b.competencyframeworkid,search:a("[data-region=\"filtercompetencies\"] input").val()}}]);c[1].done(E).fail(d.exception)},H=function(){var b=a("[data-region=\"competencyactions\"]").data("competency"),c=f.call([{methodname:"core_competency_move_down_competency",args:{id:b.id}},{methodname:"tool_lp_data_for_competencies_manage_page",args:{competencyframeworkid:b.competencyframeworkid,search:a("[data-region=\"filtercompetencies\"] input").val()}}]);c[1].done(E).fail(d.exception)},I=function(){var b=a("[data-region=\"competencyactions\"]").data("competency"),g=f.call([{methodname:"tool_lp_list_courses_using_competency",args:{id:b.id}}]);g[0].done(function(a){c.render("tool_lp/linked_courses_summary",{courses:a}).done(function(a){e.get_string("linkedcourses","tool_lp").done(function(b){new i(b,a,A)}).fail(d.exception)}).fail(d.exception)}).fail(d.exception)},J=function(){t=a("[data-region=\"competencyactions\"]").data("competency");if(!r){r=new k(q,t.competencyframeworkid);r.on("save",function(b,e){var g=e.competencyIds,h=[];a.each(g,function(a,b){h.push({methodname:"core_competency_add_related_competency",args:{competencyid:b,relatedcompetencyid:t.id}})});h.push({methodname:"tool_lp_data_for_related_competencies_section",args:{competencyid:t.id}});var i=f.call(h);i[h.length-1].then(function(a){return c.render("tool_lp/related_competencies",a)}).then(function(b,d){a("[data-region=\"relatedcompetencies\"]").replaceWith(b);c.runTemplateJS(d);U()}).catch(d.exception)})}r.setDisallowedCompetencyIDs([t.id]);r.display()},K=function(b){b.preventDefault();t=a("[data-region=\"competencyactions\"]").data("competency");s.setTargetCompetencyId(t.id);s.display()},L=function(a,b){var c={id:t.id,shortname:t.shortname,idnumber:t.idnumber,description:t.description,descriptionformat:t.descriptionformat,ruletype:b.ruletype,ruleoutcome:b.ruleoutcome,ruleconfig:b.ruleconfig},e=f.call([{methodname:"core_competency_update_competency",args:{competency:c}}]);e[0].then(function(a){if(a){t.ruletype=b.ruletype;t.ruleoutcome=b.ruleoutcome;t.ruleconfig=b.ruleconfig;X(t)}}).catch(d.exception)},M=function(){var b=a("[data-region=\"competencyactions\"]").data("competency"),c=f.call([{methodname:"core_competency_delete_competency",args:{id:b.id}},{methodname:"tool_lp_data_for_competencies_manage_page",args:{competencyframeworkid:b.competencyframeworkid,search:a("[data-region=\"filtercompetencies\"] input").val()}}]);c[0].done(function(a){if(!1===a){e.get_strings([{key:"competencycannotbedeleted",component:"tool_lp",param:b.shortname},{key:"cancel",component:"moodle"}]).done(function(a){d.alert(null,a[0])}).fail(d.exception)}}).fail(d.exception);c[1].done(E).fail(d.exception)},N=function(){var b=a("[data-region=\"competencyactions\"]").data("competency"),c="deletecompetency";if(n.hasRule(b.parentid)){c="deletecompetencyparenthasrule"}e.get_strings([{key:"confirm",component:"moodle"},{key:c,component:"tool_lp",param:b.shortname},{key:"delete",component:"moodle"},{key:"cancel",component:"moodle"}]).done(function(a){d.confirm(a[0],a[1],a[2],a[3],M)}).fail(d.exception)},O=function(b){b.originalEvent.dataTransfer.setData("text",a(b.target).parent().data("id"))},P=function(a){a.originalEvent.dataTransfer.dropEffect="move";a.preventDefault()},Q=function(b){b.preventDefault();a(this).addClass("currentdragtarget")},R=function(b){b.preventDefault();a(this).removeClass("currentdragtarget")},S=function(b){b.preventDefault();o=b.originalEvent.dataTransfer.getData("text");p=a(b.target).parent().data("id");a(this).removeClass("currentdragtarget");z()},T=function(b){b.preventDefault();var e=this.id.substr(11),g=a("[data-region=\"competencyactions\"]").data("competency"),h=f.call([{methodname:"core_competency_remove_related_competency",args:{relatedcompetencyid:e,competencyid:g.id}},{methodname:"tool_lp_data_for_related_competencies_section",args:{competencyid:g.id}}]);h[1].done(function(b){c.render("tool_lp/related_competencies",b).done(function(b){a("[data-region=\"relatedcompetencies\"]").replaceWith(b);U()}).fail(d.exception)}).fail(d.exception)},U=function(){a("[data-action=\"deleterelation\"]").on("click",T)},V=function(a){if(a.id!==w){w=a.id;f.call([{methodname:"core_competency_competency_viewed",args:{id:a.id}}])}},W=function(a){var b=u[a];if(!b){b="competency"}return b},X=function(e){var g=a.Deferred().resolve().promise(),h={};h.competency=e;h.showdeleterelatedaction=!0;h.showrelatedcompetencies=!0;h.showrule=!1;h.pluginbaseurl=b.relativeUrl("/admin/tool/lp");if(e.ruleoutcome!=l.NONE){g=l.getString(e.ruleoutcome).then(function(b){var c;a.each(v,function(a,b){if(b.type==e.ruletype){c=b.name}});return[b,c]})}g.then(function(a){if("undefined"!=typeof a){h.showrule=!0;h.rule={outcome:a[0],type:a[1]}}return h}).then(function(a){return c.render("tool_lp/competency_summary",a)}).then(function(b){a("[data-region=\"competencyinfo\"]").html(b);a("[data-action=\"deleterelation\"]").on("click",T);return c.render("tool_lp/loading",{})}).then(function(a,b){c.replaceNodeContents("[data-region=\"relatedcompetencies\"]",a,b);return f.call([{methodname:"tool_lp_data_for_related_competencies_section",args:{competencyid:e.id}}])[0]}).then(function(a){return c.render("tool_lp/related_competencies",a)}).then(function(b,d){a("[data-region=\"relatedcompetencies\"]").replaceWith(b);c.runTemplateJS(d);U()}).catch(d.exception)},Y=function(a){return e.get_string("taxonomy_add_"+W(a),"tool_lp")},Z=function(a){return e.get_string("taxonomy_selected_"+W(a),"tool_lp")},$=function(b,c){var e=c.selected,f=a(e).data("id"),g=a("[data-region=\"competencyactions\"] [data-action=\"add\"]"),h=a("[data-region=\"competencyactionsmenu\"]"),i=a("[data-region=\"selected-competency\"]"),k=0,l=1;j.closeAll();if("undefined"==typeof f){a("[data-region=\"competencyinfo\"]").html(e.clone().children().remove().end().text());a("[data-region=\"competencyactions\"]").data("competency",null);h.hide()}else{var m=n.getCompetency(f);k=n.getCompetencyLevel(f);l=k+1;h.show();a("[data-region=\"competencyactions\"]").data("competency",m);X(m);V(m)}Z(k).then(function(a){i.text(a)}).catch(d.exception);Y(l).then(function(a){g.show().find("[data-region=\"term\"]").text(a)}).catch(d.exception);b.preventDefault();return!1},_=function(a){var b=a.split(",");b.unshift("");delete b[0];return b};return{init:function init(b,c,d,e){n=b;q=c;u=_(d);v=e;a("[data-region=\"competencyactions\"] [data-action=\"add\"]").on("click",x);j.enhance(".competencyactionsmenu",{'[data-action="edit"]':D,'[data-action="delete"]':N,'[data-action="move"]':C,'[data-action="moveup"]':G,'[data-action="movedown"]':H,'[data-action="linkedcourses"]':I,'[data-action="relatedcompetencies"]':J.bind(this),'[data-action="competencyrules"]':K.bind(this)});a("[data-region=\"competencyactionsmenu\"]").hide();a("[data-region=\"competencyactions\"] [data-action=\"add\"]").hide();a("[data-region=\"filtercompetencies\"]").on("submit",F);var f=a("[data-region=\"managecompetencies\"] [data-enhance=\"tree\"]");f.on("dragstart","li>span",O).on("dragover","li>span",P).on("dragenter","li>span",Q).on("dragleave","li>span",R).on("drop","li>span",S);b.on("selectionchanged",$);s=new m(n,v);s.on("save",L.bind(this))}}});
//# sourceMappingURL=competencyactions.min.js.map
