define("core_form/modalform",["exports","core/modal_factory","core/modal_events","core/ajax","core/notification","core/yui","core/event","core/fragment","core/pending"],(function(_exports,_modal_factory,_modal_events,_ajax,_notification,_yui,_event,_fragment,_pending){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}function _toConsumableArray(arr){return function(arr){if(Array.isArray(arr))return _arrayLikeToArray(arr)}(arr)||function(iter){if("undefined"!=typeof Symbol&&null!=iter[Symbol.iterator]||null!=iter["@@iterator"])return Array.from(iter)}(arr)||function(o,minLen){if(!o)return;if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}(arr)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);enumerableOnly&&(symbols=symbols.filter((function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable}))),keys.push.apply(keys,symbols)}return keys}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events),_ajax=_interopRequireDefault(_ajax),_notification=_interopRequireDefault(_notification),_yui=_interopRequireDefault(_yui),_event=_interopRequireDefault(_event),_fragment=_interopRequireDefault(_fragment),_pending=_interopRequireDefault(_pending);var ModalForm=function(){function ModalForm(config){!function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,ModalForm),_defineProperty(this,"events",{FORM_SUBMITTED:"core_form_modalform_formsubmitted",FORM_CANCELLED:"core_form_modalform_formcancelled",CLIENT_VALIDATION_ERROR:"core_form_modalform_clientvalidationerror",SERVER_VALIDATION_ERROR:"core_form_modalform_validationerror",ERROR:"core_form_modalform_error",NOSUBMIT_BUTTON_PRESSED:"core_form_modalform_nosubmitbutton",SUBMIT_BUTTON_PRESSED:"core_form_modalform_submitbutton",CANCEL_BUTTON_PRESSED:"core_form_modalform_cancelbutton",LOADED:"core_form_modalform_loaded"}),this.modal=null,this.config=config,this.config.modalConfig=function(target){for(var i=1;i<arguments.length;i++){var source=null!=arguments[i]?arguments[i]:{};i%2?ownKeys(Object(source),!0).forEach((function(key){_defineProperty(target,key,source[key])})):Object.getOwnPropertyDescriptors?Object.defineProperties(target,Object.getOwnPropertyDescriptors(source)):ownKeys(Object(source)).forEach((function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))}))}return target}({removeOnClose:!0,type:_modal_factory.default.types.SAVE_CANCEL,large:!0},this.config.modalConfig||{}),this.config.args=this.config.args||{},this.futureListeners=[]}var Constructor,protoProps,staticProps,fn,_submitFormAjax;return Constructor=ModalForm,protoProps=[{key:"show",value:function(){var _this=this,pendingPromise=new _pending.default("core_form/modalform:init");return _modal_factory.default.create(this.config.modalConfig).then((function(modal){_this.modal=modal;var formParams=new URLSearchParams(Object.entries(_this.config.args||{})),bodyContent=_this.getBody(formParams.toString());return _this.modal.setBodyContent(bodyContent),bodyContent.catch(_notification.default.exception),_this.modal.getRoot().on(_modal_events.default.hidden,(function(){_this.notifyResetFormChanges().then((function(){return _this.modal.destroy(),_this.config.returnFocus&&_this.config.returnFocus.focus(),null})).catch((function(){return null}))})),_this.modal.getModal().addClass("modal-form-dialogue"),_this.modal.getRoot().on("click","form input[type=submit][data-no-submit]",(function(e){e.preventDefault(),_this.trigger(_this.events.NOSUBMIT_BUTTON_PRESSED,e.target).defaultPrevented||_this.processNoSubmitButton(e.target)})),_this.modal.getRoot().on("submit","form",(function(e){e.preventDefault(),_this.trigger(_this.events.SUBMIT_BUTTON_PRESSED).defaultPrevented||_this.submitFormAjax()})),void 0!==_this.config.saveButtonText&&void 0!==_this.modal.setSaveButtonText&&_this.modal.setSaveButtonText(_this.config.saveButtonText),void 0!==_this.config.saveButtonClasses&&_this.setSaveButtonClasses(_this.config.saveButtonClasses),_this.modal.getRoot().on(_modal_events.default.save,(function(e){e.preventDefault(),_this.modal.getRoot().find("form").submit()})),_this.modal.getRoot().on(_modal_events.default.cancel,(function(e){_this.trigger(_this.events.CANCEL_BUTTON_PRESSED).defaultPrevented&&e.preventDefault()})),_this.futureListeners.forEach((function(args){var _this$modal$getRoot$;return(_this$modal$getRoot$=_this.modal.getRoot()[0]).addEventListener.apply(_this$modal$getRoot$,_toConsumableArray(args))})),_this.futureListeners=[],_this.trigger(_this.events.LOADED,null,!1),_this.modal.show()})).then(pendingPromise.resolve)}},{key:"trigger",value:function(eventName){var detail=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,cancelable=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],e=new CustomEvent(eventName,{detail:detail,cancelable:cancelable});return this.modal.getRoot()[0].dispatchEvent(e),e}},{key:"addEventListener",value:function(){for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];var _this$modal$getRoot$2;this.modal?(_this$modal$getRoot$2=this.modal.getRoot()[0]).addEventListener.apply(_this$modal$getRoot$2,args):this.futureListeners.push(args)}},{key:"getBody",value:function(formDataString){var params={formdata:formDataString,form:this.config.formClass},pendingPromise=new _pending.default("core_form/modalform:form_body");return _ajax.default.call([{methodname:"core_form_dynamic_form",args:params}])[0].then((function(response){return pendingPromise.resolve(),{html:response.html,js:_fragment.default.processCollectedJavascript(response.javascript)}}))}},{key:"onSubmitError",value:function(exception){this.trigger(this.events.ERROR,exception).defaultPrevented||_notification.default.exception(exception)}},{key:"notifyResetFormChanges",value:function(){var _this2=this;return new Promise((function(resolve){_yui.default.use("event","moodle-core-event","moodle-core-formchangechecker",(function(){var form=_this2.modal.getRoot().find("form")[0];form&&(_event.default.notifyFormSubmitAjax(form,!0),M.core_formchangechecker.reset_form_dirty_state()),resolve()}))}))}},{key:"notifyFormSubmitAjax",value:function(){var _this3=this,skipValidation=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return new Promise((function(resolve){_yui.default.use("event","moodle-core-event","moodle-core-formchangechecker",(function(){_event.default.notifyFormSubmitAjax(_this3.modal.getRoot().find("form")[0],skipValidation),resolve()}))}))}},{key:"processNoSubmitButton",value:function(button){var _this4=this;this.notifyFormSubmitAjax(!0).then((function(){var formData=_this4.modal.getRoot().find("form").serialize();formData=formData+"&"+encodeURIComponent(button.getAttribute("name"))+"="+encodeURIComponent(button.getAttribute("value"));var bodyContent=_this4.getBody(formData);return _this4.modal.setBodyContent(bodyContent),bodyContent.catch(_notification.default.exception),null})).catch(null)}},{key:"validateElements",value:function(){var _this5=this;return this.notifyFormSubmitAjax().then((function(){var invalid=_this5.modal.getRoot().find('[aria-invalid="true"], .error');return!invalid.length||(invalid.first().focus(),!1)}))}},{key:"disableButtons",value:function(){this.modal.getFooter().find("[data-action]").attr("disabled",!0)}},{key:"enableButtons",value:function(){this.modal.getFooter().find("[data-action]").removeAttr("disabled")}},{key:"submitFormAjax",value:(fn=regeneratorRuntime.mark((function _callee(){var formData,_this6=this;return regeneratorRuntime.wrap((function(_context){for(;;)switch(_context.prev=_context.next){case 0:return _context.next=2,this.validateElements();case 2:if(_context.sent){_context.next=5;break}return this.trigger(this.events.CLIENT_VALIDATION_ERROR,null,!1),_context.abrupt("return");case 5:this.disableButtons(),formData=this.modal.getRoot().find("form").serialize(),_ajax.default.call([{methodname:"core_form_dynamic_form",args:{formdata:formData,form:this.config.formClass}}])[0].then((function(response){if(response.submitted){var data=JSON.parse(response.data);return _this6.notifyResetFormChanges().then((function(){return _this6.trigger(_this6.events.FORM_SUBMITTED,data).defaultPrevented||_this6.modal.hide(),null}))}var promise=new Promise((function(resolve){return resolve({html:response.html,js:_fragment.default.processCollectedJavascript(response.javascript)})}));return _this6.modal.setBodyContent(promise),_this6.enableButtons(),_this6.trigger(_this6.events.SERVER_VALIDATION_ERROR),null})).catch((function(exception){return _this6.onSubmitError(exception)}));case 8:case"end":return _context.stop()}}),_callee,this)})),_submitFormAjax=function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))},function(){return _submitFormAjax.apply(this,arguments)})},{key:"setSaveButtonClasses",value:function(value){var button=this.modal.getFooter().find("[data-action='save']");if(!button)throw new Error("Unable to find the 'save' button");button.removeClass().addClass(value)}}],protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),ModalForm}();return _exports.default=ModalForm,_exports.default}));

//# sourceMappingURL=modalform.min.js.map