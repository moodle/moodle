define(["jquery","core/log","core/str","core/templates","core/notification"],function(a,b,c,d,e){var f={DOWN:40,ENTER:13,SPACE:32,ESCAPE:27,COMMA:188,UP:38},g=function(b,c){var d=a(document.getElementById(c.selectionId)),e=d.children("[aria-selected=true]").length;for(b%=e;0>b;)b+=e;var f=a(d.children("[aria-selected=true]").get(b)),g=c.selectionId+"-"+b;d.children().attr("data-active-selection",!1).attr("id",""),f.attr("data-active-selection",!0).attr("id",g),d.attr("aria-activedescendant",g)},h=function(b,c,d,e){var f=a(d).attr("data-value");b.multiple&&e.children("option").each(function(b,c){a(c).attr("value")==f&&(a(c).prop("selected",!1),a(c).attr("data-iscustom")&&a(c).remove())}),q(b,c,e)},i=function(b,c){var d=a(document.getElementById(c.inputId)),e=a(document.getElementById(c.suggestionsId)),f=e.children("[aria-hidden=false]").length;for(b%=f;0>b;)b+=f;var g=a(e.children("[aria-hidden=false]").get(b)),h=a(e.children("[role=option]")).index(g),i=c.suggestionsId+"-"+h;e.children().attr("aria-selected",!1).attr("id",""),g.attr("aria-selected",!0).attr("id",i),d.attr("aria-activedescendant",i);var j=g.offset().top-e.offset().top+e.scrollTop()-e.height()/2;e.animate({scrollTop:j},100)},j=function(b){var c=a(document.getElementById(b.suggestionsId)),d=c.children("[aria-selected=true]"),e=c.children("[aria-hidden=false]").index(d);i(e+1,b)},k=function(b){var c=a(document.getElementById(b.selectionId)),d=c.children("[data-active-selection=true]");if(!d)return void g(0,b);var e=c.children("[aria-selected=true]").index(d);g(e-1,b)},l=function(b){var c=a(document.getElementById(b.selectionId)),d=c.children("[data-active-selection=true]");if(!d)return void g(0,b);var e=c.children("[aria-selected=true]").index(d);g(e+1,b)},m=function(b){var c=a(document.getElementById(b.suggestionsId)),d=c.children("[aria-selected=true]"),e=c.children("[aria-hidden=false]").index(d);i(e-1,b)},n=function(b){var c=a(document.getElementById(b.inputId)),d=a(document.getElementById(b.suggestionsId));c.attr("aria-expanded",!1).attr("aria-activedescendant",b.selectionId),d.hide().attr("aria-hidden",!0)},o=function(b,f,g,h){var j=a(document.getElementById(f.inputId)),k=a(document.getElementById(f.suggestionsId)),l=!1,m=[];h.children("option").each(function(b,c){a(c).prop("selected")!==!0&&(m[m.length]={label:c.innerHTML,value:a(c).attr("value")})});var n=f.caseSensitive?g:g.toLocaleLowerCase(),o=a.extend({options:m},b,f);d.render("core/form_autocomplete_suggestions",o).done(function(d){k.replaceWith(d),k=a(document.getElementById(f.suggestionsId)),k.show().attr("aria-hidden",!1),k.children().each(function(c,d){d=a(d),b.caseSensitive&&d.text().indexOf(n)>-1||!b.caseSensitive&&d.text().toLocaleLowerCase().indexOf(n)>-1?(d.show().attr("aria-hidden",!1),l=!0):d.hide().attr("aria-hidden",!0)}),j.attr("aria-expanded",!0),l?b.tags||i(0,f):c.get_string("nosuggestions","form").done(function(a){k.html(a)})}).fail(e.exception)},p=function(b,c,d){var e=a(document.getElementById(c.inputId)),f=e.val(),g=f.split(","),h=!1;a.each(g,function(c,e){if(e=e.trim(),""!==e&&(b.multiple||d.children("option").prop("selected",!1),d.children("option").each(function(b,c){a(c).attr("value")==e&&(h=!0,a(c).prop("selected",!0))}),!h)){var f=a("<option>");f.append(e),f.attr("value",e),d.append(f),f.prop("selected",!0),f.attr("data-iscustom",!0)}}),q(b,c,d),e.val(""),n(c)},q=function(b,c,f,h){void 0===h&&(h=!0);var i=[],j=a(document.getElementById(c.selectionId)),k=j.attr("aria-activedescendant"),l=!1;k&&(l=a(document.getElementById(k)).attr("data-value")),f.children("option").each(function(b,c){a(c).prop("selected")&&i.push({label:a(c).html(),value:a(c).attr("value")})});var m=a.extend({items:i},b,c);d.render("core/form_autocomplete_selection",m).done(function(b){j.empty().append(a(b).html()),l!==!1&&j.children("[aria-selected=true]").each(function(b,d){a(d).attr("data-value")===l&&g(b,c)})}).fail(e.exception),"undefined"!=typeof M.core_formchangechecker&&h&&M.core_formchangechecker.set_form_changed({target:f}),f.change()},r=function(b,c,d){var e=a(document.getElementById(c.inputId)),f=a(document.getElementById(c.suggestionsId)),g=f.children("[aria-selected=true]").attr("data-value");b.multiple||d.children("option").prop("selected",!1),d.children("option").each(function(b,c){a(c).attr("value")==g&&a(c).prop("selected",!0)}),q(b,c,d),e.val(""),n(c)},s=function(b,c,d,f,g){var h=a(b.currentTarget).val();g.transport(c.selector,h,function(b){var e=g.processResults(c.selector,b),h=[];f.children("option").each(function(b,c){c=a(c),c.prop("selected")?h.push(c.attr("value")):c.remove()}),a.each(e,function(b,c){if(-1===h.indexOf(c.value)){var d=a("<option>");d.append(c.label),d.attr("value",c.value),f.append(d)}}),o(c,d,"",f)},e.exception)},t=function(b,c,d){var e=a(document.getElementById(c.inputId));if(e.on("keydown",function(g){switch(g.keyCode){case f.DOWN:return b.showSuggestions?("true"===e.attr("aria-expanded")?j(c):!e.val()&&b.ajax?require([b.ajax],function(a){s(g,b,c,d,a)}):o(b,c,e.val(),d),g.preventDefault(),!1):!0;case f.COMMA:return b.tags&&p(b,c,d),g.preventDefault(),!1;case f.UP:return m(c),g.preventDefault(),!1;case f.ENTER:var h=a(document.getElementById(c.suggestionsId));return"true"===e.attr("aria-expanded")&&h.children("[aria-selected=true]").length>0?r(b,c,d):b.tags&&p(b,c,d),g.preventDefault(),!1;case f.ESCAPE:return"true"===e.attr("aria-expanded")&&n(c),g.preventDefault(),!1}return!0}),e.on("behat:set-value",function(){b.tags&&p(b,c,d)}),e.on("blur",function(){window.setTimeout(function(){var f=a(document.activeElement);f.attr("id")!=e.attr("id")&&(b.tags&&p(b,c,d),n(c))},500)}),b.showSuggestions){var g=a(document.getElementById(c.downArrowId));g.on("click",function(){e.focus(),o(b,c,e.val(),d)})}var q=a(document.getElementById(c.suggestionsId));q.parent().on("click","[role=option]",function(e){var f=a(e.currentTarget).closest("[role=option]"),g=a(document.getElementById(c.suggestionsId)),h=g.children("[aria-hidden=false]").index(f);i(h,c),r(b,c,d)});var t=a(document.getElementById(c.selectionId));t.on("click","[role=listitem]",function(e){var f=a(e.currentTarget);h(b,c,f,d)}),t.on("keydown",function(e){switch(e.keyCode){case f.DOWN:return l(c),e.preventDefault(),!1;case f.UP:return k(c),e.preventDefault(),!1;case f.SPACE:case f.ENTER:var g=a(document.getElementById(c.selectionId)).children("[data-active-selection=true]");return g&&(h(b,c,g,d),e.preventDefault()),!1}return!0}),b.showSuggestions&&e.on("input",function(e){var f=a(e.currentTarget).val(),g=a(e.currentTarget).data("last-value");g!==f&&o(b,c,f,d),a(e.currentTarget).data("last-value",f)})};return{enhance:function(c,e,f,g,h,i){var j={selector:c,tags:!1,ajax:!1,placeholder:g,caseSensitive:!1,showSuggestions:!0};"undefined"!=typeof e&&(j.tags=e),"undefined"!=typeof f&&(j.ajax=f),"undefined"!=typeof h&&(j.caseSensitive=h),"undefined"!=typeof i&&(j.showSuggestions=i);var k=a(c);if(!k)return b.debug("Selector not found: "+c),!1;k.hide().attr("aria-hidden",!0);var l={selectId:k.attr("id"),inputId:"form_autocomplete_input-"+a.now(),suggestionsId:"form_autocomplete_suggestions-"+a.now(),selectionId:"form_autocomplete_selection-"+a.now(),downArrowId:"form_autocomplete_downarrow-"+a.now()};j.multiple=k.attr("multiple");var m=a("[for="+l.selectId+"]"),n=[];k.children("option").each(function(b,c){n[b]={label:c.innerHTML,value:a(c).attr("value")}});var o=a.extend({},j,l);o.options=n,o.items=[],o["class"]=k.attr("class");var p=d.render("core/form_autocomplete_input",o),r=d.render("core/form_autocomplete_suggestions",o),u=d.render("core/form_autocomplete_selection",o);a.when(p,r,u).done(function(b,c,d){k.after(c),k.after(b),k.after(d),m.attr("for",l.inputId),t(j,l,k);var e=a(document.getElementById(l.inputId)),f=a(document.getElementById(l.suggestionsId));f.hide().attr("aria-hidden",!0),j.ajax&&require([j.ajax],function(b){var c=function(a){s(a,j,l,k,b)};e.on("input keypress",c);var d=a(document.getElementById(l.downArrowId));d.on("click",c)}),q(j,l,k,!1)})}}});