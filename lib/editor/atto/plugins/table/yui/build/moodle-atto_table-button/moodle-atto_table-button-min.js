YUI.add("moodle-atto_table-button",function(e,t){M.atto_table=M.atto_table||{dialogue:null,selection:null,menunode:null,controlmenu:null,lasttarget:null,display_chooser:function(e,t){e.preventDefault(),M.editor_atto.is_active(t)||M.editor_atto.focus(t),M.atto_table.selection=M.editor_atto.get_selection();if(M.atto_table.selection!==!1&&!M.atto_table.selection.collapsed){var n;M.atto_table.dialogue?n=M.atto_table.dialogue:n=new M.core.dialogue({visible:!1,modal:!0,close:!0,draggable:!0}),n.render(),n.set("bodyContent",M.atto_table.get_form_content(t)),n.set("headerContent",M.util.get_string("createtable","atto_table")),n.show(),M.atto_table.dialogue=n}},show_menu:function(t,n){var r=!1;t.preventDefault();if(this.controlmenu===null){r=!0;var i="<ul>";i+='<li><a href="#" id="addcolumnafter">'+M.util.get_string("addcolumnafter","atto_table")+"</a></li>",i+='<li><a href="#" id="addrowafter">'+M.util.get_string("addrowafter","atto_table")+"</a></li>",i+='<li><a href="#" id="moverowup">'+M.util.get_string("moverowup","atto_table")+"</a></li>",i+='<li><a href="#" id="moverowdown">'+M.util.get_string("moverowdown","atto_table")+"</a></li>",i+='<li><a href="#" id="movecolumnleft">'+M.util.get_string("movecolumnleft","atto_table")+"</a></li>",i+='<li><a href="#" id="movecolumnright">'+M.util.get_string("movecolumnright","atto_table")+"</a></li>",i+='<li><a href="#" id="deleterow">'+M.util.get_string("deleterow","atto_table")+"</a></li>",i+='<li><a href="#" id="deletecolumn">'+M.util.get_string("deletecolumn","atto_table")+"</a></li>",i+="</ul>",this.controlmenu=new M.editor_atto.controlmenu({headerText:M.util.get_string("edittable","atto_table"),bodyContent:i})}this.lasttarget=t.target.ancestor("td, th"),this.controlmenu.show(),this.controlmenu.align(t.target,[e.WidgetPositionAlign.TL,e.WidgetPositionAlign.BL]);if(r){var s=this.controlmenu.get("boundingBox");s.delegate("click",this.handle_table_control,"a",this,n),s.delegate("key",this.handle_table_control,"down:enter,space","a",this,n)}},get_row_index:function(e){var t=e.ancestor("table"),n=e.ancestor("tr");if(!t||!n)return;var r=t.all("tr");return r.indexOf(n)},get_column_index:function(e){var t=e.ancestor("tr");if(!t)return;var n=t.all("td, th");return n.indexOf(e)},delete_row:function(e){var t=this.lasttarget.ancestor("tr");t&&t.one("td")&&t.remove(!0),M.editor_atto.text_updated(e)},move_row_up:function(e){var t=this.lasttarget.ancestor("tr"),n=t.previous("tr");if(!t||!n)return;t.swap(n),M.editor_atto.text_updated(e)},move_column_left:function(t){var n=this.get_column_index(this.lasttarget),r=this.lasttarget.ancestor("table").all("tr"),i=new e.NodeList,s=new e.NodeList,o=!1;r.each(function(e){var t=e.all("td, th"),r=t.item(n),u=t.item(n-1);i.push(r),u&&(u.get("tagName")==="TD"&&(o=!0),s.push(u))});if(o&&s.size()>0){var u=0;for(u=0;u<i.size();u++){var a=i.item(u),f=s.item(u);a.swap(f)}}M.editor_atto.text_updated(t)},move_column_right:function(t){var n=this.get_column_index(this.lasttarget),r=this.lasttarget.ancestor("table").all("tr"),i=new e.NodeList,s=new e.NodeList,o=!1;r.each(function(e){var t=e.all("td, th"),r=t.item(n),u=t.item(n+1);r.get("tagName")==="TD"&&(o=!0),i.push(r),u&&s.push(u)});if(o&&s.size()>0){var u=0;for(u=0;u<i.size();u++){var a=i.item(u),f=s.item(u);a.swap(f)}}M.editor_atto.text_updated(t)},move_row_down:function(e){var t=this.lasttarget.ancestor("tr"),n=t.next("tr");if(!t||!n)return;t.swap(n),M.editor_atto.text_updated(e)},delete_column:function(t){var n=this.get_column_index(this.lasttarget),r=this.lasttarget.ancestor("table").all("tr"),i=new e.NodeList,s=!1;r.each(function(e){var t=e.all("td, th"),r=t.item(n);r.get("tagName")==="TD"&&(s=!0),i.push(r)}),s&&i.remove(!0),M.editor_atto.text_updated(t)},add_row_after:function(t){var n=this.get_row_index(this.lasttarget),r=this.lasttarget.ancestor("table").one("tbody");r||(r=this.lasttarget.ancestor("table"),n+=1);var i=r.one("tr");i||(i=this.lasttarget.ancestor("table").one("tr"));if(!i)return;newrow=i.cloneNode(!0),newrow.all("th, td").each(function(t){if(t.get("tagName")==="TH"&&t.getAttribute("scope")!=="row"){var n=e.Node.create("<td></td>");t.replace(n),t=n}t.setHTML("&nbsp;")}),r.insert(newrow,n),M.editor_atto.text_updated(t)},add_column_after:function(t){var n=this.get_column_index(this.lasttarget),r=this.lasttarget.ancestor("table"),i=r.all("tr");e.each(i,function(e){var t=e.one("td, th").cloneNode(!0);t.setHTML("&nbsp;"),e.insert(t,n+1)},this),M.editor_atto.text_updated(t)},handle_table_control:function(e,t){e.preventDefault(),this.controlmenu.hide();switch(e.target.get("id")){case"addcolumnafter":this.add_column_after(t);break;case"addrowafter":this.add_row_after(t);break;case"deleterow":this.delete_row(t);break;case"deletecolumn":this.delete_column(t);break;case"moverowdown":this.move_row_down(t);break;case"moverowup":this.move_row_up(t);break;case"movecolumnleft":this.move_column_left(t);break;case"movecolumnright":this.move_column_right(t)}},init:function(t){if(!M.atto_table.menunode){var n=e.Node.create("<img/>");n.setAttrs({alt:M.util.get_string("edittable","atto_table"),src:M.util.image_url("t/contextmenu","core"),width:"12",height:"12"});var r=e.Node.create('<a href="#" contenteditable="false"/>');r.appendChild(n),r.addClass("atto_control"),M.atto_table.menunode=r}var i=M.util.image_url("e/table","core");M.editor_atto.add_toolbar_button(t.elementid,"table",i,t.group,this.display_chooser,this);var s=e.one("#"+t.elementid+"editable");s.delegate("click",this.show_menu,"td > .atto_control, th > .atto_control",this,t.elementid),s.delegate("key",this.show_menu,"down:enter,space","td > .atto_control, th > .atto_control",this,t.elementid),e.UA.gecko&&(document.execCommand("enableInlineTableEditing",!1,"false"),document.execCommand("enableObjectResizing",!1,!1)),this.insert_table_controls(t.elementid),M.editor_atto.add_text_updated_handler(t.elementid,this.insert_table_controls)},insert_table_controls:function(t){var n=e.one("#"+t+"editable"),r=n.all("td .atto_control,th .atto_control"
),i=n.all("td:last-child,th:last-child,tbody tr:last-child > td, tbody tr:last-child > th");r.each(function(e){i.indexOf(e)===-1&&e.remove(!0)}),i.each(function(e){e.one(".atto_control")||e.append(M.atto_table.menunode.cloneNode(!0))},this)},set_table:function(t,n){var r,i,s,o,u,a,f;t.preventDefault(),M.atto_table.dialogue.hide(),r=t.currentTarget.ancestor(".atto_form").one("#atto_table_caption"),i=t.currentTarget.ancestor(".atto_form").one("#atto_table_rows"),s=t.currentTarget.ancestor(".atto_form").one("#atto_table_columns"),o=t.currentTarget.ancestor(".atto_form").one("#atto_table_headers"),M.editor_atto.set_selection(M.atto_table.selection),u="<br/><table>",u+="<caption>"+e.Escape.html(r.get("value"))+"</caption>",a=0;if(o.get("value")==="columns"||o.get("value")==="both"){a=1,u+="<thead><tr>";for(f=0;f<parseInt(s.get("value"),10);f++)u+='<th scope="col"></th>';u+="</tr></thead>"}u+="<tbody>";for(;a<parseInt(i.get("value"),10);a++){u+="<tr>";for(f=0;f<parseInt(s.get("value"),10);f++)f!==0||o.get("value")!=="rows"&&o.get("value")!=="both"?u+="<td></td>":u+='<th scope="row"></th>';u+="</tr>"}u+="</tbody>",u+="</table><br/>",document.execCommand("insertHTML",!1,u),M.editor_atto.text_updated(n)},get_form_content:function(t){var n=e.Node.create('<form class="atto_form"><label for="atto_table_caption">'+M.util.get_string("caption","atto_table")+"</label>"+'<textarea id="atto_table_caption" rows="4" class="fullwidth" required></textarea>'+"<br/>"+'<label for="atto_table_headers" class="sameline">'+M.util.get_string("headers","atto_table")+"</label>"+'<select id="atto_table_headers">'+'<option value="columns">'+M.util.get_string("columns","atto_table")+"</option>"+'<option value="rows">'+M.util.get_string("rows","atto_table")+"</option>"+'<option value="both">'+M.util.get_string("both","atto_table")+"</option>"+"</select>"+"<br/>"+'<label for="atto_table_rows" class="sameline">'+M.util.get_string("numberofrows","atto_table")+"</label>"+'<input type="number" value="3" id="atto_table_rows" size="8" min="1" max="50"/>'+"<br/>"+'<label for="atto_table_columns" class="sameline">'+M.util.get_string("numberofcolumns","atto_table")+"</label>"+'<input type="number" value="3" id="atto_table_columns" size="8" min="1" max="20"/>'+"<br/>"+'<div class="mdl-align">'+"<br/>"+'<button id="atto_table_submit">'+M.util.get_string("createtable","atto_table")+"</button>"+"</div>"+"</form>"+"<hr/>"+M.util.get_string("accessibilityhint","atto_table"));return n.one("#atto_table_submit").on("click",M.atto_table.set_table,this,t),n}}},"@VERSION@",{requires:["node","escape","event","event-valuechange"]});
