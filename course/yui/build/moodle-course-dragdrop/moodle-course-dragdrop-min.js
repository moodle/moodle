YUI.add("moodle-course-dragdrop",function(p,e){var o,t,u=".actions",s="activity",r="content",f="course-content",l="editing_move",i="iconsmall",n="jumpmenu",a="left",c="movedown",d="moveup",g="page-content",m="right",h="section",_="section-handle",v="summary",w="sectiondraggable";M.course=M.course||{},o=function(){o.superclass.constructor.apply(this,arguments)},p.extend(o,M.core.dragdrop,{sectionlistselector:null,initializer:function(){if(this.groups=[w],this.samenodeclass=M.course.format.get_sectionwrapperclass(),this.parentnodeclass=M.course.format.get_containerclass(),p.Node.one("."+n))return!1;if(this.sectionlistselector=M.course.format.get_section_wrapper(p),this.sectionlistselector){this.sectionlistselector="."+f+" "+this.sectionlistselector,this.setup_for_section(this.sectionlistselector);var e=new p.DD.Delegate({container:"."+f,nodes:"."+w,target:!0,handles:["."+a],dragConfig:{groups:this.groups}});e.dd.plug(p.Plugin.DDProxy,{moveOnEnd:!1}),e.dd.plug(p.Plugin.DDConstrained,{constrain:"#"+g,stickY:!0}),e.dd.plug(p.Plugin.DDWinScroll)}},setup_for_section:function(e){p.Node.all(e).each(function(e){var o,t,s,r,i,n=p.Moodle.core_course.util.section.getId(e);0<n&&(o=e.one("."+m+" a."+c),t=e.one("."+m+" a."+d),s=M.util.get_string("movesection","moodle",n),r=e.one("."+a),(o||t)&&r&&(r.setStyle("cursor","move"),r.appendChild(this.get_drag_handle(s,_,"icon",!0)),t&&(t.previous("br")?t.previous("br").remove():t.next("br")&&t.next("br").remove(),t.ancestor(".section_action_menu")&&"li"==t.ancestor().get("nodeName").toLowerCase()?t.ancestor().remove():t.remove()),o&&(o.previous("br")?o.previous("br").remove():o.next("br")&&o.next("br").remove(),i=o.ancestor().get("nodeName").toLowerCase(),o.ancestor(".section_action_menu")&&"li"==i?o.ancestor().remove():o.remove()),e.addClass(w)))},this)},drag_start:function(e){var o,t,s=e.target,r=s.get("node"),i=s.get("dragNode");r!==i&&((o=p.Node.create("<"+M.course.format.get_containernode()+"></"+M.course.format.get_containernode()+">")).addClass(M.course.format.get_containerclass()),(t=p.Node.create("<"+M.course.format.get_sectionwrappernode()+"></"+M.course.format.get_sectionwrappernode()+">")).addClass(M.course.format.get_sectionwrapperclass()),t.setStyle("margin",0),t.setContent(r.get("innerHTML")),o.appendChild(t),i.setContent(o),i.addClass(f))},drag_dropmiss:function(e){this.drop_hit(e)},get_section_index:function(e){var o="."+f+" "+M.course.format.get_section_selector(p),t=p.all(o);return t.indexOf(e)-t.indexOf(p.one("#section-0"))},drop_hit:function(n){var a,c,e,o,t,s,r=n.drag,i=r.get("node"),d=p.Moodle.core_course.util.section.getId(i),u=d,l=this.get_section_index(i),g=l;if(d!==l){for(t in g<u&&(u=l,g=d),r.get("dragNode").removeClass(f),a=p.Node.all(this.sectionlistselector),c=M.util.add_lightbox(p,i),e={},o=this.get("config").pageparams)o.hasOwnProperty(t)&&(e[t]=o[t]);e.sesskey=M.cfg.sesskey,e.courseId=this.get("courseid"),e["class"]="section",e.field="move",e.id=d,e.value=l,s=M.cfg.wwwroot+this.get("ajaxurl"),p.io(s,{method:"POST",data:e,on:{start:function(){c.show()},success:function(e,o){var t,s,r,i;try{(t=p.JSON.parse(o.responseText)).error&&new M.core.ajaxException(t),M.course.format.process_sections(p,a,t,u,g)}catch(n){}r=!1;do{for(r=!1,s=u;s<=g;s++)p.Moodle.core_course.util.section.getId(a.item(s-1))>p.Moodle.core_course.util.section.getId(a.item(s))&&(i=a.item(s-1).get("id"),a.item(s-1).set("id",a.item(s).get("id")),a.item(s).set("id",i),M.course.format.swap_sections(p,s-1,s),r=!0);g-=1}while(r);window.setTimeout(function(){c.hide()},250)},failure:function(e,o){this.ajax_failure(o),c.hide()}},context:this})}}},{NAME:"course-dragdrop-section",ATTRS:{courseid:{value:null},ajaxurl:{value:0},config:{value:0}}}),M.course=M.course||{},M.course.init_section_dragdrop=function(e){new o(e)},t=function(){t.superclass.constructor.apply(this,arguments)},p.extend(t,M.core.dragdrop,{initializer:function(){var e,o,t;this.groups=["resource"],this.samenodeclass=s,this.parentnodeclass=h,this.samenodelabel={identifier:"afterresource",component:"moodle"},this.parentnodelabel={identifier:"totopofsection",component:"moodle"},(e=M.course.format.get_section_selector(p))&&(e="."+f+" "+e,this.setup_for_section(e),o=e.slice(f.length+2)+" li."+s,(t=new p.DD.Delegate({container:"."+f,nodes:o,target:!0,handles:["."+l],dragConfig:{groups:this.groups}})).dd.plug(p.Plugin.DDProxy,{moveOnEnd:!1,cloneNode:!0}),t.dd.plug(p.Plugin.DDConstrained,{constrain:"#"+g}),t.dd.plug(p.Plugin.DDWinScroll),M.course.coursebase.register_module(this),M.course.dragres=this)},setup_for_section:function(e){p.Node.all(e).each(function(e){var o=e.one("."+r+" ul."+h);o||((o=p.Node.create("<ul></ul>")).addClass(h),e.one("."+r+" div."+v).insert(o,"after")),o.setAttribute("data-draggroups",this.groups.join(" ")),new p.DD.Drop({node:o,groups:this.groups,padding:"20 0 20 0"}),this.setup_for_resource("#"+e.get("id")+" li."+s)},this)},setup_for_resource:function(e){p.Node.all(e).each(function(e){var o,t,s=e.getData("draggroups");s||(e.setAttribute("data-draggroups",this.groups.join(" ")),new p.DD.Drop({node:e,groups:this.groups,padding:"20 0 20 0"})),(o=e.one("a."+l))&&(t=o.getData("sectionreturn"),o.replace(this.get_drag_handle(M.util.get_string("movecoursemodule","moodle"),l,i,!0).setAttribute("data-sectionreturn",t)))},this)},drag_start:function(e){var o=e.target;o.get("dragNode")!==o.get("node")&&(o.get("dragNode").setContent(o.get("node").get("innerHTML")),o.get("dragNode").all("img.iconsmall").setStyle("vertical-align","baseline"))},drag_dropmiss:function(e){this.drop_hit(e)},drop_hit:function(e){var o,t,r=e.drag,i=r.get("node"),s=e.drop.get("node"),n=i.one(u),a=M.util.add_spinner(p,n),c={},d=this.get("config").pageparams;for(o in d)c[o]=d[o];c.sesskey=M.cfg.sesskey,c.courseId=this.get("courseid"),c["class"]="resource",c.field="move",c.id=Number(p.Moodle.core_course.util.cm.getId(i)),c.sectionId=p.Moodle.core_course.util.section.getId(s.ancestor(M.course.format.get_section_wrapper(p),!0)),
i.next()&&(c.beforeId=Number(p.Moodle.core_course.util.cm.getId(i.next()))),t=M.cfg.wwwroot+this.get("ajaxurl"),p.io(t,{method:"POST",data:c,on:{start:function(){this.lock_drag_handle(r,l),a.show()},success:function(e,o){var t=p.JSON.parse(o.responseText),s={element:i,visible:t.visible};M.course.coursebase.invoke_function("set_visibility_resource_ui",s),this.unlock_drag_handle(r,l),window.setTimeout(function(){a.hide()},250)},failure:function(e,o){this.ajax_failure(o),this.unlock_drag_handle(r,_),a.hide()}},context:this})}},{NAME:"course-dragdrop-resource",ATTRS:{courseid:{value:null},ajaxurl:{value:0},config:{value:0}}}),M.course=M.course||{},M.course.init_resource_dragdrop=function(e){new t(e)}},"@VERSION@",{requires:["base","node","io","dom","dd","dd-scroll","moodle-core-dragdrop","moodle-core-notification","moodle-course-coursebase","moodle-course-util"]});