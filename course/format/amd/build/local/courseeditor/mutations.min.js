define("core_courseformat/local/courseeditor/mutations",["exports","core/ajax"],(function(_exports,_ajax){var obj;function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_ajax=(obj=_ajax)&&obj.__esModule?obj:{default:obj};
/**
   * Default mutation manager
   *
   * @module     core_courseformat/local/courseeditor/mutations
   * @class     core_courseformat/local/courseeditor/mutations
   * @copyright  2021 Ferran Recio <ferran@moodle.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */
var _default=function(){function _default(){!function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,_default)}var Constructor,protoProps,staticProps,_courseState,_sectionState,_cmState,_sectionPreferences,_sectionDelete,_addSection,_sectionMove,_cmMove,_callEditWebservice2;return Constructor=_default,protoProps=[{key:"_callEditWebservice",value:(_callEditWebservice2=_asyncToGenerator(regeneratorRuntime.mark((function _callee(action,courseId,ids,targetSectionId,targetCmId){var args,ajaxresult;return regeneratorRuntime.wrap((function(_context){for(;;)switch(_context.prev=_context.next){case 0:return args={action:action,courseid:courseId,ids:ids},targetSectionId&&(args.targetsectionid=targetSectionId),targetCmId&&(args.targetcmid=targetCmId),_context.next=5,_ajax.default.call([{methodname:"core_courseformat_update_course",args:args}])[0];case 5:return ajaxresult=_context.sent,_context.abrupt("return",JSON.parse(ajaxresult));case 7:case"end":return _context.stop()}}),_callee)}))),function(_x,_x2,_x3,_x4,_x5){return _callEditWebservice2.apply(this,arguments)})},{key:"init",value:function(stateManager){stateManager.addUpdateTypes({prepareFields:this._prepareFields})}},{key:"_prepareFields",value:function(stateManager,updateName,fields){return fields.locked=!1,fields}},{key:"cmMove",value:(_cmMove=_asyncToGenerator(regeneratorRuntime.mark((function _callee2(stateManager,cmids,targetSectionId,targetCmId){var course,updates;return regeneratorRuntime.wrap((function(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:if(targetSectionId||targetCmId){_context2.next=2;break}throw new Error("Mutation cmMove requires targetSectionId or targetCmId");case 2:return course=stateManager.get("course"),this.cmLock(stateManager,cmids,!0),_context2.next=6,this._callEditWebservice("cm_move",course.id,cmids,targetSectionId,targetCmId);case 6:updates=_context2.sent,stateManager.processUpdates(updates),this.cmLock(stateManager,cmids,!1);case 9:case"end":return _context2.stop()}}),_callee2,this)}))),function(_x6,_x7,_x8,_x9){return _cmMove.apply(this,arguments)})},{key:"sectionMove",value:(_sectionMove=_asyncToGenerator(regeneratorRuntime.mark((function _callee3(stateManager,sectionIds,targetSectionId){var course,updates;return regeneratorRuntime.wrap((function(_context3){for(;;)switch(_context3.prev=_context3.next){case 0:if(targetSectionId){_context3.next=2;break}throw new Error("Mutation sectionMove requires targetSectionId");case 2:return course=stateManager.get("course"),this.sectionLock(stateManager,sectionIds,!0),_context3.next=6,this._callEditWebservice("section_move",course.id,sectionIds,targetSectionId);case 6:updates=_context3.sent,stateManager.processUpdates(updates),this.sectionLock(stateManager,sectionIds,!1);case 9:case"end":return _context3.stop()}}),_callee3,this)}))),function(_x10,_x11,_x12){return _sectionMove.apply(this,arguments)})},{key:"addSection",value:(_addSection=_asyncToGenerator(regeneratorRuntime.mark((function _callee4(stateManager,targetSectionId){var course,updates;return regeneratorRuntime.wrap((function(_context4){for(;;)switch(_context4.prev=_context4.next){case 0:return targetSectionId||(targetSectionId=0),course=stateManager.get("course"),_context4.next=4,this._callEditWebservice("section_add",course.id,[],targetSectionId);case 4:updates=_context4.sent,stateManager.processUpdates(updates);case 6:case"end":return _context4.stop()}}),_callee4,this)}))),function(_x13,_x14){return _addSection.apply(this,arguments)})},{key:"sectionDelete",value:(_sectionDelete=_asyncToGenerator(regeneratorRuntime.mark((function _callee5(stateManager,sectionIds){var course,updates;return regeneratorRuntime.wrap((function(_context5){for(;;)switch(_context5.prev=_context5.next){case 0:return course=stateManager.get("course"),_context5.next=3,this._callEditWebservice("section_delete",course.id,sectionIds);case 3:updates=_context5.sent,stateManager.processUpdates(updates);case 5:case"end":return _context5.stop()}}),_callee5,this)}))),function(_x15,_x16){return _sectionDelete.apply(this,arguments)})},{key:"cmDrag",value:function(stateManager,cmIds,dragValue){this.setPageItem(stateManager),this._setElementsValue(stateManager,"cm",cmIds,"dragging",dragValue)}},{key:"sectionDrag",value:function(stateManager,sectionIds,dragValue){this.setPageItem(stateManager),this._setElementsValue(stateManager,"section",sectionIds,"dragging",dragValue)}},{key:"cmCompletion",value:function(stateManager,cmIds,complete){var newValue=complete?1:0;this._setElementsValue(stateManager,"cm",cmIds,"completionstate",newValue)}},{key:"cmLock",value:function(stateManager,cmIds,lockValue){this._setElementsValue(stateManager,"cm",cmIds,"locked",lockValue)}},{key:"sectionLock",value:function(stateManager,sectionIds,lockValue){this._setElementsValue(stateManager,"section",sectionIds,"locked",lockValue)}},{key:"_setElementsValue",value:function(stateManager,name,ids,fieldName,newValue){stateManager.setReadOnly(!1),ids.forEach((function(id){var element=stateManager.get(name,id);element&&(element[fieldName]=newValue)})),stateManager.setReadOnly(!0)}},{key:"setPageItem",value:function(stateManager,type,id,isStatic){var newPageItem;if(void 0===type||(newPageItem=stateManager.get(type,id))){stateManager.setReadOnly(!1);var course=stateManager.get("course");course.pageItem=null,newPageItem&&(course.pageItem={id:id,type:type,sectionId:"section"==type?newPageItem.id:newPageItem.sectionid,isStatic:isStatic}),stateManager.setReadOnly(!0)}}},{key:"unlockAll",value:function(stateManager){var state=stateManager.state;stateManager.setReadOnly(!1),state.section.forEach((function(section){section.locked=!1})),state.cm.forEach((function(cm){cm.locked=!1})),stateManager.setReadOnly(!0)}},{key:"sectionPreferences",value:(_sectionPreferences=_asyncToGenerator(regeneratorRuntime.mark((function _callee6(stateManager,sectionIds,preferences){var updatePreferences,course,state,prefKey,_preferences,jsonString;return regeneratorRuntime.wrap((function(_context6){for(;;)switch(_context6.prev=_context6.next){case 0:stateManager.setReadOnly(!1),updatePreferences=!1,sectionIds.forEach((function(sectionId){var _preferences$contentc,_preferences$indexcol,section=stateManager.get("section",sectionId);if(void 0!==section){var newValue=null!==(_preferences$contentc=preferences.contentcollapsed)&&void 0!==_preferences$contentc?_preferences$contentc:section.contentcollapsed;section.contentcollapsed!=newValue&&(section.contentcollapsed=newValue,updatePreferences=!0),newValue=null!==(_preferences$indexcol=preferences.indexcollapsed)&&void 0!==_preferences$indexcol?_preferences$indexcol:section.indexcollapsed,section.indexcollapsed!=newValue&&(section.indexcollapsed=newValue,updatePreferences=!0)}})),stateManager.setReadOnly(!0),updatePreferences&&(course=stateManager.get("course"),state=stateManager.state,prefKey="coursesectionspreferences_".concat(course.id),_preferences={contentcollapsed:[],indexcollapsed:[]},state.section.forEach((function(section){section.contentcollapsed&&_preferences.contentcollapsed.push(section.id),section.indexcollapsed&&_preferences.indexcollapsed.push(section.id)})),jsonString=JSON.stringify(_preferences),M.util.set_user_preference(prefKey,jsonString));case 5:case"end":return _context6.stop()}}),_callee6)}))),function(_x17,_x18,_x19){return _sectionPreferences.apply(this,arguments)})},{key:"cmState",value:(_cmState=_asyncToGenerator(regeneratorRuntime.mark((function _callee7(stateManager,cmids){var course,updates;return regeneratorRuntime.wrap((function(_context7){for(;;)switch(_context7.prev=_context7.next){case 0:return this.cmLock(stateManager,cmids,!0),course=stateManager.get("course"),_context7.next=4,this._callEditWebservice("cm_state",course.id,cmids);case 4:updates=_context7.sent,stateManager.processUpdates(updates),this.cmLock(stateManager,cmids,!1);case 7:case"end":return _context7.stop()}}),_callee7,this)}))),function(_x20,_x21){return _cmState.apply(this,arguments)})},{key:"sectionState",value:(_sectionState=_asyncToGenerator(regeneratorRuntime.mark((function _callee8(stateManager,sectionIds){var course,updates;return regeneratorRuntime.wrap((function(_context8){for(;;)switch(_context8.prev=_context8.next){case 0:return this.sectionLock(stateManager,sectionIds,!0),course=stateManager.get("course"),_context8.next=4,this._callEditWebservice("section_state",course.id,sectionIds);case 4:updates=_context8.sent,stateManager.processUpdates(updates),this.sectionLock(stateManager,sectionIds,!1);case 7:case"end":return _context8.stop()}}),_callee8,this)}))),function(_x22,_x23){return _sectionState.apply(this,arguments)})},{key:"courseState",value:(_courseState=_asyncToGenerator(regeneratorRuntime.mark((function _callee9(stateManager){var course,updates;return regeneratorRuntime.wrap((function(_context9){for(;;)switch(_context9.prev=_context9.next){case 0:return course=stateManager.get("course"),_context9.next=3,this._callEditWebservice("course_state",course.id);case 3:updates=_context9.sent,stateManager.processUpdates(updates);case 5:case"end":return _context9.stop()}}),_callee9,this)}))),function(_x24){return _courseState.apply(this,arguments)})}],protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),_default}();return _exports.default=_default,_exports.default}));

//# sourceMappingURL=mutations.min.js.map