{"version":3,"sources":["../src/tool_endpoints.js"],"names":["SELECTORS","GENERATE_REGISTRATION_URL_BUTTON","REGISTRATION_URL_TABLE","URL_VALUE","URL_INFO","URL_COPY_TO_CLIPBOARD","URL_DELETE","removeRegistrationURL","key","component","then","deletedStr","document","querySelector","classList","add","createURLButton","setAttribute","removeAttribute","remove","title","value","innerHTML","focus","catch","Notification","exception","createAndDisplayRegistrationURL","generateButton","Promise","all","Ajax","call","methodname","args","generateSuccessStr","cannotGenerateStr","urlObject","url","expirystring","showDeleteModal","ModalFactory","create","type","types","SAVE_CANCEL","large","body","modal","setSaveButtonText","getRoot","on","ModalEvents","save","promises","result","status","hidden","destroy","show","generateRegistrationURLHandler","event","triggerElement","target","closest","preventDefault","getAttribute","focusURLHandler","select","deleteClickHandler","init","addEventListener"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n/**\n * Module supporting the dynamic and manual registration tabs in the tool registration admin setting.\n *\n * @module     enrol_lti/tool_endpoints\n * @copyright  2021 Jake Dallimore <jrhdallimore@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport {add as toastNotice} from 'core/toast';\nimport Ajax from 'core/ajax';\nimport Notification from 'core/notification';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport {get_string as getString} from 'core/str';\nimport {get_strings as getStrings} from 'core/str';\nimport {prefetchStrings} from 'core/prefetch';\nimport 'core/copy_to_clipboard';\n\n/**\n * DOM Selectors.\n * @type {{GENERATE_REGISTRATION_URL_BUTTON: string, URL_COPY_TO_CLIPBOARD: string, URL_VALUE: string,\n *       REGISTRATION_URL_TABLE: string, URL_DELETE: string, URL_INFO: string}}\n */\nconst SELECTORS = {\n    GENERATE_REGISTRATION_URL_BUTTON: '[id^=\"lti_generate_registration_url\"]',\n    REGISTRATION_URL_TABLE: '[id^=\"lti_registration_url_table_\"]',\n    URL_VALUE: '[id^=\"lti_tool_endpoint_url_\"]',\n    URL_INFO: '[id^=\"lti_tool_endpoint_info_\"]',\n    URL_COPY_TO_CLIPBOARD: '[data-action=\"copytoclipboard\"]',\n    URL_DELETE: '[data-action=\"delete\"]'\n};\n\n/**\n * Remove the registration URL from the DOM, restoring the button used to create a URL in the process.\n */\nconst removeRegistrationURL = () => {\n    getStrings([\n        {key: 'registrationurldeleted', component: 'enrol_lti'}\n    ])\n    .then((deletedStr) => {\n        document.querySelector(SELECTORS.REGISTRATION_URL_TABLE).classList.add('hidden');\n        let createURLButton = document.querySelector(SELECTORS.GENERATE_REGISTRATION_URL_BUTTON);\n        createURLButton.setAttribute('aria-disabled', 'false');\n        createURLButton.removeAttribute('aria-label');\n        createURLButton.classList.remove('disabled');\n        createURLButton.title = '';\n        document.querySelector(SELECTORS.URL_VALUE).value = '';\n        document.querySelector(SELECTORS.URL_INFO).innerHTML = '';\n        createURLButton.focus();\n\n        // Let the user know the URL was deleted.\n        toastNotice(deletedStr);\n        return;\n    })\n    .catch(Notification.exception);\n};\n\n/**\n * Create and display the registration URL component in the DOM.\n *\n * @param {HTMLElement} generateButton the button responsible for generating the URL, which will be disabled once a URL is created.\n */\nconst createAndDisplayRegistrationURL = (generateButton) => {\n    let requests = [\n        {methodname: 'enrol_lti_get_lti_advantage_registration_url', args: {'createifmissing': true}},\n    ];\n    Promise.all([\n        getStrings([\n            {key: 'registrationurlgeneratesuccess', component: 'enrol_lti'},\n            {key: 'registrationurlcannotgenerate', component: 'enrol_lti'}\n        ]),\n        Ajax.call(requests)[0]\n    ])\n    .then(([[generateSuccessStr, cannotGenerateStr], urlObject]) => {\n        document.querySelector(SELECTORS.URL_VALUE).value = urlObject.url;\n        document.querySelector(SELECTORS.URL_INFO).innerHTML = urlObject.expirystring;\n        document.querySelector(SELECTORS.REGISTRATION_URL_TABLE).classList.remove('hidden');\n        generateButton.setAttribute('aria-disabled', 'true');\n        generateButton.classList.add('disabled');\n        generateButton.title = cannotGenerateStr;\n        generateButton.setAttribute('aria-label', cannotGenerateStr);\n\n        toastNotice(generateSuccessStr);\n        return;\n    })\n    .catch(Notification.exception);\n};\n\n/**\n * Display a delete confirmation modal.\n *\n * @returns {Promise}\n */\nconst showDeleteModal = () => {\n\n    return ModalFactory.create({\n        type: ModalFactory.types.SAVE_CANCEL,\n        large: false,\n        title: getString('registrationurldeletetitle', 'enrol_lti'),\n        body: getString('registrationurldeletebody', 'enrol_lti')\n    })\n    .then(modal => {\n        modal.setSaveButtonText(getString('registrationurldeleteconfirm', 'enrol_lti'));\n\n        modal.getRoot().on(ModalEvents.save, () => {\n            let requests = [\n                {methodname: 'enrol_lti_delete_lti_advantage_registration_url', args: []},\n            ];\n            let promises = Ajax.call(requests);\n\n            promises[0].then((result) => {\n                if (result.status === true) {\n                    removeRegistrationURL();\n                }\n                return;\n            }).catch(Notification.exception);\n        });\n\n        modal.getRoot().on(ModalEvents.hidden, function() {\n            modal.destroy();\n        });\n\n        return modal.show();\n    })\n    .catch(Notification.exception);\n};\n\n/**\n * Click handler which generates a registration URL and updates the DOM.\n *\n * @param {Event} event a click event.\n */\nconst generateRegistrationURLHandler = (event) => {\n    const triggerElement = event.target.closest(SELECTORS.GENERATE_REGISTRATION_URL_BUTTON);\n    if (triggerElement === null) {\n        return;\n    }\n    event.preventDefault();\n\n    if (event.target.getAttribute('aria-disabled') == \"true\") {\n        return;\n    }\n\n    createAndDisplayRegistrationURL(event.target);\n};\n\n/**\n * Focus handler for the registration URL field, enabling auto select of text on click.\n *\n * @param {Event} event a click event.\n */\nconst focusURLHandler = (event) => {\n    const triggerElement = event.target.closest(SELECTORS.URL_VALUE);\n    if (triggerElement === null) {\n        return;\n    }\n    event.preventDefault();\n\n    triggerElement.select();\n};\n\n/**\n * Click handler which generates a user confirmation modal during URL deletion.\n *\n * @param {Event} event a click event.\n */\nconst deleteClickHandler = (event) => {\n    const triggerElement = event.target.closest(SELECTORS.URL_DELETE);\n    if (triggerElement === null) {\n        return;\n    }\n    event.preventDefault();\n\n    showDeleteModal();\n};\n\n/**\n * Initialise the tool registration page, attaching handlers, prefetching strings, etc.\n */\nexport const init = () => {\n    prefetchStrings('enrol_lti', [\n        'registrationurldeletetitle',\n        'registrationurldeletebody',\n        'registrationurldeleteconfirm',\n        'registrationurlgenerate',\n        'registrationurldeleted',\n        'registrationurlgeneratesuccess',\n        'registrationurlcannotgenerate'\n    ]);\n\n    // Event capturing supporting the select on focus behaviour (with text selection permitted on subsequent clicks).\n    document.addEventListener('focusin', focusURLHandler);\n\n    // And delegation for deleting the URL.\n    document.addEventListener('click', deleteClickHandler);\n\n    // And delegation for creating a new registration URL.\n    document.addEventListener('click', generateRegistrationURLHandler);\n};\n"],"file":"tool_endpoints.min.js"}