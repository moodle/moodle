{"version":3,"file":"collapsesections.min.js","sources":["../src/collapsesections.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Collapse or expand all form sections on clicking the expand all / collapse al link.\r\n *\r\n * @module core_form/collapsesections\r\n * @copyright 2021 Bas Brands\r\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n * @since 4.0\r\n */\r\n\r\nimport Collapse from 'theme_boost/bootstrap/collapse';\r\nimport Pending from 'core/pending';\r\n\r\nconst SELECTORS = {\r\n    FORM: '.mform',\r\n    FORMHEADER: '.fheader',\r\n    FORMCONTAINER: 'fieldset > .fcontainer',\r\n};\r\n\r\nconst CLASSES = {\r\n    SHOW: 'show',\r\n    COLLAPSED: 'collapsed',\r\n    HIDDEN: 'd-none'\r\n};\r\n\r\n/**\r\n * Initialises the form section collapse / expand action.\r\n *\r\n * @param {string} collapsesections the collapse/expand link id.\r\n */\r\nexport const init = collapsesections => {\r\n    const pendingPromise = new Pending('core_form/collapsesections');\r\n    const collapsemenu = document.querySelector(collapsesections);\r\n\r\n    const formParent = collapsemenu.closest(SELECTORS.FORM);\r\n    const formContainers = formParent.querySelectorAll(SELECTORS.FORMCONTAINER);\r\n    [...formContainers].map(formContainer => new Collapse(formContainer, {toggle: false}));\r\n\r\n    collapsemenu.addEventListener('keydown', e => {\r\n        if (e.key === 'Enter' || e.key === ' ') {\r\n            e.preventDefault();\r\n            collapsemenu.click();\r\n        }\r\n    });\r\n\r\n    // Override default collapse class if all visible containers are expanded on page load\r\n    let formcontainercount = 0;\r\n    let expandedcount = 0;\r\n    formContainers.forEach(container => {\r\n        const parentFieldset = container.parentElement;\r\n        if (!parentFieldset.classList.contains(CLASSES.HIDDEN)) {\r\n            formcontainercount++;\r\n        }\r\n        if (container.classList.contains(CLASSES.SHOW)) {\r\n            expandedcount++;\r\n        }\r\n    });\r\n\r\n    if (formcontainercount === expandedcount) {\r\n        collapsemenu.classList.remove(CLASSES.COLLAPSED);\r\n        collapsemenu.setAttribute('aria-expanded', true);\r\n    }\r\n\r\n    // When the collapse menu is toggled, update each form container to match.\r\n    collapsemenu.addEventListener('click', () => {\r\n        if (collapsemenu.classList.contains(CLASSES.COLLAPSED)) {\r\n            const pendingPromiseToggle = new Pending('core_form/collapsesections:toggle-on');\r\n            formContainers.forEach((container, index, array) => {\r\n                Collapse.getInstance(container).show();\r\n                if (index === array.length - 1) {\r\n                    pendingPromiseToggle.resolve();\r\n                }\r\n            });\r\n        } else {\r\n            const pendingPromiseToggle = new Pending('core_form/collapsesections:toggle-off');\r\n            formContainers.forEach((container, index, array) => {\r\n                Collapse.getInstance(container).hide();\r\n                if (index === array.length - 1) {\r\n                    pendingPromiseToggle.resolve();\r\n                }\r\n            });\r\n        }\r\n    });\r\n\r\n    // Ensure collapse menu button adds aria-controls attribute referring to each collapsible element.\r\n    const collapseElements = formParent.querySelectorAll(SELECTORS.FORMHEADER);\r\n    const collapseElementIds = [...collapseElements].map((element, index) => {\r\n        element.id = element.id || `collapseElement-${index}`;\r\n        return element.id;\r\n    });\r\n    collapsemenu.setAttribute('aria-controls', collapseElementIds.join(' '));\r\n\r\n    // When any form container is toggled, re-calculate collapse menu state.\r\n    const collapseTriggerList = document.querySelectorAll(SELECTORS.FORMCONTAINER);\r\n    [...collapseTriggerList].forEach(collapseTriggerEl => {\r\n        collapseTriggerEl.addEventListener('hidden.bs.collapse', () => {\r\n            const allCollapsed = [...formContainers].every(container => !container.classList.contains(CLASSES.SHOW));\r\n            if (allCollapsed) {\r\n                collapsemenu.classList.add(CLASSES.COLLAPSED);\r\n                collapsemenu.setAttribute('aria-expanded', false);\r\n            }\r\n        });\r\n        collapseTriggerEl.addEventListener('shown.bs.collapse', () => {\r\n            const allExpanded = [...formContainers].every(container => container.classList.contains(CLASSES.SHOW));\r\n            if (allExpanded) {\r\n                collapsemenu.classList.remove(CLASSES.COLLAPSED);\r\n                collapsemenu.setAttribute('aria-expanded', true);\r\n            }\r\n        });\r\n    });\r\n    pendingPromise.resolve();\r\n};\r\n"],"names":["SELECTORS","CLASSES","collapsesections","pendingPromise","Pending","collapsemenu","document","querySelector","formParent","closest","formContainers","querySelectorAll","map","formContainer","Collapse","toggle","addEventListener","e","key","preventDefault","click","formcontainercount","expandedcount","forEach","container","parentElement","classList","contains","remove","setAttribute","pendingPromiseToggle","index","array","getInstance","show","length","resolve","hide","collapseElementIds","element","id","join","collapseTriggerEl","every","add"],"mappings":";;;;;;;;8KA2BMA,eACI,SADJA,qBAEU,WAFVA,wBAGa,yBAGbC,aACI,OADJA,kBAES,YAFTA,eAGM,uBAQQC,yBACVC,eAAiB,IAAIC,iBAAQ,8BAC7BC,aAAeC,SAASC,cAAcL,kBAEtCM,WAAaH,aAAaI,QAAQT,gBAClCU,eAAiBF,WAAWG,iBAAiBX,6BAC/CU,gBAAgBE,KAAIC,eAAiB,IAAIC,kBAASD,cAAe,CAACE,QAAQ,MAE9EV,aAAaW,iBAAiB,WAAWC,IACvB,UAAVA,EAAEC,KAA6B,MAAVD,EAAEC,MACvBD,EAAEE,iBACFd,aAAae,gBAKjBC,mBAAqB,EACrBC,cAAgB,EACpBZ,eAAea,SAAQC,YACIA,UAAUC,cACbC,UAAUC,SAAS1B,iBACnCoB,qBAEAG,UAAUE,UAAUC,SAAS1B,eAC7BqB,mBAIJD,qBAAuBC,gBACvBjB,aAAaqB,UAAUE,OAAO3B,mBAC9BI,aAAawB,aAAa,iBAAiB,IAI/CxB,aAAaW,iBAAiB,SAAS,QAC/BX,aAAaqB,UAAUC,SAAS1B,mBAAoB,OAC9C6B,qBAAuB,IAAI1B,iBAAQ,wCACzCM,eAAea,SAAQ,CAACC,UAAWO,MAAOC,2BAC7BC,YAAYT,WAAWU,OAC5BH,QAAUC,MAAMG,OAAS,GACzBL,qBAAqBM,iBAG1B,OACGN,qBAAuB,IAAI1B,iBAAQ,yCACzCM,eAAea,SAAQ,CAACC,UAAWO,MAAOC,2BAC7BC,YAAYT,WAAWa,OAC5BN,QAAUC,MAAMG,OAAS,GACzBL,qBAAqBM,uBAQ/BE,mBAAqB,IADF9B,WAAWG,iBAAiBX,uBACJY,KAAI,CAAC2B,QAASR,SAC3DQ,QAAQC,GAAKD,QAAQC,8BAAyBT,OACvCQ,QAAQC,MAEnBnC,aAAawB,aAAa,gBAAiBS,mBAAmBG,KAAK,UAGvCnC,SAASK,iBAAiBX,0BAC7BuB,SAAQmB,oBAC7BA,kBAAkB1B,iBAAiB,sBAAsB,KAChC,IAAIN,gBAAgBiC,OAAMnB,YAAcA,UAAUE,UAAUC,SAAS1B,kBAEtFI,aAAaqB,UAAUkB,IAAI3C,mBAC3BI,aAAawB,aAAa,iBAAiB,OAGnDa,kBAAkB1B,iBAAiB,qBAAqB,KAChC,IAAIN,gBAAgBiC,OAAMnB,WAAaA,UAAUE,UAAUC,SAAS1B,kBAEpFI,aAAaqB,UAAUE,OAAO3B,mBAC9BI,aAAawB,aAAa,iBAAiB,UAIvD1B,eAAeiC"}