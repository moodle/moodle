{"version":3,"file":"embedthumbnailpreview.min.js","sources":["../../src/embed/embedthumbnailpreview.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Tiny media plugin embed thumbnail preview class.\r\n *\r\n * This handles:\r\n * - Embed thumbnail preview.\r\n * - Delete thumbnail preview.\r\n * - Update the embed preview details with new thumbnail.\r\n *\r\n * @module      tiny_media/embed/mediathumbnail\r\n * @copyright   2024 Stevani Andolo <stevani@hotmail.com.au>\r\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport Selectors from '../selectors';\r\nimport {getString} from 'core/str';\r\nimport {\r\n    sourceTypeChecked,\r\n    setPropertiesFromData,\r\n    showElements,\r\n    stopMediaLoading,\r\n} from '../helpers';\r\nimport Notification from 'core/notification';\r\nimport {EmbedPreview} from './embedpreview';\r\nimport {mediaDetailsTemplateContext} from './embedhelpers';\r\nimport {EmbedHandler} from './embedhandler';\r\nimport {component} from '../common';\r\n\r\nexport class EmbedThumbnailPreview {\r\n\r\n    constructor(data) {\r\n        setPropertiesFromData(this, data); // Creates dynamic properties based on \"data\" param.\r\n    }\r\n\r\n    /**\r\n     * Init the media thumbnail preview.\r\n     *\r\n     * @param {object} mediaData Object of selected media data\r\n     */\r\n    init = (mediaData) => {\r\n        this.mediaData = mediaData;\r\n        this.currentModal.uploadThumbnailModal.setTitle(getString('thumbnail', component));\r\n        sourceTypeChecked({\r\n            source: this.media.poster,\r\n            root: this.thumbnailModalRoot,\r\n            fileNameSelector: Selectors.EMBED.elements.fileNameLabel,\r\n        });\r\n        this.setThumbnailSource();\r\n        this.registerMediaThumbnailEventListeners();\r\n    };\r\n\r\n    /**\r\n     * Sets media thumbnail source.\r\n     */\r\n    setThumbnailSource = () => {\r\n        const thumbnailPreview = this.thumbnailModalRoot.querySelector(Selectors.EMBED.elements.thumbnailPreview);\r\n        thumbnailPreview.src = this.media.poster;\r\n\r\n        thumbnailPreview.addEventListener('error', async() => {\r\n            // Show warning notification.\r\n            const urlWarningLabelEle = this.thumbnailModalRoot.querySelector(Selectors.EMBED.elements.urlWarning);\r\n            urlWarningLabelEle.innerHTML = await getString('imageurlrequired', component);\r\n            showElements(Selectors.EMBED.elements.urlWarning, this.thumbnailModalRoot);\r\n\r\n            // Stop the spinner.\r\n            stopMediaLoading(this.thumbnailModalRoot, Selectors.EMBED.type);\r\n\r\n            // Reset the upload form.\r\n            (new EmbedHandler(this)).resetUploadForm(false);\r\n        });\r\n\r\n        thumbnailPreview.addEventListener('load', () => {\r\n            this.mediaData.media.poster = this.media.poster;\r\n            this.media = this.mediaData.media;\r\n            stopMediaLoading(this.thumbnailModalRoot, Selectors.EMBED.type);\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Deletes the media after confirming with the user and loads the insert media page.\r\n     */\r\n    deleteMedia = () => {\r\n        Notification.deleteCancelPromise(\r\n            getString('deletemediathumbnail', component),\r\n            getString('deletemediathumbnailwarning', component)\r\n        ).then(() => {\r\n            (new EmbedHandler(this)).resetUploadForm(false);\r\n            return;\r\n        }).catch(() => {\r\n            // User cancelled the delete action.\r\n            return;\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Loads and displays a media preview with thumbnail.\r\n     */\r\n    loadPreviewMediaThumbnail = async() => {\r\n        (new EmbedHandler(this)).loadMediaDetails(new EmbedPreview(this), await mediaDetailsTemplateContext(this))\r\n        .then(() => {\r\n            // Close the thumbnail upload modal once media details have been loaded.\r\n            this.currentModal.uploadThumbnailModal.destroy();\r\n            const currentModal = this.currentModal.insertMediaModal;\r\n            this.currentModal = currentModal.insertMediaModal;\r\n            delete this.mediaData;\r\n            return;\r\n        }).catch(error => {\r\n            window.console.log(error);\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Only registers event listeners for new loaded elements in mediaThumbnail.\r\n     */\r\n    registerMediaThumbnailEventListeners = () => {\r\n        // Handles delete thumbnail.\r\n        const deleteMedia = this.thumbnailModalRoot.querySelector(Selectors.EMBED.actions.deleteThumbnail);\r\n        if (deleteMedia) {\r\n            deleteMedia.addEventListener('click', (e) => {\r\n                e.preventDefault();\r\n                this.deleteMedia();\r\n            });\r\n        }\r\n\r\n        // Handles setting the media poster.\r\n        const setPoster = this.thumbnailModalRoot.querySelector(Selectors.EMBED.actions.setPoster);\r\n        if (setPoster) {\r\n            setPoster.addEventListener('click', () => {\r\n                this.loadPreviewMediaThumbnail();\r\n            });\r\n        }\r\n    };\r\n}\r\n"],"names":["constructor","data","mediaData","currentModal","uploadThumbnailModal","setTitle","component","source","this","media","poster","root","thumbnailModalRoot","fileNameSelector","Selectors","EMBED","elements","fileNameLabel","setThumbnailSource","registerMediaThumbnailEventListeners","thumbnailPreview","querySelector","src","addEventListener","async","urlWarning","innerHTML","type","EmbedHandler","resetUploadForm","deleteCancelPromise","then","catch","loadMediaDetails","EmbedPreview","destroy","insertMediaModal","error","window","console","log","deleteMedia","actions","deleteThumbnail","e","preventDefault","setPoster","loadPreviewMediaThumbnail"],"mappings":"8vBA4CIA,YAAYC,mCASJC,iBACCA,UAAYA,eACZC,aAAaC,qBAAqBC,UAAS,kBAAU,YAAaC,mDACrD,CACdC,OAAQC,KAAKC,MAAMC,OACnBC,KAAMH,KAAKI,mBACXC,iBAAkBC,mBAAUC,MAAMC,SAASC,qBAE1CC,0BACAC,qFAMY,WACXC,iBAAmBZ,KAAKI,mBAAmBS,cAAcP,mBAAUC,MAAMC,SAASI,kBACxFA,iBAAiBE,IAAMd,KAAKC,MAAMC,OAElCU,iBAAiBG,iBAAiB,SAASC,UAEZhB,KAAKI,mBAAmBS,cAAcP,mBAAUC,MAAMC,SAASS,YACvEC,gBAAkB,kBAAU,mBAAoBpB,6CACtDQ,mBAAUC,MAAMC,SAASS,WAAYjB,KAAKI,kDAGtCJ,KAAKI,mBAAoBE,mBAAUC,MAAMY,UAGrDC,2BAAapB,MAAOqB,iBAAgB,MAG7CT,iBAAiBG,iBAAiB,QAAQ,UACjCrB,UAAUO,MAAMC,OAASF,KAAKC,MAAMC,YACpCD,MAAQD,KAAKN,UAAUO,oCACXD,KAAKI,mBAAoBE,mBAAUC,MAAMY,gDAOpD,2BACGG,qBACT,kBAAU,uBAAwBxB,oBAClC,kBAAU,8BAA+BA,oBAC3CyB,MAAK,SACEH,2BAAapB,MAAOqB,iBAAgB,MAE1CG,OAAM,8DASeR,cACnBI,2BAAapB,MAAOyB,iBAAiB,IAAIC,2BAAa1B,YAAa,6CAA4BA,OACnGuB,MAAK,UAEG5B,aAAaC,qBAAqB+B,gBACjChC,aAAeK,KAAKL,aAAaiC,sBAClCjC,aAAeA,aAAaiC,wBAC1B5B,KAAKN,aAEb8B,OAAMK,QACLC,OAAOC,QAAQC,IAAIH,0EAOY,WAE7BI,YAAcjC,KAAKI,mBAAmBS,cAAcP,mBAAUC,MAAM2B,QAAQC,iBAC9EF,aACAA,YAAYlB,iBAAiB,SAAUqB,IACnCA,EAAEC,sBACGJ,uBAKPK,UAAYtC,KAAKI,mBAAmBS,cAAcP,mBAAUC,MAAM2B,QAAQI,WAC5EA,WACAA,UAAUvB,iBAAiB,SAAS,UAC3BwB,qEAjGSvC,KAAMP"}