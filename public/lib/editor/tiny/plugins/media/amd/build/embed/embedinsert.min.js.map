{"version":3,"file":"embedinsert.min.js","sources":["../../src/embed/embedinsert.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Tiny media plugin embed upload class.\r\n *\r\n * This handles the embed upload using url, drag-drop and repositories.\r\n *\r\n * @module      tiny_media/embed/embedinsert\r\n * @copyright   2024 Stevani Andolo <stevani@hotmail.com.au>\r\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport {prefetchStrings} from 'core/prefetch';\r\nimport {getStrings} from 'core/str';\r\nimport {component} from \"../common\";\r\nimport {\r\n    setPropertiesFromData,\r\n    startMediaLoading,\r\n    stopMediaLoading,\r\n    showElements,\r\n} from '../helpers';\r\nimport Selectors from \"../selectors\";\r\nimport Dropzone from 'core/dropzone';\r\nimport uploadFile from 'editor_tiny/uploader';\r\nimport {EmbedHandler} from './embedhandler';\r\nimport {\r\n    getMediaTitle,\r\n    mediaDetailsTemplateContext,\r\n    checkMediaType,\r\n    fetchPreview,\r\n} from './embedhelpers';\r\nimport {EmbedPreview} from './embedpreview';\r\n\r\nprefetchStrings(component, [\r\n    'insertmedia',\r\n    'addmediafilesdrop',\r\n    'uploading',\r\n    'loadingmedia',\r\n]);\r\n\r\nexport class EmbedInsert {\r\n\r\n    constructor(data) {\r\n        setPropertiesFromData(this, data); // Creates dynamic properties based on \"data\" param.\r\n    }\r\n\r\n    /**\r\n     * Init the dropzone and lang strings.\r\n     */\r\n    init = async() => {\r\n        const langStringKeys = [\r\n            'insertmedia',\r\n            'addmediafilesdrop',\r\n            'uploading',\r\n            'loadingmedia',\r\n        ];\r\n        const langStringValues = await getStrings([...langStringKeys].map((key) => ({key, component})));\r\n        this.langStrings = Object.fromEntries(langStringKeys.map((key, index) => [key, langStringValues[index]]));\r\n        this.currentModal.setTitle(this.langStrings.insertmedia);\r\n\r\n        // Let's init the dropzone if canShowDropZone is true and mediaType is null.\r\n        if (this.canShowDropZone && !this.mediaType) {\r\n            const dropZoneEle = document.querySelector(Selectors.EMBED.elements.dropzoneContainer);\r\n            const dropZone = new Dropzone(\r\n                dropZoneEle,\r\n                this.acceptedMediaTypes,\r\n                files => {\r\n                    this.handleUploadedFile(files);\r\n                }\r\n            );\r\n\r\n            dropZone.setLabel(this.langStrings.addmediafilesdrop);\r\n            dropZone.init();\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Loads and displays a preview media based on the provided URL, and handles media loading events.\r\n     *\r\n     * @param {string} url - The URL of the media to load and display.\r\n     */\r\n    loadMediaPreview = async(url) => {\r\n        this.originalUrl = url;\r\n        this.fetchedMediaLinkTitle = await getMediaTitle(url, this);\r\n\r\n        if (this.newMediaLink) { // Media added using url input.\r\n            this.filteredContent = await fetchPreview(this.originalUrl, this.contextId);\r\n\r\n            if (!this.mediaType) {\r\n                // It means the url points to a physical media file.\r\n                if (this.fetchedMediaLinkTitle) {\r\n                    // Case-insensitive regex for video tag.\r\n                    const videoRegex = /<video[^>]*>.*<\\/video>/i;\r\n                    // Case-insensitive regex for audio tag.\r\n                    const audioRegex = /<audio[^>]*>.*<\\/audio>/i;\r\n\r\n                    if (videoRegex.test(this.filteredContent)) {\r\n                        this.mediaType = 'video';\r\n                    } else if (audioRegex.test(this.filteredContent)) {\r\n                        this.mediaType = 'audio';\r\n                    }\r\n                } else {\r\n                    this.mediaType = 'link';\r\n                }\r\n            }\r\n\r\n            // Process the media preview.\r\n            this.processMediaPreview();\r\n        } else { // Media added using dropzone or repositories.\r\n            this.mediaType ??= await checkMediaType(url);\r\n\r\n            // Process the media preview.\r\n            this.processMediaPreview();\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Process the media preview.\r\n     */\r\n    processMediaPreview = async() => {\r\n        // Let's combine the props.\r\n        setPropertiesFromData(\r\n            this,\r\n            await (new EmbedHandler(this)).getMediaTemplateContext()\r\n        );\r\n\r\n        // Construct templateContext for embed preview.\r\n        const templateContext = await mediaDetailsTemplateContext(this);\r\n\r\n        if (this.isUpdating && !this.newMediaLink) {\r\n            // Will be used to set the media title if it's in update state.\r\n            this.mediaTitle = templateContext.media.title;\r\n        }\r\n\r\n        // Load the media details and preview of the selected media.\r\n        (new EmbedHandler(this)).loadMediaDetails(new EmbedPreview(this), templateContext);\r\n    };\r\n\r\n    /**\r\n     * Updates the content of the loader icon.\r\n     *\r\n     * @param {HTMLElement} root - The root element containing the loader icon.\r\n     * @param {object} langStrings - An object containing language strings.\r\n     * @param {number|null} progress - The progress percentage (optional).\r\n     * @returns {void}\r\n     */\r\n    updateLoaderIcon = (root, langStrings, progress = null) => {\r\n        const loaderIconState = root.querySelector(Selectors.EMBED.elements.loaderIconContainer + ' div');\r\n        loaderIconState.innerHTML = (progress !== null) ?\r\n                               `${langStrings.uploading} ${Math.round(progress)}%` :\r\n                               langStrings.loadingmedia;\r\n    };\r\n\r\n    /**\r\n     * Handles media preview on file picker callback.\r\n     *\r\n     * @param {object} params Object of uploaded file\r\n     */\r\n    filePickerCallback = (params) => {\r\n        if (params.url) {\r\n            if (this.mediaType) {\r\n                // Set mediaType to \"null\" if it started with viewing embedded link, otherwise it will not be consistent.\r\n                this.mediaType = null;\r\n            }\r\n\r\n            // Flag as new file upload.\r\n            this.newFileUpload = true;\r\n\r\n            // Load the media preview.\r\n            this.loadMediaPreview(params.url);\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Handles the uploaded file, initiates the upload process, and updates the UI during the upload.\r\n     *\r\n     * @param {FileList} files - The list of files to upload (usually from a file input field).\r\n     * @returns {Promise<void>} A promise that resolves when the file is uploaded and processed.\r\n     */\r\n    handleUploadedFile = async(files) => {\r\n        try {\r\n            startMediaLoading(this.root, Selectors.EMBED.type);\r\n            const fileURL = await uploadFile(this.editor, 'media', files[0], files[0].name, (progress) => {\r\n                this.updateLoaderIcon(this.root, this.langStrings, progress);\r\n            });\r\n\r\n            // Set the loader icon content to \"loading\" after the file upload completes.\r\n            this.updateLoaderIcon(this.root, this.langStrings);\r\n            this.filePickerCallback({url: fileURL});\r\n        } catch (error) {\r\n            // Handle the error.\r\n            const urlWarningLabelEle = this.root.querySelector(Selectors.EMBED.elements.urlWarning);\r\n            urlWarningLabelEle.innerHTML = error.error !== undefined ? error.error : error;\r\n            showElements(Selectors.EMBED.elements.urlWarning, this.root);\r\n            stopMediaLoading(this.root, Selectors.EMBED.type);\r\n        }\r\n    };\r\n}\r\n"],"names":["component","constructor","data","async","langStringKeys","langStringValues","map","key","langStrings","Object","fromEntries","index","currentModal","setTitle","this","insertmedia","canShowDropZone","mediaType","dropZoneEle","document","querySelector","Selectors","EMBED","elements","dropzoneContainer","dropZone","Dropzone","acceptedMediaTypes","files","handleUploadedFile","setLabel","addmediafilesdrop","init","originalUrl","url","fetchedMediaLinkTitle","newMediaLink","filteredContent","contextId","audioRegex","test","processMediaPreview","EmbedHandler","getMediaTemplateContext","templateContext","isUpdating","mediaTitle","media","title","loadMediaDetails","EmbedPreview","root","progress","loaderIconState","loaderIconContainer","innerHTML","uploading","Math","round","loadingmedia","params","newFileUpload","loadMediaPreview","type","fileURL","editor","name","updateLoaderIcon","filePickerCallback","error","urlWarning","undefined"],"mappings":"0zBA8CgBA,kBAAW,CACvB,cACA,oBACA,YACA,4CAKAC,YAAYC,mCAOLC,gBACGC,eAAiB,CACnB,cACA,oBACA,YACA,gBAEEC,uBAAyB,mBAAW,IAAID,gBAAgBE,KAAKC,OAAUA,IAAAA,IAAKP,UAAAA,+BAC7EQ,YAAcC,OAAOC,YAAYN,eAAeE,KAAI,CAACC,IAAKI,QAAU,CAACJ,IAAKF,iBAAiBM,gBAC3FC,aAAaC,SAASC,KAAKN,YAAYO,aAGxCD,KAAKE,kBAAoBF,KAAKG,UAAW,OACnCC,YAAcC,SAASC,cAAcC,mBAAUC,MAAMC,SAASC,mBAC9DC,SAAW,IAAIC,kBACjBR,YACAJ,KAAKa,oBACLC,aACSC,mBAAmBD,UAIhCH,SAASK,SAAShB,KAAKN,YAAYuB,mBACnCN,SAASO,oDASE7B,MAAAA,cACV8B,YAAcC,SACdC,4BAA8B,+BAAcD,IAAKpB,MAElDA,KAAKsB,aAAc,SACdC,sBAAwB,8BAAavB,KAAKmB,YAAanB,KAAKwB,YAE5DxB,KAAKG,aAEFH,KAAKqB,sBAAuB,OAItBI,WAAa,2BAFA,2BAIJC,KAAK1B,KAAKuB,sBAChBpB,UAAY,QACVsB,WAAWC,KAAK1B,KAAKuB,wBACvBpB,UAAY,mBAGhBA,UAAY,YAKpBwB,0BACF,kDACExB,4CAAAA,gBAAoB,gCAAeiB,WAGnCO,sEAOStC,6CAGdW,WACO,IAAI4B,2BAAa5B,MAAO6B,iCAI7BC,sBAAwB,6CAA4B9B,MAEtDA,KAAK+B,aAAe/B,KAAKsB,oBAEpBU,WAAaF,gBAAgBG,MAAMC,WAIvCN,2BAAa5B,MAAOmC,iBAAiB,IAAIC,2BAAapC,MAAO8B,6DAWnD,SAACO,KAAM3C,iBAAa4C,gEAAW,WACxCC,gBAAkBF,KAAK/B,cAAcC,mBAAUC,MAAMC,SAAS+B,oBAAsB,QAC1FD,gBAAgBE,UAA0B,OAAbH,mBACH5C,YAAYgD,sBAAaC,KAAKC,MAAMN,eACvC5C,YAAYmD,2DAQjBC,SACdA,OAAO1B,MACHpB,KAAKG,iBAEAA,UAAY,WAIhB4C,eAAgB,OAGhBC,iBAAiBF,OAAO1B,oDAUhB/B,MAAAA,2CAEKW,KAAKqC,KAAM9B,mBAAUC,MAAMyC,YACvCC,cAAgB,qBAAWlD,KAAKmD,OAAQ,QAASrC,MAAM,GAAIA,MAAM,GAAGsC,MAAOd,gBACxEe,iBAAiBrD,KAAKqC,KAAMrC,KAAKN,YAAa4C,kBAIlDe,iBAAiBrD,KAAKqC,KAAMrC,KAAKN,kBACjC4D,mBAAmB,CAAClC,IAAK8B,UAChC,MAAOK,OAEsBvD,KAAKqC,KAAK/B,cAAcC,mBAAUC,MAAMC,SAAS+C,YACzDf,eAA4BgB,IAAhBF,MAAMA,MAAsBA,MAAMA,MAAQA,gCAC5DhD,mBAAUC,MAAMC,SAAS+C,WAAYxD,KAAKqC,oCACtCrC,KAAKqC,KAAM9B,mBAAUC,MAAMyC,6CAvJ1BjD,KAAMZ"}