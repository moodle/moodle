{"version":3,"file":"imageinsert.min.js","sources":["../../src/image/imageinsert.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Tiny media plugin image insertion class for Moodle.\r\n *\r\n * @module      tiny_media/image/imageinsert\r\n * @copyright   2024 Meirza <meirza.arson@moodle.com>\r\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport Selectors from '../selectors';\r\nimport Dropzone from 'core/dropzone';\r\nimport uploadFile from 'editor_tiny/uploader';\r\nimport {prefetchStrings} from 'core/prefetch';\r\nimport {getStrings} from 'core/str';\r\nimport {component} from \"../common\";\r\nimport {getFilePicker} from 'editor_tiny/options';\r\nimport {displayFilepicker} from 'editor_tiny/utils';\r\nimport {ImageDetails} from './imagedetails';\r\nimport {\r\n    body,\r\n    footer,\r\n    hideElements,\r\n    showElements,\r\n    isValidUrl,\r\n} from '../helpers';\r\nimport {MAX_LENGTH_ALT} from './imagehelpers';\r\n\r\nprefetchStrings('tiny_media', [\r\n    'insertimage',\r\n    'enterurl',\r\n    'enterurlor',\r\n    'imageurlrequired',\r\n    'uploading',\r\n    'loading',\r\n    'addfilesdrop',\r\n    'sizecustom_help',\r\n    'alttext_help',\r\n]);\r\n\r\nexport class ImageInsert {\r\n\r\n    constructor(\r\n        root,\r\n        editor,\r\n        currentModal,\r\n        canShowFilePicker,\r\n        canShowDropZone,\r\n    ) {\r\n        this.root = root;\r\n        this.editor = editor;\r\n        this.currentModal = currentModal;\r\n        this.canShowFilePicker = canShowFilePicker;\r\n        this.canShowDropZone = canShowDropZone;\r\n    }\r\n\r\n    init = async function() {\r\n        // Get the localization lang strings and turn them into object.\r\n        const langStringKeys = [\r\n            'insertimage',\r\n            'enterurl',\r\n            'enterurlor',\r\n            'imageurlrequired',\r\n            'uploading',\r\n            'loading',\r\n            'addfilesdrop',\r\n            'sizecustom_help',\r\n            'alttext_help',\r\n        ];\r\n        const langStringvalues = await getStrings([...langStringKeys].map((key) => ({key, component})));\r\n\r\n        // Convert array to object.\r\n        this.langStrings = Object.fromEntries(langStringKeys.map((key, index) => [key, langStringvalues[index]]));\r\n        this.currentModal.setTitle(this.langStrings.insertimage);\r\n        if (this.canShowDropZone) {\r\n            const dropZoneEle = document.querySelector(Selectors.IMAGE.elements.dropzoneContainer);\r\n\r\n            // Accepted types can be either a string or an array.\r\n            let acceptedTypes = getFilePicker(this.editor, 'image').accepted_types;\r\n            if (Array.isArray(acceptedTypes)) {\r\n                acceptedTypes = acceptedTypes.join(',');\r\n            }\r\n\r\n            const dropZone = new Dropzone(\r\n                dropZoneEle,\r\n                acceptedTypes,\r\n                files => {\r\n                    this.handleUploadedFile(files);\r\n                }\r\n            );\r\n            dropZone.setLabel(this.langStrings.addfilesdrop);\r\n            dropZone.init();\r\n        }\r\n        await this.registerEventListeners();\r\n    };\r\n\r\n    /**\r\n     * Enables or disables the URL-related buttons in the footer based on the current URL and input value.\r\n     */\r\n    toggleUrlButton() {\r\n        const urlInput = this.root.querySelector(Selectors.IMAGE.elements.url);\r\n        const url = urlInput.value;\r\n        const addUrl = this.root.querySelector(Selectors.IMAGE.actions.addUrl);\r\n        addUrl.disabled = !(url !== \"\" && isValidUrl(url));\r\n    }\r\n\r\n    /**\r\n     * Handles changes in the image URL input field and loads a preview of the image if the URL has changed.\r\n     */\r\n    urlChanged() {\r\n        hideElements(Selectors.IMAGE.elements.urlWarning, this.root);\r\n        const input = this.root.querySelector(Selectors.IMAGE.elements.url);\r\n        if (input.value && input.value !== this.currentUrl) {\r\n            this.loadPreviewImage(input.value);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Loads and displays a preview image based on the provided URL, and handles image loading events.\r\n     *\r\n     * @param {string} url - The URL of the image to load and display.\r\n     */\r\n    loadPreviewImage = function(url) {\r\n        this.startImageLoading();\r\n        this.currentUrl = url;\r\n        const image = new Image();\r\n        image.src = url;\r\n        image.addEventListener('error', () => {\r\n            const urlWarningLabelEle = this.root.querySelector(Selectors.IMAGE.elements.urlWarning);\r\n            urlWarningLabelEle.innerHTML = this.langStrings.imageurlrequired;\r\n            showElements(Selectors.IMAGE.elements.urlWarning, this.root);\r\n            this.currentUrl = \"\";\r\n            this.stopImageLoading();\r\n        });\r\n\r\n        image.addEventListener('load', () => {\r\n            let templateContext = {};\r\n            templateContext.sizecustomhelpicon = {text: this.langStrings.sizecustom_help};\r\n            templateContext.alttexthelpicon = {text: this.langStrings.alttext_help};\r\n            templateContext.bodyTemplate = Selectors.IMAGE.template.body.insertImageDetailsBody;\r\n            templateContext.footerTemplate = Selectors.IMAGE.template.footer.insertImageDetailsFooter;\r\n            templateContext.selector = Selectors.IMAGE.type;\r\n            templateContext.maxlengthalt = MAX_LENGTH_ALT;\r\n\r\n            Promise.all([body(templateContext, this.root), footer(templateContext, this.root)])\r\n                .then(() => {\r\n                    const imagedetails = new ImageDetails(\r\n                        this.root,\r\n                        this.editor,\r\n                        this.currentModal,\r\n                        this.canShowFilePicker,\r\n                        this.canShowDropZone,\r\n                        this.currentUrl,\r\n                        image,\r\n                    );\r\n                    imagedetails.init();\r\n                    return;\r\n                }).then(() => {\r\n                    this.stopImageLoading();\r\n                    return;\r\n                })\r\n                .catch(error => {\r\n                    window.console.log(error);\r\n                });\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Displays the upload loader and disables UI elements while loading a file.\r\n     */\r\n    startImageLoading() {\r\n        showElements(Selectors.IMAGE.elements.loaderIcon, this.root);\r\n        const elementsToHide = [\r\n            Selectors.IMAGE.elements.insertImage,\r\n            Selectors.IMAGE.elements.urlWarning,\r\n            Selectors.IMAGE.elements.modalFooter,\r\n        ];\r\n        hideElements(elementsToHide, this.root);\r\n    }\r\n\r\n    /**\r\n     * Displays the upload loader and disables UI elements while loading a file.\r\n     */\r\n    stopImageLoading() {\r\n        hideElements(Selectors.IMAGE.elements.loaderIcon, this.root);\r\n        const elementsToShow = [\r\n            Selectors.IMAGE.elements.insertImage,\r\n            Selectors.IMAGE.elements.modalFooter,\r\n        ];\r\n        showElements(elementsToShow, this.root);\r\n    }\r\n\r\n    filePickerCallback(params) {\r\n        if (params.url) {\r\n            this.loadPreviewImage(params.url);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Updates the content of the loader icon.\r\n     *\r\n     * @param {HTMLElement} root - The root element containing the loader icon.\r\n     * @param {object} langStrings - An object containing language strings.\r\n     * @param {number|null} progress - The progress percentage (optional).\r\n     * @returns {void}\r\n     */\r\n    updateLoaderIcon = (root, langStrings, progress = null) => {\r\n        const loaderIcon = root.querySelector(Selectors.IMAGE.elements.loaderIconContainer + ' div');\r\n        loaderIcon.innerHTML = progress !== null ? `${langStrings.uploading} ${Math.round(progress)}%` : langStrings.loading;\r\n    };\r\n\r\n    /**\r\n     * Handles the uploaded file, initiates the upload process, and updates the UI during the upload.\r\n     *\r\n     * @param {FileList} files - The list of files to upload (usually from a file input field).\r\n     * @returns {Promise<void>} A promise that resolves when the file is uploaded and processed.\r\n     */\r\n    handleUploadedFile = async(files) => {\r\n        try {\r\n            this.startImageLoading();\r\n            const fileURL = await uploadFile(this.editor, 'image', files[0], files[0].name, (progress) => {\r\n                this.updateLoaderIcon(this.root, this.langStrings, progress);\r\n            });\r\n            // Set the loader icon content to \"loading\" after the file upload completes.\r\n            this.updateLoaderIcon(this.root, this.langStrings);\r\n            this.filePickerCallback({url: fileURL});\r\n        } catch (error) {\r\n            // Handle the error.\r\n            const urlWarningLabelEle = this.root.querySelector(Selectors.IMAGE.elements.urlWarning);\r\n            urlWarningLabelEle.innerHTML = error.error !== undefined ? error.error : error;\r\n            showElements(Selectors.IMAGE.elements.urlWarning, this.root);\r\n            this.stopImageLoading();\r\n        }\r\n    };\r\n\r\n    registerEventListeners() {\r\n        this.root.addEventListener('click', async(e) => {\r\n            const addUrlEle = e.target.closest(Selectors.IMAGE.actions.addUrl);\r\n            if (addUrlEle) {\r\n                this.urlChanged();\r\n            }\r\n\r\n            const imageBrowserAction = e.target.closest(Selectors.IMAGE.actions.imageBrowser);\r\n            if (imageBrowserAction && this.canShowFilePicker) {\r\n                e.preventDefault();\r\n                const params = await displayFilepicker(this.editor, 'image');\r\n                this.filePickerCallback(params);\r\n            }\r\n        });\r\n\r\n        this.root.addEventListener('input', (e) => {\r\n            const urlEle = e.target.closest(Selectors.IMAGE.elements.url);\r\n            if (urlEle) {\r\n                this.toggleUrlButton();\r\n            }\r\n        });\r\n\r\n        const fileInput = this.root.querySelector(Selectors.IMAGE.elements.fileInput);\r\n        if (fileInput) {\r\n            fileInput.addEventListener('change', () => {\r\n                this.handleUploadedFile(fileInput.files);\r\n            });\r\n        }\r\n    }\r\n}\r\n"],"names":["constructor","root","editor","currentModal","canShowFilePicker","canShowDropZone","async","langStringKeys","langStringvalues","map","key","component","langStrings","Object","fromEntries","index","setTitle","this","insertimage","dropZoneEle","document","querySelector","Selectors","IMAGE","elements","dropzoneContainer","acceptedTypes","accepted_types","Array","isArray","join","dropZone","Dropzone","files","handleUploadedFile","setLabel","addfilesdrop","init","registerEventListeners","url","startImageLoading","currentUrl","image","Image","src","addEventListener","urlWarning","innerHTML","imageurlrequired","stopImageLoading","templateContext","sizecustomhelpicon","text","sizecustom_help","alttexthelpicon","alttext_help","bodyTemplate","template","body","insertImageDetailsBody","footerTemplate","footer","insertImageDetailsFooter","selector","type","maxlengthalt","MAX_LENGTH_ALT","Promise","all","then","ImageDetails","catch","error","window","console","log","progress","loaderIcon","loaderIconContainer","uploading","Math","round","loading","fileURL","name","updateLoaderIcon","filePickerCallback","undefined","toggleUrlButton","value","actions","addUrl","disabled","urlChanged","input","loadPreviewImage","elementsToHide","insertImage","modalFooter","elementsToShow","params","e","target","closest","imageBrowser","preventDefault","fileInput"],"mappings":"q1BAyCgB,aAAc,CAC1B,cACA,WACA,aACA,mBACA,YACA,UACA,eACA,kBACA,4CAKAA,YACIC,MACAC,OACAC,aACAC,kBACAC,8CASGC,uBAEGC,eAAiB,CACnB,cACA,WACA,aACA,mBACA,YACA,UACA,eACA,kBACA,gBAEEC,uBAAyB,mBAAW,IAAID,gBAAgBE,KAAKC,OAAUA,IAAAA,IAAKC,UAAAA,+BAG7EC,YAAcC,OAAOC,YAAYP,eAAeE,KAAI,CAACC,IAAKK,QAAU,CAACL,IAAKF,iBAAiBO,gBAC3FZ,aAAaa,SAASC,KAAKL,YAAYM,aACxCD,KAAKZ,gBAAiB,OAChBc,YAAcC,SAASC,cAAcC,mBAAUC,MAAMC,SAASC,uBAGhEC,eAAgB,0BAAcT,KAAKf,OAAQ,SAASyB,eACpDC,MAAMC,QAAQH,iBACdA,cAAgBA,cAAcI,KAAK,YAGjCC,SAAW,IAAIC,kBACjBb,YACAO,eACAO,aACSC,mBAAmBD,UAGhCF,SAASI,SAASlB,KAAKL,YAAYwB,cACnCL,SAASM,aAEPpB,KAAKqB,qEA6BI,SAASC,UACnBC,yBACAC,WAAaF,UACZG,MAAQ,IAAIC,MAClBD,MAAME,IAAML,IACZG,MAAMG,iBAAiB,SAAS,KACD5B,KAAKhB,KAAKoB,cAAcC,mBAAUC,MAAMC,SAASsB,YACzDC,UAAY9B,KAAKL,YAAYoC,2CACnC1B,mBAAUC,MAAMC,SAASsB,WAAY7B,KAAKhB,WAClDwC,WAAa,QACbQ,sBAGTP,MAAMG,iBAAiB,QAAQ,SACvBK,gBAAkB,GACtBA,gBAAgBC,mBAAqB,CAACC,KAAMnC,KAAKL,YAAYyC,iBAC7DH,gBAAgBI,gBAAkB,CAACF,KAAMnC,KAAKL,YAAY2C,cAC1DL,gBAAgBM,aAAelC,mBAAUC,MAAMkC,SAASC,KAAKC,uBAC7DT,gBAAgBU,eAAiBtC,mBAAUC,MAAMkC,SAASI,OAAOC,yBACjEZ,gBAAgBa,SAAWzC,mBAAUC,MAAMyC,KAC3Cd,gBAAgBe,aAAeC,6BAE/BC,QAAQC,IAAI,EAAC,iBAAKlB,gBAAiBjC,KAAKhB,OAAO,mBAAOiD,gBAAiBjC,KAAKhB,QACvEoE,MAAK,KACmB,IAAIC,2BACrBrD,KAAKhB,KACLgB,KAAKf,OACLe,KAAKd,aACLc,KAAKb,kBACLa,KAAKZ,gBACLY,KAAKwB,WACLC,OAESL,UAEdgC,MAAK,UACCpB,sBAGRsB,OAAMC,QACHC,OAAOC,QAAQC,IAAIH,yDA4ChB,SAACvE,KAAMW,iBAAagE,gEAAW,WACxCC,WAAa5E,KAAKoB,cAAcC,mBAAUC,MAAMC,SAASsD,oBAAsB,QACrFD,WAAW9B,UAAyB,OAAb6B,mBAAuBhE,YAAYmE,sBAAaC,KAAKC,MAAML,eAAehE,YAAYsE,sDAS5F5E,MAAAA,iBAERkC,0BACC2C,cAAgB,qBAAWlE,KAAKf,OAAQ,QAAS+B,MAAM,GAAIA,MAAM,GAAGmD,MAAOR,gBACxES,iBAAiBpE,KAAKhB,KAAMgB,KAAKL,YAAagE,kBAGlDS,iBAAiBpE,KAAKhB,KAAMgB,KAAKL,kBACjC0E,mBAAmB,CAAC/C,IAAK4C,UAChC,MAAOX,OAEsBvD,KAAKhB,KAAKoB,cAAcC,mBAAUC,MAAMC,SAASsB,YACzDC,eAA4BwC,IAAhBf,MAAMA,MAAsBA,MAAMA,MAAQA,gCAC5DlD,mBAAUC,MAAMC,SAASsB,WAAY7B,KAAKhB,WAClDgD,4BAtLJhD,KAAOA,WACPC,OAASA,YACTC,aAAeA,kBACfC,kBAAoBA,uBACpBC,gBAAkBA,gBA8C3BmF,wBAEUjD,IADWtB,KAAKhB,KAAKoB,cAAcC,mBAAUC,MAAMC,SAASe,KAC7CkD,MACNxE,KAAKhB,KAAKoB,cAAcC,mBAAUC,MAAMmE,QAAQC,QACxDC,WAAqB,KAARrD,MAAc,uBAAWA,MAMjDsD,uCACiBvE,mBAAUC,MAAMC,SAASsB,WAAY7B,KAAKhB,YACjD6F,MAAQ7E,KAAKhB,KAAKoB,cAAcC,mBAAUC,MAAMC,SAASe,KAC3DuD,MAAML,OAASK,MAAML,QAAUxE,KAAKwB,iBAC/BsD,iBAAiBD,MAAML,OAyDpCjD,8CACiBlB,mBAAUC,MAAMC,SAASqD,WAAY5D,KAAKhB,YACjD+F,eAAiB,CACnB1E,mBAAUC,MAAMC,SAASyE,YACzB3E,mBAAUC,MAAMC,SAASsB,WACzBxB,mBAAUC,MAAMC,SAAS0E,uCAEhBF,eAAgB/E,KAAKhB,MAMtCgD,6CACiB3B,mBAAUC,MAAMC,SAASqD,WAAY5D,KAAKhB,YACjDkG,eAAiB,CACnB7E,mBAAUC,MAAMC,SAASyE,YACzB3E,mBAAUC,MAAMC,SAAS0E,uCAEhBC,eAAgBlF,KAAKhB,MAGtCqF,mBAAmBc,QACXA,OAAO7D,UACFwD,iBAAiBK,OAAO7D,KAyCrCD,8BACSrC,KAAK4C,iBAAiB,SAASvC,MAAAA,IACd+F,EAAEC,OAAOC,QAAQjF,mBAAUC,MAAMmE,QAAQC,cAElDE,gBAGkBQ,EAAEC,OAAOC,QAAQjF,mBAAUC,MAAMmE,QAAQc,eAC1CvF,KAAKb,kBAAmB,CAC9CiG,EAAEI,uBACIL,aAAe,4BAAkBnF,KAAKf,OAAQ,cAC/CoF,mBAAmBc,iBAI3BnG,KAAK4C,iBAAiB,SAAUwD,IAClBA,EAAEC,OAAOC,QAAQjF,mBAAUC,MAAMC,SAASe,WAEhDiD,2BAIPkB,UAAYzF,KAAKhB,KAAKoB,cAAcC,mBAAUC,MAAMC,SAASkF,WAC/DA,WACAA,UAAU7D,iBAAiB,UAAU,UAC5BX,mBAAmBwE,UAAUzE"}