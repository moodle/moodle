{"version":3,"file":"embed.min.js","sources":["../../src/embed/embed.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Tiny Media plugin Embed class for Moodle.\r\n *\r\n * @module      tiny_media/embed\r\n * @copyright   2022 Huong Nguyen <huongnv13@gmail.com>\r\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport EmbedModal from './embedmodal';\r\nimport {getEmbedPermissions} from '../options';\r\nimport {getFilePicker, getContextId} from 'editor_tiny/options';\r\nimport {EmbedHandler} from './embedhandler';\r\nimport {insertMediaTemplateContext, getSelectedMediaElement} from './embedhelpers';\r\nimport {EmbedInsert} from './embedinsert';\r\nimport {startMediaLoading} from '../helpers';\r\nimport Selectors from \"../selectors\";\r\n\r\nexport default class MediaEmbed {\r\n    editor = null;\r\n    canShowFilePicker = false;\r\n    canShowFilePickerTrack = false;\r\n    canShowDropZone = false;\r\n\r\n    constructor(editor) {\r\n        const permissions = getEmbedPermissions(editor);\r\n        const options = getFilePicker(editor, 'media');\r\n\r\n        // Indicates whether the file picker can be shown.\r\n        this.canShowFilePicker = permissions.filepicker\r\n            && (typeof options !== 'undefined')\r\n            && Object.keys(options.repositories).length > 0;\r\n        this.canShowFilePickerTrack = permissions.filepicker && (typeof getFilePicker(editor, 'subtitle') !== 'undefined');\r\n        this.canShowDropZone = Object.values(options.repositories).some(repository => repository.type === 'upload');\r\n        this.editor = editor;\r\n        this.acceptedMediaTypes = options.accepted_types;\r\n        this.contextId = getContextId(editor);\r\n\r\n        // Image options.\r\n        const imageOptions = getFilePicker(editor, 'image');\r\n        this.acceptedImageTypes = imageOptions.accepted_types;\r\n        this.canShowImageFilePicker = permissions.filepicker\r\n            && (typeof imageOptions !== 'undefined')\r\n            && Object.keys(imageOptions.repositories).length > 0;\r\n    }\r\n\r\n    /**\r\n     * Displays media modal accordingly.\r\n     */\r\n    displayDialogue = async() => {\r\n        const [mediaType, selectedMedia] = getSelectedMediaElement(this.editor);\r\n        this.mediaType = mediaType;\r\n        this.selectedMedia = selectedMedia;\r\n\r\n        if (this.selectedMedia) {\r\n            // Preview the selected media.\r\n            this.isUpdating = true;\r\n            this.loadSelectedMedia();\r\n        } else {\r\n            // Create media modal.\r\n            await this.createMediaModal();\r\n            // Load insert media modal.\r\n            await this.loadInsertMediaModal();\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Load insert media modal.\r\n     */\r\n    loadInsertMediaModal = async() => {\r\n        const embedHandler = new EmbedHandler(this);\r\n        embedHandler.loadTemplatePromise(insertMediaTemplateContext(this));\r\n        await embedHandler.registerEventListeners();\r\n    };\r\n\r\n    /**\r\n     * Create media modal.\r\n     */\r\n    createMediaModal = async() => {\r\n        this.currentModal = await EmbedModal.create({\r\n            large: true,\r\n            templateContext: {elementid: this.editor.getElement().id},\r\n        });\r\n        this.modalRoot = this.currentModal.getRoot();\r\n        this.root = this.modalRoot[0];\r\n    };\r\n\r\n    /**\r\n     * Load media preview based on the selected media.\r\n     */\r\n    loadSelectedMedia = async() => {\r\n        let mediaSource = null;\r\n        if (['video', 'audio'].includes(this.mediaType)) {\r\n            mediaSource = this.selectedMedia.querySelector('source').src;\r\n            // If the selected media has more than one sources, it has main source and alternative sources.\r\n            const sources = this.selectedMedia.querySelectorAll('source');\r\n            if (sources.length > 1) {\r\n                let alternativeSources = [];\r\n                Object.keys(sources).forEach(function(source) {\r\n                    alternativeSources.push(sources[source].src);\r\n                });\r\n                this.alternativeSources = alternativeSources; // Used to later check if the embedded media has alternative sources.\r\n            }\r\n        } else if (this.selectedMedia.classList.contains(Selectors.EMBED.externalMediaProvider)) {\r\n            mediaSource = this.selectedMedia.href;\r\n            this.mediaType = 'link';\r\n        }\r\n\r\n        // Load media preview.\r\n        if (this.mediaType) {\r\n            // Create media modal.\r\n            await this.createMediaModal();\r\n            // Start the spinner.\r\n            startMediaLoading(this.root, Selectors.EMBED.type);\r\n\r\n            const embedInsert = new EmbedInsert(this);\r\n            embedInsert.init();\r\n            embedInsert.loadMediaPreview(mediaSource);\r\n            await (new EmbedHandler(this)).registerEventListeners();\r\n        } else {\r\n            // Create media modal.\r\n            await this.createMediaModal();\r\n            // Load insert media modal.\r\n            this.loadInsertMediaModal();\r\n        }\r\n    };\r\n}\r\n"],"names":["constructor","editor","async","mediaType","selectedMedia","this","isUpdating","loadSelectedMedia","createMediaModal","loadInsertMediaModal","embedHandler","EmbedHandler","loadTemplatePromise","registerEventListeners","currentModal","EmbedModal","create","large","templateContext","elementid","getElement","id","modalRoot","getRoot","root","mediaSource","includes","querySelector","src","sources","querySelectorAll","length","alternativeSources","Object","keys","forEach","source","push","classList","contains","Selectors","EMBED","externalMediaProvider","href","type","embedInsert","EmbedInsert","init","loadMediaPreview","permissions","options","canShowFilePicker","filepicker","repositories","canShowFilePickerTrack","canShowDropZone","values","some","repository","acceptedMediaTypes","accepted_types","contextId","imageOptions","acceptedImageTypes","canShowImageFilePicker"],"mappings":"8tBAsCIA,YAAYC,sCALH,gDACW,kDACK,2CACP,2CA2BAC,gBACPC,UAAWC,gBAAiB,yCAAwBC,KAAKJ,aAC3DE,UAAYA,eACZC,cAAgBA,cAEjBC,KAAKD,oBAEAE,YAAa,OACbC,4BAGCF,KAAKG,yBAELH,KAAKI,wEAOIP,gBACbQ,aAAe,IAAIC,2BAAaN,MACtCK,aAAaE,qBAAoB,4CAA2BP,aACtDK,aAAaG,qEAMJX,eACVY,mBAAqBC,oBAAWC,OAAO,CACxCC,OAAO,EACPC,gBAAiB,CAACC,UAAWd,KAAKJ,OAAOmB,aAAaC,WAErDC,UAAYjB,KAAKS,aAAaS,eAC9BC,KAAOnB,KAAKiB,UAAU,gDAMXpB,cACZuB,YAAc,QACd,CAAC,QAAS,SAASC,SAASrB,KAAKF,WAAY,CAC7CsB,YAAcpB,KAAKD,cAAcuB,cAAc,UAAUC,UAEnDC,QAAUxB,KAAKD,cAAc0B,iBAAiB,aAChDD,QAAQE,OAAS,EAAG,KAChBC,mBAAqB,GACzBC,OAAOC,KAAKL,SAASM,SAAQ,SAASC,QAClCJ,mBAAmBK,KAAKR,QAAQO,QAAQR,aAEvCI,mBAAqBA,yBAEvB3B,KAAKD,cAAckC,UAAUC,SAASC,mBAAUC,MAAMC,yBAC7DjB,YAAcpB,KAAKD,cAAcuC,UAC5BxC,UAAY,WAIjBE,KAAKF,UAAW,OAEVE,KAAKG,kDAEOH,KAAKmB,KAAMgB,mBAAUC,MAAMG,YAEvCC,YAAc,IAAIC,yBAAYzC,MACpCwC,YAAYE,OACZF,YAAYG,iBAAiBvB,mBACtB,IAAId,2BAAaN,MAAOQ,oCAGzBR,KAAKG,wBAENC,gCAlGHwC,aAAc,gCAAoBhD,QAClCiD,SAAU,2BAAcjD,OAAQ,cAGjCkD,kBAAoBF,YAAYG,iBACV,IAAZF,SACRjB,OAAOC,KAAKgB,QAAQG,cAActB,OAAS,OAC7CuB,uBAAyBL,YAAYG,iBAA4D,KAAtC,2BAAcnD,OAAQ,iBACjFsD,gBAAkBtB,OAAOuB,OAAON,QAAQG,cAAcI,MAAKC,YAAkC,WAApBA,WAAWd,YACpF3C,OAASA,YACT0D,mBAAqBT,QAAQU,oBAC7BC,WAAY,0BAAa5D,cAGxB6D,cAAe,2BAAc7D,OAAQ,cACtC8D,mBAAqBD,aAAaF,oBAClCI,uBAAyBf,YAAYG,iBACV,IAAjBU,cACR7B,OAAOC,KAAK4B,aAAaT,cAActB,OAAS"}