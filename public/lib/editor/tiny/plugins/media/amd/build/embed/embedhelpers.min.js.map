{"version":3,"file":"embedhelpers.min.js","sources":["../../src/embed/embedhelpers.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Tiny media plugin embed helpers.\r\n *\r\n * This provides easy access to any classes without instantiating a new object.\r\n *\r\n * @module      tiny_media/embed/embedhelpers\r\n * @copyright   2024 Stevani Andolo <stevani@hotmail.com.au>\r\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport Selectors from '../selectors';\r\nimport {getStrings} from 'core/str';\r\nimport {component} from \"../common\";\r\nimport {getCurrentLanguage, getMoodleLang} from 'editor_tiny/options';\r\nimport Ajax from 'core/ajax';\r\nimport {getFileName} from '../helpers';\r\n\r\n/**\r\n * Return template context for insert media.\r\n *\r\n * @param {object} props\r\n * @returns {object}\r\n */\r\nexport const insertMediaTemplateContext = (props) => {\r\n    return {\r\n        mediaType: props.mediaType,\r\n        showDropzone: props.canShowDropZone,\r\n        showFilePicker: props.canShowFilePicker,\r\n        fileType: 'audio/video',\r\n    };\r\n};\r\n\r\n/**\r\n * Return template context for insert media.\r\n *\r\n * @param {object} props\r\n * @returns {object}\r\n */\r\nexport const insertMediaThumbnailTemplateContext = (props) => {\r\n    return {\r\n        elementid: props.editor.id,\r\n        showDropzone: props.canShowDropZone,\r\n        showImageFilePicker: props.canShowImageFilePicker,\r\n        bodyTemplate: Selectors.EMBED.template.body.insertMediaBody,\r\n        footerTemplate: Selectors.EMBED.template.footer.insertMediaFooter,\r\n        fileType: 'image',\r\n        selector: Selectors.EMBED.type,\r\n    };\r\n};\r\n\r\n/**\r\n * Return selected media type and element.\r\n *\r\n * @param {editor} editor\r\n * @returns {Array}\r\n */\r\nexport const getSelectedMediaElement = (editor) => {\r\n    let mediaType = null;\r\n    let selectedMedia = null;\r\n    const mediaElm = editor.selection.getNode();\r\n\r\n    if (!mediaElm) {\r\n        mediaType = null;\r\n        selectedMedia = null;\r\n    } else if (mediaElm.nodeName.toLowerCase() === 'video' || mediaElm.nodeName.toLowerCase() === 'audio') {\r\n        mediaType = mediaElm.nodeName.toLowerCase();\r\n        selectedMedia = mediaElm;\r\n    } else if (mediaElm.querySelector('video')) {\r\n        mediaType = 'video';\r\n        selectedMedia = mediaElm.querySelector('video');\r\n    } else if (mediaElm.querySelector('audio')) {\r\n        mediaType = 'audio';\r\n        selectedMedia = mediaElm.querySelector('audio');\r\n    } else if (mediaElm.nodeName.toLowerCase() === 'a') {\r\n        selectedMedia = mediaElm;\r\n    }\r\n\r\n    return [mediaType, selectedMedia];\r\n};\r\n\r\n/**\r\n * Returns result of media filtering.\r\n *\r\n * @param {string} url\r\n * @param {string} contextId\r\n * @returns {string}\r\n */\r\nexport const fetchPreview = async(url, contextId) => {\r\n    const request = {\r\n        methodname: 'tiny_media_preview',\r\n        args: {\r\n            contextid: contextId, // Use the system one.\r\n            content: url,\r\n        }\r\n    };\r\n    const responseObj = await Ajax.call([request])[0];\r\n    return responseObj.content;\r\n};\r\n\r\n/**\r\n * Returns media type.\r\n *\r\n * @param {string} url\r\n * @returns {string|null}\r\n */\r\nexport const checkMediaType = async(url) => {\r\n    try {\r\n        const response = await fetch(url, {method: 'HEAD'});\r\n        const contentType = response.headers.get('Content-type');\r\n\r\n        if (!contentType) {\r\n            return null;\r\n        }\r\n\r\n        if (contentType.startsWith('video/')) {\r\n            return 'video';\r\n        } else if (contentType.startsWith('audio/')) {\r\n            return 'audio';\r\n        }\r\n\r\n        return null;\r\n    } catch (e) {\r\n        return null;\r\n    }\r\n};\r\n\r\n/**\r\n * Returns media title.\r\n *\r\n * @param {string} url\r\n * @param {object} props\r\n * @returns {string|null} String of media title.\r\n */\r\nexport const getMediaTitle = async(url, props) => {\r\n    const extension = url.split('.').pop().split('?')[0];\r\n    if (props.acceptedMediaTypes.includes(`.${extension}`)) {\r\n        return getFileName(url);\r\n    }\r\n\r\n    return null;\r\n};\r\n\r\n/**\r\n * Return template context for media details.\r\n *\r\n * @param {object} props\r\n * @returns {object}\r\n */\r\nexport const mediaDetailsTemplateContext = async(props) => {\r\n    const context = {\r\n        bodyTemplate: Selectors.EMBED.template.body.mediaDetailsBody,\r\n        footerTemplate: Selectors.EMBED.template.footer.mediaDetailsFooter,\r\n        isLink: (props.mediaType === 'link'),\r\n        isVideo: (props.mediaType === 'video'),\r\n        showControl: (props.mediaType === 'video' || props.mediaType === 'audio'),\r\n        isUpdating: props.isUpdating,\r\n        isNewFileOrLinkUpload: (props.newMediaLink || props.newFileUpload),\r\n        selector: Selectors.EMBED.type,\r\n    };\r\n\r\n    return {...context, ...props};\r\n};\r\n\r\n/**\r\n * Get help strings.\r\n *\r\n * @returns {object}\r\n */\r\nexport const getHelpStrings = async() => {\r\n    const [\r\n        subtitles,\r\n        captions,\r\n        descriptions,\r\n        chapters,\r\n        metadata,\r\n        customsize,\r\n        linkcustomsize,\r\n    ] = await getStrings([\r\n        'subtitles_help',\r\n        'captions_help',\r\n        'descriptions_help',\r\n        'chapters_help',\r\n        'metadata_help',\r\n        'customsize_help',\r\n        'linkcustomsize_help',\r\n    ].map((key) => ({\r\n        key,\r\n        component,\r\n    })));\r\n\r\n    return {\r\n        subtitles,\r\n        captions,\r\n        descriptions,\r\n        chapters,\r\n        metadata,\r\n        customsize,\r\n        linkcustomsize,\r\n    };\r\n};\r\n\r\n/**\r\n * Get current moodle languages.\r\n *\r\n * @param {editor} editor\r\n * @returns {object}\r\n */\r\nexport const prepareMoodleLang = (editor) => {\r\n    const moodleLangs = getMoodleLang(editor);\r\n    const currentLanguage = getCurrentLanguage(editor);\r\n\r\n    const installed = Object.entries(moodleLangs.installed).map(([code, lang]) => ({\r\n        lang,\r\n        code,\r\n        \"default\": code === currentLanguage,\r\n    }));\r\n\r\n    const available = Object.entries(moodleLangs.available).map(([code, lang]) => ({\r\n        lang,\r\n        code,\r\n        \"default\": code === currentLanguage,\r\n    }));\r\n\r\n    return {\r\n        installed,\r\n        available,\r\n    };\r\n};\r\n\r\n/**\r\n * Return moodle lang.\r\n *\r\n * @param {string} subtitleLang\r\n * @param {editor} editor\r\n * @returns {object|null}\r\n */\r\nexport const getMoodleLangObj = (subtitleLang, editor) => {\r\n    const {available} = getMoodleLang(editor);\r\n\r\n    if (available[subtitleLang]) {\r\n        return {\r\n            lang: subtitleLang,\r\n            code: available[subtitleLang],\r\n        };\r\n    }\r\n\r\n    return null;\r\n};\r\n\r\n/**\r\n * Get media data from the inserted media.\r\n *\r\n * @param {object} props\r\n * @returns {object}\r\n */\r\nexport const getEmbeddedMediaDetails = (props) => {\r\n    const tracks = {\r\n        subtitles: [],\r\n        captions: [],\r\n        descriptions: [],\r\n        chapters: [],\r\n        metadata: []\r\n    };\r\n\r\n    const mediaMetadata = props.root.querySelectorAll(Selectors.EMBED.elements.mediaMetadataTabPane);\r\n    mediaMetadata.forEach(metaData => {\r\n        const trackElements = metaData.querySelectorAll(Selectors.EMBED.elements.track);\r\n        trackElements.forEach(track => {\r\n            tracks[metaData.dataset.trackKind].push({\r\n                src: track.querySelector(Selectors.EMBED.elements.url).value,\r\n                srclang: track.querySelector(Selectors.EMBED.elements.trackLang).value,\r\n                label: track.querySelector(Selectors.EMBED.elements.trackLabel).value,\r\n                defaultTrack: track.querySelector(Selectors.EMBED.elements.trackDefault).checked,\r\n            });\r\n        });\r\n    });\r\n\r\n    const querySelector = (element) => props.root.querySelector(element);\r\n    const mediaDataProps = {};\r\n    mediaDataProps.media = {\r\n        type: props.mediaType,\r\n        sources: props.media,\r\n        poster: props.media.poster ?? null,\r\n        title: querySelector(Selectors.EMBED.elements.title).value,\r\n        width: querySelector(Selectors.EMBED.elements.width).value,\r\n        height: querySelector(Selectors.EMBED.elements.height).value,\r\n        autoplay: querySelector(Selectors.EMBED.elements.mediaAutoplay).checked,\r\n        loop: querySelector(Selectors.EMBED.elements.mediaLoop).checked,\r\n        muted: querySelector(Selectors.EMBED.elements.mediaMute).checked,\r\n        controls: querySelector(Selectors.EMBED.elements.mediaControl).checked,\r\n        tracks,\r\n    };\r\n    mediaDataProps.link = false;\r\n    return mediaDataProps;\r\n};\r\n\r\n/**\r\n * Check for video/audio attributes.\r\n *\r\n * @param {HTMLElement} elem\r\n * @param {string} attr Attribute name\r\n * @returns {boolean}\r\n */\r\nexport const hasAudioVideoAttr = (elem, attr) => {\r\n    // As explained in MDL-64175, some OS (like Ubuntu), are removing the value for these attributes.\r\n    // So in order to check if attr=\"true\", we need to check if the attribute exists and if the value is empty or true.\r\n    return (elem.hasAttribute(attr) && (elem.getAttribute(attr) || elem.getAttribute(attr) === ''));\r\n};\r\n"],"names":["props","mediaType","showDropzone","canShowDropZone","showFilePicker","canShowFilePicker","fileType","elementid","editor","id","showImageFilePicker","canShowImageFilePicker","bodyTemplate","Selectors","EMBED","template","body","insertMediaBody","footerTemplate","footer","insertMediaFooter","selector","type","selectedMedia","mediaElm","selection","getNode","nodeName","toLowerCase","querySelector","async","url","contextId","request","methodname","args","contextid","content","Ajax","call","contentType","fetch","method","headers","get","startsWith","e","extension","split","pop","acceptedMediaTypes","includes","mediaDetailsBody","mediaDetailsFooter","isLink","isVideo","showControl","isUpdating","isNewFileOrLinkUpload","newMediaLink","newFileUpload","subtitles","captions","descriptions","chapters","metadata","customsize","linkcustomsize","map","key","component","moodleLangs","currentLanguage","installed","Object","entries","_ref","code","lang","available","_ref2","subtitleLang","tracks","root","querySelectorAll","elements","mediaMetadataTabPane","forEach","metaData","track","dataset","trackKind","push","src","value","srclang","trackLang","label","trackLabel","defaultTrack","trackDefault","checked","element","mediaDataProps","media","sources","poster","title","width","height","autoplay","mediaAutoplay","loop","mediaLoop","muted","mediaMute","controls","mediaControl","link","elem","attr","hasAttribute","getAttribute"],"mappings":";;;;;;;;;+hBAsC2CA,QAChC,CACHC,UAAWD,MAAMC,UACjBC,aAAcF,MAAMG,gBACpBC,eAAgBJ,MAAMK,kBACtBC,SAAU,6DAUkCN,QACzC,CACHO,UAAWP,MAAMQ,OAAOC,GACxBP,aAAcF,MAAMG,gBACpBO,oBAAqBV,MAAMW,uBAC3BC,aAAcC,mBAAUC,MAAMC,SAASC,KAAKC,gBAC5CC,eAAgBL,mBAAUC,MAAMC,SAASI,OAAOC,kBAChDd,SAAU,QACVe,SAAUR,mBAAUC,MAAMQ,wCAUMd,aAChCP,UAAY,KACZsB,cAAgB,WACdC,SAAWhB,OAAOiB,UAAUC,iBAE7BF,SAG0C,UAApCA,SAASG,SAASC,eAAiE,UAApCJ,SAASG,SAASC,eACxE3B,UAAYuB,SAASG,SAASC,cAC9BL,cAAgBC,UACTA,SAASK,cAAc,UAC9B5B,UAAY,QACZsB,cAAgBC,SAASK,cAAc,UAChCL,SAASK,cAAc,UAC9B5B,UAAY,QACZsB,cAAgBC,SAASK,cAAc,UACI,MAApCL,SAASG,SAASC,gBACzBL,cAAgBC,WAZhBvB,UAAY,KACZsB,cAAgB,MAcb,CAACtB,UAAWsB,sCAUKO,MAAMC,IAAKC,mBAC7BC,QAAU,CACZC,WAAY,qBACZC,KAAM,CACFC,UAAWJ,UACXK,QAASN,mBAGSO,cAAKC,KAAK,CAACN,UAAU,IAC5BI,iCASOP,MAAAA,gBAGhBU,mBADiBC,MAAMV,IAAK,CAACW,OAAQ,UACdC,QAAQC,IAAI,uBAEpCJ,YAIDA,YAAYK,WAAW,UAChB,QACAL,YAAYK,WAAW,UACvB,QAGJ,KATI,KAUb,MAAOC,UACE,8BAWchB,MAAMC,IAAK/B,eAC9B+C,UAAYhB,IAAIiB,MAAM,KAAKC,MAAMD,MAAM,KAAK,UAC9ChD,MAAMkD,mBAAmBC,oBAAaJ,aAC/B,wBAAYhB,KAGhB,2CASgCD,MAAAA,QAYhC,IAXS,CACZlB,aAAcC,mBAAUC,MAAMC,SAASC,KAAKoC,iBAC5ClC,eAAgBL,mBAAUC,MAAMC,SAASI,OAAOkC,mBAChDC,OAA6B,SAApBtD,MAAMC,UACfsD,QAA8B,UAApBvD,MAAMC,UAChBuD,YAAkC,UAApBxD,MAAMC,WAA6C,UAApBD,MAAMC,UACnDwD,WAAYzD,MAAMyD,WAClBC,sBAAwB1D,MAAM2D,cAAgB3D,MAAM4D,cACpDvC,SAAUR,mBAAUC,MAAMQ,SAGPtB,gCAQG8B,gBAEtB+B,UACAC,SACAC,aACAC,SACAC,SACAC,WACAC,sBACM,mBAAW,CACjB,iBACA,gBACA,oBACA,gBACA,gBACA,kBACA,uBACFC,KAAKC,OACHA,IAAAA,IACAC,UAAAA,6BAGG,CACHT,UAAAA,UACAC,SAAAA,SACAC,aAAAA,aACAC,SAAAA,SACAC,SAAAA,SACAC,WAAAA,WACAC,eAAAA,4CAU0B3D,eACxB+D,aAAc,0BAAc/D,QAC5BgE,iBAAkB,+BAAmBhE,cAcpC,CACHiE,UAbcC,OAAOC,QAAQJ,YAAYE,WAAWL,KAAIQ,WAAEC,KAAMC,iBAAW,CAC3EA,KAAAA,KACAD,KAAAA,aACWA,OAASL,oBAWpBO,UARcL,OAAOC,QAAQJ,YAAYQ,WAAWX,KAAIY,YAAEH,KAAMC,kBAAW,CAC3EA,KAAAA,KACAD,KAAAA,aACWA,OAASL,gDAgBI,CAACS,aAAczE,gBACrCuE,UAACA,YAAa,0BAAcvE,eAE9BuE,UAAUE,cACH,CACHH,KAAMG,aACNJ,KAAME,UAAUE,eAIjB,uCAS6BjF,sCAC9BkF,OAAS,CACXrB,UAAW,GACXC,SAAU,GACVC,aAAc,GACdC,SAAU,GACVC,SAAU,IAGQjE,MAAMmF,KAAKC,iBAAiBvE,mBAAUC,MAAMuE,SAASC,sBAC7DC,SAAQC,WACIA,SAASJ,iBAAiBvE,mBAAUC,MAAMuE,SAASI,OAC3DF,SAAQE,QAClBP,OAAOM,SAASE,QAAQC,WAAWC,KAAK,CACpCC,IAAKJ,MAAM5D,cAAchB,mBAAUC,MAAMuE,SAAStD,KAAK+D,MACvDC,QAASN,MAAM5D,cAAchB,mBAAUC,MAAMuE,SAASW,WAAWF,MACjEG,MAAOR,MAAM5D,cAAchB,mBAAUC,MAAMuE,SAASa,YAAYJ,MAChEK,aAAcV,MAAM5D,cAAchB,mBAAUC,MAAMuE,SAASe,cAAcC,sBAK/ExE,cAAiByE,SAAYtG,MAAMmF,KAAKtD,cAAcyE,SACtDC,eAAiB,UACvBA,eAAeC,MAAQ,CACnBlF,KAAMtB,MAAMC,UACZwG,QAASzG,MAAMwG,MACfE,mCAAQ1G,MAAMwG,MAAME,0DAAU,KAC9BC,MAAO9E,cAAchB,mBAAUC,MAAMuE,SAASsB,OAAOb,MACrDc,MAAO/E,cAAchB,mBAAUC,MAAMuE,SAASuB,OAAOd,MACrDe,OAAQhF,cAAchB,mBAAUC,MAAMuE,SAASwB,QAAQf,MACvDgB,SAAUjF,cAAchB,mBAAUC,MAAMuE,SAAS0B,eAAeV,QAChEW,KAAMnF,cAAchB,mBAAUC,MAAMuE,SAAS4B,WAAWZ,QACxDa,MAAOrF,cAAchB,mBAAUC,MAAMuE,SAAS8B,WAAWd,QACzDe,SAAUvF,cAAchB,mBAAUC,MAAMuE,SAASgC,cAAchB,QAC/DnB,OAAAA,QAEJqB,eAAee,MAAO,EACff,2CAUsB,CAACgB,KAAMC,OAG5BD,KAAKE,aAAaD,QAAUD,KAAKG,aAAaF,OAAqC,KAA5BD,KAAKG,aAAaF"}