{"version":3,"file":"embedthumbnailinsert.min.js","sources":["../../src/embed/embedthumbnailinsert.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Tiny media plugin embed thumbnail upload class.\r\n *\r\n * This handles the embed thumbnail upload using drag-drop.\r\n *\r\n * @module      tiny_media/embed/embedthumbnailinsert\r\n * @copyright   2024 Stevani Andolo <stevani@hotmail.com.au>\r\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport Selectors from '../selectors';\r\nimport Dropzone from 'core/dropzone';\r\nimport uploadFile from 'editor_tiny/uploader';\r\nimport {prefetchStrings} from 'core/prefetch';\r\nimport {getStrings} from 'core/str';\r\nimport {component} from \"../common\";\r\nimport {\r\n    showElements,\r\n    startMediaLoading,\r\n    stopMediaLoading,\r\n    setPropertiesFromData,\r\n    body,\r\n    footer,\r\n} from '../helpers';\r\nimport {EmbedThumbnailPreview} from './embedthumbnailpreview';\r\nimport {EmbedHandler} from './embedhandler';\r\nimport {displayFilepicker} from 'editor_tiny/utils';\r\n\r\nprefetchStrings(component, [\r\n    'insertmediathumbnail',\r\n    'uploading',\r\n    'loadingembedthumbnail',\r\n    'addmediathumbnaildrop',\r\n]);\r\n\r\nexport class EmbedThumbnailInsert {\r\n\r\n    constructor(data) {\r\n        setPropertiesFromData(this, data); // Creates dynamic properties based on \"data\" param.\r\n    }\r\n\r\n    /**\r\n     * Init the dropzone and lang strings.\r\n     *\r\n     * @param {object} mediaData Object of selected media data\r\n     */\r\n    init = async(mediaData) => {\r\n        this.mediaData = mediaData; // Current selected media data passed from embedPreview.\r\n        const langStringKeys = [\r\n            'insertmediathumbnail',\r\n            'uploading',\r\n            'loadingembedthumbnail',\r\n            'addmediathumbnaildrop',\r\n        ];\r\n        const langStringvalues = await getStrings([...langStringKeys].map((key) => ({key, component})));\r\n        this.langStrings = Object.fromEntries(langStringKeys.map((key, index) => [key, langStringvalues[index]]));\r\n        this.currentModal.uploadThumbnailModal.setTitle(this.langStrings.insertmediathumbnail);\r\n\r\n        // Let's init the dropzone if canShowDropZone is true.\r\n        if (this.canShowDropZone) {\r\n            const dropZoneEle = document.querySelector(Selectors.EMBED.elements.dropzoneContainer);\r\n            const dropZone = new Dropzone(\r\n                dropZoneEle,\r\n                this.acceptedImageTypes,\r\n                files => {\r\n                    this.handleUploadedFile(files);\r\n                }\r\n            );\r\n            dropZone.setLabel(this.langStrings.addmediathumbnaildrop);\r\n            dropZone.init();\r\n        }\r\n\r\n        this.registerInsertMediaThumbnailEvents(this.thumbnailModalRoot);\r\n    };\r\n\r\n    /**\r\n     * Load and display a preview thumbnail based on the provided URL, and handles thumbnail loading events.\r\n     *\r\n     * @param {string} url - The URL of the thumbnail to load and display.\r\n     */\r\n    loadPreviewThumbnail = (url) => {\r\n        this.media.poster = url;\r\n\r\n        let templateContext = {\r\n            bodyTemplate: Selectors.EMBED.template.body.mediaThumbnailBody,\r\n            footerTemplate: Selectors.EMBED.template.footer.mediaThumbnailFooter,\r\n            selector: Selectors.EMBED.type,\r\n        };\r\n\r\n        Promise.all([body(templateContext, this.thumbnailModalRoot), footer(templateContext, this.thumbnailModalRoot)])\r\n            .then(() => {\r\n                const mediaThumbnail = new EmbedThumbnailPreview(this);\r\n                mediaThumbnail.init(this.mediaData);\r\n                return;\r\n            })\r\n            .catch(error => {\r\n                window.console.log(error);\r\n            });\r\n    };\r\n\r\n    /**\r\n     * Handles media preview on file picker callback.\r\n     *\r\n     * @param {object} params Object of uploaded file\r\n     */\r\n    filePickerCallback = (params) => {\r\n        if (params.url) {\r\n            this.loadPreviewThumbnail(params.url);\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Updates the content of the loader icon.\r\n     *\r\n     * @param {HTMLElement} root - The root element containing the loader icon.\r\n     * @param {object} langStrings - An object containing language strings.\r\n     * @param {number|null} progress - The progress percentage (optional).\r\n     */\r\n    updateLoaderIcon = (root, langStrings, progress = null) => {\r\n        const loaderIconState = root.querySelector(Selectors.EMBED.elements.loaderIconContainer + ' div');\r\n        loaderIconState.innerHTML = (progress !== null) ?\r\n                               `${langStrings.uploading} ${Math.round(progress)}%` :\r\n                               langStrings.loadingembedthumbnail;\r\n    };\r\n\r\n    /**\r\n     * Handles changes in the media URL input field and loads a preview of the media if the URL has changed.\r\n     */\r\n    urlChanged() {\r\n        const url = this.thumbnailModalRoot.querySelector(Selectors.EMBED.elements.fromUrl).value;\r\n        if (url && url !== this.currentUrl) {\r\n            this.loadPreviewThumbnail(url);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Handles the uploaded file, initiates the upload process, and updates the UI during the upload.\r\n     *\r\n     * @param {FileList} files - The list of files to upload (usually from a file input field).\r\n     * @returns {Promise<void>} A promise that resolves when the file is uploaded and processed.\r\n     */\r\n    handleUploadedFile = async(files) => {\r\n        try {\r\n            startMediaLoading(this.thumbnailModalRoot, Selectors.EMBED.type);\r\n            const fileURL = await uploadFile(this.editor, 'image', files[0], files[0].name, (progress) => {\r\n                this.updateLoaderIcon(this.thumbnailModalRoot, this.langStrings, progress);\r\n            });\r\n\r\n            // Set the loader icon content to \"loading\" after the file upload completes.\r\n            this.updateLoaderIcon(this.thumbnailModalRoot, this.langStrings);\r\n            this.filePickerCallback({url: fileURL});\r\n        } catch (error) {\r\n            // Handle the error.\r\n            const urlWarningLabelEle = this.thumbnailModalRoot.querySelector(Selectors.EMBED.elements.urlWarning);\r\n            urlWarningLabelEle.innerHTML = error.error !== undefined ? error.error : error;\r\n            showElements(Selectors.EMBED.elements.urlWarning, this.thumbnailModalRoot);\r\n            stopMediaLoading(this.thumbnailModalRoot, Selectors.EMBED.type);\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Registers events for insert thumbnail modal.\r\n     *\r\n     * @param {HTMLElement} root - The root element containing the loader icon.\r\n     */\r\n    registerInsertMediaThumbnailEvents = (root) => {\r\n        const urlEle = root.querySelector(Selectors.EMBED.elements.fromUrl);\r\n        if (urlEle) {\r\n            urlEle.addEventListener('input', () => {\r\n                (new EmbedHandler(this)).toggleUrlButton(urlEle, this.thumbnailModalRoot);\r\n            });\r\n        }\r\n\r\n        // Handles add media url.\r\n        const addUrlEle = root.querySelector(Selectors.EMBED.actions.addUrl);\r\n        if (addUrlEle) {\r\n            addUrlEle.addEventListener('click', () => {\r\n                startMediaLoading(this.thumbnailModalRoot, Selectors.EMBED.type);\r\n                this.urlChanged();\r\n            });\r\n        }\r\n\r\n        // Handle repository browsing.\r\n        const imageBrowser = root.querySelector(Selectors.IMAGE.actions.imageBrowser);\r\n        if (imageBrowser) {\r\n            imageBrowser.addEventListener('click', async(e) => {\r\n                e.preventDefault();\r\n                const params = await displayFilepicker(this.editor, 'image');\r\n                this.filePickerCallback(params);\r\n            });\r\n        }\r\n    };\r\n}\r\n"],"names":["component","constructor","data","async","mediaData","langStringKeys","langStringvalues","map","key","langStrings","Object","fromEntries","index","currentModal","uploadThumbnailModal","setTitle","this","insertmediathumbnail","canShowDropZone","dropZoneEle","document","querySelector","Selectors","EMBED","elements","dropzoneContainer","dropZone","Dropzone","acceptedImageTypes","files","handleUploadedFile","setLabel","addmediathumbnaildrop","init","registerInsertMediaThumbnailEvents","thumbnailModalRoot","url","media","poster","templateContext","bodyTemplate","template","body","mediaThumbnailBody","footerTemplate","footer","mediaThumbnailFooter","selector","type","Promise","all","then","EmbedThumbnailPreview","catch","error","window","console","log","params","loadPreviewThumbnail","root","progress","loaderIconState","loaderIconContainer","innerHTML","uploading","Math","round","loadingembedthumbnail","fileURL","editor","name","updateLoaderIcon","filePickerCallback","urlWarning","undefined","urlEle","fromUrl","addEventListener","EmbedHandler","toggleUrlButton","addUrlEle","actions","addUrl","urlChanged","imageBrowser","IMAGE","e","preventDefault","value","currentUrl"],"mappings":"01BA2CgBA,kBAAW,CACvB,uBACA,YACA,wBACA,8DAKAC,YAAYC,mCASLC,MAAAA,iBACEC,UAAYA,gBACXC,eAAiB,CACnB,uBACA,YACA,wBACA,yBAEEC,uBAAyB,mBAAW,IAAID,gBAAgBE,KAAKC,OAAUA,IAAAA,IAAKR,UAAAA,+BAC7ES,YAAcC,OAAOC,YAAYN,eAAeE,KAAI,CAACC,IAAKI,QAAU,CAACJ,IAAKF,iBAAiBM,gBAC3FC,aAAaC,qBAAqBC,SAASC,KAAKP,YAAYQ,sBAG7DD,KAAKE,gBAAiB,OAChBC,YAAcC,SAASC,cAAcC,mBAAUC,MAAMC,SAASC,mBAC9DC,SAAW,IAAIC,kBACjBR,YACAH,KAAKY,oBACLC,aACSC,mBAAmBD,UAGhCH,SAASK,SAASf,KAAKP,YAAYuB,uBACnCN,SAASO,YAGRC,mCAAmClB,KAAKmB,oEAQzBC,WACfC,MAAMC,OAASF,QAEhBG,gBAAkB,CAClBC,aAAclB,mBAAUC,MAAMkB,SAASC,KAAKC,mBAC5CC,eAAgBtB,mBAAUC,MAAMkB,SAASI,OAAOC,qBAChDC,SAAUzB,mBAAUC,MAAMyB,MAG9BC,QAAQC,IAAI,EAAC,iBAAKX,gBAAiBvB,KAAKmB,qBAAqB,mBAAOI,gBAAiBvB,KAAKmB,sBACrFgB,MAAK,KACqB,IAAIC,6CAAsBpC,MAClCiB,KAAKjB,KAAKZ,cAG5BiD,OAAMC,QACHC,OAAOC,QAAQC,IAAIH,wDASTI,SACdA,OAAOtB,UACFuB,qBAAqBD,OAAOtB,iDAWtB,SAACwB,KAAMnD,iBAAaoD,gEAAW,WACxCC,gBAAkBF,KAAKvC,cAAcC,mBAAUC,MAAMC,SAASuC,oBAAsB,QAC1FD,gBAAgBE,UAA0B,OAAbH,mBACHpD,YAAYwD,sBAAaC,KAAKC,MAAMN,eACvCpD,YAAY2D,oEAmBlBjE,MAAAA,2CAEKa,KAAKmB,mBAAoBb,mBAAUC,MAAMyB,YACrDqB,cAAgB,qBAAWrD,KAAKsD,OAAQ,QAASzC,MAAM,GAAIA,MAAM,GAAG0C,MAAOV,gBACxEW,iBAAiBxD,KAAKmB,mBAAoBnB,KAAKP,YAAaoD,kBAIhEW,iBAAiBxD,KAAKmB,mBAAoBnB,KAAKP,kBAC/CgE,mBAAmB,CAACrC,IAAKiC,UAChC,MAAOf,OAEsBtC,KAAKmB,mBAAmBd,cAAcC,mBAAUC,MAAMC,SAASkD,YACvEV,eAA4BW,IAAhBrB,MAAMA,MAAsBA,MAAMA,MAAQA,gCAC5DhC,mBAAUC,MAAMC,SAASkD,WAAY1D,KAAKmB,kDACtCnB,KAAKmB,mBAAoBb,mBAAUC,MAAMyB,qEAS5BY,aAC5BgB,OAAShB,KAAKvC,cAAcC,mBAAUC,MAAMC,SAASqD,SACvDD,QACAA,OAAOE,iBAAiB,SAAS,SACxBC,2BAAa/D,MAAOgE,gBAAgBJ,OAAQ5D,KAAKmB,6BAKxD8C,UAAYrB,KAAKvC,cAAcC,mBAAUC,MAAM2D,QAAQC,QACzDF,WACAA,UAAUH,iBAAiB,SAAS,oCACd9D,KAAKmB,mBAAoBb,mBAAUC,MAAMyB,WACtDoC,sBAKPC,aAAezB,KAAKvC,cAAcC,mBAAUgE,MAAMJ,QAAQG,cAC5DA,cACAA,aAAaP,iBAAiB,SAAS3E,MAAAA,IACnCoF,EAAEC,uBACI9B,aAAe,4BAAkB1C,KAAKsD,OAAQ,cAC/CG,mBAAmBf,iDAtJV1C,KAAMd,MA0FhCkF,mBACUhD,IAAMpB,KAAKmB,mBAAmBd,cAAcC,mBAAUC,MAAMC,SAASqD,SAASY,MAChFrD,KAAOA,MAAQpB,KAAK0E,iBACf/B,qBAAqBvB"}