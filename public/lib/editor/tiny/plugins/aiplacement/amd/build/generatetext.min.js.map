{"version":3,"file":"generatetext.min.js","sources":["../src/generatetext.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Tiny AI generate text.\r\n *\r\n * @module      tiny_aiplacement/generatetext\r\n * @copyright   2024 Matt Porritt <matt.porritt@moodle.com>\r\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport TextModal from './textmodal';\r\nimport Ajax from 'core/ajax';\r\nimport {getString} from 'core/str';\r\nimport Templates from 'core/templates';\r\nimport AIHelper from 'core_ai/helper';\r\nimport {getContextId} from './options';\r\nimport TinyAiTextMarker from './textmark';\r\nimport GenerateBase from './generatebase';\r\n\r\nexport default class GenerateText extends GenerateBase {\r\n    SELECTORS = {\r\n        GENERATEBUTTON: () => `[id=\"${this.editor.id}_tiny_aiplacement_generatebutton\"]`,\r\n        PROMPTAREA: () => `[id=\"${this.editor.id}_tiny_aiplacement_textprompt\"]`,\r\n        TEXTCONTAINER: () => `[id=\"${this.editor.id}_tiny_aiplacement_generate_text\"]`,\r\n        GENERATEDRESPONSE: () => `[id=\"${this.editor.id}_tiny_aiplacement_textresponse\"]`,\r\n        INSERTBTN: '[data-action=\"inserter\"]',\r\n        BACKTBTN: '[data-action=\"back\"]',\r\n    };\r\n\r\n    getModalClass() {\r\n        return TextModal;\r\n    }\r\n\r\n    /**\r\n     * Handle click events within the text modal.\r\n     *\r\n     * @param {Event} e - The click event object.\r\n     * @param {HTMLElement} root - The root element of the modal.\r\n     */\r\n    handleContentModalClick(e, root) {\r\n        const actions = {\r\n            generate: () => this.handleSubmit(root, e.target),\r\n            inserter: () => this.handleInsert(root, e.target),\r\n            cancel: () => this.modalObject.destroy(),\r\n            back: () => {\r\n                this.modalObject.destroy();\r\n                this.displayContentModal();\r\n            },\r\n        };\r\n\r\n        const actionKey = Object.keys(actions).find(key => e.target.closest(`[data-action=\"${key}\"]`));\r\n        if (actionKey) {\r\n            e.preventDefault();\r\n            actions[actionKey]();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Set up the prompt area in the modal, adding necessary event listeners.\r\n     *\r\n     * @param {HTMLElement} root - The root element of the modal.\r\n     */\r\n    setupPromptArea(root) {\r\n        const generateBtn = root.querySelector(this.SELECTORS.GENERATEBUTTON());\r\n        const promptArea = root.querySelector(this.SELECTORS.PROMPTAREA());\r\n\r\n        promptArea.addEventListener('input', () => {\r\n            generateBtn.disabled = promptArea.value.trim() === '';\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Handle the submit action.\r\n     *\r\n     * @param {Object} root The root element of the modal.\r\n     * @param {Object} submitBtn The submit button element.\r\n     */\r\n    async handleSubmit(root, submitBtn) {\r\n        await this.displayLoading(root, submitBtn);\r\n\r\n        const requestArgs = this.getRequestArgs(root);\r\n        const request = {\r\n            methodname: 'aiplacement_editor_generate_text',\r\n            args: requestArgs\r\n        };\r\n\r\n        try {\r\n            this.responseObj = await Ajax.call([request])[0];\r\n            if (this.responseObj.errorcode) {\r\n                this.handleGenerationError(root, submitBtn, this.responseObj.error, this.responseObj.errormessage);\r\n            } else {\r\n                await this.displayGeneratedText(root);\r\n                await this.hideLoading(root, submitBtn);\r\n                // Focus the container for accessibility.\r\n                const textDisplayContainer = root.querySelector(this.SELECTORS.TEXTCONTAINER());\r\n                textDisplayContainer.focus();\r\n            }\r\n        } catch (error) {\r\n            this.handleGenerationError(root, submitBtn);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Handle the insert action.\r\n     *\r\n     * @param {Object} root The root element of the modal.\r\n     * @param {HTMLElement} submitBtn - The submit button element.\r\n     */\r\n    async handleInsert(root, submitBtn) {\r\n        await this.displayLoading(root, submitBtn);\r\n\r\n        // Update the generated response with the content from the form.\r\n        // In case the user has edited the response.\r\n        const generatedResponseDiv = root.querySelector(this.SELECTORS.GENERATEDRESPONSE());\r\n\r\n        // Wrap the edited sections in the response with tags.\r\n        // This is so we can differentiate between the edited sections and the generated content.\r\n        const wrappedEditedResponse = await TinyAiTextMarker.wrapEditedSections(\r\n            this.responseObj.generatedcontent,\r\n            generatedResponseDiv.value)\r\n        ;\r\n\r\n        // Replace double line breaks with <br> and with </p><p> for paragraphs and removed any markdown.\r\n        this.responseObj.editedtext = AIHelper.formatResponse(wrappedEditedResponse);\r\n\r\n        // Generate the HTML for the response.\r\n        const formattedResponse = await Templates.render('tiny_aiplacement/textinsert', this.responseObj);\r\n\r\n        // Insert the response into the editor.\r\n        this.editor.insertContent(formattedResponse);\r\n        this.editor.execCommand('mceRepaint');\r\n        this.editor.windowManager.close();\r\n\r\n        // Close the modal and return to the editor.\r\n        this.modalObject.hide();\r\n    }\r\n\r\n    /**\r\n     * Handle a generation error.\r\n     *\r\n     * @param {Object} root The root element of the modal.\r\n     * @param {Object} submitBtn The submit button element.\r\n     * @param {String} error The error name to display.\r\n     * @param {String} errorMessage The error message to display.\r\n     */\r\n    async handleGenerationError(root, submitBtn, error = '', errorMessage = '') {\r\n        if (!error) {\r\n            // Get the default error message.\r\n            error = await getString('error:defaultname', 'core_ai');\r\n            errorMessage = await getString('error:defaultmessage', 'core_ai');\r\n        }\r\n        this.modalObject.setBody(Templates.render('tiny_aiplacement/modalbodyerror',\r\n            {'error': error, 'errorMessage': errorMessage}));\r\n        const backBtn = root.querySelector(this.SELECTORS.BACKTBTN);\r\n        const generateBtn = root.querySelector(this.SELECTORS.GENERATEBUTTON());\r\n        backBtn.classList.remove('hidden');\r\n        generateBtn.classList.add('hidden');\r\n        await this.hideLoading(root, submitBtn);\r\n        // Focus the back button for accessibility.\r\n        backBtn.focus();\r\n    }\r\n\r\n    /**\r\n     * Display the generated text in the modal.\r\n     *\r\n     * @param {HTMLElement} root - The root element of the modal.\r\n     */\r\n    async displayGeneratedText(root) {\r\n        const textDisplayContainer = root.querySelector(this.SELECTORS.TEXTCONTAINER());\r\n        const insertBtn = root.querySelector(this.SELECTORS.INSERTBTN);\r\n\r\n        // Render the textarea template and insert it into the modal.\r\n        textDisplayContainer.innerHTML = await Templates.render('tiny_aiplacement/textarea', {\r\n            elementid: this.editor.id,\r\n            text: this.responseObj.generatedcontent,\r\n        });\r\n        const textareaElement = root.querySelector(this.SELECTORS.GENERATEDRESPONSE());\r\n\r\n        return new Promise((resolve, reject) => {\r\n            if (textareaElement.textLength > 0) {\r\n                insertBtn.classList.remove('hidden');\r\n                textareaElement.focus();\r\n                resolve();\r\n            } else {\r\n                reject();\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Get the request args for the generated text.\r\n     *\r\n     * @param {Object} root The root element of the modal.\r\n     */\r\n    getRequestArgs(root) {\r\n        const contextId = getContextId(this.editor);\r\n        const promptText = root.querySelector(this.SELECTORS.PROMPTAREA()).value;\r\n\r\n        return {\r\n            contextid: contextId,\r\n            prompttext: promptText\r\n        };\r\n    }\r\n}\r\n"],"names":["GenerateText","GenerateBase","GENERATEBUTTON","this","editor","id","PROMPTAREA","TEXTCONTAINER","GENERATEDRESPONSE","INSERTBTN","BACKTBTN","getModalClass","TextModal","handleContentModalClick","e","root","actions","generate","handleSubmit","target","inserter","handleInsert","cancel","modalObject","destroy","back","displayContentModal","actionKey","Object","keys","find","key","closest","preventDefault","setupPromptArea","generateBtn","querySelector","SELECTORS","promptArea","addEventListener","disabled","value","trim","submitBtn","displayLoading","request","methodname","args","getRequestArgs","responseObj","Ajax","call","errorcode","handleGenerationError","error","errormessage","displayGeneratedText","hideLoading","focus","generatedResponseDiv","wrappedEditedResponse","TinyAiTextMarker","wrapEditedSections","generatedcontent","editedtext","AIHelper","formatResponse","formattedResponse","Templates","render","insertContent","execCommand","windowManager","close","hide","errorMessage","setBody","backBtn","classList","remove","add","textDisplayContainer","insertBtn","innerHTML","elementid","text","textareaElement","Promise","resolve","reject","textLength","contextid","prompttext"],"mappings":"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"}