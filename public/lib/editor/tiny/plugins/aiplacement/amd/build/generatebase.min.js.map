{"version":3,"file":"generatebase.min.js","sources":["../src/generatebase.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Tiny AI base generate class.\r\n *\r\n * @module      tiny_aiplacement/generatebase\r\n * @copyright   2024 Matt Porritt <matt.porritt@moodle.com>\r\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport {loadingMessages} from 'tiny_aiplacement/loading';\r\nimport {getString} from 'core/str';\r\nimport {\r\n    getContextId,\r\n    getUserId,\r\n} from 'tiny_aiplacement/options';\r\nimport Policy from 'core_ai/policy';\r\nimport PolicyModal from 'core_ai/policymodal';\r\nimport CustomEvents from 'core/custom_interaction_events';\r\nimport {isPolicyAgreed} from './options';\r\n\r\nexport default class GenerateBase {\r\n    modalObject;\r\n\r\n    /**\r\n     * Class constructor.\r\n     *\r\n     * @param {TinyMCE.editor} editor The tinyMCE editor instance.\r\n     */\r\n    constructor(editor) {\r\n        this.editor = editor;\r\n        this.userid = getUserId(editor);\r\n        this.contextid = getContextId(editor);\r\n        this.responseObj = null;\r\n    }\r\n\r\n    /**\r\n     * Display the modal when the AI button is clicked.\r\n     *\r\n     */\r\n    async displayContentModal() {\r\n        Policy.preconfigurePolicyState(this.userid, isPolicyAgreed(this.editor));\r\n        if (!await Policy.getPolicyStatus(this.userid)) {\r\n            const policyModal = await PolicyModal.create();\r\n            policyModal.getModal().on(CustomEvents.events.activate, policyModal.getActionSelector('save'), () => {\r\n                this.displayContentModal();\r\n            });\r\n            return;\r\n        }\r\n\r\n        this.modalObject = await this.setupModal();\r\n    }\r\n\r\n    getModalClass() {\r\n        throw new Error(\"Method 'getModalClass' must be implemented.\");\r\n    }\r\n\r\n\r\n    /**\r\n     * Set up the base text generation modal with default body content.\r\n     *\r\n     * @returns {TextModal} The image modal object.\r\n     */\r\n    async setupModal() {\r\n        const modal = this.getModalClass().create({\r\n            templateContext: {\r\n                elementid: this.editor.id,\r\n            },\r\n        });\r\n\r\n        this.addContentEventListeners(modal);\r\n\r\n        return modal;\r\n    }\r\n\r\n    /**\r\n     * Add event listeners for the text modal.\r\n     *\r\n     * @param {Modal} modal\r\n     */\r\n    async addContentEventListeners(modal) {\r\n        const modalRoot = (await modal).getRoot();\r\n        const root = modalRoot[0];\r\n\r\n        root.addEventListener('click', (e) => {\r\n            this.handleContentModalClick(e, root);\r\n        });\r\n\r\n        this.setupPromptArea(root);\r\n        this.hideLoadingSpinner(root);\r\n    }\r\n\r\n    handleContentModalClick() {\r\n        throw new Error('Method handleContentModalClick must be implemented.');\r\n    }\r\n\r\n    /**\r\n     * Hide the loading spinner.\r\n     *\r\n     * @param {Object} root The root element of the modal.\r\n     */\r\n    hideLoadingSpinner(root) {\r\n        const loadingSpinnerDiv = root.querySelector(`[id=\"${this.editor.id}_tiny_aiplacement_spinner\"]`);\r\n        loadingSpinnerDiv.classList.add('hidden');\r\n        loadingSpinnerDiv.classList.remove('tiny-aiplacement-loading-spinner-container');\r\n    }\r\n\r\n    /**\r\n     * Display the loading state in the modal.\r\n     *\r\n     * @param {HTMLElement} root - The root element of the modal.\r\n     * @param {HTMLElement} submitBtn - The submit button element.\r\n     * @param {String|null} removeClass - The class to be removed from the loading spinner div, if any.\r\n     */\r\n    async displayLoading(root, submitBtn, removeClass = null) {\r\n        const loadingSpinnerDiv = root.querySelector(`[id=\"${this.editor.id}_tiny_aiplacement_spinner\"]`);\r\n        const overlayDiv = root.querySelector(`[id=\"${this.editor.id}_tiny_aiplacement_overlay\"]`);\r\n        const blurDiv = root.querySelector(`[id=\"${this.editor.id}_tiny_aiplacement_blur\"]`);\r\n        const loadingTextDiv = root.querySelector(`[id=\"${this.editor.id}_tiny_aiplacement_loading_text\"]`);\r\n        const actionButtons = root.querySelectorAll('.tiny-aiplacement-generate-footer button');\r\n\r\n        loadingMessages(loadingTextDiv);\r\n\r\n        if (removeClass) {\r\n            loadingSpinnerDiv.classList.remove(removeClass);\r\n        }\r\n\r\n        loadingSpinnerDiv.classList.remove('hidden');\r\n        overlayDiv.classList.remove('hidden');\r\n        blurDiv.classList.add('tiny-aiplacement-blur');\r\n        submitBtn.innerHTML = await getString('generating', 'tiny_aiplacement');\r\n\r\n        if (actionButtons) {\r\n            actionButtons.forEach((button) => {\r\n                button.disabled = true;\r\n            });\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Hide the loading action in the modal.\r\n     *\r\n     * @param {Object} root The root element of the modal.\r\n     * @param {Object} submitBtn The submit button element.\r\n     */\r\n    async hideLoading(root, submitBtn) {\r\n        const loadingSpinnerDiv = root.querySelector(`[id=\"${this.editor.id}_tiny_aiplacement_spinner\"]`);\r\n        const overlayDiv = root.querySelector(`[id=\"${this.editor.id}_tiny_aiplacement_overlay\"]`);\r\n        const blurDiv = root.querySelector(`[id=\"${this.editor.id}_tiny_aiplacement_blur\"]`);\r\n        const actionButtons = root.querySelectorAll('.tiny-aiplacement-generate-footer button');\r\n        if (loadingSpinnerDiv) {\r\n            loadingSpinnerDiv.classList.add('hidden');\r\n        }\r\n        if (overlayDiv) {\r\n            overlayDiv.classList.add('hidden');\r\n        }\r\n        if (blurDiv) {\r\n            blurDiv.classList.remove('tiny-aiplacement-blur');\r\n        }\r\n        submitBtn.innerHTML = await getString('regenerate', 'tiny_aiplacement');\r\n\r\n        if (actionButtons) {\r\n            actionButtons.forEach((button) => {\r\n                button.disabled = false;\r\n            });\r\n        }\r\n    }\r\n}\r\n"],"names":["constructor","editor","userid","contextid","responseObj","preconfigurePolicyState","this","Policy","getPolicyStatus","modalObject","setupModal","policyModal","PolicyModal","create","getModal","on","CustomEvents","events","activate","getActionSelector","displayContentModal","getModalClass","Error","modal","templateContext","elementid","id","addContentEventListeners","root","getRoot","addEventListener","e","handleContentModalClick","setupPromptArea","hideLoadingSpinner","loadingSpinnerDiv","querySelector","classList","add","remove","submitBtn","removeClass","overlayDiv","blurDiv","loadingTextDiv","actionButtons","querySelectorAll","innerHTML","forEach","button","disabled"],"mappings":"qpBA0CIA,YAAYC,kLACHA,OAASA,YACTC,QAAS,sBAAUD,aACnBE,WAAY,yBAAaF,aACzBG,YAAc,oDAQZC,wBAAwBC,KAAKJ,QAAQ,4BAAeI,KAAKL,eACrDM,gBAAOC,gBAAgBF,KAAKJ,aAQlCO,kBAAoBH,KAAKI,wBAPpBC,kBAAoBC,qBAAYC,SACtCF,YAAYG,WAAWC,GAAGC,mCAAaC,OAAOC,SAAUP,YAAYQ,kBAAkB,SAAS,UACtFC,0BAQjBC,sBACU,IAAIC,MAAM,wEAUVC,MAAQjB,KAAKe,gBAAgBR,OAAO,CACtCW,gBAAiB,CACbC,UAAWnB,KAAKL,OAAOyB,kBAI1BC,yBAAyBJ,OAEvBA,qCAQoBA,aAErBK,YADmBL,OAAOM,UACT,GAEvBD,KAAKE,iBAAiB,SAAUC,SACvBC,wBAAwBD,EAAGH,cAG/BK,gBAAgBL,WAChBM,mBAAmBN,MAG5BI,gCACU,IAAIV,MAAM,uDAQpBY,mBAAmBN,YACTO,kBAAoBP,KAAKQ,6BAAsB9B,KAAKL,OAAOyB,mCACjES,kBAAkBE,UAAUC,IAAI,UAChCH,kBAAkBE,UAAUE,OAAO,mEAUlBX,KAAMY,eAAWC,mEAAc,WAC1CN,kBAAoBP,KAAKQ,6BAAsB9B,KAAKL,OAAOyB,mCAC3DgB,WAAad,KAAKQ,6BAAsB9B,KAAKL,OAAOyB,mCACpDiB,QAAUf,KAAKQ,6BAAsB9B,KAAKL,OAAOyB,gCACjDkB,eAAiBhB,KAAKQ,6BAAsB9B,KAAKL,OAAOyB,wCACxDmB,cAAgBjB,KAAKkB,iBAAiB,yEAE5BF,gBAEZH,aACAN,kBAAkBE,UAAUE,OAAOE,aAGvCN,kBAAkBE,UAAUE,OAAO,UACnCG,WAAWL,UAAUE,OAAO,UAC5BI,QAAQN,UAAUC,IAAI,yBACtBE,UAAUO,gBAAkB,kBAAU,aAAc,oBAEhDF,eACAA,cAAcG,SAASC,SACnBA,OAAOC,UAAW,uBAWZtB,KAAMY,iBACdL,kBAAoBP,KAAKQ,6BAAsB9B,KAAKL,OAAOyB,mCAC3DgB,WAAad,KAAKQ,6BAAsB9B,KAAKL,OAAOyB,mCACpDiB,QAAUf,KAAKQ,6BAAsB9B,KAAKL,OAAOyB,gCACjDmB,cAAgBjB,KAAKkB,iBAAiB,4CACxCX,mBACAA,kBAAkBE,UAAUC,IAAI,UAEhCI,YACAA,WAAWL,UAAUC,IAAI,UAEzBK,SACAA,QAAQN,UAAUE,OAAO,yBAE7BC,UAAUO,gBAAkB,kBAAU,aAAc,oBAEhDF,eACAA,cAAcG,SAASC,SACnBA,OAAOC,UAAW"}