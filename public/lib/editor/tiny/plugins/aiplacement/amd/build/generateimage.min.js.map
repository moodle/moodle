{"version":3,"file":"generateimage.min.js","sources":["../src/generateimage.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Tiny AI generate images.\r\n *\r\n * @module      tiny_aiplacement/generateimage\r\n * @copyright   2024 Matt Porritt <matt.porritt@moodle.com>\r\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport ImageModal from 'tiny_aiplacement/imagemodal';\r\nimport Ajax from 'core/ajax';\r\nimport {getString} from 'core/str';\r\nimport Templates from 'core/templates';\r\nimport AiMediaImage from './mediaimage';\r\nimport {getContextId} from 'tiny_aiplacement/options';\r\nimport GenerateBase from 'tiny_aiplacement/generatebase';\r\n\r\nexport default class GenerateImage extends GenerateBase {\r\n    SELECTORS = {\r\n        GENERATEBUTTON: () => `[id=\"${this.editor.id}_tiny_aiplacement_generatebutton\"]`,\r\n        PROMPTAREA: () => `[id=\"${this.editor.id}_tiny_aiplacement_imageprompt\"]`,\r\n        IMAGECONTAINER: () => `[id=\"${this.editor.id}_tiny_aiplacement_generate_image\"]`,\r\n        GENERATEBTN: '[data-action=\"generate\"]',\r\n        INSERTBTN: '[data-action=\"inserter\"]',\r\n        BACKTBTN: '[data-action=\"back\"]',\r\n        GENERATEDIMAGE: () => `[id=\"${this.editor.id}_tiny_generated_image\"]`,\r\n    };\r\n\r\n    imageURL = null;\r\n\r\n    getModalClass() {\r\n        return ImageModal;\r\n    }\r\n\r\n    /**\r\n     * Handle click events within the image modal.\r\n     *\r\n     * @param {Event} e - The click event object.\r\n     * @param {HTMLElement} root - The root element of the modal.\r\n     */\r\n    handleContentModalClick(e, root) {\r\n        const actions = {\r\n            generate: () => this.handleSubmit(root, e.target),\r\n            inserter: () => this.handleInsert(),\r\n            cancel: () => this.modalObject.destroy(),\r\n            back: () => {\r\n                this.modalObject.destroy();\r\n                this.displayContentModal();\r\n            },\r\n        };\r\n\r\n        const actionKey = Object.keys(actions).find(key => e.target.closest(`[data-action=\"${key}\"]`));\r\n        if (actionKey) {\r\n            e.preventDefault();\r\n            actions[actionKey]();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Set up the prompt area in the modal, adding necessary event listeners.\r\n     *\r\n     * @param {HTMLElement} root - The root element of the modal.\r\n     */\r\n    setupPromptArea(root) {\r\n        const generateBtn = root.querySelector(this.SELECTORS.GENERATEBUTTON());\r\n        const promptArea = root.querySelector(this.SELECTORS.PROMPTAREA());\r\n\r\n        promptArea.addEventListener('input', () => {\r\n            generateBtn.disabled = promptArea.value.trim() === '';\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Handle the submit action.\r\n     *\r\n     * @param {Object} root The root element of the modal.\r\n     * @param {Object} submitBtn The submit button element.\r\n     */\r\n    async handleSubmit(root, submitBtn) {\r\n        await this.displayLoading(root, submitBtn);\r\n\r\n        const displayArgs = this.getDisplayArgs(root);\r\n        const request = {\r\n            methodname: 'aiplacement_editor_generate_image',\r\n            args: displayArgs\r\n        };\r\n\r\n        try {\r\n            this.responseObj = await Ajax.call([request])[0];\r\n            if (this.responseObj.error) {\r\n                this.handleGenerationError(root, submitBtn, this.responseObj.error, this.responseObj.errormessage);\r\n            } else {\r\n                await this.displayGeneratedImage(root);\r\n                await this.hideLoading(root, submitBtn);\r\n                // Focus the container for accessibility.\r\n                const imageDisplayContainer = root.querySelector(this.SELECTORS.IMAGECONTAINER());\r\n                imageDisplayContainer.focus();\r\n            }\r\n        } catch (error) {\r\n            this.handleGenerationError(root, submitBtn);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Handle the insert action.\r\n     *\r\n     */\r\n    async handleInsert() {\r\n        // Use the revised prompt for the image alt text if it is available in the response.\r\n        const revisedPrompt = this.responseObj.revisedprompt;\r\n        const altTextToUse = revisedPrompt ? revisedPrompt : this.promptText;\r\n        const mediaImage = new AiMediaImage(this.editor, this.imageURL, altTextToUse);\r\n        await mediaImage.displayDialogue();\r\n        this.modalObject.destroy();\r\n    }\r\n\r\n    /**\r\n     * Handle a generation error.\r\n     *\r\n     * @param {Object} root The root element of the modal.\r\n     * @param {Object} submitBtn The submit button element.\r\n     * @param {String} error The error name to display.\r\n     * @param {String} errorMessage The error message to display.\r\n     */\r\n    async handleGenerationError(root, submitBtn, error = '', errorMessage = '') {\r\n        if (!error) {\r\n            // Get the default error message.\r\n            error = await getString('error:defaultname', 'core_ai');\r\n            errorMessage = await getString('error:defaultmessage', 'core_ai');\r\n        }\r\n        const backBtn = root.querySelector(this.SELECTORS.BACKTBTN);\r\n        const generateBtn = root.querySelector(this.SELECTORS.GENERATEBUTTON());\r\n        backBtn.classList.remove('hidden');\r\n        generateBtn.classList.add('hidden');\r\n        await this.hideLoading(root, submitBtn);\r\n        this.modalObject.setBody(Templates.render('tiny_aiplacement/modalbodyerror',\r\n            {'error': error, 'errorMessage': errorMessage}));\r\n        // Focus the back button for accessibility.\r\n        backBtn.focus();\r\n    }\r\n\r\n    /**\r\n     * Display the generated image in the modal.\r\n     *\r\n     * @param {HTMLElement} root - The root element of the modal.\r\n     */\r\n    async displayGeneratedImage(root) {\r\n        const imageDisplayContainer = root.querySelector(this.SELECTORS.IMAGECONTAINER());\r\n        const insertBtn = root.querySelector(this.SELECTORS.INSERTBTN);\r\n        // Set the draft URL as it's used elsewhere.\r\n        this.imageURL = this.responseObj.drafturl;\r\n\r\n        // Render the image template and insert it into the modal.\r\n        imageDisplayContainer.innerHTML = await Templates.render('tiny_aiplacement/image', {\r\n            url: this.responseObj.drafturl,\r\n            elementid: this.editor.id,\r\n            alt: this.promptText,\r\n        });\r\n        const imagElement = root.querySelector(this.SELECTORS.GENERATEDIMAGE());\r\n\r\n        return new Promise((resolve, reject) => {\r\n            imagElement.onload = () => {\r\n                insertBtn.classList.remove('hidden');\r\n                imagElement.focus();\r\n                resolve(); // Resolve the promise when the image is loaded.\r\n            };\r\n            imagElement.onerror = (error) => {\r\n                reject(error); // Reject the promise if there is an error loading the image.\r\n            };\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Get the display args for the image.\r\n     *\r\n     * @param {Object} root The root element of the modal.\r\n     */\r\n    getDisplayArgs(root) {\r\n        const contextId = getContextId(this.editor);\r\n        const promptText = root.querySelector(this.SELECTORS.PROMPTAREA()).value;\r\n        this.promptText = promptText;\r\n\r\n        const aspectRatio = this.getSelectedRadioValue('aspect-ratio', 'square');\r\n        const imageQuality = this.getSelectedRadioValue('quality', 'standard');\r\n\r\n        return {\r\n            contextid: contextId,\r\n            prompttext: promptText,\r\n            aspectratio: aspectRatio,\r\n            quality: imageQuality,\r\n            numimages: 1\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Get the value of the selected radio button.\r\n     *\r\n     * @param {String} radioName The name of the radio button group.\r\n     * @param {String} defaultValue The default value of the radio button.\r\n     */\r\n    getSelectedRadioValue(radioName, defaultValue = null) {\r\n        const radios = document.getElementsByName(radioName);\r\n        for (const radio of radios) {\r\n            if (radio.checked) {\r\n                return radio.value;\r\n            }\r\n        }\r\n        return defaultValue;\r\n    }\r\n}\r\n"],"names":["GenerateImage","GenerateBase","GENERATEBUTTON","this","editor","id","PROMPTAREA","IMAGECONTAINER","GENERATEBTN","INSERTBTN","BACKTBTN","GENERATEDIMAGE","getModalClass","ImageModal","handleContentModalClick","e","root","actions","generate","handleSubmit","target","inserter","handleInsert","cancel","modalObject","destroy","back","displayContentModal","actionKey","Object","keys","find","key","closest","preventDefault","setupPromptArea","generateBtn","querySelector","SELECTORS","promptArea","addEventListener","disabled","value","trim","submitBtn","displayLoading","request","methodname","args","getDisplayArgs","responseObj","Ajax","call","error","handleGenerationError","errormessage","displayGeneratedImage","hideLoading","focus","revisedPrompt","revisedprompt","altTextToUse","promptText","mediaImage","AiMediaImage","imageURL","displayDialogue","errorMessage","backBtn","classList","remove","add","setBody","Templates","render","imageDisplayContainer","insertBtn","drafturl","innerHTML","url","elementid","alt","imagElement","Promise","resolve","reject","onload","onerror","contextId","contextid","prompttext","aspectratio","getSelectedRadioValue","quality","numimages","radioName","defaultValue","radios","document","getElementsByName","radio","checked"],"mappings":"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"}