{"version":3,"file":"uploader.min.js","sources":["../src/uploader.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Tiny Media plugin for Moodle.\r\n *\r\n * @module      editor_tiny/uploader\r\n * @copyright   2022 Andrew Lyons <andrew@nicols.co.uk>\r\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\nimport {\r\n    notifyUploadStarted,\r\n    notifyUploadCompleted,\r\n} from 'core_form/events';\r\nimport {getFilePicker} from 'editor_tiny/options';\r\n\r\n// This image uploader is based on advice given at:\r\n// https://www.tiny.cloud/docs/tinymce/6/upload-images/\r\nexport default (editor, filePickerType, blob, fileName, progress) => new Promise((resolve, reject) => {\r\n    notifyUploadStarted(editor.targetElm.id);\r\n\r\n    const xhr = new XMLHttpRequest();\r\n\r\n    // Add the progress handler.\r\n    xhr.upload.addEventListener('progress', (e) => {\r\n        progress(e.loaded / e.total * 100);\r\n    });\r\n\r\n    xhr.addEventListener('load', () => {\r\n        if (xhr.status === 403) {\r\n            reject({\r\n                message: `HTTP error: ${xhr.status}`,\r\n                remove: true,\r\n            });\r\n            return;\r\n        }\r\n\r\n        if (xhr.status < 200 || xhr.status >= 300) {\r\n            reject(`HTTP Error: ${xhr.status}`);\r\n            return;\r\n        }\r\n\r\n        const response = JSON.parse(xhr.responseText);\r\n\r\n        if (!response) {\r\n            reject(`Invalid JSON: ${xhr.responseText}`);\r\n            return;\r\n        }\r\n\r\n        notifyUploadCompleted(editor.targetElm.id);\r\n\r\n        let location;\r\n        if (response.url) {\r\n            location = response.url;\r\n        } else if (response.event && response.event === 'fileexists' && response.newfile) {\r\n            // A file with this name is already in use here - rename to avoid conflict.\r\n            // Chances are, it's a different image (stored in a different folder on the user's computer).\r\n            // If the user wants to reuse an existing image, they can copy/paste it within the editor.\r\n            location = response.newfile.url;\r\n        }\r\n\r\n        if (location && typeof location === 'string') {\r\n            resolve(location);\r\n            return;\r\n        }\r\n\r\n        // Try to parse the error response into a JSON object.\r\n        const errorString = xhr.responseText;\r\n        let output = '';\r\n        try {\r\n            output = JSON.parse(errorString);\r\n        } catch (error) {\r\n            // If the JSON parsing process returns an error, then it returns the original.\r\n            output = errorString;\r\n        }\r\n\r\n        reject(output);\r\n    });\r\n\r\n    xhr.addEventListener('error', () => {\r\n        reject({\r\n            message: `Upload failed due to an XHR transport error. Code: ${xhr.status}`,\r\n            remove: true,\r\n        });\r\n    });\r\n\r\n    const formData = new FormData();\r\n    const options = getFilePicker(editor, filePickerType);\r\n\r\n    formData.append('repo_upload_file', blob, fileName);\r\n    formData.append('itemid', options.itemid);\r\n    Object.values(options.repositories).some((repository) => {\r\n        if (repository.type === 'upload') {\r\n            formData.append('repo_id', repository.id);\r\n            return true;\r\n        }\r\n        return false;\r\n    });\r\n\r\n    formData.append('env', options.env);\r\n    formData.append('sesskey', M.cfg.sesskey);\r\n    formData.append('client_id', options.client_id);\r\n    formData.append('savepath', options.savepath ?? '/');\r\n    formData.append('ctx_id', options.context.id);\r\n\r\n    // Accepted types can be either a string or an array, but an array is\r\n    // expected in the processing script, so make sure we are sending an array.\r\n    const acceptedTypes = options.accepted_types;\r\n    if (Array.isArray(acceptedTypes)) {\r\n        acceptedTypes.forEach(function(type) {\r\n              formData.append('accepted_types[]', type);\r\n        });\r\n    } else {\r\n        formData.append('accepted_types[]', acceptedTypes);\r\n    }\r\n\r\n    xhr.open('POST', `${M.cfg.wwwroot}/repository/repository_ajax.php?action=upload`, true);\r\n    xhr.send(formData);\r\n});\r\n"],"names":["editor","filePickerType","blob","fileName","progress","Promise","resolve","reject","targetElm","id","xhr","XMLHttpRequest","upload","addEventListener","e","loaded","total","status","message","remove","response","JSON","parse","responseText","location","url","event","newfile","errorString","output","error","formData","FormData","options","append","itemid","Object","values","repositories","some","repository","type","env","M","cfg","sesskey","client_id","savepath","context","acceptedTypes","accepted_types","Array","isArray","forEach","open","wwwroot","send"],"mappings":"gOA8Be,CAACA,OAAQC,eAAgBC,KAAMC,SAAUC,WAAa,IAAIC,SAAQ,CAACC,QAASC,gEACnEP,OAAOQ,UAAUC,UAE/BC,IAAM,IAAIC,eAGhBD,IAAIE,OAAOC,iBAAiB,YAAaC,IACrCV,SAASU,EAAEC,OAASD,EAAEE,MAAQ,QAGlCN,IAAIG,iBAAiB,QAAQ,QACN,MAAfH,IAAIO,mBACJV,OAAO,CACHW,8BAAwBR,IAAIO,QAC5BE,QAAQ,OAKZT,IAAIO,OAAS,KAAOP,IAAIO,QAAU,gBAClCV,6BAAsBG,IAAIO,eAIxBG,SAAWC,KAAKC,MAAMZ,IAAIa,kBAE3BH,qBACDb,+BAAwBG,IAAIa,mBAM5BC,8CAFkBxB,OAAOQ,UAAUC,IAGnCW,SAASK,IACTD,SAAWJ,SAASK,IACbL,SAASM,OAA4B,eAAnBN,SAASM,OAA0BN,SAASO,UAIrEH,SAAWJ,SAASO,QAAQF,KAG5BD,UAAgC,iBAAbA,qBACnBlB,QAAQkB,gBAKNI,YAAclB,IAAIa,iBACpBM,OAAS,OAETA,OAASR,KAAKC,MAAMM,aACtB,MAAOE,OAELD,OAASD,YAGbrB,OAAOsB,WAGXnB,IAAIG,iBAAiB,SAAS,KAC1BN,OAAO,CACHW,qEAA+DR,IAAIO,QACnEE,QAAQ,aAIVY,SAAW,IAAIC,SACfC,SAAU,0BAAcjC,OAAQC,gBAEtC8B,SAASG,OAAO,mBAAoBhC,KAAMC,UAC1C4B,SAASG,OAAO,SAAUD,QAAQE,QAClCC,OAAOC,OAAOJ,QAAQK,cAAcC,MAAMC,YACd,WAApBA,WAAWC,OACXV,SAASG,OAAO,UAAWM,WAAW/B,KAC/B,KAKfsB,SAASG,OAAO,MAAOD,QAAQS,KAC/BX,SAASG,OAAO,UAAWS,EAAEC,IAAIC,SACjCd,SAASG,OAAO,YAAaD,QAAQa,WACrCf,SAASG,OAAO,qCAAYD,QAAQc,wDAAY,KAChDhB,SAASG,OAAO,SAAUD,QAAQe,QAAQvC,UAIpCwC,cAAgBhB,QAAQiB,eAC1BC,MAAMC,QAAQH,eACdA,cAAcI,SAAQ,SAASZ,MACzBV,SAASG,OAAO,mBAAoBO,SAG1CV,SAASG,OAAO,mBAAoBe,eAGxCvC,IAAI4C,KAAK,iBAAWX,EAAEC,IAAIW,0DAAwD,GAClF7C,IAAI8C,KAAKzB"}