{"version":3,"file":"upload.min.js","sources":["../src/upload.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Upload module for Google Docs repository.\r\n *\r\n * @module     repository_googledocs/upload\r\n * @copyright  2025 Huong Nguyen <huongnv13@gmail.com>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport {subscribe} from 'core/pubsub';\r\nimport SaveCancelModal from 'core/modal_save_cancel';\r\nimport {getString} from 'core/str';\r\nimport Templates from 'core/templates';\r\nimport ModalEvents from 'core/modal_events';\r\nimport Dropzone from 'core/dropzone';\r\nimport * as config from 'core/config';\r\nimport Notification from 'core/notification';\r\n\r\nlet listenersRegistered = false;\r\nlet droppedFiles = [];\r\n\r\n/**\r\n * Open the upload modal.\r\n *\r\n * @param {object} data Data passed from the event\r\n */\r\nconst openUploadModal = (data) => {\r\n    Templates.render('repository_googledocs/upload_dialogue', {}).then(function(bodyHtml) {\r\n        return SaveCancelModal.create({\r\n            title: getString('upload'),\r\n            body: bodyHtml,\r\n            large: true,\r\n        }).then(function(modal) {\r\n            modal.getRoot().on(ModalEvents.shown, () => {\r\n                droppedFiles = [];\r\n                initDropzone(modal);\r\n            });\r\n            modal.getRoot().on(ModalEvents.hidden, () => {\r\n                modal.destroy();\r\n            });\r\n            modal.getRoot().on(ModalEvents.save, (e) => {\r\n                e.preventDefault();\r\n                commitFiles(data.repoId, data.contextId, data.callback, droppedFiles, modal);\r\n            });\r\n            modal.getRoot().on(ModalEvents.cancel, () => {\r\n                modal.hide();\r\n            });\r\n            modal.show();\r\n\r\n            return modal;\r\n        });\r\n    });\r\n};\r\n\r\n/**\r\n * Initialize the dropzone inside the modal.\r\n *\r\n * @param {Modal} modal Modal instance\r\n */\r\nconst initDropzone = (modal) => {\r\n    const $body = modal.getBody();\r\n    const dropzoneContainer = $body.find('.repository_googledocs_dropzone_container').get(0);\r\n    const fileListContainer = $body.find('ul.repository_googledocs_files_list').get(0);\r\n    const dz = new Dropzone(dropzoneContainer, '*', (files) => {\r\n        droppedFiles.push(...files);\r\n        let fileListHTML = '';\r\n        for (let i = 0; i < droppedFiles.length; i++) {\r\n            fileListHTML += '<li>' + droppedFiles[i].name + '</li>';\r\n        }\r\n        fileListContainer.innerHTML = fileListHTML;\r\n    });\r\n\r\n    getString('dropfiles', 'repository').then((label) => {\r\n        dz.setLabel(label);\r\n    });\r\n\r\n    dz.init();\r\n};\r\n\r\n/**\r\n * Upload files to server.\r\n *\r\n * @param {Integer} repoId Repository ID\r\n * @param {Integer} contextId Context ID\r\n * @param {function} callback Callback function\r\n * @param {array} files Files to be uploaded\r\n * @param {Modal} modal Modal instance\r\n */\r\nconst commitFiles = (repoId, contextId, callback, files, modal) => {\r\n    const saveButton = modal.getFooter().find('[data-action=\"save\"]');\r\n    const formData = new FormData();\r\n    formData.append('action', 'upload');\r\n    formData.append('repo_id', repoId);\r\n    formData.append('contextid', contextId);\r\n    formData.append('sesskey', config.sesskey);\r\n    for (let i = 0; i < files.length; i++) {\r\n        formData.append(\"files[]\", files[i]);\r\n    }\r\n    const xhr = new XMLHttpRequest();\r\n    xhr.open('POST', config.wwwroot + '/repository/googledocs/repository_ajax.php', false);\r\n    xhr.onload = function() {\r\n        const response = JSON.parse(xhr.responseText);\r\n        if (response.error) {\r\n            saveButton.removeAttr('disabled');\r\n            Notification.alert(\r\n                getString('uploaderror', 'repository'),\r\n                response.error,\r\n                getString('close', 'repository'),\r\n            );\r\n        } else {\r\n            saveButton.removeAttr('disabled');\r\n            modal.hide();\r\n            callback();\r\n        }\r\n    };\r\n    xhr.send(formData);\r\n};\r\n\r\n/**\r\n * Register events.\r\n */\r\nconst registerEventListeners = () => {\r\n    if (!listenersRegistered) {\r\n        subscribe('repository_googledocs_upload', (data) => {\r\n            openUploadModal(data);\r\n        });\r\n        listenersRegistered = true;\r\n    }\r\n};\r\n\r\n/**\r\n * Initializes the upload module.\r\n */\r\nexport const init = () => {\r\n    registerEventListeners();\r\n};\r\n"],"names":["listenersRegistered","droppedFiles","initDropzone","modal","$body","getBody","dropzoneContainer","find","get","fileListContainer","dz","Dropzone","files","push","fileListHTML","i","length","name","innerHTML","then","label","setLabel","init","commitFiles","repoId","contextId","callback","saveButton","getFooter","formData","FormData","append","config","sesskey","xhr","XMLHttpRequest","open","wwwroot","onload","response","JSON","parse","responseText","error","removeAttr","alert","hide","send","registerEventListeners","data","render","bodyHtml","SaveCancelModal","create","title","body","large","getRoot","on","ModalEvents","shown","hidden","destroy","save","e","preventDefault","cancel","show","openUploadModal"],"mappings":";;;;;;;k/BAgCIA,qBAAsB,EACtBC,aAAe,SAwCbC,aAAgBC,cACZC,MAAQD,MAAME,UACdC,kBAAoBF,MAAMG,KAAK,6CAA6CC,IAAI,GAChFC,kBAAoBL,MAAMG,KAAK,uCAAuCC,IAAI,GAC1EE,GAAK,IAAIC,kBAASL,kBAAmB,KAAMM,QAC7CX,aAAaY,QAAQD,WACjBE,aAAe,OACd,IAAIC,EAAI,EAAGA,EAAId,aAAae,OAAQD,IACrCD,cAAgB,OAASb,aAAac,GAAGE,KAAO,QAEpDR,kBAAkBS,UAAYJ,mCAGxB,YAAa,cAAcK,MAAMC,QACvCV,GAAGW,SAASD,UAGhBV,GAAGY,QAYDC,YAAc,CAACC,OAAQC,UAAWC,SAAUd,MAAOT,eAC/CwB,WAAaxB,MAAMyB,YAAYrB,KAAK,wBACpCsB,SAAW,IAAIC,SACrBD,SAASE,OAAO,SAAU,UAC1BF,SAASE,OAAO,UAAWP,QAC3BK,SAASE,OAAO,YAAaN,WAC7BI,SAASE,OAAO,UAAWC,OAAOC,aAC7B,IAAIlB,EAAI,EAAGA,EAAIH,MAAMI,OAAQD,IAC9Bc,SAASE,OAAO,UAAWnB,MAAMG,UAE/BmB,IAAM,IAAIC,eAChBD,IAAIE,KAAK,OAAQJ,OAAOK,QAAU,8CAA8C,GAChFH,IAAII,OAAS,iBACHC,SAAWC,KAAKC,MAAMP,IAAIQ,cAC5BH,SAASI,OACThB,WAAWiB,WAAW,kCACTC,OACT,kBAAU,cAAe,cACzBN,SAASI,OACT,kBAAU,QAAS,iBAGvBhB,WAAWiB,WAAW,YACtBzC,MAAM2C,OACNpB,aAGRQ,IAAIa,KAAKlB,WAMPmB,uBAAyB,KACtBhD,4CACS,gCAAiCiD,OAjG1BA,CAAAA,0BACXC,OAAO,wCAAyC,IAAI/B,MAAK,SAASgC,iBACjEC,2BAAgBC,OAAO,CAC1BC,OAAO,kBAAU,UACjBC,KAAMJ,SACNK,OAAO,IACRrC,MAAK,SAAShB,cACbA,MAAMsD,UAAUC,GAAGC,sBAAYC,OAAO,KAClC3D,aAAe,GACfC,aAAaC,UAEjBA,MAAMsD,UAAUC,GAAGC,sBAAYE,QAAQ,KACnC1D,MAAM2D,aAEV3D,MAAMsD,UAAUC,GAAGC,sBAAYI,MAAOC,IAClCA,EAAEC,iBACF1C,YAAY0B,KAAKzB,OAAQyB,KAAKxB,UAAWwB,KAAKvB,SAAUzB,aAAcE,UAE1EA,MAAMsD,UAAUC,GAAGC,sBAAYO,QAAQ,KACnC/D,MAAM2C,UAEV3C,MAAMgE,OAEChE,aA2EPiE,CAAgBnB,SAEpBjD,qBAAsB,kBAOV,KAChBgD"}