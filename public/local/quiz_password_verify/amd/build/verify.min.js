/**
 * JavaScript for password verification popup
 *
 * @module     local_quiz_password_verify/verify
 * @copyright  2024
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_quiz_password_verify/verify",["jquery","core/notification","core/modal_factory","core/modal_events"],(function($,Notification,ModalFactory,ModalEvents){var attemptId=null,verified=!1,showPasswordModal=function(verificationData,successCallback){return ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:M.util.get_string("verifyyouridentity","local_quiz_password_verify"),body:'<div class="form-group"><label for="verify-password">'+M.util.get_string("enteryourpassword","local_quiz_password_verify")+'</label><input type="password" class="form-control" id="verify-password" autocomplete="current-password" required><small class="form-text text-muted">'+M.util.get_string("passwordhelp","local_quiz_password_verify")+"</small></div>"}).then((function(modal){return modal.setSaveButtonText(M.util.get_string("verify","local_quiz_password_verify")),modal.getRoot().addClass("quiz-password-verify-modal"),modal.getRoot().on(ModalEvents.save,(function(e){e.preventDefault();var password=$("#verify-password").val();password?verifyPassword(password,modal,verificationData,successCallback):Notification.addNotification({message:M.util.get_string("passwordrequired","local_quiz_password_verify"),type:"error"})})),modal.show(),modal.getRoot().on(ModalEvents.shown,(function(){$("#verify-password").focus()})),modal}))},verifyPassword=function(password,modal,verificationData,successCallback){var data={password:password,sesskey:M.cfg.sesskey};verificationData.attemptid?data.attemptid=verificationData.attemptid:verificationData.cmid&&(data.cmid=verificationData.cmid),$.ajax({url:M.cfg.wwwroot+"/local/quiz_password_verify/verify.php",type:"POST",data:data,dataType:"json",success:function(response){response.success?(verified=!0,modal.hide(),modal.destroy(),Notification.addNotification({message:response.message,type:"success"}),successCallback&&successCallback()):(Notification.addNotification({message:response.message,type:"error"}),$("#verify-password").val("").focus())},error:function(xhr,status,error){Notification.addNotification({message:"Error verifying password: "+error,type:"error"}),$("#verify-password").val("").focus()}})},originalProtoSubmit=HTMLFormElement.prototype.submit;HTMLFormElement.prototype.submit=function(){var isFinishForm="frm-finishattempt"===this.id,isSummaryPage=document.body.classList.contains("path-mod-quiz-summary")||"page-mod-quiz-summary"===document.body.id,isProcessAttempt=this.action&&this.action.indexOf("processattempt.php")>-1;if(isFinishForm||isProcessAttempt&&isSummaryPage){var form=this;if(verified)return void originalProtoSubmit.apply(this,arguments);var attemptIdField=$(form).find('input[name="attempt"]'),currentAttemptId=attemptIdField.val();!currentAttemptId&&attemptId&&(currentAttemptId=attemptId),currentAttemptId?showPasswordModal({attemptid:currentAttemptId},(function(){originalProtoSubmit.apply(form,arguments)})):originalProtoSubmit.apply(this,arguments)}else originalProtoSubmit.apply(this,arguments)};return{init:function(quizAttemptId){attemptId=quizAttemptId,window.addEventListener("click",(function(e){var toggleButton=e.target.closest('[data-action="toggle-manual-completion"]');if(toggleButton&&(toggleButton.closest(".modtype_quiz")||toggleButton.closest(".activity.quiz")||document.body.classList.contains("path-mod-quiz"))){if(verified)return;e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation();var cmid=toggleButton.dataset.cmid;showPasswordModal({cmid:cmid},(function(){toggleButton.click()}))}else;}),!0)},verifyAction:function(data,callback){verified?callback():showPasswordModal(data,(function(){callback()}))}}}));

//# sourceMappingURL=verify.min.js.map