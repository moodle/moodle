{"version":3,"file":"verify.min.js","sources":["../src/verify.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n\n/**\n * JavaScript for password verification popup\n *\n * @module     local_quiz_password_verify/verify\n * @copyright  2024\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/notification', 'core/modal_factory', 'core/modal_events'],\n    function($, Notification, ModalFactory, ModalEvents) {\n\n        var attemptId = null;\n        var verified = false;\n\n        /**\n         * Show password verification modal\n         *\n         * @param {Object} verificationData Data for verification (attemptid or cmid)\n         * @param {Function} successCallback Callback to run on success\n         * @returns {Promise} Modal promise\n         */\n        var showPasswordModal = function(verificationData, successCallback) {\n            return ModalFactory.create({\n                type: ModalFactory.types.SAVE_CANCEL,\n                title: M.util.get_string('verifyyouridentity', 'local_quiz_password_verify'),\n                body: '<div class=\"form-group\">' +\n                    '<label for=\"verify-password\">' +\n                    M.util.get_string('enteryourpassword', 'local_quiz_password_verify') + '</label>' +\n                    '<input type=\"password\" class=\"form-control\" id=\"verify-password\" autocomplete=\"current-password\" required>' +\n                    '<small class=\"form-text text-muted\">' +\n                    M.util.get_string('passwordhelp', 'local_quiz_password_verify') + '</small>' +\n                    '</div>',\n            }).then(function(modal) {\n                modal.setSaveButtonText(M.util.get_string('verify', 'local_quiz_password_verify'));\n\n                // Add custom class for styling.\n                modal.getRoot().addClass('quiz-password-verify-modal');\n\n                modal.getRoot().on(ModalEvents.save, function(e) {\n                    e.preventDefault();\n                    var password = $('#verify-password').val();\n\n                    if (!password) {\n                        Notification.addNotification({\n                            message: M.util.get_string('passwordrequired', 'local_quiz_password_verify'),\n                            type: 'error'\n                        });\n                        return;\n                    }\n\n                    verifyPassword(password, modal, verificationData, successCallback);\n                });\n\n                modal.show();\n\n                // Focus password field when modal opens.\n                modal.getRoot().on(ModalEvents.shown, function() {\n                    $('#verify-password').focus();\n                });\n\n                return modal;\n            });\n        };\n\n        /**\n         * Verify password via AJAX\n         *\n         * @param {string} password The password to verify\n         * @param {Object} modal The modal instance\n         * @param {Object} verificationData The verification data (attemptid or cmid)\n         * @param {Function} successCallback The callback to execute on success\n         */\n        var verifyPassword = function(password, modal, verificationData, successCallback) {\n            var data = {\n                password: password,\n                sesskey: M.cfg.sesskey\n            };\n\n            if (verificationData.attemptid) {\n                data.attemptid = verificationData.attemptid;\n            } else if (verificationData.cmid) {\n                data.cmid = verificationData.cmid;\n            }\n\n            $.ajax({\n                url: M.cfg.wwwroot + '/local/quiz_password_verify/verify.php',\n                type: 'POST',\n                data: data,\n                dataType: 'json',\n                success: function(response) {\n                    if (response.success) {\n                        verified = true;\n                        modal.hide();\n                        modal.destroy();\n\n                        Notification.addNotification({\n                            message: response.message,\n                            type: 'success'\n                        });\n\n                        if (successCallback) {\n                            successCallback();\n                        }\n                    } else {\n                        Notification.addNotification({\n                            message: response.message,\n                            type: 'error'\n                        });\n                        $('#verify-password').val('').focus();\n                    }\n                },\n                error: function(xhr, status, error) {\n                    Notification.addNotification({\n                        message: 'Error verifying password: ' + error,\n                        type: 'error'\n                    });\n                    $('#verify-password').val('').focus();\n                }\n            });\n        };\n\n        // Nuclear Proxy: Intercept HTMLFormElement.prototype.submit.\n        var originalProtoSubmit = HTMLFormElement.prototype.submit;\n        HTMLFormElement.prototype.submit = function() {\n\n            // Intercept if it's the finish attempt form (ID check is most reliable for Summary page)\n            // OR if it's processattempt.php on the summary page (fallback).\n            var isFinishForm = (this.id === 'frm-finishattempt');\n            var isSummaryPage = document.body.classList.contains('path-mod-quiz-summary') ||\n                document.body.id === 'page-mod-quiz-summary';\n            var isProcessAttempt = this.action && this.action.indexOf('processattempt.php') > -1;\n\n            if (isFinishForm || (isProcessAttempt && isSummaryPage)) {\n                var form = this;\n\n                if (verified) {\n                    originalProtoSubmit.apply(this, arguments);\n                    return;\n                }\n\n                var attemptIdField = $(form).find('input[name=\"attempt\"]');\n                var currentAttemptId = attemptIdField.val();\n\n                if (!currentAttemptId && attemptId) {\n                    currentAttemptId = attemptId;\n                }\n\n                if (currentAttemptId) {\n                    showPasswordModal({\n                        attemptid: currentAttemptId\n                    }, function() {\n                        originalProtoSubmit.apply(form, arguments);\n                    });\n                } else {\n                    originalProtoSubmit.apply(this, arguments);\n                }\n            } else {\n                originalProtoSubmit.apply(this, arguments);\n            }\n        };\n\n        /**\n         * Initialize the password verification\n         *\n         * @param {int} quizAttemptId The attempt ID\n         */\n        var init = function(quizAttemptId) {\n            attemptId = quizAttemptId;\n\n            // Capture phase listener for \"Mark as done\" ONLY.\n            window.addEventListener('click', function(e) {\n                var target = e.target;\n\n                // Handle \"Mark as done\".\n                var toggleButton = target.closest('[data-action=\"toggle-manual-completion\"]');\n                if (toggleButton) {\n                    // Check for quiz context (including View page).\n                    if (toggleButton.closest('.modtype_quiz') ||\n                        toggleButton.closest('.activity.quiz') ||\n                        document.body.classList.contains('path-mod-quiz')) {\n\n                        if (verified) {\n                            return;\n                        }\n\n                        e.preventDefault();\n                        e.stopImmediatePropagation();\n                        e.stopPropagation();\n\n                        var cmid = toggleButton.dataset.cmid;\n                        showPasswordModal({\n                            cmid: cmid\n                        }, function() {\n                            toggleButton.click();\n                        });\n                        return;\n                    }\n                }\n            }, true); // Capture phase on WINDOW.\n        };\n\n        /**\n         * Verify action (exposed API)\n         *\n         * @param {Object} data Data for verification {attemptid: ..., cmid: ...}\n         * @param {Function} callback Function to call on success\n         */\n        var verifyAction = function(data, callback) {\n            if (verified) {\n                callback();\n                return;\n            }\n            showPasswordModal(data, function() {\n                callback();\n            });\n        };\n\n        return {\n            init: init,\n            verifyAction: verifyAction\n        };\n    });\n"],"names":["define","$","Notification","ModalFactory","ModalEvents","attemptId","verified","showPasswordModal","verificationData","successCallback","create","type","types","SAVE_CANCEL","title","M","util","get_string","body","then","modal","setSaveButtonText","getRoot","addClass","on","save","e","preventDefault","password","val","verifyPassword","addNotification","message","show","shown","focus","data","sesskey","cfg","attemptid","cmid","ajax","url","wwwroot","dataType","success","response","hide","destroy","error","xhr","status","originalProtoSubmit","HTMLFormElement","prototype","submit","isFinishForm","this","id","isSummaryPage","document","classList","contains","isProcessAttempt","action","indexOf","form","apply","arguments","attemptIdField","find","currentAttemptId","init","quizAttemptId","window","addEventListener","toggleButton","target","closest","stopImmediatePropagation","stopPropagation","dataset","click","verifyAction","callback"],"mappings":"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"}