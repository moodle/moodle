{"version":3,"file":"verify.min.js","sources":["../src/verify.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n\n/**\n * JavaScript for password verification popup\n *\n * @module     local_quiz_password_verify/verify\n * @copyright  2024\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/notification', 'core/modal_factory', 'core/modal_events'],\n    function ($, Notification, ModalFactory, ModalEvents) {\n\n        var attemptId = null;\n        var verified = false;\n\n        /**\n         * Show password verification modal\n         *\n         * @param {Object} verificationData Data for verification (attemptid or cmid)\n         * @param {Function} successCallback Callback to run on success\n         * @returns {Promise} Modal promise\n         */\n        var showPasswordModal = function (verificationData, successCallback) {\n            return ModalFactory.create({\n                type: ModalFactory.types.SAVE_CANCEL,\n                title: M.util.get_string('verifyyouridentity', 'local_quiz_password_verify'),\n                body: '<div class=\"form-group\">' +\n                    '<label for=\"verify-password\">' +\n                    M.util.get_string('enteryourpassword', 'local_quiz_password_verify') + '</label>' +\n                    '<input type=\"password\" class=\"form-control\" id=\"verify-password\" autocomplete=\"current-password\" required>' +\n                    '<small class=\"form-text text-muted\">' +\n                    M.util.get_string('passwordhelp', 'local_quiz_password_verify') + '</small>' +\n                    '</div>',\n            }).then(function (modal) {\n                modal.setSaveButtonText(M.util.get_string('verify', 'local_quiz_password_verify'));\n\n                // Add custom class for styling.\n                modal.getRoot().addClass('quiz-password-verify-modal');\n\n                modal.getRoot().on(ModalEvents.save, function (e) {\n                    e.preventDefault();\n                    var password = $('#verify-password').val();\n\n                    if (!password) {\n                        Notification.addNotification({\n                            message: M.util.get_string('passwordrequired', 'local_quiz_password_verify'),\n                            type: 'error'\n                        });\n                        return;\n                    }\n\n                    verifyPassword(password, modal, verificationData, successCallback);\n                });\n\n                modal.show();\n\n                // Focus password field when modal opens.\n                modal.getRoot().on(ModalEvents.shown, function () {\n                    $('#verify-password').focus();\n                });\n\n                return modal;\n            });\n        };\n\n        /**\n         * Verify password via AJAX\n         *\n         * @param {string} password The password to verify\n         * @param {Object} modal The modal instance\n         * @param {Object} verificationData The verification data (attemptid or cmid)\n         * @param {Function} successCallback The callback to execute on success\n         */\n        var verifyPassword = function (password, modal, verificationData, successCallback) {\n            var data = {\n                password: password,\n                sesskey: M.cfg.sesskey\n            };\n\n            if (verificationData.attemptid) {\n                data.attemptid = verificationData.attemptid;\n            } else if (verificationData.cmid) {\n                data.cmid = verificationData.cmid;\n            }\n\n            // Include action type if provided.\n            if (verificationData.actiontype) {\n                data.actiontype = verificationData.actiontype;\n            }\n\n            $.ajax({\n                url: M.cfg.wwwroot + '/local/quiz_password_verify/verify.php',\n                type: 'POST',\n                data: data,\n                dataType: 'json',\n                success: function (response) {\n                    if (response.success) {\n                        verified = true;\n                        modal.hide();\n                        modal.destroy();\n\n                        Notification.addNotification({\n                            message: response.message,\n                            type: 'success'\n                        });\n\n                        if (successCallback) {\n                            successCallback();\n                        }\n                    } else {\n                        Notification.addNotification({\n                            message: response.message,\n                            type: 'error'\n                        });\n                        $('#verify-password').val('').focus();\n                    }\n                },\n                error: function (xhr, status, error) {\n                    Notification.addNotification({\n                        message: 'Error verifying password: ' + error,\n                        type: 'error'\n                    });\n                    $('#verify-password').val('').focus();\n                }\n            });\n        };\n\n        // Nuclear Proxy: Intercept HTMLFormElement.prototype.submit.\n        var originalProtoSubmit = HTMLFormElement.prototype.submit;\n        HTMLFormElement.prototype.submit = function () {\n\n            // Intercept if it's the finish attempt form (ID check is most reliable for Summary page)\n            // OR if it's processattempt.php on the summary page (fallback).\n            var isFinishForm = (this.id === 'frm-finishattempt');\n            var isSummaryPage = document.body.classList.contains('path-mod-quiz-summary') ||\n                document.body.id === 'page-mod-quiz-summary';\n            var isProcessAttempt = this.action && this.action.indexOf('processattempt.php') > -1;\n\n            if (isFinishForm || (isProcessAttempt && isSummaryPage)) {\n                var form = this;\n\n                if (verified) {\n                    originalProtoSubmit.apply(this, arguments);\n                    return;\n                }\n\n                var attemptIdField = $(form).find('input[name=\"attempt\"]');\n                var currentAttemptId = attemptIdField.val();\n\n                if (!currentAttemptId && attemptId) {\n                    currentAttemptId = attemptId;\n                }\n\n                if (currentAttemptId) {\n                    showPasswordModal({\n                        attemptid: currentAttemptId,\n                        actiontype: 'quiz_submit'\n                    }, function () {\n                        originalProtoSubmit.apply(form, arguments);\n                    });\n                } else {\n                    originalProtoSubmit.apply(this, arguments);\n                }\n            } else {\n                originalProtoSubmit.apply(this, arguments);\n            }\n        };\n\n        /**\n         * Initialize the password verification\n         *\n         * @param {int} quizAttemptId The attempt ID\n         */\n        var init = function (quizAttemptId) {\n            attemptId = quizAttemptId;\n\n            // Capture phase listener for \"Mark as done\" ONLY.\n            window.addEventListener('click', function (e) {\n                var target = e.target;\n\n                // Handle \"Mark as done\".\n                var toggleButton = target.closest('[data-action=\"toggle-manual-completion\"]');\n                if (toggleButton) {\n                    // Check for quiz OR resource context (including View page).\n                    // This covers both Read and Understand (resource) and Competency (quiz) courses.\n                    if (toggleButton.closest('.modtype_quiz') ||\n                        toggleButton.closest('.activity.quiz') ||\n                        toggleButton.closest('.modtype_resource') ||\n                        toggleButton.closest('.activity.resource') ||\n                        document.body.classList.contains('path-mod-quiz') ||\n                        document.body.classList.contains('path-mod-resource')) {\n\n                        if (verified) {\n                            return;\n                        }\n\n                        e.preventDefault();\n                        e.stopImmediatePropagation();\n                        e.stopPropagation();\n\n                        var cmid = toggleButton.dataset.cmid;\n\n                        // Determine action type based on current completion state.\n                        var actiontype = 'mark_done'; // Default.\n                        var completionState = toggleButton.dataset.toggletype;\n                        if (completionState === 'manual:undo') {\n                            actiontype = 'mark_undone';\n                        } else if (completionState === 'manual:mark-done') {\n                            actiontype = 'mark_done';\n                        }\n\n                        showPasswordModal({\n                            cmid: cmid,\n                            actiontype: actiontype\n                        }, function () {\n                            toggleButton.click();\n                        });\n                        return;\n                    }\n                }\n            }, true); // Capture phase on WINDOW.\n        };\n\n        /**\n         * Verify action (exposed API)\n         *\n         * @param {Object} data Data for verification {attemptid: ..., cmid: ...}\n         * @param {Function} callback Function to call on success\n         */\n        var verifyAction = function (data, callback) {\n            if (verified) {\n                callback();\n                return;\n            }\n            showPasswordModal(data, function () {\n                callback();\n            });\n        };\n\n        return {\n            init: init,\n            verifyAction: verifyAction\n        };\n    });\n"],"names":["define","$","Notification","ModalFactory","ModalEvents","attemptId","verified","showPasswordModal","verificationData","successCallback","create","type","types","SAVE_CANCEL","title","M","util","get_string","body","then","modal","setSaveButtonText","getRoot","addClass","on","save","e","preventDefault","password","val","verifyPassword","addNotification","message","show","shown","focus","data","sesskey","cfg","attemptid","cmid","actiontype","ajax","url","wwwroot","dataType","success","response","hide","destroy","error","xhr","status","originalProtoSubmit","HTMLFormElement","prototype","submit","isFinishForm","this","id","isSummaryPage","document","classList","contains","isProcessAttempt","action","indexOf","form","apply","arguments","attemptIdField","find","currentAttemptId","init","quizAttemptId","window","addEventListener","toggleButton","target","closest","stopImmediatePropagation","stopPropagation","dataset","completionState","toggletype","click","verifyAction","callback"],"mappings":"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"}