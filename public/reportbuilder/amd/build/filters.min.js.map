{"version":3,"file":"filters.min.js","sources":["../src/filters.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Report builder filter management\r\n *\r\n * @module      core_reportbuilder/filters\r\n * @copyright   2021 Paul Holden <paulh@moodle.com>\r\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport {dispatchEvent} from 'core/event_dispatcher';\r\nimport {loadFragment} from 'core/fragment';\r\nimport Notification from 'core/notification';\r\nimport Pending from 'core/pending';\r\nimport {getString} from 'core/str';\r\nimport Templates from 'core/templates';\r\nimport {add as addToast} from 'core/toast';\r\nimport DynamicForm from 'core_form/dynamicform';\r\nimport * as reportEvents from 'core_reportbuilder/local/events';\r\nimport * as reportSelectors from 'core_reportbuilder/local/selectors';\r\nimport {resetFilters} from 'core_reportbuilder/local/repository/filters';\r\n\r\n/**\r\n * Update filter button text to indicate applied filter count\r\n *\r\n * @param {Element} reportElement\r\n * @param {Number} filterCount\r\n */\r\nconst setFilterButtonCount = async(reportElement, filterCount) => {\r\n    const filterButtonLabel = reportElement.querySelector(reportSelectors.regions.filterButtonLabel);\r\n\r\n    if (filterCount > 0) {\r\n        filterButtonLabel.textContent = await getString('filtersappliedx', 'core_reportbuilder', filterCount);\r\n    } else {\r\n        filterButtonLabel.textContent = await getString('filters', 'moodle');\r\n    }\r\n};\r\n\r\n/**\r\n * Initialise module for given report\r\n *\r\n * @method\r\n * @param {String} reportElementId\r\n * @param {Number} contextId\r\n */\r\nexport const init = (reportElementId, contextId) => {\r\n    const reportElement = document.getElementById(reportElementId);\r\n    const filterFormContainer = reportElement.querySelector(reportSelectors.regions.filtersForm);\r\n\r\n    // Ensure we only add our listeners once (can be called multiple times by mustache template).\r\n    if (filterFormContainer.dataset.initialized) {\r\n        return;\r\n    }\r\n    filterFormContainer.dataset.initialized = true;\r\n\r\n    const filterForm = new DynamicForm(filterFormContainer, '\\\\core_reportbuilder\\\\form\\\\filter');\r\n\r\n    // Submit report filters.\r\n    filterForm.addEventListener(filterForm.events.FORM_SUBMITTED, event => {\r\n        event.preventDefault();\r\n\r\n        // After the form has been submitted, we should trigger report table reload.\r\n        dispatchEvent(reportEvents.tableReload, {}, reportElement);\r\n        setFilterButtonCount(reportElement, event.detail);\r\n\r\n        getString('filtersapplied', 'core_reportbuilder')\r\n            .then(addToast)\r\n            .catch(Notification.exception);\r\n    });\r\n\r\n    // Reset report filters.\r\n    filterForm.addEventListener(filterForm.events.NOSUBMIT_BUTTON_PRESSED, event => {\r\n        event.preventDefault();\r\n\r\n        const pendingPromise = new Pending('core_reportbuilder/filters:reset');\r\n\r\n        const {reportId, reportParameters} = reportElement.dataset;\r\n        resetFilters(reportId, reportParameters)\r\n            .then(() => getString('filtersreset', 'core_reportbuilder'))\r\n            .then(addToast)\r\n            .then(() => loadFragment('core_reportbuilder', 'filters_form', contextId, {\r\n                reportid: reportId,\r\n                parameters: reportParameters,\r\n            }))\r\n            .then((html, js) => {\r\n                Templates.replaceNodeContents(filterFormContainer, html, js);\r\n\r\n                dispatchEvent(reportEvents.tableReload, {}, reportElement);\r\n                setFilterButtonCount(reportElement, 0);\r\n\r\n                return pendingPromise.resolve();\r\n            })\r\n            .catch(Notification.exception);\r\n    });\r\n\r\n    // Modify \"region-main\" overflow for big filter forms.\r\n    document.querySelector('#region-main').style.overflowX = \"visible\";\r\n};\r\n"],"names":["setFilterButtonCount","async","reportElement","filterCount","filterButtonLabel","querySelector","reportSelectors","regions","textContent","reportElementId","contextId","document","getElementById","filterFormContainer","filtersForm","dataset","initialized","filterForm","DynamicForm","addEventListener","events","FORM_SUBMITTED","event","preventDefault","reportEvents","tableReload","detail","then","addToast","catch","Notification","exception","NOSUBMIT_BUTTON_PRESSED","pendingPromise","Pending","reportId","reportParameters","reportid","parameters","html","js","replaceNodeContents","resolve","style","overflowX"],"mappings":";;;;;;;kYAyCMA,qBAAuBC,MAAMC,cAAeC,qBACxCC,kBAAoBF,cAAcG,cAAcC,gBAAgBC,QAAQH,mBAG1EA,kBAAkBI,YADlBL,YAAc,QACwB,kBAAU,kBAAmB,qBAAsBA,mBAEnD,kBAAU,UAAW,yBAW/C,CAACM,gBAAiBC,mBAC5BR,cAAgBS,SAASC,eAAeH,iBACxCI,oBAAsBX,cAAcG,cAAcC,gBAAgBC,QAAQO,gBAG5ED,oBAAoBE,QAAQC,mBAGhCH,oBAAoBE,QAAQC,aAAc,QAEpCC,WAAa,IAAIC,qBAAYL,oBAAqB,sCAGxDI,WAAWE,iBAAiBF,WAAWG,OAAOC,gBAAgBC,QAC1DA,MAAMC,qDAGQC,aAAaC,YAAa,GAAIvB,eAC5CF,qBAAqBE,cAAeoB,MAAMI,2BAEhC,iBAAkB,sBACvBC,KAAKC,YACLC,MAAMC,sBAAaC,cAI5Bd,WAAWE,iBAAiBF,WAAWG,OAAOY,yBAAyBV,QACnEA,MAAMC,uBAEAU,eAAiB,IAAIC,iBAAQ,qCAE7BC,SAACA,SAADC,iBAAWA,kBAAoBlC,cAAca,kCACtCoB,SAAUC,kBAClBT,MAAK,KAAM,kBAAU,eAAgB,wBACrCA,KAAKC,YACLD,MAAK,KAAM,0BAAa,qBAAsB,eAAgBjB,UAAW,CACtE2B,SAAUF,SACVG,WAAYF,qBAEfT,MAAK,CAACY,KAAMC,yBACCC,oBAAoB5B,oBAAqB0B,KAAMC,wCAE3ChB,aAAaC,YAAa,GAAIvB,eAC5CF,qBAAqBE,cAAe,GAE7B+B,eAAeS,aAEzBb,MAAMC,sBAAaC,cAI5BpB,SAASN,cAAc,gBAAgBsC,MAAMC,UAAY"}