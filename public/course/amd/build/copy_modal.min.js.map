{"version":3,"file":"copy_modal.min.js","sources":["../src/copy_modal.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * This module provides the course copy modal from the course and\r\n * category management screen.\r\n *\r\n * @module     core_course/copy_modal\r\n * @copyright  2020 onward The Moodle Users Association <https://moodleassociation.org/>\r\n * @author     Matt Porritt <mattp@catalyst-au.net>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n * @since      3.9\r\n */\r\n\r\nimport {get_string as getString} from 'core/str';\r\nimport Modal from 'core/modal';\r\nimport * as ajax from 'core/ajax';\r\nimport * as Fragment from 'core/fragment';\r\nimport Notification from 'core/notification';\r\nimport * as Config from 'core/config';\r\n\r\nexport default class CopyModal {\r\n    static init(context) {\r\n        return new CopyModal(context);\r\n    }\r\n\r\n    constructor(context) {\r\n        this.contextid = context;\r\n\r\n        this.registerEventListeners();\r\n    }\r\n\r\n    registerEventListeners() {\r\n        document.addEventListener('click', (e) => {\r\n            const copyAction = e.target.closest('.action-copy');\r\n            if (!copyAction) {\r\n                return;\r\n            }\r\n            e.preventDefault(); // Stop. Hammer time.\r\n\r\n            const url = new URL(copyAction.href);\r\n            const params = new URLSearchParams(url.search);\r\n\r\n            this.fetchCourseData(params.get('id'))\r\n            .then(([course]) => this.createModal(course))\r\n            .catch((error) => Notification.exception(error));\r\n        });\r\n    }\r\n\r\n    fetchCourseData(courseid) {\r\n        return ajax.call([{\r\n            methodname: 'core_course_get_courses',\r\n            args: {\r\n                options: {\r\n                    ids: [courseid],\r\n                },\r\n            },\r\n        }])[0];\r\n    }\r\n\r\n    submitBackupRequest(jsonformdata) {\r\n        return ajax.call([{\r\n            methodname: 'core_backup_submit_copy_form',\r\n            args: {\r\n                jsonformdata,\r\n            },\r\n        }])[0];\r\n    }\r\n\r\n    createModal(\r\n        course,\r\n        formdata = {},\r\n    ) {\r\n        const params = {\r\n            jsonformdata: JSON.stringify(formdata),\r\n            courseid: course.id,\r\n        };\r\n\r\n        // Create the Modal.\r\n        return Modal.create({\r\n            title: getString('copycoursetitle', 'backup', course.shortname),\r\n            body: Fragment.loadFragment('course', 'new_base_form', this.contextid, params),\r\n            large: true,\r\n            show: true,\r\n            removeOnClose: true,\r\n        })\r\n        .then((modal) => {\r\n            // Explicitly handle form click events.\r\n            modal.getRoot().on('click', '#id_submitreturn', (e) => {\r\n                this.processModalForm(course, modal, e);\r\n            });\r\n            modal.getRoot().on('click', '#id_cancel', (e) => {\r\n                e.preventDefault();\r\n                modal.destroy();\r\n            });\r\n            modal.getRoot().on('click', '#id_submitdisplay', (e) => {\r\n                e.formredirect = true;\r\n                this.processModalForm(course, modal, e);\r\n\r\n            });\r\n\r\n            return modal;\r\n        });\r\n    }\r\n\r\n    processModalForm(course, modal, e) {\r\n        e.preventDefault(); // Stop modal from closing.\r\n\r\n        // Form data.\r\n        const copyform = modal.getRoot().find('form').serialize();\r\n        const formjson = JSON.stringify(copyform);\r\n\r\n        // Handle invalid form fields for better UX.\r\n        const invalid = modal.getRoot()[0].querySelectorAll('[aria-invalid=\"true\"], .error');\r\n        if (invalid.length) {\r\n            invalid[0].focus();\r\n            return;\r\n        }\r\n\r\n        modal.destroy();\r\n\r\n        // Submit form via ajax.\r\n        this.submitBackupRequest(formjson)\r\n        .then(() => {\r\n            if (e.formredirect == true) {\r\n                // We are redirecting to copy progress display.\r\n                const redirect = `${Config.wwwroot}/backup/copyprogress.php?id=${course.id}`;\r\n                window.location.assign(redirect);\r\n            }\r\n\r\n            return;\r\n        })\r\n        .catch(() => {\r\n            // Form submission failed server side, redisplay with errors.\r\n            this.createModal(course, copyform);\r\n        });\r\n    }\r\n}\r\n"],"names":["CopyModal","context","constructor","contextid","registerEventListeners","document","addEventListener","e","copyAction","target","closest","preventDefault","url","URL","href","params","URLSearchParams","search","fetchCourseData","get","then","_ref","course","this","createModal","catch","error","Notification","exception","courseid","ajax","call","methodname","args","options","ids","submitBackupRequest","jsonformdata","formdata","JSON","stringify","id","Modal","create","title","shortname","body","Fragment","loadFragment","large","show","removeOnClose","modal","getRoot","on","processModalForm","destroy","formredirect","copyform","find","serialize","formjson","invalid","querySelectorAll","length","focus","redirect","Config","wwwroot","window","location","assign"],"mappings":";;;;;;;;;;0SAiCqBA,sBACLC,gBACD,IAAID,UAAUC,SAGzBC,YAAYD,cACHE,UAAYF,aAEZG,yBAGTA,yBACIC,SAASC,iBAAiB,SAAUC,UAC1BC,WAAaD,EAAEE,OAAOC,QAAQ,oBAC/BF,kBAGLD,EAAEI,uBAEIC,IAAM,IAAIC,IAAIL,WAAWM,MACzBC,OAAS,IAAIC,gBAAgBJ,IAAIK,aAElCC,gBAAgBH,OAAOI,IAAI,OAC/BC,MAAKC,WAAEC,oBAAYC,KAAKC,YAAYF,WACpCG,OAAOC,OAAUC,sBAAaC,UAAUF,YAIjDR,gBAAgBW,iBACLC,KAAKC,KAAK,CAAC,CACdC,WAAY,0BACZC,KAAM,CACFC,QAAS,CACLC,IAAK,CAACN,eAGd,GAGRO,oBAAoBC,qBACTP,KAAKC,KAAK,CAAC,CACdC,WAAY,+BACZC,KAAM,CACFI,aAAAA,iBAEJ,GAGRb,YACIF,YACAgB,gEAAW,SAELvB,OAAS,CACXsB,aAAcE,KAAKC,UAAUF,UAC7BT,SAAUP,OAAOmB,WAIdC,eAAMC,OAAO,CAChBC,OAAO,mBAAU,kBAAmB,SAAUtB,OAAOuB,WACrDC,KAAMC,SAASC,aAAa,SAAU,gBAAiBzB,KAAKpB,UAAWY,QACvEkC,OAAO,EACPC,MAAM,EACNC,eAAe,IAElB/B,MAAMgC,QAEHA,MAAMC,UAAUC,GAAG,QAAS,oBAAqB/C,SACxCgD,iBAAiBjC,OAAQ8B,MAAO7C,MAEzC6C,MAAMC,UAAUC,GAAG,QAAS,cAAe/C,IACvCA,EAAEI,iBACFyC,MAAMI,aAEVJ,MAAMC,UAAUC,GAAG,QAAS,qBAAsB/C,IAC9CA,EAAEkD,cAAe,OACZF,iBAAiBjC,OAAQ8B,MAAO7C,MAIlC6C,SAIfG,iBAAiBjC,OAAQ8B,MAAO7C,GAC5BA,EAAEI,uBAGI+C,SAAWN,MAAMC,UAAUM,KAAK,QAAQC,YACxCC,SAAWtB,KAAKC,UAAUkB,UAG1BI,QAAUV,MAAMC,UAAU,GAAGU,iBAAiB,iCAChDD,QAAQE,OACRF,QAAQ,GAAGG,SAIfb,MAAMI,eAGDpB,oBAAoByB,UACxBzC,MAAK,QACoB,GAAlBb,EAAEkD,aAAsB,OAElBS,mBAAcC,OAAOC,+CAAsC9C,OAAOmB,IACxE4B,OAAOC,SAASC,OAAOL,cAK9BzC,OAAM,UAEED,YAAYF,OAAQoC"}