{"version":3,"file":"actions.min.js","sources":["../../../src/local/content/actions.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Course state actions dispatcher.\r\n *\r\n * This module captures all data-dispatch links in the course content and dispatch the proper\r\n * state mutation, including any confirmation and modal required.\r\n *\r\n * @module     core_courseformat/local/content/actions\r\n * @class      core_courseformat/local/content/actions\r\n * @copyright  2021 Ferran Recio <ferran@moodle.com>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport {BaseComponent} from 'core/reactive';\r\nimport {eventTypes} from 'core/local/inplace_editable/events';\r\nimport Collapse from 'theme_boost/bootstrap/collapse';\r\nimport log from 'core/log';\r\nimport Modal from 'core/modal';\r\nimport ModalSaveCancel from 'core/modal_save_cancel';\r\nimport ModalDeleteCancel from 'core/modal_delete_cancel';\r\nimport ModalCopyToClipboard from 'core/modal_copy_to_clipboard';\r\nimport ModalEvents from 'core/modal_events';\r\nimport Templates from 'core/templates';\r\nimport {prefetchStrings} from 'core/prefetch';\r\nimport {getString} from 'core/str';\r\nimport {getFirst} from 'core/normalise';\r\nimport {toggleBulkSelectionAction} from 'core_courseformat/local/content/actions/bulkselection';\r\nimport Pending from 'core/pending';\r\nimport ContentTree from 'core_courseformat/local/courseeditor/contenttree';\r\n\r\n// Load global strings.\r\nprefetchStrings('core', ['movecoursesection', 'movecoursemodule', 'confirm', 'delete']);\r\n\r\n// Mutations are dispatched by the course content actions.\r\n// Formats can use this module addActions static method to add custom actions.\r\n// Direct mutations can be simple strings (mutation) name or functions.\r\nconst directMutations = {\r\n    sectionHide: 'sectionHide',\r\n    sectionShow: 'sectionShow',\r\n    cmHide: 'cmHide',\r\n    cmShow: 'cmShow',\r\n    cmStealth: 'cmStealth',\r\n    cmMoveRight: 'cmMoveRight',\r\n    cmMoveLeft: 'cmMoveLeft',\r\n    cmNoGroups: 'cmNoGroups',\r\n    cmSeparateGroups: 'cmSeparateGroups',\r\n    cmVisibleGroups: 'cmVisibleGroups',\r\n};\r\n\r\nexport default class extends BaseComponent {\r\n\r\n    /**\r\n     * Constructor hook.\r\n     */\r\n    create() {\r\n        // Optional component name for debugging.\r\n        this.name = 'content_actions';\r\n        // Default query selectors.\r\n        this.selectors = {\r\n            ACTIONLINK: `[data-action]`,\r\n            // Move modal selectors.\r\n            SECTIONLINK: `[data-for='section']`,\r\n            CMLINK: `[data-for='cm']`,\r\n            SECTIONNODE: `[data-for='sectionnode']`,\r\n            MODALTOGGLER: `[data-bs-toggle='collapse']`,\r\n            ADDSECTION: `[data-action='addSection']`,\r\n            CONTENTTREE: `#destination-selector`,\r\n            ACTIONMENU: `.action-menu`,\r\n            ACTIONMENUTOGGLER: `[data-bs-toggle=\"dropdown\"]`,\r\n            // Availability modal selectors.\r\n            OPTIONSRADIO: `[type='radio']`,\r\n            COURSEADDSECTION: `#course-addsection`,\r\n            ADDSECTIONREGION: `[data-region='section-addsection']`,\r\n        };\r\n        // Component css classes.\r\n        this.classes = {\r\n            DISABLED: `disabled`,\r\n            ITALIC: `fst-italic`,\r\n            DISPLAYNONE: `d-none`,\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Add extra actions to the module.\r\n     *\r\n     * @param {array} actions array of methods to execute\r\n     */\r\n    static addActions(actions) {\r\n        for (const [action, mutationReference] of Object.entries(actions)) {\r\n            if (typeof mutationReference !== 'function' && typeof mutationReference !== 'string') {\r\n                throw new Error(`${action} action must be a mutation name or a function`);\r\n            }\r\n            directMutations[action] = mutationReference;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Initial state ready method.\r\n     */\r\n    stateReady() {\r\n        // Delegate dispatch clicks.\r\n        this.addEventListener(\r\n            this.element,\r\n            'click',\r\n            this._dispatchClick\r\n        );\r\n        // Any inplace editable update needs state refresh.\r\n        this.addEventListener(\r\n            this.element,\r\n            eventTypes.elementUpdated,\r\n            this._inplaceEditableHandler\r\n        );\r\n    }\r\n\r\n    _dispatchClick(event) {\r\n        const target = event.target.closest(this.selectors.ACTIONLINK);\r\n        if (!target) {\r\n            return;\r\n        }\r\n        if (target.classList.contains(this.classes.DISABLED)) {\r\n            event.preventDefault();\r\n            return;\r\n        }\r\n\r\n        // Invoke proper method.\r\n        const actionName = target.dataset.action;\r\n        const methodName = this._actionMethodName(actionName);\r\n\r\n        if (this[methodName] !== undefined) {\r\n            this[methodName](target, event);\r\n            return;\r\n        }\r\n\r\n        // Check direct mutations or mutations handlers.\r\n        if (directMutations[actionName] !== undefined) {\r\n            if (typeof directMutations[actionName] === 'function') {\r\n                directMutations[actionName](target, event);\r\n                return;\r\n            }\r\n            this._requestMutationAction(target, event, directMutations[actionName]);\r\n            return;\r\n        }\r\n    }\r\n\r\n    _actionMethodName(name) {\r\n        const requestName = name.charAt(0).toUpperCase() + name.slice(1);\r\n        return `_request${requestName}`;\r\n    }\r\n\r\n    /**\r\n     * Handle inplace editable updates.\r\n     *\r\n     * @param {Event} event the triggered event\r\n     * @private\r\n     */\r\n    _inplaceEditableHandler(event) {\r\n        const itemtype = event.detail?.ajaxreturn?.itemtype;\r\n        const itemid = parseInt(event.detail?.ajaxreturn?.itemid);\r\n        if (!Number.isFinite(itemid) || !itemtype) {\r\n            return;\r\n        }\r\n\r\n        if (itemtype === 'activityname') {\r\n            this.reactive.dispatch('cmState', [itemid]);\r\n            return;\r\n        }\r\n        // Sections uses sectionname for normal sections and sectionnamenl for the no link sections.\r\n        if (itemtype === 'sectionname' || itemtype === 'sectionnamenl') {\r\n            this.reactive.dispatch('sectionState', [itemid]);\r\n            return;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Return the ids represented by this element.\r\n     *\r\n     * Depending on the dataset attributes the action could represent a single id\r\n     * or a bulk actions with all the current selected ids.\r\n     *\r\n     * @param {HTMLElement} target\r\n     * @returns {Number[]} array of Ids\r\n     */\r\n    _getTargetIds(target) {\r\n        let ids = [];\r\n        if (target?.dataset?.id) {\r\n            ids.push(target.dataset.id);\r\n        }\r\n        const bulkType = target?.dataset?.bulk;\r\n        if (!bulkType) {\r\n            return ids;\r\n        }\r\n        const bulk = this.reactive.get('bulk');\r\n        if (bulk.enabled && bulk.selectedType === bulkType) {\r\n            ids = [...ids, ...bulk.selection];\r\n        }\r\n        return ids;\r\n    }\r\n\r\n    /**\r\n     * Handle a move section request.\r\n     *\r\n     * @param {Element} target the dispatch action element\r\n     * @param {Event} event the triggered event\r\n     */\r\n    async _requestMoveSection(target, event) {\r\n        // Check we have an id.\r\n        const sectionIds = this._getTargetIds(target);\r\n        if (sectionIds.length == 0) {\r\n            return;\r\n        }\r\n\r\n        event.preventDefault();\r\n\r\n        const pendingModalReady = new Pending(`courseformat/actions:prepareMoveSectionModal`);\r\n\r\n        // The section edit menu to refocus on end.\r\n        const editTools = this._getClosestActionMenuToogler(target);\r\n\r\n        // Collect section information from the state.\r\n        const exporter = this.reactive.getExporter();\r\n        const data = exporter.course(this.reactive.state);\r\n        let titleText = null;\r\n\r\n        // Add the target section id and title.\r\n        let sectionInfo = null;\r\n        if (sectionIds.length == 1) {\r\n            sectionInfo = this.reactive.get('section', sectionIds[0]);\r\n            data.sectionid = sectionInfo.id;\r\n            data.sectiontitle = sectionInfo.title;\r\n            data.information = await this.reactive.getFormatString('sectionmove_info', data.sectiontitle);\r\n            titleText = this.reactive.getFormatString('sectionmove_title');\r\n        } else {\r\n            data.information = await this.reactive.getFormatString('sectionsmove_info', sectionIds.length);\r\n            titleText = this.reactive.getFormatString('sectionsmove_title');\r\n        }\r\n\r\n\r\n        // Create the modal.\r\n        // Build the modal parameters from the event data.\r\n        const modal = await this._modalBodyRenderedPromise(Modal, {\r\n            title: titleText,\r\n            body: Templates.render('core_courseformat/local/content/movesection', data),\r\n        });\r\n\r\n        const modalBody = getFirst(modal.getBody());\r\n\r\n        // Disable current selected section ids.\r\n        sectionIds.forEach(sectionId => {\r\n            const currentElement = modalBody.querySelector(`${this.selectors.SECTIONLINK}[data-id='${sectionId}']`);\r\n            this._disableLink(currentElement);\r\n        });\r\n\r\n        // Setup keyboard navigation.\r\n        new ContentTree(\r\n            modalBody.querySelector(this.selectors.CONTENTTREE),\r\n            {\r\n                SECTION: this.selectors.SECTIONNODE,\r\n                TOGGLER: this.selectors.MODALTOGGLER,\r\n                COLLAPSE: this.selectors.MODALTOGGLER,\r\n            },\r\n            true\r\n        );\r\n\r\n        // Capture click.\r\n        modalBody.addEventListener('click', (event) => {\r\n            const target = event.target.closest('a');\r\n            if (!target || target.dataset.for != 'section' || target.dataset.id === undefined) {\r\n                return;\r\n            }\r\n            if (target.getAttribute('aria-disabled')) {\r\n                return;\r\n            }\r\n            event.preventDefault();\r\n            this.reactive.dispatch('sectionMoveAfter', sectionIds, target.dataset.id);\r\n            this._destroyModal(modal, editTools);\r\n        });\r\n\r\n        pendingModalReady.resolve();\r\n    }\r\n\r\n    /**\r\n     * Handle a move cm request.\r\n     *\r\n     * @param {Element} target the dispatch action element\r\n     * @param {Event} event the triggered event\r\n     */\r\n    async _requestMoveCm(target, event) {\r\n        // Check we have an id.\r\n        const cmIds = this._getTargetIds(target);\r\n        if (cmIds.length == 0) {\r\n            return;\r\n        }\r\n\r\n        event.preventDefault();\r\n\r\n        const pendingModalReady = new Pending(`courseformat/actions:prepareMoveCmModal`);\r\n\r\n        // The section edit menu to refocus on end.\r\n        const editTools = this._getClosestActionMenuToogler(target);\r\n\r\n        // Collect information from the state.\r\n        const exporter = this.reactive.getExporter();\r\n        const data = exporter.course(this.reactive.state);\r\n\r\n        let titleText = null;\r\n        if (cmIds.length == 1) {\r\n            const cmInfo = this.reactive.get('cm', cmIds[0]);\r\n            data.cmid = cmInfo.id;\r\n            data.cmname = cmInfo.name;\r\n            data.information = await this.reactive.getFormatString('cmmove_info', data.cmname);\r\n            if (cmInfo.hasdelegatedsection) {\r\n                titleText = this.reactive.getFormatString('cmmove_subsectiontitle');\r\n            } else {\r\n                titleText = this.reactive.getFormatString('cmmove_title');\r\n            }\r\n        } else {\r\n            data.information = await this.reactive.getFormatString('cmsmove_info', cmIds.length);\r\n            titleText = this.reactive.getFormatString('cmsmove_title');\r\n        }\r\n\r\n        // Create the modal.\r\n        // Build the modal parameters from the event data.\r\n        const modal = await this._modalBodyRenderedPromise(Modal, {\r\n            title: titleText,\r\n            body: Templates.render('core_courseformat/local/content/movecm', data),\r\n        });\r\n\r\n        const modalBody = getFirst(modal.getBody());\r\n\r\n        // Disable current selected section ids.\r\n        cmIds.forEach(cmId => {\r\n            const currentElement = modalBody.querySelector(`${this.selectors.CMLINK}[data-id='${cmId}']`);\r\n            this._disableLink(currentElement);\r\n        });\r\n\r\n        // Setup keyboard navigation.\r\n        new ContentTree(\r\n            modalBody.querySelector(this.selectors.CONTENTTREE),\r\n            {\r\n                SECTION: this.selectors.SECTIONNODE,\r\n                TOGGLER: this.selectors.MODALTOGGLER,\r\n                COLLAPSE: this.selectors.MODALTOGGLER,\r\n                ENTER: this.selectors.SECTIONLINK,\r\n            }\r\n        );\r\n\r\n        cmIds.forEach(cmId => {\r\n            const cmInfo = this.reactive.get('cm', cmId);\r\n            let selector;\r\n            if (!cmInfo.hasdelegatedsection) {\r\n                selector = `${this.selectors.CMLINK}[data-id='${cmId}']`;\r\n            } else {\r\n                selector = `${this.selectors.SECTIONLINK}[data-id='${cmInfo.sectionid}']`;\r\n            }\r\n            const currentElement = modalBody.querySelector(selector);\r\n            this._expandCmMoveModalParentSections(modalBody, currentElement);\r\n        });\r\n\r\n        modalBody.addEventListener('click', (event) => {\r\n            const target = event.target.closest('a');\r\n            if (!target || target.dataset.for === undefined || target.dataset.id === undefined) {\r\n                return;\r\n            }\r\n            if (target.getAttribute('aria-disabled')) {\r\n                return;\r\n            }\r\n            event.preventDefault();\r\n\r\n            let targetSectionId;\r\n            let targetCmId;\r\n            let droppedCmIds = [...cmIds];\r\n            if (target.dataset.for == 'cm') {\r\n                const dropData = exporter.cmDraggableData(this.reactive.state, target.dataset.id);\r\n                targetSectionId = dropData.sectionid;\r\n                targetCmId = dropData.nextcmid;\r\n            } else {\r\n                const section = this.reactive.get('section', target.dataset.id);\r\n                targetSectionId = target.dataset.id;\r\n                targetCmId = section?.cmlist[0];\r\n            }\r\n            const section = this.reactive.get('section', targetSectionId);\r\n            if (section.component) {\r\n                // Remove cmIds which are not allowed to be moved to this delegated section (mostly\r\n                // all other delegated cm).\r\n                droppedCmIds = droppedCmIds.filter(cmId => {\r\n                    const cmInfo = this.reactive.get('cm', cmId);\r\n                    return !cmInfo.hasdelegatedsection;\r\n                });\r\n            }\r\n            if (droppedCmIds.length === 0) {\r\n                return; // No cm to move.\r\n            }\r\n            this.reactive.dispatch('cmMove', droppedCmIds, targetSectionId, targetCmId);\r\n            this._destroyModal(modal, editTools);\r\n        });\r\n\r\n        pendingModalReady.resolve();\r\n    }\r\n\r\n    /**\r\n     * Expand all the modal tree branches that contains the element.\r\n     *\r\n     * @private\r\n     * @param {HTMLElement} modalBody the modal body element\r\n     * @param {HTMLElement} element the element to display\r\n     */\r\n    _expandCmMoveModalParentSections(modalBody, element) {\r\n        const sectionnode = element.closest(this.selectors.SECTIONNODE);\r\n        if (!sectionnode) {\r\n            return;\r\n        }\r\n\r\n        const toggler = sectionnode.querySelector(this.selectors.MODALTOGGLER);\r\n        let collapsibleId = toggler.dataset.target ?? toggler.getAttribute('href');\r\n        if (collapsibleId) {\r\n            // We cannot be sure we have # in the id element name.\r\n            collapsibleId = collapsibleId.replace('#', '');\r\n            const expandNode = modalBody.querySelector(`#${collapsibleId}`);\r\n            new Collapse(expandNode, {toggle: false}).show();\r\n        }\r\n\r\n        // Section are a tree structure, we need to expand all the parents.\r\n        this._expandCmMoveModalParentSections(modalBody, sectionnode.parentElement);\r\n    }\r\n\r\n    /**\r\n     * Handle a create section request.\r\n     *\r\n     * @param {Element} target the dispatch action element\r\n     * @param {Event} event the triggered event\r\n     */\r\n    async _requestAddSection(target, event) {\r\n        event.preventDefault();\r\n        this.reactive.dispatch('addSection', target.dataset.id ?? 0);\r\n    }\r\n\r\n    /**\r\n     * Handle a create subsection request.\r\n     *\r\n     * @deprecated since Moodle 5.0 MDL-83469.\r\n     * @todo MDL-83851 This will be deleted in Moodle 6.0.\r\n     * @param {Element} target the dispatch action element\r\n     * @param {Event} event the triggered event\r\n     */\r\n    async _requestAddModule(target, event) {\r\n        log.debug('AddModule action is deprecated. Use newModule instead');\r\n        event.preventDefault();\r\n        this.reactive.dispatch('addModule', target.dataset.modname, target.dataset.sectionnum, target.dataset.beforemod);\r\n    }\r\n\r\n    /**\r\n     * Handle a new create subsection request.\r\n     *\r\n     * @param {Element} target the dispatch action element\r\n     * @param {Event} event the triggered event\r\n     */\r\n    async _requestNewModule(target, event) {\r\n        event.preventDefault();\r\n        this.reactive.dispatch('newModule', target.dataset.modname, target.dataset.sectionid, target.dataset.beforemod);\r\n    }\r\n\r\n    /**\r\n     * Handle a delete section request.\r\n     *\r\n     * @param {Element} target the dispatch action element\r\n     * @param {Event} event the triggered event\r\n     */\r\n    async _requestDeleteSection(target, event) {\r\n        const sectionIds = this._getTargetIds(target);\r\n        if (sectionIds.length == 0) {\r\n            return;\r\n        }\r\n\r\n        event.preventDefault();\r\n\r\n        // We don't need confirmation to delete empty sections.\r\n        let needsConfirmation = sectionIds.some(sectionId => {\r\n            const sectionInfo = this.reactive.get('section', sectionId);\r\n            const cmList = sectionInfo.cmlist ?? [];\r\n            return (cmList.length || sectionInfo.hassummary || sectionInfo.rawtitle);\r\n        });\r\n        if (!needsConfirmation) {\r\n            this._dispatchSectionDelete(sectionIds, target);\r\n            return;\r\n        }\r\n\r\n        let bodyText = null;\r\n        let titleText = null;\r\n        if (sectionIds.length == 1) {\r\n            titleText = this.reactive.getFormatString('sectiondelete_title');\r\n            const sectionInfo = this.reactive.get('section', sectionIds[0]);\r\n            bodyText = this.reactive.getFormatString('sectiondelete_info', {name: sectionInfo.title});\r\n        } else {\r\n            titleText = this.reactive.getFormatString('sectionsdelete_title');\r\n            bodyText = this.reactive.getFormatString('sectionsdelete_info', {count: sectionIds.length});\r\n        }\r\n\r\n        const modal = await this._modalBodyRenderedPromise(ModalDeleteCancel, {\r\n            title: titleText,\r\n            body: bodyText,\r\n        });\r\n\r\n        modal.getRoot().on(\r\n            ModalEvents.delete,\r\n            e => {\r\n                // Stop the default save button behaviour which is to close the modal.\r\n                e.preventDefault();\r\n                modal.destroy();\r\n                this._dispatchSectionDelete(sectionIds, target);\r\n            }\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Dispatch the section delete action and handle the redirection if necessary.\r\n     *\r\n     * @param {Array} sectionIds  the IDs of the sections to delete.\r\n     * @param {Element} target the dispatch action element\r\n     */\r\n    async _dispatchSectionDelete(sectionIds, target) {\r\n        await this.reactive.dispatch('sectionDelete', sectionIds);\r\n        if (target.baseURI.includes('section.php')) {\r\n            // Redirect to the course main page if the section is the current page.\r\n            window.location.href = this.reactive.get('course').baseurl;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Handle a toggle cm selection.\r\n     *\r\n     * @param {Element} target the dispatch action element\r\n     * @param {Event} event the triggered event\r\n     */\r\n    async _requestToggleSelectionCm(target, event) {\r\n        toggleBulkSelectionAction(this.reactive, target, event, 'cm');\r\n    }\r\n\r\n    /**\r\n     * Handle a toggle section selection.\r\n     *\r\n     * @param {Element} target the dispatch action element\r\n     * @param {Event} event the triggered event\r\n     */\r\n    async _requestToggleSelectionSection(target, event) {\r\n        toggleBulkSelectionAction(this.reactive, target, event, 'section');\r\n    }\r\n\r\n    /**\r\n     * Basic mutation action helper.\r\n     *\r\n     * @param {Element} target the dispatch action element\r\n     * @param {Event} event the triggered event\r\n     * @param {string} mutationName the mutation name\r\n     */\r\n    async _requestMutationAction(target, event, mutationName) {\r\n        if (!target.dataset.id && target.dataset.for !== 'bulkaction') {\r\n            return;\r\n        }\r\n        event.preventDefault();\r\n        if (target.dataset.for === 'bulkaction') {\r\n            // If the mutation is a bulk action we use the current selection.\r\n            this.reactive.dispatch(mutationName, this.reactive.get('bulk').selection);\r\n        } else {\r\n            this.reactive.dispatch(mutationName, [target.dataset.id]);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Handle a course permalink modal request.\r\n     *\r\n     * @param {Element} target the dispatch action element\r\n     * @param {Event} event the triggered event\r\n     */\r\n    _requestPermalink(target, event) {\r\n        event.preventDefault();\r\n        ModalCopyToClipboard.create(\r\n            {\r\n                text: target.getAttribute('href'),\r\n            },\r\n            getString('sectionlink', 'course')\r\n        );\r\n        return;\r\n    }\r\n\r\n    /**\r\n     * Handle a course module duplicate request.\r\n     *\r\n     * @param {Element} target the dispatch action element\r\n     * @param {Event} event the triggered event\r\n     */\r\n    async _requestCmDuplicate(target, event) {\r\n        const cmIds = this._getTargetIds(target);\r\n        if (cmIds.length == 0) {\r\n            return;\r\n        }\r\n        const sectionId = target.dataset.sectionid ?? null;\r\n        event.preventDefault();\r\n        this.reactive.dispatch('cmDuplicate', cmIds, sectionId);\r\n    }\r\n\r\n    /**\r\n     * Handle a delete cm request.\r\n     *\r\n     * @param {Element} target the dispatch action element\r\n     * @param {Event} event the triggered event\r\n     */\r\n    async _requestCmDelete(target, event) {\r\n        const cmIds = this._getTargetIds(target);\r\n        if (cmIds.length == 0) {\r\n            return;\r\n        }\r\n\r\n        event.preventDefault();\r\n\r\n        let bodyText = null;\r\n        let titleText = null;\r\n        let delegatedsection = null;\r\n        if (cmIds.length == 1) {\r\n            const cmInfo = this.reactive.get('cm', cmIds[0]);\r\n            if (cmInfo.hasdelegatedsection) {\r\n                delegatedsection = cmInfo.delegatesectionid;\r\n                titleText = this.reactive.getFormatString('cmdelete_subsectiontitle');\r\n                bodyText = getString(\r\n                    'sectiondelete_info',\r\n                    'core_courseformat',\r\n                    {\r\n                        type: cmInfo.modname,\r\n                        name: cmInfo.name,\r\n                    }\r\n                );\r\n            } else {\r\n                titleText = this.reactive.getFormatString('cmdelete_title');\r\n                bodyText = getString(\r\n                    'cmdelete_info',\r\n                    'core_courseformat',\r\n                    {\r\n                        type: cmInfo.modname,\r\n                        name: cmInfo.name,\r\n                    }\r\n                );\r\n            }\r\n        } else {\r\n            titleText = getString('cmsdelete_title', 'core_courseformat');\r\n            bodyText = getString(\r\n                'cmsdelete_info',\r\n                'core_courseformat',\r\n                {count: cmIds.length}\r\n            );\r\n        }\r\n\r\n        const modal = await this._modalBodyRenderedPromise(ModalDeleteCancel, {\r\n            title: titleText,\r\n            body: bodyText,\r\n        });\r\n\r\n        modal.getRoot().on(\r\n            ModalEvents.delete,\r\n            e => {\r\n                // Stop the default save button behaviour which is to close the modal.\r\n                e.preventDefault();\r\n                modal.destroy();\r\n                this.reactive.dispatch('cmDelete', cmIds);\r\n                if (cmIds.length == 1 && delegatedsection && target.baseURI.includes('section.php')) {\r\n                    // Redirect to the course main page if the subsection is the current page.\r\n                    let parameters = new URLSearchParams(window.location.search);\r\n                    if (parameters.has('id') && parameters.get('id') == delegatedsection) {\r\n                        this._dispatchSectionDelete([delegatedsection], target);\r\n                    }\r\n                }\r\n            }\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Handle a cm availability change request.\r\n     *\r\n     * @param {Element} target the dispatch action element\r\n     */\r\n    async _requestCmAvailability(target) {\r\n        const cmIds = this._getTargetIds(target);\r\n        if (cmIds.length == 0) {\r\n            return;\r\n        }\r\n        // Show the availability modal to decide which action to trigger.\r\n        const exporter = this.reactive.getExporter();\r\n        const data = {\r\n            allowstealth: exporter.canUseStealth(this.reactive.state, cmIds),\r\n        };\r\n        const modal = await this._modalBodyRenderedPromise(ModalSaveCancel, {\r\n            title: getString('availability', 'core'),\r\n            body: Templates.render('core_courseformat/local/content/cm/availabilitymodal', data),\r\n            saveButtonText: getString('apply', 'core'),\r\n        });\r\n\r\n        this._setupMutationRadioButtonModal(modal, cmIds);\r\n    }\r\n\r\n    /**\r\n     * Handle a section availability change request.\r\n     *\r\n     * @param {Element} target the dispatch action element\r\n     */\r\n    async _requestSectionAvailability(target) {\r\n        const sectionIds = this._getTargetIds(target);\r\n        if (sectionIds.length == 0) {\r\n            return;\r\n        }\r\n        const title = (sectionIds.length == 1) ? 'sectionavailability_title' : 'sectionsavailability_title';\r\n        // Show the availability modal to decide which action to trigger.\r\n        const modal = await this._modalBodyRenderedPromise(ModalSaveCancel, {\r\n            title: this.reactive.getFormatString(title),\r\n            body: Templates.render('core_courseformat/local/content/section/availabilitymodal', []),\r\n            saveButtonText: getString('apply', 'core'),\r\n        });\r\n\r\n        this._setupMutationRadioButtonModal(modal, sectionIds);\r\n    }\r\n\r\n    /**\r\n     * Add events to a mutation selector radio buttons modal.\r\n     * @param {Modal} modal\r\n     * @param {Number[]} ids the section or cm ids to apply the mutation\r\n     */\r\n    _setupMutationRadioButtonModal(modal, ids) {\r\n        // The save button is not enabled until the user selects an option.\r\n        modal.setButtonDisabled('save', true);\r\n\r\n        const submitFunction = (radio) => {\r\n            const mutation = radio?.value;\r\n            if (!mutation) {\r\n                return false;\r\n            }\r\n            this.reactive.dispatch(mutation, ids);\r\n            return true;\r\n        };\r\n\r\n        const modalBody = getFirst(modal.getBody());\r\n        const radioOptions = modalBody.querySelectorAll(this.selectors.OPTIONSRADIO);\r\n        radioOptions.forEach(radio => {\r\n            radio.addEventListener('change', () => {\r\n                modal.setButtonDisabled('save', false);\r\n            });\r\n            radio.parentNode.addEventListener('click', () => {\r\n                radio.checked = true;\r\n                modal.setButtonDisabled('save', false);\r\n            });\r\n            radio.parentNode.addEventListener('dblclick', dbClickEvent => {\r\n                if (submitFunction(radio)) {\r\n                    dbClickEvent.preventDefault();\r\n                    modal.destroy();\r\n                }\r\n            });\r\n        });\r\n\r\n        modal.getRoot().on(\r\n            ModalEvents.save,\r\n            () => {\r\n                const radio = modalBody.querySelector(`${this.selectors.OPTIONSRADIO}:checked`);\r\n                submitFunction(radio);\r\n            }\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Replace an element with a copy with a different tag name.\r\n     *\r\n     * @param {Element} element the original element\r\n     */\r\n    _disableLink(element) {\r\n        if (element) {\r\n            element.style.pointerEvents = 'none';\r\n            element.style.userSelect = 'none';\r\n            element.classList.add(this.classes.DISABLED);\r\n            element.classList.add(this.classes.ITALIC);\r\n            element.setAttribute('aria-disabled', true);\r\n            element.addEventListener('click', event => event.preventDefault());\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Render a modal and return a body ready promise.\r\n     *\r\n     * @param {Modal} ModalClass the modal class\r\n     * @param {object} modalParams the modal params\r\n     * @return {Promise} the modal body ready promise\r\n     */\r\n    _modalBodyRenderedPromise(ModalClass, modalParams) {\r\n        return new Promise((resolve, reject) => {\r\n            ModalClass.create(modalParams).then((modal) => {\r\n                modal.setRemoveOnClose(true);\r\n                // Handle body loading event.\r\n                modal.getRoot().on(ModalEvents.bodyRendered, () => {\r\n                    resolve(modal);\r\n                });\r\n                // Configure some extra modal params.\r\n                if (modalParams.saveButtonText !== undefined) {\r\n                    modal.setSaveButtonText(modalParams.saveButtonText);\r\n                }\r\n                if (modalParams.deleteButtonText !== undefined) {\r\n                    modal.setDeleteButtonText(modalParams.saveButtonText);\r\n                }\r\n                modal.show();\r\n                return;\r\n            }).catch(() => {\r\n                reject(`Cannot load modal content`);\r\n            });\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Hide and later destroy a modal.\r\n     *\r\n     * Behat will fail if we remove the modal while some boostrap collapse is executing.\r\n     *\r\n     * @param {Modal} modal\r\n     * @param {HTMLElement} element the dom element to focus on.\r\n     */\r\n    _destroyModal(modal, element) {\r\n        modal.hide();\r\n        const pendingDestroy = new Pending(`courseformat/actions:destroyModal`);\r\n        if (element) {\r\n            element.focus();\r\n        }\r\n        setTimeout(() =>{\r\n            modal.destroy();\r\n            pendingDestroy.resolve();\r\n        }, 500);\r\n    }\r\n\r\n    /**\r\n     * Get the closest actions menu toggler to an action element.\r\n     *\r\n     * @param {HTMLElement} element the action link element\r\n     * @returns {HTMLElement|undefined}\r\n     */\r\n    _getClosestActionMenuToogler(element) {\r\n        const actionMenu = element.closest(this.selectors.ACTIONMENU);\r\n        if (!actionMenu) {\r\n            return undefined;\r\n        }\r\n        return actionMenu.querySelector(this.selectors.ACTIONMENUTOGGLER);\r\n    }\r\n}\r\n"],"names":["directMutations","sectionHide","sectionShow","cmHide","cmShow","cmStealth","cmMoveRight","cmMoveLeft","cmNoGroups","cmSeparateGroups","cmVisibleGroups","BaseComponent","create","name","selectors","ACTIONLINK","SECTIONLINK","CMLINK","SECTIONNODE","MODALTOGGLER","ADDSECTION","CONTENTTREE","ACTIONMENU","ACTIONMENUTOGGLER","OPTIONSRADIO","COURSEADDSECTION","ADDSECTIONREGION","classes","DISABLED","ITALIC","DISPLAYNONE","actions","action","mutationReference","Object","entries","Error","stateReady","addEventListener","this","element","_dispatchClick","eventTypes","elementUpdated","_inplaceEditableHandler","event","target","closest","classList","contains","preventDefault","actionName","dataset","methodName","_actionMethodName","undefined","_requestMutationAction","requestName","charAt","toUpperCase","slice","itemtype","detail","_event$detail","ajaxreturn","_event$detail$ajaxret","itemid","parseInt","_event$detail2","_event$detail2$ajaxre","Number","isFinite","reactive","dispatch","_getTargetIds","ids","_target$dataset","id","push","bulkType","_target$dataset2","bulk","get","enabled","selectedType","selection","sectionIds","length","pendingModalReady","Pending","editTools","_getClosestActionMenuToogler","data","getExporter","course","state","titleText","sectionInfo","sectionid","sectiontitle","title","information","getFormatString","modal","_modalBodyRenderedPromise","Modal","body","Templates","render","modalBody","getBody","forEach","sectionId","currentElement","querySelector","_disableLink","ContentTree","SECTION","TOGGLER","COLLAPSE","for","getAttribute","_destroyModal","resolve","cmIds","exporter","cmInfo","cmid","cmname","hasdelegatedsection","cmId","ENTER","selector","_expandCmMoveModalParentSections","targetSectionId","targetCmId","droppedCmIds","dropData","cmDraggableData","nextcmid","section","cmlist","component","filter","sectionnode","toggler","collapsibleId","replace","expandNode","Collapse","toggle","show","parentElement","debug","modname","sectionnum","beforemod","some","hassummary","rawtitle","_dispatchSectionDelete","bodyText","count","ModalDeleteCancel","getRoot","on","ModalEvents","delete","e","destroy","baseURI","includes","window","location","href","baseurl","mutationName","_requestPermalink","text","delegatedsection","delegatesectionid","type","parameters","URLSearchParams","search","has","allowstealth","canUseStealth","ModalSaveCancel","saveButtonText","_setupMutationRadioButtonModal","setButtonDisabled","submitFunction","radio","mutation","value","querySelectorAll","parentNode","checked","dbClickEvent","save","style","pointerEvents","userSelect","add","setAttribute","ModalClass","modalParams","Promise","reject","then","setRemoveOnClose","bodyRendered","setSaveButtonText","deleteButtonText","setDeleteButtonText","catch","hide","pendingDestroy","focus","setTimeout","actionMenu"],"mappings":"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"}