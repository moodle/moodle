define("core_courseformat/local/activitychooser/dialogue",["exports","jquery","core/utils","core/custom_interaction_events","core_courseformat/local/activitychooser/dialoguedom","core/key_codes","core_courseformat/local/activitychooser/exporter","core/normalise","core/str","core/modal","core/modal_events","core/notification","core_courseformat/local/activitychooser/repository","core_courseformat/local/activitychooser/selectors","core/templates"],(function(_exports,_jquery,_utils,_custom_interaction_events,_dialoguedom,_key_codes,_exporter,_normalise,_str,_modal,ModalEvents,_notification,Repository,_selectors,Templates){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.displayActivityChooserModal=async function(footerDataPromise,modulesDataPromise){let bodyPromiseResolver;const bodyPromise=new Promise((resolve=>{bodyPromiseResolver=resolve})),exporter=new _exporter.default,footerData=await footerDataPromise,footerPromise=Templates.render("core_courseformat/local/activitychooser/footer",exporter.getFooterData(footerData)),sectionModal=_modal.default.create({body:bodyPromise,title:(0,_str.getString)("addresourceoractivity"),footer:footerPromise,large:!0,scrollable:!1,templateContext:{classes:"modchooser"},show:!0});try{const modulesData=await modulesDataPromise;if(!modulesData)return;const modal=await sectionModal;new ActivityChooserDialogue(modal,modulesData,footerData);const templateData=await exporter.getModChooserTemplateData(modulesData);bodyPromiseResolver(await Templates.render("core_courseformat/activitychooser",templateData))}catch(error){const errorTemplateData={errormessage:error.message};return void bodyPromiseResolver(await Templates.render("core_courseformat/local/activitychooser/error",errorTemplateData))}},_exports.displayChooser=void 0,_jquery=_interopRequireDefault(_jquery),_custom_interaction_events=_interopRequireDefault(_custom_interaction_events),_dialoguedom=_interopRequireDefault(_dialoguedom),_exporter=_interopRequireDefault(_exporter),_modal=_interopRequireDefault(_modal),ModalEvents=_interopRequireWildcard(ModalEvents),_notification=_interopRequireDefault(_notification),Repository=_interopRequireWildcard(Repository),_selectors=_interopRequireDefault(_selectors),Templates=_interopRequireWildcard(Templates);var _systemImportTransformerGlobalIdentifier="undefined"!=typeof window?window:"undefined"!=typeof self?self:"undefined"!=typeof global?global:{};function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}_exports.displayChooser=(modalPromise,sectionModules,partialFavourite,footerData)=>{window.console.warn("The displayChooser function is deprecated. Please displayActivityChooserModal instead."),modalPromise.then((modal=>(new ActivityChooserDialogue(modal,sectionModules,footerData),modal))).catch(_notification.default.exception)};class ActivityChooserDialogue{constructor(modal,modulesData,footerData){this.modal=modal,this.dialogueDom=null,this.footerData=footerData,this.exporter=new _exporter.default,this.selectedModule=null,this.isFavouriteTabDirty=!1,this.mappedModules=new Map,modulesData.forEach((module=>{this.mappedModules.set(module.componentname+"_"+module.link,module)})),this.init()}async init(){await this.modal.getBodyPromise(),await this.modal.getFooterPromise(),this.dialogueDom=new _dialoguedom.default(this,this.modal,this.exporter),this.registerModalListenerEvents(),this.setupKeyboardAccessibility(),this.modal.getRoot().on(ModalEvents.hidden,(()=>{this.modal.destroy()})),this.dialogueDom.unmarkAllChooserOptionAsSelected()}async registerModalListenerEvents(){const modalRoot=(0,_normalise.getFirst)(this.modal.getRoot());modalRoot.addEventListener("shown.bs.tab",(event=>{if(this.dialogueDom.unmarkAllChooserOptionAsSelected(),event.target.closest(_selectors.default.regions.allTabNav))return;const searchInput=this.dialogueDom.getSearchInputElement();searchInput.value.length>0&&(searchInput.value="",this.toggleSearchResultsView(searchInput.value))})),modalRoot.addEventListener("click",this.handleModalClick.bind(this)),modalRoot.addEventListener("dblclick",this.handleModalDoubleClick.bind(this));const searchInput=this.dialogueDom.getSearchInputElement();searchInput.addEventListener("input",(0,_utils.debounce)((()=>{this.toggleSearchResultsView(searchInput.value)}),300,{pending:!0})),this.dialogueDom.initBootstrapComponents(),modalRoot.addEventListener("shown.bs.tab",(event=>{event.relatedTarget&&this.dialogueDom.disableFocusAllChooserOptions(event.relatedTarget),this.dialogueDom.initActiveTabNavigation()})),modalRoot.addEventListener("shown.bs.tab",(()=>{this.isFavouriteTabDirty&&!this.dialogueDom.isFavoutiteTabActive()&&this.refreshFavouritesTabContent()})),this.dialogueDom.initActiveTabNavigation();(0,_normalise.getFirst)(await this.modal.getFooterPromise()).addEventListener("click",this.handleFooterClick.bind(this)),modalRoot.addEventListener("slide.bs.carousel",(event=>{void 0!==event.to&&(this.dialogueDom.toggleActiveFooter(0===event.to),this.dialogueDom.toggleBackButton(0!==event.to),this.dialogueDom.toggleAddButton(event.to<2))}))}async handleFooterClick(event){if(event.target.closest(_selectors.default.actions.addSelectedChooserOption)&&this.submitAddSelectedModule(),event.target.closest(_selectors.default.regions.activeFooter)&&!0===this.footerData.footer){const footerjs=await(pluginName=this.footerData.customfooterjs,"function"==typeof _systemImportTransformerGlobalIdentifier.define&&_systemImportTransformerGlobalIdentifier.define.amd?new Promise((function(resolve,reject){_systemImportTransformerGlobalIdentifier.require([pluginName],resolve,reject)})):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&_systemImportTransformerGlobalIdentifier.require&&"component"===_systemImportTransformerGlobalIdentifier.require.loader?Promise.resolve(require(pluginName)):Promise.resolve(_systemImportTransformerGlobalIdentifier[pluginName]));await footerjs.footerClickListener(event,this.footerData,this.modal)}var pluginName}async handleModalClick(event){const target=event.target;return target.closest(_selectors.default.actions.optionActions.showSummary)?(event.preventDefault(),void this.handleShowSummary(target)):target.closest(_selectors.default.actions.displayCategory)?(event.preventDefault(),void this.handleDisplayCategory(target)):target.closest(_selectors.default.actions.optionActions.manageFavourite)?(event.preventDefault(),void await this.handleFavouriteClick(target)):target.matches(_selectors.default.actions.closeOption)?(event.preventDefault(),void this.dialogueDom.hideModuleHelp(target.dataset.modname)):target.closest(_selectors.default.actions.clearSearch)?void this.handleClearSearch():target.closest(_selectors.default.regions.chooserOption.info)?(event.preventDefault(),void this.handleOptionSelection(target)):void 0}handleModalDoubleClick(event){null!==this.dialogueDom.getClosestChooserOption(event.target)&&this.submitAddSelectedModule(this.selectedModule)}handleShowSummary(target){const moduleName=this.dialogueDom.getClosestChooserOption(target).dataset.modname,moduleData=this.mappedModules.get(moduleName);this.handleOptionSelection(target),moduleData.showFooter=this.modal.hasFooterContent(),this.dialogueDom.setBackButtonModuleData(moduleData),this.dialogueDom.showModuleHelp(moduleData,this.modal)}handleDisplayCategory(target){const category=target.dataset.category;if(!category)return;this.dialogueDom.hideModuleHelp();const tabNav=this.dialogueDom.showCategoryTab(category);tabNav.focus(),tabNav.scrollIntoView()}async handleFavouriteClick(target){const caller=target.closest(_selectors.default.actions.optionActions.manageFavourite),id=caller.dataset.id,name=caller.dataset.name,internal=caller.dataset.internal;"true"===caller.dataset.favourited?(await Repository.unfavouriteModule(name,id),this.updateFavouriteItemValue(internal,!1)):(await Repository.favouriteModule(name,id),this.updateFavouriteItemValue(internal,!0))}handleClearSearch(){const searchInput=this.dialogueDom.getSearchInputElement();searchInput.value="",searchInput.focus(),this.toggleSearchResultsView(searchInput.value)}handleOptionSelection(target){const option=this.dialogueDom.getClosestChooserOption(target);null!==option&&(this.selectedModule=option,this.dialogueDom.markChooserOptionAsSelected(option,(0,_normalise.getFirst)(this.modal.getFooter())))}submitAddSelectedModule(){let newSelectedModule=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;newSelectedModule&&this.handleOptionSelection(newSelectedModule),null!==this.selectedModule&&(window.location.href=this.dialogueDom.getChooserOptionUrl(this.selectedModule))}setupKeyboardAccessibility(){const mainElement=(0,_normalise.getFirst)(this.modal.getModal()),$mainElement=(0,_jquery.default)(mainElement);mainElement.tabIndex=-1,_custom_interaction_events.default.define($mainElement,[_custom_interaction_events.default.events.next,_custom_interaction_events.default.events.previous,_custom_interaction_events.default.events.home,_custom_interaction_events.default.events.end]);const bindings=[{event:_custom_interaction_events.default.events.next,method:"focusNextChooserOption"},{event:_custom_interaction_events.default.events.previous,method:"focusPreviousChooserOption"},{event:_custom_interaction_events.default.events.home,method:"focusFirstChooserOption"},{event:_custom_interaction_events.default.events.end,method:"focusLastChooserOption"}],handleFocusMove=method=>(e,data)=>{const currentOption=this.dialogueDom.getClosestChooserOption(data.originalEvent.target);null!==currentOption&&(data.originalEvent.preventDefault(),this.dialogueDom[method](currentOption))};bindings.forEach((_ref=>{let{event:event,method:method}=_ref;$mainElement.on(event,handleFocusMove(method))})),mainElement.addEventListener("keydown",(e=>{const currentOption=this.dialogueDom.getClosestChooserOption(e.target);null!==currentOption&&(e.keyCode!==_key_codes.enter&&e.keyCode!==_key_codes.space||!e.target.closest(_selectors.default.regions.chooserOption.actions))&&(e.keyCode===_key_codes.space&&(e.preventDefault(),this.handleOptionSelection(currentOption)),e.keyCode===_key_codes.enter&&(e.preventDefault(),this.submitAddSelectedModule(currentOption)))}))}async toggleSearchResultsView(searchQuery){const searchResultsData=this.searchModules(searchQuery);searchQuery.length>0?(await this.dialogueDom.refreshSearchResults(searchQuery,searchResultsData),this.dialogueDom.showAllActivitiesTab(!0)):this.dialogueDom.cleanSearchResults()}searchModules(searchTerm){if(""===searchTerm)return this.mappedModules;searchTerm=searchTerm.toLowerCase();const searchResults=[];return this.mappedModules.forEach((activity=>{const activityName=activity.title.toLowerCase(),activitySummary=activity.summary.toLowerCase(),activityDesc=activity.help.toLowerCase();(activityName.includes(searchTerm)||activitySummary.includes(searchTerm)||activityDesc.includes(searchTerm))&&searchResults.push(activity)})),searchResults}async updateFavouriteItemValue(internal,favourite){const moduleItem=this.mappedModules.find((_ref2=>{let{name:name}=_ref2;return name===internal}));moduleItem&&(moduleItem.favourite=favourite,this.dialogueDom.updateItemStarredIcons(internal,favourite),this.dialogueDom.isFavoutiteTabActive()?this.isFavouriteTabDirty=!0:this.refreshFavouritesTabContent())}async refreshFavouritesTabContent(){this.isFavouriteTabDirty=!1;const favouriteCount=this.mappedModules.filter((mod=>!0===mod.favourite)).size;this.dialogueDom.toggleFavouriteTabDisplay(favouriteCount>0),await this.dialogueDom.refreshFavouritesTabContent(this.mappedModules)}}}));

//# sourceMappingURL=dialogue.min.js.map