{"version":3,"file":"exporter.min.js","sources":["../../../src/local/activitychooser/exporter.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Module to generate template data for the activity chooser.\r\n *\r\n * @module     core_courseformat/local/activitychooser/exporter\r\n * @copyright  2025 Ferran Recio <ferran@moodle.com>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport {getStrings} from 'core/str';\r\n\r\nconst activityCategories = [\r\n    'administration',\r\n    'assessment',\r\n    'collaboration',\r\n    'communication',\r\n    'content',\r\n    'interactivecontent',\r\n];\r\n\r\nlet allStrings = null;\r\n\r\nloadNecessaryStrings();\r\n\r\nexport default class {\r\n    /**\r\n     * A tab data structure.\r\n     *\r\n     * @typedef {object} TabData\r\n     * @property {String} tabId the tab ID\r\n     * @property {Boolean} active whether the tab is active or not\r\n     * @property {Array} items the filtered modules to be displayed in the tab\r\n     * @property {Boolean} displayed whether the tab is displayed or not\r\n     * @property {String} tabLabel the tab label\r\n     * @property {String|null} tabHelp the help text for the tab (optional)\r\n     */\r\n\r\n    /**\r\n     * @typedef {Object} ModuleHelpData\r\n     * @property {String} name The name of the module.\r\n     * @property {String} description The description of the module.\r\n     * @property {Array<ModulePurposeData>} purposes The purposes of the module.\r\n     * @property {Array} details Additional details about the module.\r\n     */\r\n\r\n    /**\r\n     * @typedef {Object} ModulePurposeData\r\n     * @property {String} purposename The name of the purpose.\r\n     * @property {String} purposelabel The label of the purpose.\r\n     */\r\n\r\n    /**\r\n     * Generate a tab data object for the activity chooser.\r\n     *\r\n     * @private\r\n     * @param {String} tabId Tab ID.\r\n     * @param {Array} filteredModules Filtered modules to be displayed in the tab.\r\n     * @param {String} tabLabel Tab label.\r\n     * @param {String|null} tabHelp Help text for the tab (optional).\r\n     * @param {Boolean} active Whether the tab is active or not.\r\n     * @return {TabData} Tab data object.\r\n     */\r\n    getTabData(tabId, filteredModules, tabLabel, tabHelp = null, active = false) {\r\n        const result = {\r\n            tabId: tabId,\r\n            active: active,\r\n            items: filteredModules,\r\n            displayed: filteredModules.length > 0,\r\n            tabLabel,\r\n        };\r\n        if (tabHelp) {\r\n            result.tabHelp = tabHelp;\r\n        }\r\n        return result;\r\n    }\r\n\r\n    /**\r\n     * Normalise the modules data to be used in the chooser.\r\n     *\r\n     * The modulesData can be a plain array or a Map. This method will convert it to a\r\n     * plain array of objects.\r\n     *\r\n     * @param {Array|Map} modulesData Modules data to be used in the chooser.\r\n     * @return {Array} Normalised modules data.\r\n     */\r\n    normaliseModulesData(modulesData) {\r\n        if (modulesData instanceof Map) {\r\n            modulesData = Array.from(modulesData.values());\r\n        } else if (!Array.isArray(modulesData)) {\r\n            throw new Error('Invalid modules data format. Expected an array or a Map.');\r\n        }\r\n        return modulesData;\r\n    }\r\n\r\n    /**\r\n     * Fetch the chooser template data for a specific section.\r\n     *\r\n     * @param {Array|Map} modulesData Modules data to be used in the chooser.\r\n     * @return {Promise<Object>} Promise resolved with the template data.\r\n     */\r\n    async getModChooserTemplateData(modulesData) {\r\n        modulesData = this.normaliseModulesData(modulesData);\r\n        const allStrings = await loadNecessaryStrings();\r\n        const favouriteTab = await this.getFavouriteTabData(modulesData);\r\n\r\n        const tabs = [\r\n            {\r\n                ...this.getTabData(\r\n                    'all',\r\n                    modulesData,\r\n                    allStrings.all,\r\n                    null,\r\n                    !favouriteTab.displayed,\r\n                ),\r\n                hasSearchResults: true, // The all tab will also show search results.\r\n            },\r\n            favouriteTab,\r\n            {\r\n                ...this.getTabData(\r\n                    'recommended',\r\n                    modulesData.filter(mod => mod.recommended === true),\r\n                    allStrings.recommended,\r\n                    allStrings.recommended_help\r\n                ),\r\n                separator: true, // Add a separator before the purpose categories.\r\n            },\r\n        ];\r\n\r\n        activityCategories.forEach((category) => {\r\n            const categoryModules = modulesData.filter(mod => mod.purpose == category || mod.otherpurpose == category);\r\n            if (categoryModules.length === 0) {\r\n                return;\r\n            }\r\n            tabs.push(\r\n                this.getTabData(\r\n                    category,\r\n                    categoryModules,\r\n                    allStrings['mod_purpose_' + category],\r\n                    allStrings['mod_purpose_' + category + '_help']\r\n                )\r\n            );\r\n        });\r\n\r\n        return {\r\n            modules: modulesData,\r\n            tabs,\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Get the module help template data.\r\n     *\r\n     * @param {Object} moduleData Data of the module to get help for.\r\n     * @return {Promise<ModuleHelpData>} Promise resolved with the module help data.\r\n     */\r\n    async getModuleHelpTemplateData(moduleData) {\r\n        const allStrings = await loadNecessaryStrings();\r\n        const data = {\r\n            ...moduleData,\r\n            purposes: [],\r\n        };\r\n        // Add purpose information from all related fields.\r\n        for (const purposeField of ['purpose', 'otherpurpose']) {\r\n            if (\r\n                !moduleData[purposeField]\r\n                || !activityCategories.includes(moduleData[purposeField])\r\n            ) {\r\n                continue;\r\n            }\r\n            data.purposes.push({\r\n                purposename: moduleData[purposeField],\r\n                purposelabel: allStrings[`mod_purpose_${moduleData[purposeField]}`],\r\n            });\r\n        }\r\n        data.haspurposes = data.purposes.length > 0;\r\n        // The rest of details are displayed as a simpler list.\r\n        data.details = [\r\n            {\r\n                label: allStrings['gradable'],\r\n                value: moduleData.gradable ? allStrings['yes'] : allStrings['no'],\r\n            },\r\n        ];\r\n        return data;\r\n    }\r\n\r\n    /**\r\n     * Get the favourite tab data.\r\n     *\r\n     * @param {Array|Map} modulesData Modules data to be used in the chooser.\r\n     * @return {Promise<TabData>} Promise resolved with the template data.\r\n     */\r\n    async getFavouriteTabData(modulesData) {\r\n        modulesData = this.normaliseModulesData(modulesData);\r\n        const allStrings = await loadNecessaryStrings();\r\n\r\n        // We need to deconstruct the modules data to ensure it is an array.\r\n        const favouriteModules = modulesData.filter(\r\n            mod => {\r\n                return mod.favourite === true;\r\n            }\r\n        );\r\n\r\n        return this.getTabData(\r\n            'favourites',\r\n            favouriteModules,\r\n            allStrings.favourites,\r\n            null,\r\n            favouriteModules.length > 0,\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Get the search result template data.\r\n     *\r\n     * @param {String} searchQuery The search query string.\r\n     * @param {Array|Map} resultsModulesData Modules data to be used in the chooser.\r\n     * @return {Object} The template data.\r\n     */\r\n    getSearchResultData(searchQuery, resultsModulesData) {\r\n        resultsModulesData = this.normaliseModulesData(resultsModulesData);\r\n        return {\r\n            'searchresultsnumber': resultsModulesData.length,\r\n            'searchresults': resultsModulesData,\r\n            'hasresults': resultsModulesData.length > 0,\r\n            'searchquery': searchQuery,\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Get the number of items in a tab.\r\n     *\r\n     * @param {TabData} tabData The tab data.\r\n     * @return {Number} The number of items in the tab.\r\n     */\r\n    countTabItems(tabData) {\r\n        return tabData.items?.length ?? 0;\r\n    }\r\n\r\n    /**\r\n     * Get the activity chooser footer template data.\r\n     * @param {Object} footerData The active footer data object.\r\n     * @return {Object} The template data.\r\n     */\r\n    getFooterData(footerData) {\r\n        return {\r\n            'activeFooter': footerData.customfootertemplate,\r\n        };\r\n    }\r\n}\r\n\r\n/**\r\n * Load the necessary strings for the activity chooser.\r\n *\r\n * @return {Promise<Object>} Promise resolved with the loaded strings.\r\n */\r\nasync function loadNecessaryStrings() {\r\n    if (allStrings !== null) {\r\n        return allStrings;\r\n    }\r\n    allStrings = {};\r\n\r\n    const stringToLoad = [\r\n        {key: 'all', component: 'core'},\r\n        {key: 'yes', component: 'core'},\r\n        {key: 'no', component: 'core'},\r\n        {key: 'favourites', component: 'core'},\r\n        {key: 'recommended', component: 'core'},\r\n        {key: 'gradable', component: 'core'},\r\n        {key: 'recommended_help', component: 'core_course'},\r\n        ...activityCategories.map(\r\n            (key) => ({\r\n                key: 'mod_purpose_' + key,\r\n                component: 'core_course',\r\n            })\r\n        ),\r\n        ...activityCategories.map(\r\n            (key) => ({\r\n                key: 'mod_purpose_' + key + '_help',\r\n                component: 'core_course',\r\n            })\r\n        ),\r\n    ];\r\n\r\n    const loadedStrings = await getStrings(stringToLoad);\r\n    stringToLoad.forEach(({key}, index) => {\r\n        allStrings[key] = loadedStrings[index];\r\n    });\r\n    return allStrings;\r\n}\r\n"],"names":["activityCategories","allStrings","loadNecessaryStrings","stringToLoad","key","component","map","loadedStrings","forEach","index","getTabData","tabId","filteredModules","tabLabel","tabHelp","result","active","items","displayed","length","normaliseModulesData","modulesData","Map","Array","from","values","isArray","Error","this","favouriteTab","getFavouriteTabData","tabs","all","hasSearchResults","filter","mod","recommended","recommended_help","separator","category","categoryModules","purpose","otherpurpose","push","modules","moduleData","data","purposes","purposeField","includes","purposename","purposelabel","haspurposes","details","label","value","gradable","favouriteModules","favourite","favourites","getSearchResultData","searchQuery","resultsModulesData","countTabItems","tabData","_tabData$items","getFooterData","footerData","customfootertemplate"],"mappings":";;;;;;;;MAyBMA,mBAAqB,CACvB,iBACA,aACA,gBACA,gBACA,UACA,0BAGAC,WAAa,KAEjBC,sCAyOeA,0BACQ,OAAfD,kBACOA,WAEXA,WAAa,SAEPE,aAAe,CACjB,CAACC,IAAK,MAAOC,UAAW,QACxB,CAACD,IAAK,MAAOC,UAAW,QACxB,CAACD,IAAK,KAAMC,UAAW,QACvB,CAACD,IAAK,aAAcC,UAAW,QAC/B,CAACD,IAAK,cAAeC,UAAW,QAChC,CAACD,IAAK,WAAYC,UAAW,QAC7B,CAACD,IAAK,mBAAoBC,UAAW,kBAClCL,mBAAmBM,KACjBF,OACGA,IAAK,eAAiBA,IACtBC,UAAW,qBAGhBL,mBAAmBM,KACjBF,OACGA,IAAK,eAAiBA,IAAM,QAC5BC,UAAW,mBAKjBE,oBAAsB,mBAAWJ,qBACvCA,aAAaK,SAAQ,MAAQC,aAAPL,IAACA,UACnBH,WAAWG,KAAOG,cAAcE,UAE7BR,yCAjOPS,WAAWC,MAAOC,gBAAiBC,cAAUC,+DAAU,WAC7CC,OAAS,CACXJ,MAAOA,MACPK,+DACAC,MAAOL,gBACPM,UAAWN,gBAAgBO,OAAS,EACpCN,SAAAA,iBAEAC,UACAC,OAAOD,QAAUA,SAEdC,OAYXK,qBAAqBC,gBACbA,uBAAuBC,IACvBD,YAAcE,MAAMC,KAAKH,YAAYI,eAClC,IAAKF,MAAMG,QAAQL,mBAChB,IAAIM,MAAM,mEAEbN,4CASqBA,aAC5BA,YAAcO,KAAKR,qBAAqBC,mBAClCpB,iBAAmBC,uBACnB2B,mBAAqBD,KAAKE,oBAAoBT,aAE9CU,KAAO,CACT,IACOH,KAAKlB,WACJ,MACAW,YACApB,WAAW+B,IACX,MACCH,aAAaX,WAElBe,kBAAkB,GAEtBJ,aACA,IACOD,KAAKlB,WACJ,cACAW,YAAYa,QAAOC,MAA2B,IAApBA,IAAIC,cAC9BnC,WAAWmC,YACXnC,WAAWoC,kBAEfC,WAAW,WAInBtC,mBAAmBQ,SAAS+B,iBAClBC,gBAAkBnB,YAAYa,QAAOC,KAAOA,IAAIM,SAAWF,UAAYJ,IAAIO,cAAgBH,WAClE,IAA3BC,gBAAgBrB,QAGpBY,KAAKY,KACDf,KAAKlB,WACD6B,SACAC,gBACAvC,WAAW,eAAiBsC,UAC5BtC,WAAW,eAAiBsC,SAAW,cAK5C,CACHK,QAASvB,YACTU,KAAAA,sCAUwBc,kBACtB5C,iBAAmBC,uBACnB4C,KAAO,IACND,WACHE,SAAU,QAGT,MAAMC,eAAgB,CAAC,UAAW,gBAE9BH,WAAWG,eACRhD,mBAAmBiD,SAASJ,WAAWG,gBAI/CF,KAAKC,SAASJ,KAAK,CACfO,YAAaL,WAAWG,cACxBG,aAAclD,iCAA0B4C,WAAWG,yBAG3DF,KAAKM,YAAcN,KAAKC,SAAS5B,OAAS,EAE1C2B,KAAKO,QAAU,CACX,CACIC,MAAOrD,WAAU,SACjBsD,MAAOV,WAAWW,SAAWvD,WAAU,IAAUA,WAAU,KAG5D6C,+BASezB,aACtBA,YAAcO,KAAKR,qBAAqBC,mBAClCpB,iBAAmBC,uBAGnBuD,iBAAmBpC,YAAYa,QACjCC,MAC6B,IAAlBA,IAAIuB,mBAIZ9B,KAAKlB,WACR,aACA+C,iBACAxD,WAAW0D,WACX,KACAF,iBAAiBtC,OAAS,GAWlCyC,oBAAoBC,YAAaC,0BAEtB,sBADPA,mBAAqBlC,KAAKR,qBAAqB0C,qBAED3C,qBACzB2C,8BACHA,mBAAmB3C,OAAS,cAC3B0C,aAUvBE,cAAcC,8GACHA,QAAQ/C,uCAARgD,eAAe9C,8DAAU,EAQpC+C,cAAcC,kBACH,cACaA,WAAWC"}