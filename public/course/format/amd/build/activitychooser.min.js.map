{"version":3,"file":"activitychooser.min.js","sources":["../src/activitychooser.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * A type of dialogue used as for choosing modules in a course.\r\n *\r\n * @module     core_courseformat/activitychooser\r\n * @copyright  2020 Mathew May <mathew.solutions>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport * as ChooserDialogue from 'core_courseformat/local/activitychooser/dialogue';\r\nimport CustomEvents from 'core/custom_interaction_events';\r\nimport Log from 'core/log';\r\nimport Pending from 'core/pending';\r\nimport * as Repository from 'core_courseformat/local/activitychooser/repository';\r\nimport selectors from 'core_courseformat/local/activitychooser/selectors';\r\n\r\nlet initialized = false;\r\n\r\n/**\r\n * Set up the activity chooser.\r\n *\r\n * @method init\r\n * @param {Number} courseId Course ID to use later on in fetchModules()\r\n * @param {Object|null} chooserConfig Any PHP config settings that we may need to reference\r\n */\r\nexport const init = (courseId, chooserConfig = null) => {\r\n    const pendingPromise = new Pending();\r\n\r\n    // TODO: Remove the chooserConfig in Moodle 6.0 (MDL-85655)\r\n    if (chooserConfig?.tabmode !== undefined) {\r\n        window.console.warn('The tabmode config option has been deprecated and will be ignored.');\r\n    }\r\n\r\n    registerListenerEvents(courseId);\r\n\r\n    pendingPromise.resolve();\r\n};\r\n\r\n/**\r\n * Once a selection has been made make the modal & module information and pass it along\r\n *\r\n * @method registerListenerEvents\r\n * @param {Number} courseId\r\n */\r\nconst registerListenerEvents = (courseId) => {\r\n    if (initialized) {\r\n        return;\r\n    }\r\n    initialized = true;\r\n\r\n    const eventsToHandle = [\r\n        'click',\r\n        CustomEvents.events.activate,\r\n        CustomEvents.events.keyboardActivate\r\n    ];\r\n\r\n    CustomEvents.define(document, eventsToHandle);\r\n\r\n    // Display module chooser event listeners.\r\n    eventsToHandle.forEach((eventToHandle) => {\r\n        document.addEventListener(eventToHandle, async(event) => {\r\n            if (!event.target.closest(selectors.elements.sectionmodchooser)) {\r\n                return;\r\n            }\r\n            const position = getCoursePositionFromTarget(event.target);\r\n\r\n            const footerDataPromise = Repository.getModalFooterData(courseId, position.sectionNum);\r\n\r\n            let modulesDataPromise;\r\n            if (position.sectionId && position.sectionId !== '') {\r\n                modulesDataPromise = Repository.getSectionModulesData(\r\n                    courseId,\r\n                    position.sectionId,\r\n                    position.sectionReturnNum,\r\n                    position.beforeMod,\r\n                );\r\n            } else {\r\n                // Todo remove this else in Moodle 6.0 (MDL-86310)\r\n                Log.debug(\r\n                    'Having only the section number attribute in the activity chooser is deprecated. ' +\r\n                    'Please add the data-section-id attribute.'\r\n                );\r\n                modulesDataPromise = Repository.getModulesData(\r\n                    courseId,\r\n                    position.sectionNum,\r\n                    position.sectionReturnNum,\r\n                    position.beforeMod,\r\n                );\r\n            }\r\n\r\n            ChooserDialogue.displayActivityChooserModal(footerDataPromise, modulesDataPromise);\r\n        });\r\n    });\r\n};\r\n\r\n/**\r\n * Return the course position of a target add activity element.\r\n *\r\n * @param {HTMLElement} target The target element.\r\n * @return {Object} The course position of the target.\r\n * @property {Number} sectionNum The section number.\r\n * @property {Number|null} sectionId The section id.\r\n * @property {Number|null} sectionReturnNum The section return number.\r\n * @property {Number|null} sectionReturnId The section return id.\r\n * @property {Number|null} beforeMod The ID of the cm to add the modules before.\r\n */\r\nfunction getCoursePositionFromTarget(target) {\r\n    let caller;\r\n    let sectionNum = null;\r\n    let sectionId = null;\r\n    // We need to know who called this.\r\n    // Standard courses use the ID in the main section info.\r\n    const sectionDiv = target.closest(selectors.elements.section);\r\n    // Front page courses need some special handling.\r\n    const button = target.closest(selectors.elements.sectionmodchooser);\r\n\r\n    // If we don't have a section number use the fallback ID.\r\n    // We always want the sectionDiv caller first as it keeps track of section number's after DnD changes.\r\n    // The button attribute is always just a fallback for us as the section div is not always available.\r\n    // A YUI change could be done maybe to only update the button attribute but we are going for minimal change here.\r\n    if (\r\n        sectionDiv !== null\r\n        && (sectionDiv.hasAttribute('data-number') || sectionDiv.hasAttribute('data-id'))\r\n    ) {\r\n        // We check for attributes just in case of outdated contrib course formats.\r\n        caller = sectionDiv;\r\n        sectionNum = sectionDiv.getAttribute('data-number');\r\n        sectionId = sectionDiv.getAttribute('data-id');\r\n    } else {\r\n        caller = button;\r\n        if (caller.hasAttribute('data-sectionid')) {\r\n            window.console.warn(\r\n                'The data-sectionid attribute has been deprecated. ' +\r\n                'Please update your code to use data-section-id passing the real section ID instead.'\r\n            );\r\n            caller.setAttribute('data-sectionnum', caller.dataset.sectionid);\r\n        }\r\n        sectionNum = caller.dataset.sectionnum;\r\n        sectionId = caller.getAttribute('data-section-id');\r\n    }\r\n    return {\r\n        sectionNum,\r\n        sectionId,\r\n        // The old data attribute for the section return number was data-sectionreturn.\r\n        sectionReturnNum: caller.dataset?.sectionreturnnum ?? caller.dataset?.sectionreturn ?? null,\r\n        sectionReturnId: caller.dataset?.sectionreturnid ?? null,\r\n        beforeMod: caller.dataset?.beforemod ?? null,\r\n    };\r\n}\r\n"],"names":["initialized","courseId","chooserConfig","pendingPromise","Pending","undefined","tabmode","window","console","warn","registerListenerEvents","resolve","eventsToHandle","CustomEvents","events","activate","keyboardActivate","define","document","forEach","eventToHandle","addEventListener","async","event","target","closest","selectors","elements","sectionmodchooser","position","caller","sectionNum","sectionId","sectionDiv","section","button","hasAttribute","getAttribute","setAttribute","dataset","sectionid","sectionnum","sectionReturnNum","_caller$dataset","sectionreturnnum","_caller$dataset2","sectionreturn","sectionReturnId","_caller$dataset3","sectionreturnid","beforeMod","_caller$dataset4","beforemod","getCoursePositionFromTarget","footerDataPromise","Repository","getModalFooterData","modulesDataPromise","getSectionModulesData","debug","getModulesData","ChooserDialogue","displayActivityChooserModal"],"mappings":";;;;;;;sYA8BIA,aAAc,gBASE,SAACC,cAAUC,qEAAgB,WACrCC,eAAiB,IAAIC,sBAGIC,KAA3BH,MAAAA,qBAAAA,cAAeI,UACfC,OAAOC,QAAQC,KAAK,sEAGxBC,uBAAuBT,UAEvBE,eAAeQ,iBASbD,uBAA0BT,cACxBD,mBAGJA,aAAc,QAERY,eAAiB,CACnB,QACAC,mCAAaC,OAAOC,SACpBF,mCAAaC,OAAOE,qDAGXC,OAAOC,SAAUN,gBAG9BA,eAAeO,SAASC,gBACpBF,SAASG,iBAAiBD,eAAeE,MAAAA,YAChCC,MAAMC,OAAOC,QAAQC,mBAAUC,SAASC,gCAGvCC,kBA0CmBL,2JAC7BM,OACAC,WAAa,KACbC,UAAY,WAGVC,WAAaT,OAAOC,QAAQC,mBAAUC,SAASO,SAE/CC,OAASX,OAAOC,QAAQC,mBAAUC,SAASC,mBAO9B,OAAfK,aACIA,WAAWG,aAAa,gBAAkBH,WAAWG,aAAa,aAGtEN,OAASG,WACTF,WAAaE,WAAWI,aAAa,eACrCL,UAAYC,WAAWI,aAAa,aAEpCP,OAASK,OACLL,OAAOM,aAAa,oBACpB7B,OAAOC,QAAQC,KACX,yIAGJqB,OAAOQ,aAAa,kBAAmBR,OAAOS,QAAQC,YAE1DT,WAAaD,OAAOS,QAAQE,WAC5BT,UAAYF,OAAOO,aAAa,0BAE7B,CACHN,WAAAA,WACAC,UAAAA,UAEAU,oFAAkBZ,OAAOS,0CAAPI,gBAAgBC,iGAAoBd,OAAOS,2CAAPM,iBAAgBC,mCAAiB,KACvFC,wEAAiBjB,OAAOS,2CAAPS,iBAAgBC,yEAAmB,KACpDC,iEAAWpB,OAAOS,2CAAPY,iBAAgBC,iEAAa,MAlFnBC,CAA4B9B,MAAMC,QAE7C8B,kBAAoBC,WAAWC,mBAAmBvD,SAAU4B,SAASE,gBAEvE0B,mBACA5B,SAASG,WAAoC,KAAvBH,SAASG,UAC/ByB,mBAAqBF,WAAWG,sBAC5BzD,SACA4B,SAASG,UACTH,SAASa,iBACTb,SAASqB,yBAITS,MACA,6HAGJF,mBAAqBF,WAAWK,eAC5B3D,SACA4B,SAASE,WACTF,SAASa,iBACTb,SAASqB,YAIjBW,gBAAgBC,4BAA4BR,kBAAmBG"}