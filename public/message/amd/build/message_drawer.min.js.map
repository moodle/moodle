{"version":3,"file":"message_drawer.min.js","sources":["../src/message_drawer.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Controls the message drawer.\r\n *\r\n * @module     core_message/message_drawer\r\n * @copyright  2018 Ryan Wyllie <ryan@moodle.com>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\ndefine(\r\n[\r\n    'jquery',\r\n    'core/custom_interaction_events',\r\n    'core/pubsub',\r\n    'core_message/message_drawer_view_contact',\r\n    'core_message/message_drawer_view_contacts',\r\n    'core_message/message_drawer_view_conversation',\r\n    'core_message/message_drawer_view_group_info',\r\n    'core_message/message_drawer_view_overview',\r\n    'core_message/message_drawer_view_search',\r\n    'core_message/message_drawer_view_settings',\r\n    'core_message/message_drawer_router',\r\n    'core_message/message_drawer_routes',\r\n    'core_message/message_drawer_events',\r\n    'core_message/message_drawer_helper',\r\n    'core/pending',\r\n    'core/drawer',\r\n    'core/toast',\r\n    'core/str',\r\n    'core/config',\r\n    'core/ajax',\r\n    'core/local/aria/focuslock',\r\n    'core/modal_backdrop',\r\n    'core/templates',\r\n    'core/local/aria/selectors',\r\n],\r\nfunction(\r\n    $,\r\n    CustomEvents,\r\n    PubSub,\r\n    ViewContact,\r\n    ViewContacts,\r\n    ViewConversation,\r\n    ViewGroupInfo,\r\n    ViewOverview,\r\n    ViewSearch,\r\n    ViewSettings,\r\n    Router,\r\n    Routes,\r\n    Events,\r\n    Helper,\r\n    Pending,\r\n    Drawer,\r\n    Toast,\r\n    Str,\r\n    Config,\r\n    Ajax,\r\n    FocusLock,\r\n    ModalBackdrop,\r\n    Templates,\r\n    AriaSelectors,\r\n) {\r\n\r\n    var SELECTORS = {\r\n        DRAWER: '[data-region=\"right-hand-drawer\"]',\r\n        PANEL_BODY_CONTAINER: '[data-region=\"panel-body-container\"]',\r\n        PANEL_HEADER_CONTAINER: '[data-region=\"panel-header-container\"]',\r\n        VIEW_CONTACT: '[data-region=\"view-contact\"]',\r\n        VIEW_CONTACTS: '[data-region=\"view-contacts\"]',\r\n        VIEW_CONVERSATION: '[data-region=\"view-conversation\"]',\r\n        VIEW_CONVERSATION_WITH_ID: '[data-region=\"view-conversation\"][data-conversation-id]',\r\n        VIEW_CONVERSATION_WITH_USER: '[data-region=\"view-conversation\"][data-other-user-id]',\r\n        VIEW_GROUP_INFO: '[data-region=\"view-group-info\"]',\r\n        VIEW_OVERVIEW: '[data-region=\"view-overview\"]',\r\n        VIEW_SEARCH: '[data-region=\"view-search\"]',\r\n        VIEW_SETTINGS: '[data-region=\"view-settings\"]',\r\n        ROUTES: '[data-route]',\r\n        ROUTES_BACK: '[data-route-back]',\r\n        HEADER_CONTAINER: '[data-region=\"header-container\"]',\r\n        BODY_CONTAINER: '[data-region=\"body-container\"]',\r\n        FOOTER_CONTAINER: '[data-region=\"footer-container\"]',\r\n        CLOSE_BUTTON: '[data-action=\"closedrawer\"]',\r\n        MESSAGE_INDEX: '[data-region=\"message-index\"]',\r\n        MESSAGE_TEXT_AREA: '[data-region=\"send-message-txt\"]',\r\n    };\r\n\r\n    /**\r\n     * Get elements for route.\r\n     *\r\n     * @param {String} namespace Unique identifier for the Routes\r\n     * @param {Object} root The message drawer container.\r\n     * @param {string} selector The route container.\r\n     *\r\n     * @return {array} elements Found route container objects.\r\n     */\r\n    var getParametersForRoute = function(namespace, root, selector) {\r\n\r\n        var header = root.find(SELECTORS.HEADER_CONTAINER).find(selector);\r\n        if (!header.length) {\r\n            header = root.find(SELECTORS.PANEL_HEADER_CONTAINER).find(selector);\r\n        }\r\n        var body = root.find(SELECTORS.BODY_CONTAINER).find(selector);\r\n        if (!body.length) {\r\n            body = root.find(SELECTORS.PANEL_BODY_CONTAINER).find(selector);\r\n        }\r\n        var footer = root.find(SELECTORS.FOOTER_CONTAINER).find(selector);\r\n\r\n        return [\r\n            namespace,\r\n            header.length ? header : null,\r\n            body.length ? body : null,\r\n            footer.length ? footer : null\r\n        ];\r\n    };\r\n\r\n    var routes = [\r\n        [Routes.VIEW_CONTACT, SELECTORS.VIEW_CONTACT, ViewContact.show, ViewContact.description],\r\n        [Routes.VIEW_CONTACTS, SELECTORS.VIEW_CONTACTS, ViewContacts.show, ViewContacts.description],\r\n        [Routes.VIEW_CONVERSATION, SELECTORS.VIEW_CONVERSATION, ViewConversation.show, ViewConversation.description],\r\n        [Routes.VIEW_GROUP_INFO, SELECTORS.VIEW_GROUP_INFO, ViewGroupInfo.show, ViewGroupInfo.description],\r\n        [Routes.VIEW_OVERVIEW, SELECTORS.VIEW_OVERVIEW, ViewOverview.show, ViewOverview.description],\r\n        [Routes.VIEW_SEARCH, SELECTORS.VIEW_SEARCH, ViewSearch.show, ViewSearch.description],\r\n        [Routes.VIEW_SETTINGS, SELECTORS.VIEW_SETTINGS, ViewSettings.show, ViewSettings.description]\r\n    ];\r\n\r\n    /**\r\n     * Create routes.\r\n     *\r\n     * @param {String} namespace Unique identifier for the Routes\r\n     * @param {Object} root The message drawer container.\r\n     */\r\n    var createRoutes = function(namespace, root) {\r\n        routes.forEach(function(route) {\r\n            Router.add(namespace, route[0], getParametersForRoute(namespace, root, route[1]), route[2], route[3]);\r\n        });\r\n    };\r\n\r\n    let backdropPromise = null;\r\n\r\n    /**\r\n     * Set the focus on the drawer.\r\n     *\r\n     * This method also creates or destroy any necessary backdrop zone and focus trap.\r\n     *\r\n     * @param {Object} root The message drawer container.\r\n     * @param {Boolean} hasFocus Whether the drawer has focus or not.\r\n     */\r\n    var setFocus = function(root, hasFocus) {\r\n        var drawerRoot = Drawer.getDrawerRoot(root);\r\n        if (!drawerRoot.length) {\r\n            return;\r\n        }\r\n        if (!backdropPromise) {\r\n            backdropPromise = Templates.render('core/modal_backdrop', {})\r\n                .then(html => new ModalBackdrop(html));\r\n        }\r\n        const backdropWithAdjustments = backdropPromise.then(modalBackdrop => {\r\n            const messageDrawerZIndex = window.getComputedStyle(drawerRoot[0]).zIndex;\r\n            if (messageDrawerZIndex) {\r\n                modalBackdrop.setZIndex(messageDrawerZIndex - 1);\r\n            }\r\n            modalBackdrop.getAttachmentPoint().get(0).addEventListener('click', e => {\r\n                PubSub.publish(Events.HIDE, {});\r\n                e.preventDefault();\r\n            });\r\n            return modalBackdrop;\r\n        });\r\n        if (hasFocus) {\r\n            FocusLock.trapFocus(root[0]);\r\n            // eslint-disable-next-line promise/catch-or-return\r\n            backdropWithAdjustments.then(modalBackdrop => {\r\n                if (modalBackdrop) {\r\n                    modalBackdrop.show();\r\n                    const pageWrapper = document.getElementById('page');\r\n                    pageWrapper.style.overflow = 'hidden';\r\n                    // Set the focus on the close button so when we press enter, it closes the drawer as it did before\r\n                    var closeButton = root.find(SELECTORS.CLOSE_BUTTON);\r\n                    if (closeButton.length) {\r\n                        closeButton.focus();\r\n                    }\r\n                }\r\n                return modalBackdrop;\r\n            });\r\n        } else {\r\n            // eslint-disable-next-line promise/catch-or-return\r\n            backdropWithAdjustments.then(modalBackdrop => {\r\n                if (modalBackdrop) {\r\n                    FocusLock.untrapFocus();\r\n                    var button = $(SELECTORS.DRAWER).attr('data-origin');\r\n                    if (button) {\r\n                        $('#' + button).focus();\r\n                    }\r\n                    modalBackdrop.hide();\r\n                    const pageWrapper = document.getElementById('page');\r\n                    pageWrapper.style.overflow = 'visible';\r\n                }\r\n                return modalBackdrop;\r\n            });\r\n        }\r\n    };\r\n    /**\r\n     * Show the message drawer.\r\n     *\r\n     * @param {string} namespace The route namespace.\r\n     * @param {Object} root The message drawer container.\r\n     */\r\n    var show = function(namespace, root) {\r\n        if (!root.attr('data-shown')) {\r\n            Router.go(namespace, Routes.VIEW_OVERVIEW);\r\n            root.attr('data-shown', true);\r\n        }\r\n\r\n        var drawerRoot = Drawer.getDrawerRoot(root);\r\n        if (drawerRoot.length) {\r\n            setFocus(root, true);\r\n            Drawer.show(drawerRoot);\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Hide the message drawer.\r\n     *\r\n     * @param {Object} root The message drawer container.\r\n     */\r\n    var hide = function(root) {\r\n        var drawerRoot = Drawer.getDrawerRoot(root);\r\n        if (drawerRoot.length) {\r\n            setFocus(root, false);\r\n            Drawer.hide(drawerRoot);\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Check if the drawer is visible.\r\n     *\r\n     * @param {Object} root The message drawer container.\r\n     * @return {boolean}\r\n     */\r\n    var isVisible = function(root) {\r\n        var drawerRoot = Drawer.getDrawerRoot(root);\r\n        if (drawerRoot.length) {\r\n            return Drawer.isVisible(drawerRoot);\r\n        }\r\n        return true;\r\n    };\r\n\r\n    /**\r\n     * Set Jump from button\r\n     *\r\n     * @param {String} buttonid The originating button id\r\n     */\r\n    var setJumpFrom = function(buttonid) {\r\n        $(SELECTORS.DRAWER).attr('data-origin', buttonid);\r\n    };\r\n\r\n    /**\r\n     * Store an unsent message.\r\n     *\r\n     * Don't store this if the user has already seen the unsent message.\r\n     * This avoids spamming and ensures the user is only reminded once per unsent message.\r\n     * If the unsent message is sent, this attribute is removed and notification is possible again (see sendMessage).\r\n     */\r\n    const storeUnsentMessage = async() => {\r\n        const messageTextArea = document.querySelector(SELECTORS.MESSAGE_TEXT_AREA);\r\n\r\n        if (messageTextArea.value.trim().length > 0 && !messageTextArea.hasAttribute('data-unsent-message-viewed')) {\r\n\r\n            let message = messageTextArea.value;\r\n            let conversationid = 0;\r\n            let otheruserid = 0;\r\n\r\n            // We don't always have a conversation to link the unsent message to, so let's check for that.\r\n            const conversationId = document.querySelector(SELECTORS.VIEW_CONVERSATION_WITH_ID);\r\n            if (conversationId) {\r\n                const conversationWithId = messageTextArea.closest(SELECTORS.VIEW_CONVERSATION_WITH_ID);\r\n                conversationid = conversationWithId.getAttribute('data-conversation-id');\r\n            }\r\n            // Store the 'other' user id if it is there. This can be used to create conversations.\r\n            const conversationUser = document.querySelector(SELECTORS.VIEW_CONVERSATION_WITH_USER);\r\n            if (conversationUser) {\r\n                const conversationWithUser = messageTextArea.closest(SELECTORS.VIEW_CONVERSATION_WITH_USER);\r\n                otheruserid = conversationWithUser.getAttribute('data-other-user-id');\r\n            }\r\n\r\n            setStoredUnsentMessage(message, conversationid, otheruserid);\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Get the stored unsent message from the session via web service.\r\n     *\r\n     * @returns {Promise}\r\n     */\r\n    const getStoredUnsentMessage = () => Ajax.call([{\r\n        methodname: 'core_message_get_unsent_message',\r\n        args: {}\r\n    }])[0];\r\n\r\n    /**\r\n     * Set the unsent message value in the session via web service.\r\n     *\r\n     * SendBeacon is used here because this is called on 'beforeunload'.\r\n     *\r\n     * @param {string} message The message string.\r\n     * @param {number} conversationid The conversation id.\r\n     * @param {number} otheruserid The other user id.\r\n     * @returns {Promise}\r\n     */\r\n    const setStoredUnsentMessage = (message, conversationid, otheruserid) => {\r\n        const method = 'core_message_set_unsent_message';\r\n        const requestUrl = new URL(`${Config.wwwroot}/lib/ajax/service.php`);\r\n        requestUrl.searchParams.set('sesskey', Config.sesskey);\r\n        requestUrl.searchParams.set('info', method);\r\n\r\n        navigator.sendBeacon(requestUrl, JSON.stringify([{\r\n            index: 0,\r\n            methodname: method,\r\n            args: {\r\n                message: message,\r\n                conversationid: conversationid,\r\n                otheruserid: otheruserid,\r\n            }\r\n        }]));\r\n    };\r\n\r\n    /**\r\n     * Check for an unsent message.\r\n     *\r\n     * @param {String} uniqueId Unique identifier for the Routes.\r\n     * @param {Object} root The message drawer container.\r\n     */\r\n    const getUnsentMessage = async(uniqueId, root) => {\r\n        let type;\r\n        let messageRoot;\r\n\r\n        // We need to check if we are on the message/index page.\r\n        // This logic is needed to handle the two message widgets here and ensure we are targetting the right one.\r\n        const messageIndex = document.querySelector(SELECTORS.MESSAGE_INDEX);\r\n        if (messageIndex !== null) {\r\n            type = 'index';\r\n            messageRoot = document.getElementById(`message-index-${uniqueId}`);\r\n            if (!messageRoot) {\r\n                // This is not the correct widget.\r\n                return;\r\n            }\r\n\r\n        } else {\r\n            type = 'drawer';\r\n            messageRoot = document.getElementById(`message-drawer-${uniqueId}`);\r\n        }\r\n\r\n        const storedMessage = await getStoredUnsentMessage();\r\n        const messageTextArea = messageRoot.querySelector(SELECTORS.MESSAGE_TEXT_AREA);\r\n        if (storedMessage.message && messageTextArea !== null) {\r\n            showUnsentMessage(messageTextArea, storedMessage, type, uniqueId, root);\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Show an unsent message.\r\n     *\r\n     * There are two message widgets on the message/index page.\r\n     * Because of that, we need to try and target the correct widget.\r\n     *\r\n     * @param {String} textArea The textarea element.\r\n     * @param {Object} stored The stored message content.\r\n     * @param {String} type Is this from the drawer or index page?\r\n     * @param {String} uniqueId Unique identifier for the Routes.\r\n     * @param {Object} root The message drawer container.\r\n     */\r\n    const showUnsentMessage = (textArea, stored, type, uniqueId, root) => {\r\n        // The user has already been notified.\r\n        if (textArea.hasAttribute('data-unsent-message-viewed')) {\r\n            return;\r\n        }\r\n\r\n        // Depending on the type, show the conversation with the data we have available.\r\n        // A conversation can be continued if there is a conversationid.\r\n        // If the user was messaging a new non-contact, we won't have a conversationid yet.\r\n        // In that case, we use the otheruserid value to start a conversation with them.\r\n        switch (type) {\r\n            case 'index':\r\n                // Show the conversation in the main panel on the message/index page.\r\n                if (stored.conversationid) {\r\n                    Router.go(uniqueId, Routes.VIEW_CONVERSATION, stored.conversationid, 'frompanel');\r\n                // There was no conversation id, let's get a conversation going using the user id.\r\n                } else if (stored.otheruserid) {\r\n                    Router.go(uniqueId, Routes.VIEW_CONVERSATION, null, 'create', stored.otheruserid);\r\n                }\r\n                break;\r\n\r\n            case 'drawer':\r\n                // Open the drawer and show the conversation.\r\n                if (stored.conversationid) {\r\n                    let args = {\r\n                        conversationid: stored.conversationid\r\n                    };\r\n                    Helper.showConversation(args);\r\n                // There was no conversation id, let's get a conversation going using the user id.\r\n                } else if (stored.otheruserid) {\r\n                    show(uniqueId, root);\r\n                    Router.go(uniqueId, Routes.VIEW_CONVERSATION, null, 'create', stored.otheruserid);\r\n                }\r\n                break;\r\n        }\r\n\r\n        // Populate the text area.\r\n        textArea.value = stored.message;\r\n        textArea.setAttribute('data-unsent-message-viewed', 1);\r\n\r\n        // Notify the user.\r\n        Toast.add(Str.get_string('unsentmessagenotification', 'core_message'));\r\n    };\r\n\r\n    /**\r\n     * Listen to and handle events for routing, showing and hiding the message drawer.\r\n     *\r\n     * @param {string} namespace The route namespace.\r\n     * @param {Object} root The message drawer container.\r\n     * @param {bool} alwaysVisible Is this messaging app always shown?\r\n     */\r\n    var registerEventListeners = function(namespace, root, alwaysVisible) {\r\n        CustomEvents.define(root, [CustomEvents.events.activate, CustomEvents.events.escape]);\r\n        var paramRegex = /^data-route-param-?(\\d*)$/;\r\n\r\n        root.on(CustomEvents.events.activate, SELECTORS.ROUTES, function(e, data) {\r\n            var element = $(e.target).closest(SELECTORS.ROUTES);\r\n            var route = element.attr('data-route');\r\n            var attributes = [];\r\n\r\n            for (var i = 0; i < element[0].attributes.length; i++) {\r\n                attributes.push(element[0].attributes[i]);\r\n            }\r\n\r\n            var paramAttributes = attributes.filter(function(attribute) {\r\n                var name = attribute.nodeName;\r\n                var match = paramRegex.test(name);\r\n                return match;\r\n            });\r\n            paramAttributes.sort(function(a, b) {\r\n                var aParts = paramRegex.exec(a.nodeName);\r\n                var bParts = paramRegex.exec(b.nodeName);\r\n                var aIndex = aParts.length > 1 ? aParts[1] : 0;\r\n                var bIndex = bParts.length > 1 ? bParts[1] : 0;\r\n\r\n                if (aIndex < bIndex) {\r\n                    return -1;\r\n                } else if (bIndex < aIndex) {\r\n                    return 1;\r\n                } else {\r\n                    return 0;\r\n                }\r\n            });\r\n\r\n            var params = paramAttributes.map(function(attribute) {\r\n                return attribute.nodeValue;\r\n            });\r\n\r\n            var routeParams = [namespace, route].concat(params);\r\n\r\n            Router.go.apply(null, routeParams);\r\n\r\n            data.originalEvent.preventDefault();\r\n        });\r\n\r\n        root.on(CustomEvents.events.activate, SELECTORS.ROUTES_BACK, function(e, data) {\r\n            Router.back(namespace);\r\n\r\n            data.originalEvent.preventDefault();\r\n        });\r\n\r\n        // Close the message drawer if the drawer is visible and the click happened outside the drawer and the toggle button.\r\n        $(document).on(CustomEvents.events.activate, e => {\r\n            var drawer = $(e.target).closest(SELECTORS.DRAWER);\r\n            var toggleButtonId = $(SELECTORS.DRAWER)?.attr('data-origin');\r\n            var toggleButton = '';\r\n            if (toggleButtonId !== undefined && toggleButtonId) {\r\n                toggleButton = $(e.target).closest(\"#\" + toggleButtonId);\r\n            }\r\n\r\n            if (!drawer.length && !toggleButton.length && isVisible(root)) {\r\n                // Determine if the element that was clicked is focusable.\r\n                var focusableElement = $(e.target).closest(AriaSelectors.elements.focusable);\r\n                if (focusableElement.length) {\r\n                    // We need to move the focus to the clicked element after the drawer is hidden,\r\n                    // so we need to clear the `data-origin` attribute first.\r\n                    $(SELECTORS.DRAWER).attr('data-origin', '');\r\n                }\r\n                // Hide the drawer.\r\n                hide(root);\r\n                // Move the focus to the clicked element if it is focusable.\r\n                if (focusableElement.length) {\r\n                    focusableElement.focus();\r\n                }\r\n            }\r\n        });\r\n\r\n        // These are theme-specific to help us fix random behat fails.\r\n        // These events target those events defined in BS3 and BS4 onwards.\r\n        root[0].querySelectorAll('.collapse').forEach((collapse) => {\r\n            collapse.addEventListener('hide.bs.collapse', (e) => {\r\n                var pendingPromise = new Pending();\r\n                e.target.addEventListener('hidden.bs.collapse', function() {\r\n                    pendingPromise.resolve();\r\n                }, {once: true});\r\n            });\r\n        });\r\n\r\n        root[0].querySelectorAll('.collapse').forEach((collapse) => {\r\n            collapse.addEventListener('show.bs.collapse', (e) => {\r\n                var pendingPromise = new Pending();\r\n                e.target.addEventListener('shown.bs.collapse', function() {\r\n                    pendingPromise.resolve();\r\n                }, {once: true});\r\n            });\r\n        });\r\n\r\n        $(SELECTORS.JUMPTO).focus(function() {\r\n            var firstInput = root.find(SELECTORS.CLOSE_BUTTON);\r\n            if (firstInput.length) {\r\n                firstInput.focus();\r\n            } else {\r\n                $(SELECTORS.HEADER_CONTAINER).find(SELECTORS.ROUTES_BACK).focus();\r\n            }\r\n        });\r\n\r\n        $(SELECTORS.DRAWER).focus(function() {\r\n            var button = $(this).attr('data-origin');\r\n            if (button) {\r\n                $('#' + button).focus();\r\n            }\r\n        });\r\n\r\n        if (!alwaysVisible) {\r\n            PubSub.subscribe(Events.SHOW, function() {\r\n                show(namespace, root);\r\n            });\r\n\r\n            PubSub.subscribe(Events.HIDE, function() {\r\n                hide(root);\r\n            });\r\n\r\n            PubSub.subscribe(Events.TOGGLE_VISIBILITY, function(buttonid) {\r\n                const buttonElement = document.getElementById(buttonid);\r\n                if (isVisible(root)) {\r\n                    hide(root);\r\n                    buttonElement?.setAttribute('aria-expanded', false);\r\n                    $(SELECTORS.JUMPTO).attr('tabindex', -1);\r\n                } else {\r\n                    show(namespace, root);\r\n                    buttonElement?.setAttribute('aria-expanded', true);\r\n                    setJumpFrom(buttonid);\r\n                    $(SELECTORS.JUMPTO).attr('tabindex', 0);\r\n                }\r\n            });\r\n            root.on(CustomEvents.events.escape, function() {\r\n                PubSub.publish(Events.HIDE, {});\r\n            });\r\n        }\r\n\r\n        PubSub.subscribe(Events.SHOW_CONVERSATION, function(args) {\r\n            setJumpFrom(args.buttonid);\r\n            show(namespace, root);\r\n            Router.go(namespace, Routes.VIEW_CONVERSATION, args.conversationid);\r\n        });\r\n\r\n        var closebutton = root.find(SELECTORS.CLOSE_BUTTON);\r\n        closebutton.on(CustomEvents.events.activate, function(e, data) {\r\n            data.originalEvent.preventDefault();\r\n            setFocus(root, false);\r\n            var button = $(SELECTORS.DRAWER).attr('data-origin');\r\n            if (button) {\r\n                $('#' + button).focus();\r\n            }\r\n            PubSub.publish(Events.TOGGLE_VISIBILITY, button);\r\n        });\r\n\r\n        PubSub.subscribe(Events.CREATE_CONVERSATION_WITH_USER, function(args) {\r\n            setJumpFrom(args.buttonid);\r\n            show(namespace, root);\r\n            Router.go(namespace, Routes.VIEW_CONVERSATION, null, 'create', args.userid);\r\n        });\r\n\r\n        PubSub.subscribe(Events.SHOW_SETTINGS, function() {\r\n            show(namespace, root);\r\n            Router.go(namespace, Routes.VIEW_SETTINGS);\r\n        });\r\n\r\n        PubSub.subscribe(Events.PREFERENCES_UPDATED, function(preferences) {\r\n            var filteredPreferences = preferences.filter(function(preference) {\r\n                return preference.type == 'message_entertosend';\r\n            });\r\n            var enterToSendPreference = filteredPreferences.length ? filteredPreferences[0] : null;\r\n\r\n            if (enterToSendPreference) {\r\n                var viewConversationFooter = root.find(SELECTORS.FOOTER_CONTAINER).find(SELECTORS.VIEW_CONVERSATION);\r\n                viewConversationFooter.attr('data-enter-to-send', enterToSendPreference.value);\r\n            }\r\n        });\r\n\r\n        // If our textarea is modified, remove the attribute which indicates the user has seen the unsent message notification.\r\n        // This will allow the user to be notified again.\r\n        const textArea = document.querySelector(SELECTORS.MESSAGE_TEXT_AREA);\r\n        if (textArea) {\r\n            textArea.addEventListener('keyup', function() {\r\n                textArea.removeAttribute('data-unsent-message-viewed');\r\n            });\r\n        }\r\n\r\n        // Catch any unsent messages and store them.\r\n        window.addEventListener('beforeunload', storeUnsentMessage);\r\n    };\r\n\r\n    /**\r\n     * Initialise the message drawer.\r\n     *\r\n     * @param {Object} root The message drawer container.\r\n     * @param {String} uniqueId Unique identifier for the Routes\r\n     * @param {bool} alwaysVisible Should we show the app now, or wait for the user?\r\n     * @param {Object} route\r\n     */\r\n    var init = function(root, uniqueId, alwaysVisible, route) {\r\n        root = $(root);\r\n        createRoutes(uniqueId, root);\r\n        registerEventListeners(uniqueId, root, alwaysVisible);\r\n\r\n        if (alwaysVisible) {\r\n            show(uniqueId, root);\r\n\r\n            if (route) {\r\n                var routeParams = route.params || [];\r\n                routeParams = [uniqueId, route.path].concat(routeParams);\r\n                Router.go.apply(null, routeParams);\r\n            }\r\n        }\r\n\r\n        // Mark the drawer as ready.\r\n        Helper.markDrawerReady();\r\n\r\n        // Get and show any unsent message.\r\n        getUnsentMessage(uniqueId, root);\r\n    };\r\n\r\n    return {\r\n        init: init,\r\n    };\r\n});\r\n"],"names":["define","$","CustomEvents","PubSub","ViewContact","ViewContacts","ViewConversation","ViewGroupInfo","ViewOverview","ViewSearch","ViewSettings","Router","Routes","Events","Helper","Pending","Drawer","Toast","Str","Config","Ajax","FocusLock","ModalBackdrop","Templates","AriaSelectors","SELECTORS","DRAWER","PANEL_BODY_CONTAINER","PANEL_HEADER_CONTAINER","VIEW_CONTACT","VIEW_CONTACTS","VIEW_CONVERSATION","VIEW_CONVERSATION_WITH_ID","VIEW_CONVERSATION_WITH_USER","VIEW_GROUP_INFO","VIEW_OVERVIEW","VIEW_SEARCH","VIEW_SETTINGS","ROUTES","ROUTES_BACK","HEADER_CONTAINER","BODY_CONTAINER","FOOTER_CONTAINER","CLOSE_BUTTON","MESSAGE_INDEX","MESSAGE_TEXT_AREA","routes","show","description","createRoutes","namespace","root","forEach","route","add","selector","header","find","length","body","footer","getParametersForRoute","backdropPromise","setFocus","hasFocus","drawerRoot","getDrawerRoot","render","then","html","backdropWithAdjustments","modalBackdrop","messageDrawerZIndex","window","getComputedStyle","zIndex","setZIndex","getAttachmentPoint","get","addEventListener","e","publish","HIDE","preventDefault","trapFocus","document","getElementById","style","overflow","closeButton","focus","untrapFocus","button","attr","hide","go","isVisible","setJumpFrom","buttonid","storeUnsentMessage","async","messageTextArea","querySelector","value","trim","hasAttribute","message","conversationid","otheruserid","closest","getAttribute","setStoredUnsentMessage","method","requestUrl","URL","wwwroot","searchParams","set","sesskey","navigator","sendBeacon","JSON","stringify","index","methodname","args","getUnsentMessage","uniqueId","type","messageRoot","storedMessage","call","showUnsentMessage","textArea","stored","showConversation","setAttribute","get_string","init","alwaysVisible","events","activate","escape","paramRegex","on","data","element","target","attributes","i","push","paramAttributes","filter","attribute","name","nodeName","test","sort","a","b","aParts","exec","bParts","aIndex","bIndex","params","map","nodeValue","routeParams","concat","apply","originalEvent","back","drawer","toggleButtonId","_$","toggleButton","undefined","focusableElement","elements","focusable","querySelectorAll","collapse","pendingPromise","resolve","once","JUMPTO","firstInput","this","subscribe","SHOW","TOGGLE_VISIBILITY","buttonElement","SHOW_CONVERSATION","CREATE_CONVERSATION_WITH_USER","userid","SHOW_SETTINGS","PREFERENCES_UPDATED","preferences","filteredPreferences","preference","enterToSendPreference","removeAttribute","registerEventListeners","path","markDrawerReady"],"mappings":"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"}