{"version":3,"file":"loader.min.js","sources":["../src/loader.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/ //\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Mathjax JS Loader.\r\n *\r\n * @module filter_mathjaxloader/loader\r\n * @copyright 2014 Damyon Wiese  <damyon@moodle.com>\r\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\nimport {\r\n    eventTypes,\r\n    notifyFilterContentRenderingComplete,\r\n} from 'core_filters/events';\r\n\r\n/**\r\n * URL to MathJax.\r\n * @type {string|null}\r\n */\r\nlet mathJaxUrl = null;\r\n\r\n/**\r\n * Promise that is resolved when MathJax was loaded.\r\n * @type {Promise|null}\r\n */\r\nlet mathJaxLoaded = null;\r\n\r\n/**\r\n * Called by the filter when it is active on any page.\r\n * This does not load MathJAX yet - it adds the configuration in case it gets loaded later.\r\n * It also subscribes to the filter-content-updated event so MathJax can respond to content loaded by Ajax.\r\n *\r\n * @param {Object} params List of configuration params containing mathjaxurl, mathjaxconfig (text) and lang\r\n */\r\nexport const configure = (params) => {\r\n    let config = {};\r\n    try {\r\n        if (params.mathjaxconfig !== '') {\r\n            config = JSON.parse(params.mathjaxconfig);\r\n        }\r\n    }\r\n    catch (e) {\r\n        window.console.error('Invalid JSON in mathjaxconfig.', e);\r\n    }\r\n    if (typeof config != 'object') {\r\n        config = {};\r\n    }\r\n    if (typeof config.loader !== 'object') {\r\n        config.loader = {};\r\n    }\r\n    if (!Array.isArray(config.loader.load)) {\r\n        config.loader.load = [];\r\n    }\r\n    if (typeof config.startup !== 'object') {\r\n        config.startup = {};\r\n    }\r\n\r\n    // Always ensure that ui/safe is in the list. Otherwise, there is a risk of XSS.\r\n    // https://docs.mathjax.org/en/v3.2-latest/options/safe.html.\r\n    if (!config.loader.load.includes('ui/safe')) {\r\n        config.loader.load.push('ui/safe');\r\n    }\r\n\r\n    // This filter controls what elements to typeset.\r\n    config.startup.typeset = false;\r\n\r\n    // Let's still set the locale even if the localization is not yet ported to version 3.2.2\r\n    // https://docs.mathjax.org/en/v3.2-latest/upgrading/v2.html#not-yet-ported-to-version-3.\r\n    config.locale = params.lang;\r\n\r\n    mathJaxUrl = params.mathjaxurl;\r\n    window.MathJax = config;\r\n\r\n    // Listen for events triggered when new text is added to a page that needs\r\n    // processing by a filter.\r\n    document.addEventListener(eventTypes.filterContentUpdated, contentUpdated);\r\n};\r\n\r\n/**\r\n * Add the node to the typeset queue.\r\n *\r\n * @param {HTMLElement} node The Node to be processed by MathJax\r\n * @private\r\n */\r\nconst typesetNode = (node) => {\r\n    if (!(node instanceof HTMLElement)) {\r\n        // We may have been passed a #text node.\r\n        // These cannot be formatted.\r\n        return;\r\n    }\r\n\r\n    loadMathJax().then(() => {\r\n        // Chain the calls to typesetPromise as it is recommended.\r\n        // https://docs.mathjax.org/en/v3.2-latest/web/typeset.html#handling-asynchronous-typesetting.\r\n        window.MathJax.startup.promise = window.MathJax.startup.promise\r\n            .then(() => window.MathJax.typesetPromise([node]))\r\n            .then(() => {\r\n                notifyFilterContentRenderingComplete([node]);\r\n            })\r\n            .catch(e => {\r\n                window.console.log(e);\r\n            });\r\n    });\r\n};\r\n\r\n/**\r\n * Called by the filter when an equation is found while rendering the page.\r\n */\r\nexport const typeset = () => {\r\n    const elements = document.getElementsByClassName('filter_mathjaxloader_equation');\r\n    for (const element of elements) {\r\n        typesetNode(element);\r\n    }\r\n};\r\n\r\n/**\r\n * Handle content updated events - typeset the new content.\r\n *\r\n * @param {CustomEvent} event - Custom event with \"nodes\" indicating the root of the updated nodes.\r\n */\r\nexport const contentUpdated = (event) => {\r\n    let listOfElementContainMathJax = [];\r\n    let hasMathJax = false;\r\n    // The list of HTMLElements in an Array.\r\n    event.detail.nodes.forEach((node) => {\r\n        if (!(node instanceof HTMLElement)) {\r\n            // We may have been passed a #text node.\r\n            return;\r\n        }\r\n        const mathjaxElements = node.querySelectorAll('.filter_mathjaxloader_equation');\r\n        if (mathjaxElements.length > 0) {\r\n            hasMathJax = true;\r\n        }\r\n        listOfElementContainMathJax.push(mathjaxElements);\r\n    });\r\n\r\n    if (!hasMathJax) {\r\n        return;\r\n    }\r\n\r\n    listOfElementContainMathJax.forEach((mathjaxElements) => {\r\n        mathjaxElements.forEach((node) => typesetNode(node));\r\n    });\r\n};\r\n\r\n/**\r\n * Load the MathJax script.\r\n *\r\n * @return Promise that is resolved when MathJax was loaded.\r\n */\r\nexport const loadMathJax = () => {\r\n    if (!mathJaxLoaded) {\r\n        if (!mathJaxUrl) {\r\n            return Promise.reject(new Error('URL to MathJax not set.'));\r\n        }\r\n\r\n        mathJaxLoaded = new Promise((resolve, reject) => {\r\n            const script = document.createElement('script');\r\n            script.type = 'text/javascript';\r\n            script.onload = resolve;\r\n            script.onerror = reject;\r\n            script.src = mathJaxUrl;\r\n            document.getElementsByTagName('head')[0].appendChild(script);\r\n        });\r\n    }\r\n    return mathJaxLoaded;\r\n};\r\n"],"names":["mathJaxUrl","mathJaxLoaded","params","config","mathjaxconfig","JSON","parse","e","window","console","error","loader","Array","isArray","load","startup","includes","push","typeset","locale","lang","mathjaxurl","MathJax","document","addEventListener","eventTypes","filterContentUpdated","contentUpdated","typesetNode","node","HTMLElement","loadMathJax","then","promise","typesetPromise","catch","log","elements","getElementsByClassName","element","event","listOfElementContainMathJax","hasMathJax","detail","nodes","forEach","mathjaxElements","querySelectorAll","length","Promise","reject","Error","resolve","script","createElement","type","onload","onerror","src","getElementsByTagName","appendChild"],"mappings":";;;;;;;;IA8BIA,WAAa,KAMbC,cAAgB,wBASMC,aAClBC,OAAS,OAEoB,KAAzBD,OAAOE,gBACPD,OAASE,KAAKC,MAAMJ,OAAOE,gBAGnC,MAAOG,GACHC,OAAOC,QAAQC,MAAM,iCAAkCH,GAEtC,iBAAVJ,SACPA,OAAS,IAEgB,iBAAlBA,OAAOQ,SACdR,OAAOQ,OAAS,IAEfC,MAAMC,QAAQV,OAAOQ,OAAOG,QAC7BX,OAAOQ,OAAOG,KAAO,IAEK,iBAAnBX,OAAOY,UACdZ,OAAOY,QAAU,IAKhBZ,OAAOQ,OAAOG,KAAKE,SAAS,YAC7Bb,OAAOQ,OAAOG,KAAKG,KAAK,WAI5Bd,OAAOY,QAAQG,SAAU,EAIzBf,OAAOgB,OAASjB,OAAOkB,KAEvBpB,WAAaE,OAAOmB,WACpBb,OAAOc,QAAUnB,OAIjBoB,SAASC,iBAAiBC,mBAAWC,qBAAsBC,uBASzDC,YAAeC,OACXA,gBAAgBC,aAMtBC,cAAcC,MAAK,KAGfxB,OAAOc,QAAQP,QAAQkB,QAAUzB,OAAOc,QAAQP,QAAQkB,QACnDD,MAAK,IAAMxB,OAAOc,QAAQY,eAAe,CAACL,SAC1CG,MAAK,sDACmC,CAACH,UAEzCM,OAAM5B,IACHC,OAAOC,QAAQ2B,IAAI7B,2BAQZ,WACb8B,SAAWd,SAASe,uBAAuB,qCAC5C,MAAMC,WAAWF,SAClBT,YAAYW,gBASPZ,eAAkBa,YACvBC,4BAA8B,GAC9BC,YAAa,EAEjBF,MAAMG,OAAOC,MAAMC,SAAShB,YAClBA,gBAAgBC,0BAIhBgB,gBAAkBjB,KAAKkB,iBAAiB,kCAC1CD,gBAAgBE,OAAS,IACzBN,YAAa,GAEjBD,4BAA4BxB,KAAK6B,oBAGhCJ,YAILD,4BAA4BI,SAASC,kBACjCA,gBAAgBD,SAAShB,MAASD,YAAYC,yDASzCE,YAAc,SAClB9B,cAAe,KACXD,kBACMiD,QAAQC,OAAO,IAAIC,MAAM,4BAGpClD,cAAgB,IAAIgD,SAAQ,CAACG,QAASF,gBAC5BG,OAAS9B,SAAS+B,cAAc,UACtCD,OAAOE,KAAO,kBACdF,OAAOG,OAASJ,QAChBC,OAAOI,QAAUP,OACjBG,OAAOK,IAAM1D,WACbuB,SAASoC,qBAAqB,QAAQ,GAAGC,YAAYP,kBAGtDpD"}