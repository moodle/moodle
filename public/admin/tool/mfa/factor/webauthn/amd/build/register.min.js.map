{"version":3,"file":"register.min.js","sources":["../src/register.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * For collecting WebAuthn authenticator details on factor setup\r\n *\r\n * @module     factor_webauthn/register\r\n * @copyright  Catalyst IT\r\n * @author     Alex Morris <alex.morris@catalyst.net.nz>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\ndefine([\r\n    'factor_webauthn/utils',\r\n    'core/prefetch',\r\n    'core/str',\r\n    'core/toast',\r\n], function(\r\n    utils,\r\n    Prefetch,\r\n    Str,\r\n    Toast,\r\n) {\r\n\r\n    /**\r\n     * Register the security key.\r\n     *\r\n     * @param {*} createArgs\r\n     */\r\n    async function registerSecurityKey(createArgs) {\r\n        try {\r\n            if (!navigator.credentials || !navigator.credentials.create) {\r\n                throw new Error('Browser not supported.');\r\n            }\r\n\r\n            if (createArgs.success === false) {\r\n                throw new Error(createArgs.msg || 'unknown error occurred');\r\n            }\r\n\r\n            utils.recursiveBase64StrToArrayBuffer(createArgs);\r\n            const cred = await navigator.credentials.create(createArgs);\r\n            const authenticatorResponse = {\r\n                transports: cred.response.getTransports ? cred.response.getTransports() : null,\r\n                clientDataJSON: cred.response.clientDataJSON ?\r\n                    utils.arrayBufferToBase64(cred.response.clientDataJSON) : null,\r\n                attestationObject: cred.response.attestationObject ?\r\n                    utils.arrayBufferToBase64(cred.response.attestationObject) : null,\r\n            };\r\n\r\n            const registerSuccess = await Str.getString('registersuccess', 'factor_webauthn');\r\n            await Toast.add(registerSuccess, {type: 'success'});\r\n\r\n            document.getElementById('id_response_input').value = JSON.stringify(authenticatorResponse);\r\n            // Enable the submit button so that we can proceed.\r\n            document.getElementById('id_submitbutton').disabled = false;\r\n        } catch (e) {\r\n            const registerError = await Str.getString('registererror', 'factor_webauthn', e.message);\r\n            await Toast.add(registerError, {type: 'warning'});\r\n        }\r\n    }\r\n\r\n    return {\r\n        init: function(createArgs) {\r\n            // Disable the submit button until we have registered a security key.\r\n            document.getElementById('id_submitbutton').disabled = true;\r\n\r\n            Prefetch.prefetchStrings('factor_webauthn', [\r\n                'registersuccess',\r\n                'registererror',\r\n            ]);\r\n\r\n            // Register event listeners.\r\n            createArgs = JSON.parse(createArgs);\r\n            document.getElementById('factor_webauthn-register').addEventListener('click', function() {\r\n                registerSecurityKey(createArgs);\r\n            });\r\n            document.getElementById('factor_webauthn-register').addEventListener('keypress', function() {\r\n                registerSecurityKey(createArgs);\r\n            });\r\n        }\r\n    };\r\n});\r\n"],"names":["define","utils","Prefetch","Str","Toast","registerSecurityKey","createArgs","navigator","credentials","create","Error","success","msg","recursiveBase64StrToArrayBuffer","cred","authenticatorResponse","transports","response","getTransports","clientDataJSON","arrayBufferToBase64","attestationObject","registerSuccess","getString","add","type","document","getElementById","value","JSON","stringify","disabled","e","registerError","message","init","prefetchStrings","parse","addEventListener"],"mappings":";;;;;;;;AAwBAA,kCAAO,CACH,wBACA,gBACA,WACA,eACD,SACCC,MACAC,SACAC,IACAC,sBAQeC,oBAAoBC,oBAEtBC,UAAUC,cAAgBD,UAAUC,YAAYC,aAC3C,IAAIC,MAAM,8BAGO,IAAvBJ,WAAWK,cACL,IAAID,MAAMJ,WAAWM,KAAO,0BAGtCX,MAAMY,gCAAgCP,kBAChCQ,WAAaP,UAAUC,YAAYC,OAAOH,YAC1CS,sBAAwB,CAC1BC,WAAYF,KAAKG,SAASC,cAAgBJ,KAAKG,SAASC,gBAAkB,KAC1EC,eAAgBL,KAAKG,SAASE,eAC1BlB,MAAMmB,oBAAoBN,KAAKG,SAASE,gBAAkB,KAC9DE,kBAAmBP,KAAKG,SAASI,kBAC7BpB,MAAMmB,oBAAoBN,KAAKG,SAASI,mBAAqB,MAG/DC,sBAAwBnB,IAAIoB,UAAU,kBAAmB,yBACzDnB,MAAMoB,IAAIF,gBAAiB,CAACG,KAAM,YAExCC,SAASC,eAAe,qBAAqBC,MAAQC,KAAKC,UAAUf,uBAEpEW,SAASC,eAAe,mBAAmBI,UAAW,EACxD,MAAOC,SACCC,oBAAsB9B,IAAIoB,UAAU,gBAAiB,kBAAmBS,EAAEE,eAC1E9B,MAAMoB,IAAIS,cAAe,CAACR,KAAM,mBAIvC,CACHU,KAAM,SAAS7B,YAEXoB,SAASC,eAAe,mBAAmBI,UAAW,EAEtD7B,SAASkC,gBAAgB,kBAAmB,CACxC,kBACA,kBAIJ9B,WAAauB,KAAKQ,MAAM/B,YACxBoB,SAASC,eAAe,4BAA4BW,iBAAiB,SAAS,WAC1EjC,oBAAoBC,eAExBoB,SAASC,eAAe,4BAA4BW,iBAAiB,YAAY,WAC7EjC,oBAAoBC"}