{"version":3,"file":"instance_form.min.js","sources":["../src/instance_form.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Our basic form manager for when a user either enters\r\n * their profile url or just wants to browse.\r\n *\r\n * This file is a mishmash of JS functions we need for both the standalone (M3.7, M3.8)\r\n * plugin & Moodle 3.9 functions. The 3.9 Functions have a base understanding that certain\r\n * things exist i.e. directory structures for templates. When this feature goes 3.9+ only\r\n * The goal is that we can quickly gut all AMD modules into bare JS files and use ES6 guidelines.\r\n * Till then this will have to do.\r\n *\r\n * @module     tool_moodlenet/instance_form\r\n * @copyright  2020 Mathew May <mathew.solutions>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\ndefine(['tool_moodlenet/validator',\r\n        'tool_moodlenet/selectors',\r\n        'core/loadingicon',\r\n        'core/templates',\r\n        'core/notification',\r\n        'jquery',\r\n        'theme_boost/bootstrap/carousel',\r\n        'core/normalise'],\r\n    function(Validator,\r\n             Selectors,\r\n             LoadingIcon,\r\n             Templates,\r\n             Notification,\r\n             $,\r\n             Carousel,\r\n             Normalise) {\r\n\r\n    /**\r\n     * Add the event listeners to our form.\r\n     *\r\n     * @method registerListenerEvents\r\n     * @param {HTMLElement} page The whole page element for our form area\r\n     */\r\n    var registerListenerEvents = function registerListenerEvents(page) {\r\n        page.addEventListener('click', function(e) {\r\n\r\n            // Our fake submit button / browse button.\r\n            if (e.target.matches(Selectors.action.submit)) {\r\n                var input = page.querySelector('[data-var=\"mnet-link\"]');\r\n                var overlay = page.querySelector(Selectors.region.spinner);\r\n                var validationArea = document.querySelector(Selectors.region.validationArea);\r\n\r\n                overlay.classList.remove('d-none');\r\n                var spinner = LoadingIcon.addIconToContainerWithPromise(overlay);\r\n                Validator.validation(input)\r\n                    .then(function(result) {\r\n                        spinner.resolve();\r\n                        overlay.classList.add('d-none');\r\n                        if (result.result) {\r\n                            input.classList.remove('is-invalid'); // Just in case the class has been applied already.\r\n                            input.classList.add('is-valid');\r\n                            validationArea.innerText = result.message;\r\n                            validationArea.classList.remove('text-danger');\r\n                            validationArea.classList.add('text-success');\r\n                            // Give the user some time to see their input is valid.\r\n                            setTimeout(function() {\r\n                                window.location = result.domain;\r\n                            }, 1000);\r\n                        } else {\r\n                            input.classList.add('is-invalid');\r\n                            validationArea.innerText = result.message;\r\n                            validationArea.classList.add('text-danger');\r\n                        }\r\n                        return;\r\n                }).catch(Notification.exception);\r\n            }\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Given a user wishes to see the MoodleNet profile url form transition them there.\r\n     *\r\n     * @method chooserNavigateToMnet\r\n     * @param {HTMLElement} showMoodleNet The chooser's area for ment\r\n     * @param {Object} footerData Our footer object to render out\r\n     * @param {Element} carousel Our carousel instance to manage\r\n     */\r\n    var chooserNavigateToMnet = function(showMoodleNet, footerData, carousel) {\r\n        showMoodleNet.innerHTML = '';\r\n\r\n        // Add a spinner.\r\n        var spinnerPromise = LoadingIcon.addIconToContainer(showMoodleNet);\r\n\r\n        // Used later...\r\n        var transitionPromiseResolver = null;\r\n        var transitionPromise = new Promise(resolve => {\r\n            transitionPromiseResolver = resolve;\r\n        });\r\n\r\n        $.when(\r\n            spinnerPromise,\r\n            transitionPromise\r\n        ).then(function() {\r\n                Templates.replaceNodeContents(showMoodleNet, footerData.customcarouseltemplate, '');\r\n                return;\r\n        }).catch(Notification.exception);\r\n\r\n        // We apply our handlers in here to minimise plugin dependency in the Chooser.\r\n        registerListenerEvents(showMoodleNet);\r\n\r\n        // Move to the next slide, and resolve the transition promise when it's done.\r\n        carousel.addEventListener('slid.bs.carousel', function() {\r\n            transitionPromiseResolver();\r\n        }, {once: true});\r\n        // Trigger the transition between 'pages'.\r\n        Carousel.getInstance(carousel).to(2);\r\n    };\r\n\r\n    /**\r\n     * Given a user no longer wishes to see the MoodleNet profile url form transition them from there.\r\n     *\r\n     * @method chooserNavigateFromMnet\r\n     * @param {Element} carousel Our carousel instance to manage\r\n     * @param {jQuery} modal Our modal instance to manage\r\n     * @param {Object} footerData Our footer object to render out\r\n     */\r\n    var chooserNavigateFromMnet = function(carousel, modal, footerData) {\r\n        // Trigger the transition between 'pages'.\r\n        Carousel.getInstance(carousel).to(0);\r\n        modal.setFooter(footerData.customfootertemplate);\r\n    };\r\n\r\n        /**\r\n         * Create the custom listener that would handle anything in the footer.\r\n         *\r\n         * @param {Event} e The event being triggered.\r\n         * @param {Object} footerData The data generated from the exporter.\r\n         * @param {Object} modal The chooser modal.\r\n         */\r\n    var footerClickListener = function(e, footerData, modal) {\r\n        const modalBody = Normalise.getFirst(modal.getBody());\r\n        if (e.target.matches(Selectors.action.showMoodleNet) || e.target.closest(Selectors.action.showMoodleNet)) {\r\n            e.preventDefault();\r\n            const carousel = modalBody.querySelector(Selectors.region.carousel);\r\n            const showMoodleNet = carousel.querySelector(Selectors.region.moodleNet);\r\n\r\n            chooserNavigateToMnet(showMoodleNet, footerData, carousel, modal);\r\n        }\r\n        // From the help screen go back to the module overview.\r\n        if (e.target.matches(Selectors.action.closeOption)) {\r\n            const carousel = modalBody.querySelector(Selectors.region.carousel);\r\n\r\n            chooserNavigateFromMnet(carousel, modal, footerData);\r\n        }\r\n    };\r\n\r\n    return {\r\n        footerClickListener: footerClickListener\r\n    };\r\n});\r\n"],"names":["define","Validator","Selectors","LoadingIcon","Templates","Notification","$","Carousel","Normalise","chooserNavigateToMnet","showMoodleNet","footerData","carousel","innerHTML","page","spinnerPromise","addIconToContainer","transitionPromiseResolver","transitionPromise","Promise","resolve","when","then","replaceNodeContents","customcarouseltemplate","catch","exception","addEventListener","e","target","matches","action","submit","input","querySelector","overlay","region","spinner","validationArea","document","classList","remove","addIconToContainerWithPromise","validation","result","add","innerText","message","setTimeout","window","location","domain","once","getInstance","to","footerClickListener","modal","modalBody","getFirst","getBody","closest","preventDefault","moodleNet","closeOption","setFooter","customfootertemplate","chooserNavigateFromMnet"],"mappings":";;;;;;;;;;;;;;AA8BAA,sCAAO,CAAC,2BACA,2BACA,mBACA,iBACA,oBACA,SACA,iCACA,mBACJ,SAASC,UACAC,UACAC,YACAC,UACAC,aACAC,EACAC,SACAC,eAoDLC,sBAAwB,SAASC,cAAeC,WAAYC,UAC5DF,cAAcG,UAAY,OA7C+BC,KAgDrDC,eAAiBZ,YAAYa,mBAAmBN,eAGhDO,0BAA4B,KAC5BC,kBAAoB,IAAIC,SAAQC,UAChCH,0BAA4BG,WAGhCd,EAAEe,KACEN,eACAG,mBACFI,MAAK,WACClB,UAAUmB,oBAAoBb,cAAeC,WAAWa,uBAAwB,OAErFC,MAAMpB,aAAaqB,YA9DmCZ,KAiElCJ,eAhElBiB,iBAAiB,SAAS,SAASC,MAGhCA,EAAEC,OAAOC,QAAQ5B,UAAU6B,OAAOC,QAAS,KACvCC,MAAQnB,KAAKoB,cAAc,0BAC3BC,QAAUrB,KAAKoB,cAAchC,UAAUkC,OAAOC,SAC9CC,eAAiBC,SAASL,cAAchC,UAAUkC,OAAOE,gBAE7DH,QAAQK,UAAUC,OAAO,cACrBJ,QAAUlC,YAAYuC,8BAA8BP,SACxDlC,UAAU0C,WAAWV,OAChBX,MAAK,SAASsB,QACXP,QAAQjB,UACRe,QAAQK,UAAUK,IAAI,UAClBD,OAAOA,QACPX,MAAMO,UAAUC,OAAO,cACvBR,MAAMO,UAAUK,IAAI,YACpBP,eAAeQ,UAAYF,OAAOG,QAClCT,eAAeE,UAAUC,OAAO,eAChCH,eAAeE,UAAUK,IAAI,gBAE7BG,YAAW,WACPC,OAAOC,SAAWN,OAAOO,SAC1B,OAEHlB,MAAMO,UAAUK,IAAI,cACpBP,eAAeQ,UAAYF,OAAOG,QAClCT,eAAeE,UAAUK,IAAI,mBAGtCpB,MAAMpB,aAAaqB,eAqC9Bd,SAASe,iBAAiB,oBAAoB,WAC1CV,8BACD,CAACmC,MAAM,IAEV7C,SAAS8C,YAAYzC,UAAU0C,GAAG,UAyC/B,CACHC,oBAlBsB,SAAS3B,EAAGjB,WAAY6C,aACxCC,UAAYjD,UAAUkD,SAASF,MAAMG,cACvC/B,EAAEC,OAAOC,QAAQ5B,UAAU6B,OAAOrB,gBAAkBkB,EAAEC,OAAO+B,QAAQ1D,UAAU6B,OAAOrB,eAAgB,CACtGkB,EAAEiC,uBACIjD,SAAW6C,UAAUvB,cAAchC,UAAUkC,OAAOxB,UACpDF,cAAgBE,SAASsB,cAAchC,UAAUkC,OAAO0B,WAE9DrD,sBAAsBC,cAAeC,WAAYC,aAGjDgB,EAAEC,OAAOC,QAAQ5B,UAAU6B,OAAOgC,aAAc,EAvB1B,SAASnD,SAAU4C,MAAO7C,YAEpDJ,SAAS8C,YAAYzC,UAAU0C,GAAG,GAClCE,MAAMQ,UAAUrD,WAAWsD,sBAuBvBC,CAFiBT,UAAUvB,cAAchC,UAAUkC,OAAOxB,UAExB4C,MAAO7C"}