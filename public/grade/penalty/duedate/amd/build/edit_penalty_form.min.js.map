{"version":3,"file":"edit_penalty_form.min.js","sources":["../src/edit_penalty_form.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Handles edit penalty form.\r\n *\r\n * @module     gradepenalty_duedate/edit_penalty_form\r\n * @copyright  2024 Catalyst IT\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport * as notification from 'core/notification';\r\nimport Fragment from 'core/fragment';\r\nimport Templates from 'core/templates';\r\n\r\n/**\r\n * Rule js class.\r\n */\r\nclass PenaltyRule {\r\n    constructor(\r\n        overdueby = 0,\r\n        penalty = 0,\r\n    ) {\r\n        this.overdueby = overdueby;\r\n        this.penalty = penalty;\r\n    }\r\n}\r\n\r\n/**\r\n * Selectors\r\n */\r\nconst SELECTORS = {\r\n    FORM_CONTAINER: '#penalty_rule_form_container',\r\n    ACTION_MENU: '.action-menu',\r\n    ADD_BUTTON: '#addrulebutton',\r\n    INSERT_BUTTON: '.insertbelow',\r\n    DELETE_BUTTON: '.deleterulebuttons',\r\n    DELETE_ALL_BUTTON_CONTAINER: '#deleteallrulesbuttoncontainer',\r\n};\r\n\r\n/**\r\n * Register click event for delete and insert buttons.\r\n */\r\nconst registerEventListeners = () => {\r\n    // Find all action menus in penalty rule form.\r\n    const container = document.querySelector(SELECTORS.FORM_CONTAINER);\r\n    container.addEventListener('click', (e) => {\r\n        if (e.target.closest(SELECTORS.DELETE_BUTTON)) {\r\n            e.preventDefault();\r\n            deleteRule(e.target);\r\n\r\n            return;\r\n        }\r\n\r\n        if (e.target.closest(SELECTORS.INSERT_BUTTON)) {\r\n            e.preventDefault();\r\n            insertRule(e.target);\r\n\r\n            return;\r\n        }\r\n    });\r\n\r\n    document.querySelector(SELECTORS.ADD_BUTTON).addEventListener('click', (e) => {\r\n        e.preventDefault();\r\n        insertRuleAtIndex(container.querySelectorAll(SELECTORS.ACTION_MENU).length);\r\n\r\n        return;\r\n    });\r\n};\r\n\r\n/**\r\n * Delete a rule group represented by thenode.\r\n *\r\n * @param {NodeElement} target\r\n */\r\nconst deleteRule = (target) => {\r\n    // Get all form data.\r\n    const {contextid, penaltyRules, finalPenaltyRule} = buildFormParams();\r\n    const ruleNumber = getRuleNumber(target);\r\n\r\n    // Remove the penalty rule.\r\n    const updatedPenaltyRules = penaltyRules.filter((rule, index) => index !== ruleNumber);\r\n\r\n    loadPenaltyRuleForm(\r\n        contextid,\r\n        updatedPenaltyRules,\r\n        finalPenaltyRule,\r\n    );\r\n};\r\n\r\n/**\r\n * Insert a rule group below the clicked button.\r\n *\r\n * @param {NodeElement} target\r\n */\r\nconst insertRule = (target) => insertRuleAtIndex(getRuleNumber(target) + 1);\r\n\r\n/**\r\n * Add a new rule group at the specified index.\r\n *\r\n * @param {Number} ruleNumber\r\n */\r\nconst insertRuleAtIndex = (ruleNumber) => {\r\n    // Get all form data.\r\n    const {contextid, penaltyRules, finalPenaltyRule} = buildFormParams();\r\n\r\n    // Insert a new penalty rule.\r\n    penaltyRules.splice(ruleNumber, 0, new PenaltyRule());\r\n\r\n    loadPenaltyRuleForm(\r\n        contextid,\r\n        penaltyRules,\r\n        finalPenaltyRule,\r\n    );\r\n};\r\n\r\n/**\r\n * Get the rule number from the target.\r\n *\r\n * @param {Object} target\r\n * @return {Number} rule number\r\n */\r\nconst getRuleNumber = (target) => {\r\n    const allRules = target\r\n        .closest(SELECTORS.FORM_CONTAINER)\r\n        .querySelectorAll(SELECTORS.ACTION_MENU);\r\n\r\n    const foundIndex = Array.prototype.findIndex.call(\r\n        allRules,\r\n        (element) => element.contains(target),\r\n    );\r\n\r\n    if (foundIndex === -1) {\r\n        throw new Error('Rule number not found on target', target);\r\n    }\r\n\r\n    return foundIndex;\r\n};\r\n\r\n/**\r\n * Build form parameters for loading fragment.\r\n *\r\n * @return {Object} form params\r\n */\r\nconst buildFormParams = () => {\r\n    // Get the penalty rule form in its container.\r\n    const container = document.querySelector(SELECTORS.FORM_CONTAINER);\r\n    const form = container.querySelector('form');\r\n\r\n    // Get all form data\r\n    const formData = new FormData(form);\r\n\r\n    // Get context id.\r\n    const contextid = formData.get('contextid');\r\n\r\n    // Get group count.\r\n    const groupCount = formData.get('rulegroupcount');\r\n\r\n    // Create list of penalty rules.\r\n    const penaltyRules = [];\r\n\r\n    // Current penalty rules.\r\n\r\n    for (let i = 0; i < groupCount; i++) {\r\n        penaltyRules.push(new PenaltyRule(\r\n            formData.get(`overdueby[${i}][number]`) * formData.get(`overdueby[${i}][timeunit]`),\r\n            formData.get(`penalty[${i}]`)\r\n        ));\r\n    }\r\n\r\n    return {\r\n        contextid,\r\n        penaltyRules,\r\n        finalPenaltyRule: formData.get('finalpenaltyrule'),\r\n    };\r\n};\r\n\r\n/**\r\n * Load the penalty rule form.\r\n *\r\n * @param {Number} contextId\r\n * @param {Array} penaltyRules\r\n * @param {Number} finalPenaltyRule\r\n */\r\nconst loadPenaltyRuleForm = (\r\n    contextId,\r\n    penaltyRules,\r\n    finalPenaltyRule,\r\n) => {\r\n    // Disable the form while loading to improve UX.\r\n    const container = document.querySelector(SELECTORS.FORM_CONTAINER);\r\n    const form = container.querySelector('form');\r\n    form.querySelectorAll('input, select').forEach(input => {\r\n        input.disabled = true;\r\n    });\r\n\r\n    // Disable the add rule button.\r\n    const addButton = document.querySelector(SELECTORS.ADD_BUTTON);\r\n    if (addButton) {\r\n        addButton.disabled = true;\r\n    }\r\n\r\n    // Disable the delete all rules button.\r\n    const deleteAllButton = document.querySelector(SELECTORS.DELETE_ALL_BUTTON_CONTAINER).querySelector('button');\r\n    if (deleteAllButton) {\r\n        deleteAllButton.disabled = true;\r\n    }\r\n\r\n    // Replace the form with the new form.\r\n    Fragment.loadFragment(\r\n        'gradepenalty_duedate',\r\n        'penalty_rule_form',\r\n        contextId,\r\n        {\r\n            penaltyrules: JSON.stringify(penaltyRules),\r\n            finalpenaltyrule: finalPenaltyRule,\r\n        },\r\n    )\r\n        .then((html, js) => {\r\n            Templates.replaceNodeContents(document.querySelector(SELECTORS.FORM_CONTAINER), html, js);\r\n\r\n            if (addButton) {\r\n                addButton.disabled = false;\r\n            }\r\n\r\n            if (deleteAllButton) {\r\n                deleteAllButton.disabled = false;\r\n            }\r\n            return;\r\n        })\r\n        .catch(notification.exception);\r\n\r\n\r\n};\r\n\r\n/**\r\n * Initialize the js.\r\n */\r\nexport const init = () => {\r\n    registerEventListeners();\r\n};\r\n"],"names":["PenaltyRule","constructor","overdueby","penalty","SELECTORS","deleteRule","target","contextid","penaltyRules","finalPenaltyRule","buildFormParams","ruleNumber","getRuleNumber","updatedPenaltyRules","filter","rule","index","loadPenaltyRuleForm","insertRule","insertRuleAtIndex","splice","allRules","closest","querySelectorAll","foundIndex","Array","prototype","findIndex","call","element","contains","Error","form","document","querySelector","formData","FormData","get","groupCount","i","push","contextId","forEach","input","disabled","addButton","deleteAllButton","loadFragment","penaltyrules","JSON","stringify","finalpenaltyrule","then","html","js","replaceNodeContents","catch","notification","exception","container","addEventListener","e","preventDefault","length","registerEventListeners"],"mappings":";;;;;;;oHA8BMA,YACFC,kBACIC,iEAAY,EACZC,+DAAU,OAELD,UAAYA,eACZC,QAAUA,eAOjBC,yBACc,+BADdA,sBAEW,eAFXA,qBAGU,iBAHVA,wBAIa,eAJbA,wBAKa,qBALbA,sCAM2B,iCAsC3BC,WAAcC,eAEVC,UAACA,UAADC,aAAYA,aAAZC,iBAA0BA,kBAAoBC,kBAC9CC,WAAaC,cAAcN,QAG3BO,oBAAsBL,aAAaM,QAAO,CAACC,KAAMC,QAAUA,QAAUL,aAE3EM,oBACIV,UACAM,oBACAJ,mBASFS,WAAcZ,QAAWa,kBAAkBP,cAAcN,QAAU,GAOnEa,kBAAqBR,mBAEjBJ,UAACA,UAADC,aAAYA,aAAZC,iBAA0BA,kBAAoBC,kBAGpDF,aAAaY,OAAOT,WAAY,EAAG,IAAIX,aAEvCiB,oBACIV,UACAC,aACAC,mBAUFG,cAAiBN,eACbe,SAAWf,OACZgB,QAAQlB,0BACRmB,iBAAiBnB,uBAEhBoB,WAAaC,MAAMC,UAAUC,UAAUC,KACzCP,UACCQ,SAAYA,QAAQC,SAASxB,cAGd,IAAhBkB,iBACM,IAAIO,MAAM,kCAAmCzB,eAGhDkB,YAQLd,gBAAkB,WAGdsB,KADYC,SAASC,cAAc9B,0BAClB8B,cAAc,QAG/BC,SAAW,IAAIC,SAASJ,MAGxBzB,UAAY4B,SAASE,IAAI,aAGzBC,WAAaH,SAASE,IAAI,kBAG1B7B,aAAe,OAIhB,IAAI+B,EAAI,EAAGA,EAAID,WAAYC,IAC5B/B,aAAagC,KAAK,IAAIxC,YAClBmC,SAASE,wBAAiBE,gBAAgBJ,SAASE,wBAAiBE,kBACpEJ,SAASE,sBAAeE,gBAIzB,CACHhC,UAAAA,UACAC,aAAAA,aACAC,iBAAkB0B,SAASE,IAAI,sBAWjCpB,oBAAsB,CACxBwB,UACAjC,aACAC,oBAGkBwB,SAASC,cAAc9B,0BAClB8B,cAAc,QAChCX,iBAAiB,iBAAiBmB,SAAQC,QAC3CA,MAAMC,UAAW,WAIfC,UAAYZ,SAASC,cAAc9B,sBACrCyC,YACAA,UAAUD,UAAW,SAInBE,gBAAkBb,SAASC,cAAc9B,uCAAuC8B,cAAc,UAChGY,kBACAA,gBAAgBF,UAAW,qBAItBG,aACL,uBACA,oBACAN,UACA,CACIO,aAAcC,KAAKC,UAAU1C,cAC7B2C,iBAAkB1C,mBAGrB2C,MAAK,CAACC,KAAMC,yBACCC,oBAAoBtB,SAASC,cAAc9B,0BAA2BiD,KAAMC,IAElFT,YACAA,UAAUD,UAAW,GAGrBE,kBACAA,gBAAgBF,UAAW,MAIlCY,MAAMC,aAAaC,0BAQR,KAnMW,YAErBC,UAAY1B,SAASC,cAAc9B,0BACzCuD,UAAUC,iBAAiB,SAAUC,GAC7BA,EAAEvD,OAAOgB,QAAQlB,0BACjByD,EAAEC,sBACFzD,WAAWwD,EAAEvD,SAKbuD,EAAEvD,OAAOgB,QAAQlB,0BACjByD,EAAEC,sBACF5C,WAAW2C,EAAEvD,kBAMrB2B,SAASC,cAAc9B,sBAAsBwD,iBAAiB,SAAUC,IACpEA,EAAEC,iBACF3C,kBAAkBwC,UAAUpC,iBAAiBnB,uBAAuB2D,YA+KxEC"}