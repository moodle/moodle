{"version":3,"file":"singleview.min.js","sources":["../src/singleview.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Allow navigation through table cells using Ctrl + arrow keys and handle override toggles.\r\n *\r\n * @module    gradereport_singleview/singleview\r\n * @copyright The Open University\r\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nconst selectors = {\r\n    cell: 'td.cell, th.cell',\r\n    col: 'td, th',\r\n    keyboardHandled: 'table input, table select, table a',\r\n    navigableCell: 'input:not([type=\"hidden\"]):not([disabled]), select, a',\r\n    override: 'input[name^=override_]',\r\n    row: 'tr',\r\n    // Dyanmic selectors.\r\n    input: (interest) => `input[name$='${interest}'][data-uielement='text']`,\r\n    select: (interest) => `select[name$='${interest}']`,\r\n};\r\n\r\nlet initialized = false;\r\n\r\n/**\r\n * Initializes the module, setting up event listeners for table cell navigation and override toggles.\r\n */\r\nexport function init() {\r\n    if (initialized) {\r\n        return;\r\n    }\r\n    initialized = true;\r\n\r\n    // Add ctrl+arrow controls for navigation.\r\n    // Use capturing phase to intercept events before they reach anchor elements.\r\n    document.addEventListener('keydown', keydownHandler, true);\r\n\r\n    // Handle override toggles.\r\n    document.querySelectorAll(selectors.override).forEach(input => {\r\n        input.addEventListener('change', () => {\r\n            updateOverrideToggle(input);\r\n        });\r\n    });\r\n}\r\n\r\n/**\r\n * Handles control+arrow table navigation.\r\n *\r\n * @private\r\n * @param {KeyboardEvent} event The keydown event.\r\n */\r\nfunction keydownHandler(event) {\r\n    if (!event.ctrlKey) {\r\n        return;\r\n    }\r\n\r\n    // Check if it's an arrow key.\r\n    if (!['ArrowLeft', 'ArrowUp', 'ArrowRight', 'ArrowDown'].includes(event.key)) {\r\n        return;\r\n    }\r\n\r\n    const activeElement = document.activeElement;\r\n    if (!activeElement.matches(selectors.keyboardHandled)) {\r\n        return;\r\n    }\r\n\r\n    let next = null;\r\n    switch (event.key) {\r\n        case 'ArrowLeft':\r\n            next = getPrevCell(activeElement.closest(selectors.col));\r\n            break;\r\n        case 'ArrowUp':\r\n            next = getAboveCell(activeElement.closest(selectors.col));\r\n            break;\r\n        case 'ArrowRight':\r\n            next = getNextCell(activeElement.closest(selectors.col));\r\n            break;\r\n        case 'ArrowDown':\r\n            next = getBelowCell(activeElement.closest(selectors.col));\r\n            break;\r\n    }\r\n\r\n    // Immediately prevent default behavior and stop propagation.\r\n    event.preventDefault();\r\n    event.stopImmediatePropagation();\r\n\r\n    if (next) {\r\n        next.querySelector(selectors.navigableCell)?.focus();\r\n    }\r\n}\r\n\r\n/**\r\n * Handles changes to override toggles.\r\n *\r\n * @private\r\n * @param {HTMLInputElement} input The override toggle input element.\r\n */\r\nfunction updateOverrideToggle(input) {\r\n    const checked = input.checked;\r\n    const [, itemid, userid] = input.getAttribute('name').split('_');\r\n    const interest = `_${itemid}_${userid}`;\r\n\r\n    // Handle text inputs.\r\n    document.querySelectorAll(selectors.input(interest)).forEach(\r\n        text => {\r\n            text.disabled = !checked;\r\n        }\r\n    );\r\n\r\n    // Handle select elements.\r\n    document.querySelectorAll(selectors.select(interest)).forEach(\r\n        select => {\r\n            select.disabled = !checked;\r\n        }\r\n    );\r\n}\r\n\r\n/**\r\n * Helper function to get the next cell in the table.\r\n *\r\n * @private\r\n * @param {HTMLElement} cell The cell of the table.\r\n * @returns {HTMLElement|null} The next navigable cell or null if none found.\r\n */\r\nfunction getNextCell(cell) {\r\n    const checkElement = cell || document.activeElement;\r\n    const next = checkElement.nextElementSibling?.matches(selectors.cell) ? checkElement.nextElementSibling : null;\r\n    if (!next) {\r\n        return null;\r\n    }\r\n    // Continue until we find a navigable cell.\r\n    if (!next.querySelector(selectors.navigableCell)) {\r\n        return getNextCell(next);\r\n    }\r\n\r\n    return next;\r\n}\r\n\r\n/**\r\n * Helper function to get the previous cell in the table.\r\n *\r\n * @private\r\n * @param {HTMLElement} cell The cell of the table.\r\n */\r\nfunction getPrevCell(cell) {\r\n    const checkElement = cell || document.activeElement;\r\n    const prev = checkElement.previousElementSibling?.matches(selectors.cell) ? checkElement.previousElementSibling : null;\r\n    if (!prev) {\r\n        return null;\r\n    }\r\n    // Continue until we find a navigable cell.\r\n    if (!prev.querySelector(selectors.navigableCell)) {\r\n        return getPrevCell(prev);\r\n    }\r\n\r\n    return prev;\r\n}\r\n\r\n/**\r\n * Helper function to get the cell above the current cell in the table.\r\n *\r\n * @private\r\n * @param {HTMLElement} cell The current table cell element.\r\n * @returns {HTMLElement|null} The cell above or null if none found.\r\n */\r\nfunction getAboveCell(cell) {\r\n    const checkElement = cell || document.activeElement;\r\n    const tr = checkElement.closest(selectors.row).previousElementSibling;\r\n    const columnIndex = getColumnIndex(checkElement);\r\n    if (!tr) {\r\n        return null;\r\n    }\r\n    const next = tr.querySelectorAll(selectors.col)[columnIndex];\r\n    // Continue until we find a navigable cell.\r\n    if (!next?.querySelector(selectors.navigableCell)) {\r\n        return getAboveCell(next);\r\n    }\r\n\r\n    return next;\r\n}\r\n\r\n/**\r\n * Helper function to get the cell below the current cell in the table.\r\n *\r\n * @private\r\n * @param {HTMLElement} cell The current table cell element.\r\n * @returns {HTMLElement|null} The cell below or null if none found.\r\n */\r\nfunction getBelowCell(cell) {\r\n    const checkElement = cell || document.activeElement;\r\n    const tr = checkElement.closest('tr').nextElementSibling;\r\n    const columnIndex = getColumnIndex(checkElement);\r\n    if (!tr) {\r\n        return null;\r\n    }\r\n    const next = tr.querySelectorAll('td, th')[columnIndex];\r\n    // Continue until we find a navigable cell.\r\n    if (!next?.querySelector(selectors.navigableCell)) {\r\n        return getBelowCell(next);\r\n    }\r\n\r\n    return next;\r\n}\r\n\r\n/**\r\n * Helper function to get the column index of a cell.\r\n *\r\n * @param {HTMLElement} cell The cell of the table.\r\n * @returns {number} The index of the cell within its row.\r\n */\r\nfunction getColumnIndex(cell) {\r\n    const rowNode = cell.closest(selectors.row);\r\n    if (!rowNode || !cell) {\r\n        return -1;\r\n    }\r\n    const cells = Array.from(rowNode.querySelectorAll(selectors.col));\r\n\r\n    return cells.indexOf(cell);\r\n}\r\n"],"names":["initialized","document","addEventListener","keydownHandler","querySelectorAll","selectors","forEach","input","checked","itemid","userid","getAttribute","split","interest","text","disabled","select","updateOverrideToggle","event","ctrlKey","includes","key","activeElement","matches","next","getPrevCell","closest","getAboveCell","getNextCell","getBelowCell","preventDefault","stopImmediatePropagation","querySelector","focus","cell","checkElement","nextElementSibling","prev","previousElementSibling","tr","columnIndex","getColumnIndex","rowNode","Array","from","indexOf"],"mappings":"+JAyCQA,mBAGJA,aAAc,EAIdC,SAASC,iBAAiB,UAAWC,gBAAgB,GAGrDF,SAASG,iBAAiBC,oBAAoBC,SAAQC,QAClDA,MAAML,iBAAiB,UAAU,eA0DXK,aACpBC,QAAUD,MAAMC,UACbC,OAAQC,QAAUH,MAAMI,aAAa,QAAQC,MAAM,KACtDC,oBAAeJ,mBAAUC,QAG/BT,SAASG,iBAAiBC,gBAAgBQ,WAAWP,SACjDQ,OACIA,KAAKC,UAAYP,WAKzBP,SAASG,iBAAiBC,iBAAiBQ,WAAWP,SAClDU,SACIA,OAAOD,UAAYP,WAxEnBS,CAAqBV;;;;;;;;MA9B3BF,eACI,mBADJA,cAEG,SAFHA,0BAGe,qCAHfA,wBAIa,wDAJbA,mBAKQ,yBALRA,cAMG,KANHA,gBAQMQ,iCAA6BA,sCARnCR,iBASOQ,kCAA8BA,mBAGvCb,aAAc,WA6BTG,eAAee,WACfA,MAAMC,mBAKN,CAAC,YAAa,UAAW,aAAc,aAAaC,SAASF,MAAMG,kBAIlEC,cAAgBrB,SAASqB,kBAC1BA,cAAcC,QAAQlB,sCAIvBmB,KAAO,YACHN,MAAMG,SACL,YACDG,KAAOC,YAAYH,cAAcI,QAAQrB,0BAExC,UACDmB,KAAOG,aAAaL,cAAcI,QAAQrB,0BAEzC,aACDmB,KAAOI,YAAYN,cAAcI,QAAQrB,0BAExC,YACDmB,KAAOK,aAAaP,cAAcI,QAAQrB,yCAKlDa,MAAMY,iBACNZ,MAAMa,2BAEFP,oCACAA,KAAKQ,cAAc3B,6EAA0B4B,kBAqC5CL,YAAYM,sCACXC,aAAeD,MAAQjC,SAASqB,cAChCE,mCAAOW,aAAaC,2EAAoBb,QAAQlB,gBAAkB8B,aAAaC,mBAAqB,YACrGZ,KAIAA,KAAKQ,cAAc3B,yBAIjBmB,KAHII,YAAYJ,MAJZ,cAgBNC,YAAYS,sCACXC,aAAeD,MAAQjC,SAASqB,cAChCe,mCAAOF,aAAaG,+EAAwBf,QAAQlB,gBAAkB8B,aAAaG,uBAAyB,YAC7GD,KAIAA,KAAKL,cAAc3B,yBAIjBgC,KAHIZ,YAAYY,MAJZ,cAiBNV,aAAaO,YACZC,aAAeD,MAAQjC,SAASqB,cAChCiB,GAAKJ,aAAaT,QAAQrB,eAAeiC,uBACzCE,YAAcC,eAAeN,kBAC9BI,UACM,WAELf,KAAOe,GAAGnC,iBAAiBC,eAAemC,oBAE3ChB,MAAAA,MAAAA,KAAMQ,cAAc3B,yBAIlBmB,KAHIG,aAAaH,eAanBK,aAAaK,YACZC,aAAeD,MAAQjC,SAASqB,cAChCiB,GAAKJ,aAAaT,QAAQ,MAAMU,mBAChCI,YAAcC,eAAeN,kBAC9BI,UACM,WAELf,KAAOe,GAAGnC,iBAAiB,UAAUoC,oBAEtChB,MAAAA,MAAAA,KAAMQ,cAAc3B,yBAIlBmB,KAHIK,aAAaL,eAYnBiB,eAAeP,YACdQ,QAAUR,KAAKR,QAAQrB,mBACxBqC,UAAYR,YACL,SAEES,MAAMC,KAAKF,QAAQtC,iBAAiBC,gBAErCwC,QAAQX"}