{"version":3,"file":"modal_question_bank_bulkmove.min.js","sources":["../src/modal_question_bank_bulkmove.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Contain the logic for the bulkmove questions modal.\r\n *\r\n * @module     qbank_bulkmove/modal_question_bank_bulkmove\r\n * @copyright  2024 onwards Catalyst IT EU {@link https://catalyst-eu.net}\r\n * @author     Simon Adams <simon.adams@catalyst-eu.net>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport Modal from 'core/modal';\r\nimport * as Fragment from 'core/fragment';\r\nimport {getString} from 'core/str';\r\nimport AutoComplete from 'core/form-autocomplete';\r\nimport {moveQuestions} from 'core_question/repository';\r\nimport Templates from 'core/templates';\r\nimport Notification from 'core/notification';\r\nimport Pending from 'core/pending';\r\n\r\n\r\nexport default class ModalQuestionBankBulkmove extends Modal {\r\n    static TYPE = 'qbank_bulkmove/bulkmove';\r\n\r\n    static SELECTORS = {\r\n        SAVE_BUTTON: '[data-action=\"bulkmovesave\"]',\r\n        SELECTED_QUESTIONS: 'table#categoryquestions input[id^=\"checkq\"]',\r\n        SEARCH_BANK: '#searchbanks',\r\n        SEARCH_CATEGORY: '.selectcategory',\r\n        QUESTION_CATEGORY_SELECTOR: '.question_category_selector',\r\n        CATEGORY_OPTIONS: '.selectcategory option',\r\n        BANK_OPTIONS: '#searchbanks option',\r\n        CATEGORY_ENHANCED_INPUT: '.search-categories input',\r\n        ORIGINAL_SELECTS: 'select.bulk-move',\r\n        CATEGORY_WARNING: '#searchcatwarning',\r\n        CATEGORY_SUGGESTION: '.search-categories span.form-autocomplete-downarrow',\r\n        CATEGORY_SELECTION: '.search-categories span[role=\"option\"][data-active-selection=\"true\"]',\r\n        CONFIRM_BUTTON: '.bulk-move-footer button[data-action=\"save\"]',\r\n        CANCEL_BUTTON: '.bulk-move-footer button[data-action=\"cancel\"]'\r\n    };\r\n\r\n    /**\r\n     * @param {integer} contextId The current bank context id.\r\n     * @param {integer} categoryId The current question category id.\r\n     */\r\n    static init(contextId, categoryId) {\r\n        document.addEventListener('click', (e) => {\r\n            const trigger = e.target;\r\n            if (trigger.classList.contains('dropdown-item') && trigger.getAttribute('name') === 'move') {\r\n                e.preventDefault();\r\n                ModalQuestionBankBulkmove.create({\r\n                    contextId,\r\n                    title: getString('bulkmoveheader', 'qbank_bulkmove'),\r\n                    show: true,\r\n                    categoryId: categoryId,\r\n                });\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Set the initialised config on the class.\r\n     *\r\n     * @param {Object} modalConfig\r\n     */\r\n    configure(modalConfig) {\r\n        this.contextId = modalConfig.contextId;\r\n        this.targetBankContextId = modalConfig.contextId;\r\n        this.initSelectedCategoryId(modalConfig.categoryId);\r\n        modalConfig.removeOnClose = true;\r\n        super.configure(modalConfig);\r\n    }\r\n\r\n    /**\r\n     * Initialise the category select based on the data passed to the JS or if a filter is applied in the url.\r\n     * @param {integer} categoryId\r\n     */\r\n    initSelectedCategoryId(categoryId) {\r\n        const filter = new URLSearchParams(window.location.href).get('filter');\r\n        if (filter) {\r\n            const filteredCategoryId = JSON.parse(filter)?.category.values[0];\r\n            this.currentCategoryId = filteredCategoryId > 0 ? filteredCategoryId : null;\r\n            this.targetCategoryId = filteredCategoryId;\r\n            return;\r\n        }\r\n        this.currentCategoryId = categoryId;\r\n        this.targetCategoryId = categoryId;\r\n    }\r\n\r\n    /**\r\n     * Render the modal contents.\r\n     * @return {Promise}\r\n     */\r\n    show() {\r\n        void this.display(this.contextId, this.currentCategoryId);\r\n        return super.show();\r\n    }\r\n\r\n    /**\r\n     * Get the content to display and enhance the selects into auto complete fields.\r\n     * @param {integer} currentBankContextId\r\n     * @param {integer} currentCategoryId\r\n     */\r\n    async display(currentBankContextId, currentCategoryId) {\r\n        const displayPending = new Pending('qbank_bulkmove/bulk_move_modal');\r\n        this.bodyPromise = await Fragment.loadFragment(\r\n            'qbank_bulkmove',\r\n            'bulk_move',\r\n            currentBankContextId,\r\n            {\r\n                'categoryid': currentCategoryId,\r\n            }\r\n        );\r\n\r\n        await this.setBody(this.bodyPromise);\r\n        await this.enhanceSelects();\r\n        this.registerEnhancedEventListeners();\r\n        this.updateSaveButtonState();\r\n        displayPending.resolve();\r\n    }\r\n\r\n    /**\r\n     * Register event listeners on the enhanced selects. Must be done after they have been enhanced.\r\n     */\r\n    registerEnhancedEventListeners() {\r\n        document.querySelector(ModalQuestionBankBulkmove.SELECTORS.SEARCH_CATEGORY).addEventListener(\"change\", () => {\r\n            this.updateSaveButtonState();\r\n        });\r\n\r\n        document.querySelector(ModalQuestionBankBulkmove.SELECTORS.SEARCH_BANK).addEventListener(\"change\", async(e) => {\r\n            if (parseInt(e.target.value) === 0) {\r\n                // The autocomplete contains a dummy option containing the text that the limit has been reached and the user\r\n                // has to refine the search. Selection of this dummy option has to be handled separately.\r\n                await this.updateCategorySelector(null);\r\n                return;\r\n            }\r\n            await this.updateCategorySelector(e.currentTarget.value);\r\n            this.updateSaveButtonState();\r\n        });\r\n\r\n        this.getModal().on(\"click\", ModalQuestionBankBulkmove.SELECTORS.SAVE_BUTTON, (e) => {\r\n            e.preventDefault();\r\n            void this.displayConfirmMove();\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Update the body with a confirmation prompt and set confirm cancel buttons in the footer.\r\n     * @return {Promise<void>}\r\n     */\r\n    async displayConfirmMove() {\r\n        this.setTitle(getString('confirm', 'core'));\r\n        this.setBody(getString('confirmmove', 'qbank_bulkmove'));\r\n        if (!this.hasFooterContent()) {\r\n            // We don't have the footer yet so go grab it and register event listeners on the buttons.\r\n            this.setFooter(Templates.render('qbank_bulkmove/bulk_move_footer', {}));\r\n            await this.getFooterPromise();\r\n\r\n            document.querySelector(ModalQuestionBankBulkmove.SELECTORS.CONFIRM_BUTTON).addEventListener(\"click\", (e) => {\r\n                e.preventDefault();\r\n                this.moveQuestionsAfterConfirm(this.targetBankContextId, this.targetCategoryId);\r\n            });\r\n\r\n            document.querySelector(ModalQuestionBankBulkmove.SELECTORS.CANCEL_BUTTON).addEventListener(\"click\", (e) => {\r\n                e.preventDefault();\r\n                this.setTitle(getString('bulkmoveheader', 'qbank_bulkmove'));\r\n                this.setBodyContent(Templates.renderForPromise('core/loading', {}));\r\n                this.hideFooter();\r\n                this.display(this.targetBankContextId, this.targetCategoryId);\r\n            });\r\n        } else {\r\n            // We already have a footer so just show it.\r\n            this.showFooter();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Update the category selector based on the selected question bank.\r\n     *\r\n     * @param {Number} selectedBankCmId\r\n     * @return {Promise} Resolved when the update is complete.\r\n     */\r\n    updateCategorySelector(selectedBankCmId) {\r\n        if (!selectedBankCmId) {\r\n            this.updateCategorySelectorState(false);\r\n            return Promise.resolve();\r\n        } else {\r\n            return Fragment.loadFragment(\r\n                'core_question',\r\n                'category_selector',\r\n                this.contextId,\r\n                {\r\n                    'bankcmid': selectedBankCmId,\r\n                }\r\n            )\r\n            .then((html, js) => {\r\n                const categorySelector = document.querySelector(ModalQuestionBankBulkmove.SELECTORS.QUESTION_CATEGORY_SELECTOR);\r\n                return Templates.replaceNode(categorySelector, html, js);\r\n            })\r\n            .then(() => {\r\n                document.querySelector(ModalQuestionBankBulkmove.SELECTORS.CATEGORY_WARNING).classList.add('d-none');\r\n                return this.enhanceSelects();\r\n            })\r\n            .catch(Notification.exception);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Disable/enable the enhanced category selector field.\r\n     * @param {boolean} toEnable True to enable, false to disable the field.\r\n     */\r\n    updateCategorySelectorState(toEnable) {\r\n        const warning = document.querySelector(ModalQuestionBankBulkmove.SELECTORS.CATEGORY_WARNING);\r\n        const enhancedInput = document.querySelector(ModalQuestionBankBulkmove.SELECTORS.CATEGORY_ENHANCED_INPUT);\r\n        const suggestionButton = document.querySelector(ModalQuestionBankBulkmove.SELECTORS.CATEGORY_SUGGESTION);\r\n        const selection = document.querySelector(ModalQuestionBankBulkmove.SELECTORS.CATEGORY_SELECTION);\r\n\r\n        if (toEnable) {\r\n            warning.classList.add('d-none');\r\n            enhancedInput.removeAttribute('disabled');\r\n            suggestionButton.classList.remove('d-none');\r\n        } else {\r\n            warning.classList.remove('d-none');\r\n            enhancedInput.setAttribute('disabled', 'disabled');\r\n            suggestionButton.classList.add('d-none');\r\n            selection.click(); // Clear selected category.\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Disable the button if the selected category is the same as the one the questions already belong to. Enable it otherwise.\r\n     */\r\n    updateSaveButtonState() {\r\n        const saveButton = document.querySelector(ModalQuestionBankBulkmove.SELECTORS.SAVE_BUTTON);\r\n        const categorySelector = document.querySelector(ModalQuestionBankBulkmove.SELECTORS.SEARCH_CATEGORY);\r\n        [this.targetCategoryId, this.targetBankContextId] = categorySelector.value.split(',');\r\n\r\n        if (this.targetCategoryId && this.targetCategoryId !== this.currentCategoryId) {\r\n            saveButton.removeAttribute('disabled');\r\n        } else {\r\n            saveButton.setAttribute('disabled', 'disabled');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Move the selected questions to their new target category.\r\n     * @param {integer} targetContextId the target bank context id.\r\n     * @param {integer} targetCategoryId the target question category id.\r\n     * @return {Promise<void>}\r\n     */\r\n    async moveQuestionsAfterConfirm(targetContextId, targetCategoryId) {\r\n        await this.setBody(Templates.render('core/loading', {}));\r\n        const qelements = document.querySelectorAll(ModalQuestionBankBulkmove.SELECTORS.SELECTED_QUESTIONS);\r\n        const questionids = [];\r\n        qelements.forEach((element) => {\r\n            if (element.checked) {\r\n                const name = element.getAttribute('name');\r\n                questionids.push(name.substr(1, name.length));\r\n            }\r\n        });\r\n        if (questionids.length === 0) {\r\n            await Notification.exception('No questions selected');\r\n        }\r\n\r\n        try {\r\n            window.location.href = await moveQuestions(\r\n                targetContextId,\r\n                targetCategoryId,\r\n                questionids.join(),\r\n                window.location.href\r\n            );\r\n        } catch (error) {\r\n            await Notification.exception(error);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Take the provided select options and enhance them into auto-complete fields.\r\n     *\r\n     * @return {Promise<Promise[]>}\r\n     */\r\n    async enhanceSelects() {\r\n        const placeholder = await getString('searchbyname', 'mod_quiz');\r\n\r\n        await AutoComplete.enhance(\r\n            ModalQuestionBankBulkmove.SELECTORS.SEARCH_BANK,\r\n            false,\r\n            'core_question/question_banks_datasource',\r\n            placeholder,\r\n            false,\r\n            true,\r\n            '',\r\n            true,\r\n        );\r\n\r\n        await AutoComplete.enhance(\r\n            ModalQuestionBankBulkmove.SELECTORS.SEARCH_CATEGORY,\r\n            false,\r\n            null,\r\n            placeholder,\r\n            false,\r\n            true,\r\n            '',\r\n            true,\r\n        );\r\n    }\r\n}\r\n"],"names":["ModalQuestionBankBulkmove","Modal","contextId","categoryId","document","addEventListener","e","trigger","target","classList","contains","getAttribute","preventDefault","create","title","show","configure","modalConfig","targetBankContextId","initSelectedCategoryId","removeOnClose","filter","URLSearchParams","window","location","href","get","filteredCategoryId","JSON","parse","_JSON$parse","category","values","currentCategoryId","targetCategoryId","this","display","super","currentBankContextId","displayPending","Pending","bodyPromise","Fragment","loadFragment","setBody","enhanceSelects","registerEnhancedEventListeners","updateSaveButtonState","resolve","querySelector","SELECTORS","SEARCH_CATEGORY","SEARCH_BANK","async","parseInt","value","updateCategorySelector","currentTarget","getModal","on","SAVE_BUTTON","displayConfirmMove","setTitle","hasFooterContent","showFooter","setFooter","Templates","render","getFooterPromise","CONFIRM_BUTTON","moveQuestionsAfterConfirm","CANCEL_BUTTON","setBodyContent","renderForPromise","hideFooter","selectedBankCmId","then","html","js","categorySelector","QUESTION_CATEGORY_SELECTOR","replaceNode","CATEGORY_WARNING","add","catch","Notification","exception","updateCategorySelectorState","Promise","toEnable","warning","enhancedInput","CATEGORY_ENHANCED_INPUT","suggestionButton","CATEGORY_SUGGESTION","selection","CATEGORY_SELECTION","removeAttribute","remove","setAttribute","click","saveButton","split","targetContextId","qelements","querySelectorAll","SELECTED_QUESTIONS","questionids","forEach","element","checked","name","push","substr","length","join","error","placeholder","AutoComplete","enhance","CATEGORY_OPTIONS","BANK_OPTIONS","ORIGINAL_SELECTS"],"mappings":"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"}