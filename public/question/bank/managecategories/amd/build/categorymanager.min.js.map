{"version":3,"file":"categorymanager.min.js","sources":["../src/categorymanager.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Reactive module for category manager\r\n *\r\n * @module qbank_managecategories/categorymanager\r\n */\r\n\r\nimport {Reactive} from 'core/reactive';\r\nimport {get_string as getString} from 'core/str';\r\nimport {mutations} from 'qbank_managecategories/mutations';\r\nimport {eventTypes, notifyQbankManagecategoriesStateUpdated} from 'qbank_managecategories/events';\r\nimport Ajax from \"core/ajax\";\r\nimport Notification from \"core/notification\";\r\nimport ModalForm from 'core_form/modalform';\r\n\r\nconst SELECTORS = {\r\n    CATEGORY_LIST: '.qbank_managecategories-categorylist',\r\n    CONTEXT: '.qbank_managecategories-categorylist[data-contextid]',\r\n    CATEGORY_ITEM: '.qbank_managecategories-item[data-categoryid]',\r\n    CATEGORY_ROOT: '#categoryroot',\r\n    SHOWDESCRIPTIONS_TOGGLE: '#showdescriptions-toggle',\r\n    ADD_EDIT_BUTTON: '[data-action=\"addeditcategory\"]',\r\n};\r\n\r\nconst CLASSES = {\r\n    DRAGHANDLE: 'draghandle',\r\n    DANGER: 'alert-danger',\r\n};\r\n\r\n/**\r\n * Load the initial state.\r\n *\r\n * This iterates over the initial tree of category items, and captures the data required for the state from each category.\r\n * It also captures a count of the number of children in each list.\r\n *\r\n * @param {Reactive} reactive\r\n * @return {Promise<void>}\r\n */\r\nconst loadState = async(reactive) => {\r\n    const rootElement = document.querySelector(SELECTORS.CATEGORY_ROOT);\r\n    const stateData = {\r\n        page: {\r\n            contextid: rootElement.dataset.contextid,\r\n            showdescriptions: document.querySelector(SELECTORS.SHOWDESCRIPTIONS_TOGGLE).checked,\r\n        },\r\n        categories: [],\r\n        categoryLists: [],\r\n    };\r\n    const listItems = document.querySelectorAll(SELECTORS.CATEGORY_ITEM);\r\n    listItems.forEach(item => {\r\n        stateData.categories.push({\r\n            id: item.dataset.categoryid,\r\n            name: item.dataset.categoryname,\r\n            parent: item.dataset.parent,\r\n            contextid: item.dataset.contextid,\r\n            sortorder: item.dataset.sortorder,\r\n            draghandle: item.classList.contains(CLASSES.DRAGHANDLE),\r\n        });\r\n    });\r\n    const categoryLists = document.querySelectorAll(SELECTORS.CATEGORY_LIST);\r\n    categoryLists.forEach(categoryList => {\r\n        stateData.categoryLists.push({\r\n            id: categoryList.dataset.categoryid,\r\n            childCount: categoryList.querySelectorAll(SELECTORS.CATEGORY_ITEM).length,\r\n        });\r\n    });\r\n    reactive.setInitialState(stateData);\r\n};\r\n\r\n/**\r\n * Reactive instance for the category manager.\r\n */\r\nclass CategoryManager extends Reactive {\r\n    /**\r\n     * Move a category to a new position within the given parent.\r\n     *\r\n     * This will call the move_category web service function to re-order the categories, then update\r\n     * the state with the returned updates.\r\n     *\r\n     * @param {Number} categoryId The ID of the category being moved.\r\n     * @param {Number} targetParentId The ID of the destination parent category (this may not have changed).\r\n     * @param {Number} precedingSiblingId The ID of the category to put the moved category after.\r\n     *     This may be null if moving to the top of a list.\r\n     */\r\n    moveCategory(\r\n        categoryId,\r\n        targetParentId,\r\n        precedingSiblingId = null,\r\n    ) {\r\n        const call = {\r\n            methodname: 'qbank_managecategories_move_category',\r\n            args: {\r\n                pagecontextid: this.state.page.contextid,\r\n                categoryid: categoryId,\r\n                targetparentid: targetParentId,\r\n                precedingsiblingid: precedingSiblingId,\r\n            }\r\n        };\r\n        Ajax.call([call])[0]\r\n            .then((stateUpdates) => {\r\n                this.stateManager.processUpdates(stateUpdates);\r\n                return stateUpdates;\r\n            })\r\n            .catch(error => {\r\n                Notification.addNotification({\r\n                    message: error.message,\r\n                    type: 'error',\r\n                });\r\n                document.getElementsByClassName(CLASSES.DANGER)[0]?.scrollIntoView();\r\n            });\r\n    }\r\n\r\n    /**\r\n     * Return title for the add/edit modal.\r\n     *\r\n     * @param {boolean} isEdit is 'add' or 'edit' form\r\n     * @returns {String} title string\r\n     */\r\n    getTitle(isEdit) {\r\n        return getString(isEdit ? 'editcategory' : 'addcategory', 'question');\r\n    }\r\n\r\n    /**\r\n     * Return save button label for the add/edit modal.\r\n     *\r\n     * @param {boolean} isEdit is 'add' or 'edit' form\r\n     * @returns {String} save string\r\n     */\r\n    getSave(isEdit) {\r\n        return isEdit ? getString('savechanges', 'core') : getString('addcategory', 'question');\r\n    }\r\n\r\n    /**\r\n     * Function handling display of modal form.\r\n     *\r\n     * @param {Event} e The click event triggering the modal.\r\n     */\r\n    showEditModal(e) {\r\n        const addEditButton = e.target.closest(SELECTORS.ADD_EDIT_BUTTON);\r\n\r\n        // Return if it is not 'addeditcategory' button.\r\n        if (!addEditButton) {\r\n            return;\r\n        }\r\n\r\n        // Return if the action type is not specified.\r\n        if (!addEditButton.dataset.actiontype) {\r\n            return;\r\n        }\r\n\r\n        e.preventDefault();\r\n        // Data for the modal.\r\n        const title = categorymanager.getTitle(addEditButton.dataset.actiontype === 'edit');\r\n        const save = categorymanager.getSave(addEditButton.dataset.actiontype === 'edit');\r\n        const cmid = addEditButton.dataset.cmid;\r\n        const courseid = addEditButton.dataset.courseid;\r\n        const questioncount = addEditButton.dataset.questioncount;\r\n        let contextid = addEditButton.dataset.contextid;\r\n        let categoryid = null;\r\n        let sortorder = null;\r\n        let parent = null;\r\n        const categoryItem = e.target.closest(SELECTORS.CATEGORY_ITEM);\r\n        if (categoryItem) {\r\n            contextid = categoryItem.dataset.contextid;\r\n            categoryid = categoryItem.dataset.categoryid;\r\n            sortorder = categoryItem.dataset.sortorder;\r\n            const parentContext = categoryItem.closest(SELECTORS.CONTEXT);\r\n            parent = categoryItem.dataset.parent + ',' + parentContext.dataset.contextid;\r\n        }\r\n\r\n        // Call the modal.\r\n        const modalForm = new ModalForm({\r\n            formClass: \"qbank_managecategories\\\\form\\\\question_category_edit_form\",\r\n            args: {\r\n                cmid,\r\n                courseid,\r\n                questioncount,\r\n                contextid,\r\n                categoryid,\r\n                sortorder,\r\n                parent,\r\n            },\r\n            modalConfig: {\r\n                title: title,\r\n                large: true,\r\n            },\r\n            saveButtonText: save,\r\n            returnFocus: addEditButton,\r\n        });\r\n        // Once the form has been submitted via the web service, update the state with the new or updated\r\n        // category based on the web service response.\r\n        modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, (response) => {\r\n            categorymanager.stateManager.processUpdates(response.detail);\r\n        });\r\n        // Show the form.\r\n        modalForm.show();\r\n    }\r\n}\r\n\r\nexport const categorymanager = new CategoryManager({\r\n    name: 'qtype_managecategories_categorymanager',\r\n    eventName: eventTypes.qbankManagecategoriesStateUpdated,\r\n    eventDispatch: notifyQbankManagecategoriesStateUpdated,\r\n    mutations,\r\n});\r\n\r\n/**\r\n * Load the initial state.\r\n */\r\nexport const init = () => {\r\n    loadState(categorymanager);\r\n};\r\n"],"names":["SELECTORS","CLASSES","CategoryManager","Reactive","moveCategory","categoryId","targetParentId","precedingSiblingId","call","methodname","args","pagecontextid","this","state","page","contextid","categoryid","targetparentid","precedingsiblingid","then","stateUpdates","stateManager","processUpdates","catch","error","addNotification","message","type","document","getElementsByClassName","scrollIntoView","getTitle","isEdit","getSave","showEditModal","e","addEditButton","target","closest","dataset","actiontype","preventDefault","title","categorymanager","save","cmid","courseid","questioncount","sortorder","parent","categoryItem","parentContext","modalForm","ModalForm","formClass","modalConfig","large","saveButtonText","returnFocus","addEventListener","events","FORM_SUBMITTED","response","detail","show","name","eventName","eventTypes","qbankManagecategoriesStateUpdated","eventDispatch","notifyQbankManagecategoriesStateUpdated","mutations","async","stateData","querySelector","showdescriptions","checked","categories","categoryLists","querySelectorAll","forEach","item","push","id","categoryname","draghandle","classList","contains","categoryList","childCount","length","reactive","setInitialState","loadState"],"mappings":"ymBA6BMA,wBACa,uCADbA,kBAEO,uDAFPA,wBAGa,gDAHbA,wBAIa,gBAJbA,kCAKuB,2BALvBA,0BAMe,kCAGfC,mBACU,aADVA,eAEM,qBA8CNC,wBAAwBC,mBAY1BC,aACIC,WACAC,oBACAC,0EAAqB,WAEfC,KAAO,CACTC,WAAY,uCACZC,KAAM,CACFC,cAAeC,KAAKC,MAAMC,KAAKC,UAC/BC,WAAYX,WACZY,eAAgBX,eAChBY,mBAAoBX,mCAGvBC,KAAK,CAACA,OAAO,GACbW,MAAMC,oBACEC,aAAaC,eAAeF,cAC1BA,gBAEVG,OAAMC,wDACUC,gBAAgB,CACzBC,QAASF,MAAME,QACfC,KAAM,wCAEVC,SAASC,uBAAuB5B,gBAAgB,2DAAI6B,oBAUhEC,SAASC,eACE,mBAAUA,OAAS,eAAiB,cAAe,YAS9DC,QAAQD,eACGA,QAAS,mBAAU,cAAe,SAAU,mBAAU,cAAe,YAQhFE,cAAcC,SACJC,cAAgBD,EAAEE,OAAOC,QAAQtC,+BAGlCoC,yBAKAA,cAAcG,QAAQC,kBAI3BL,EAAEM,uBAEIC,MAAQC,gBAAgBZ,SAA8C,SAArCK,cAAcG,QAAQC,YACvDI,KAAOD,gBAAgBV,QAA6C,SAArCG,cAAcG,QAAQC,YACrDK,KAAOT,cAAcG,QAAQM,KAC7BC,SAAWV,cAAcG,QAAQO,SACjCC,cAAgBX,cAAcG,QAAQQ,kBACxChC,UAAYqB,cAAcG,QAAQxB,UAClCC,WAAa,KACbgC,UAAY,KACZC,OAAS,WACPC,aAAef,EAAEE,OAAOC,QAAQtC,4BAClCkD,aAAc,CACdnC,UAAYmC,aAAaX,QAAQxB,UACjCC,WAAakC,aAAaX,QAAQvB,WAClCgC,UAAYE,aAAaX,QAAQS,gBAC3BG,cAAgBD,aAAaZ,QAAQtC,mBAC3CiD,OAASC,aAAaX,QAAQU,OAAS,IAAME,cAAcZ,QAAQxB,gBAIjEqC,UAAY,IAAIC,mBAAU,CAC5BC,UAAW,4DACX5C,KAAM,CACFmC,KAAAA,KACAC,SAAAA,SACAC,cAAAA,cACAhC,UAAAA,UACAC,WAAAA,WACAgC,UAAAA,UACAC,OAAAA,QAEJM,YAAa,CACTb,MAAOA,MACPc,OAAO,GAEXC,eAAgBb,KAChBc,YAAatB,gBAIjBgB,UAAUO,iBAAiBP,UAAUQ,OAAOC,gBAAiBC,WACzDnB,gBAAgBtB,aAAaC,eAAewC,SAASC,WAGzDX,UAAUY,cAILrB,gBAAkB,IAAIzC,gBAAgB,CAC/C+D,KAAM,yCACNC,UAAWC,mBAAWC,kCACtBC,cAAeC,gDACfC,UAAAA,8EAMgB,KA3KFC,OAAAA,iBAERC,UAAY,CACd3D,KAAM,CACFC,UAHYa,SAAS8C,cAAc1E,yBAGZuC,QAAQxB,UAC/B4D,iBAAkB/C,SAAS8C,cAAc1E,mCAAmC4E,SAEhFC,WAAY,GACZC,cAAe,IAEDlD,SAASmD,iBAAiB/E,yBAClCgF,SAAQC,OACdR,UAAUI,WAAWK,KAAK,CACtBC,GAAIF,KAAK1C,QAAQvB,WACjBiD,KAAMgB,KAAK1C,QAAQ6C,aACnBnC,OAAQgC,KAAK1C,QAAQU,OACrBlC,UAAWkE,KAAK1C,QAAQxB,UACxBiC,UAAWiC,KAAK1C,QAAQS,UACxBqC,WAAYJ,KAAKK,UAAUC,SAAStF,yBAGtB2B,SAASmD,iBAAiB/E,yBAClCgF,SAAQQ,eAClBf,UAAUK,cAAcI,KAAK,CACzBC,GAAIK,aAAajD,QAAQvB,WACzByE,WAAYD,aAAaT,iBAAiB/E,yBAAyB0F,YAG3EC,SAASC,gBAAgBnB,YAgJzBoB,CAAUlD"}