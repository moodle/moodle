{"version":3,"file":"categories.min.js","sources":["../../../src/datafilter/filtertypes/categories.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Filter managing display of subcategories questions.\r\n *\r\n * @module     qbank_managecategories/datafilter/filtertypes/categories\r\n * @author     Mark Johnson <mark.johnson@catalyst-eu.net>\r\n * @copyright  2023 Catalyst IT Europe Ltd.\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport GenericFilter from 'core/datafilter/filtertype';\r\nimport Templates from 'core/templates';\r\nimport {getUserPreference, setUserPreference} from 'core_user/repository';\r\nimport Notification from 'core/notification';\r\nimport {get_strings as getStrings} from 'core/str';\r\n\r\nexport default class extends GenericFilter {\r\n\r\n    SELECTORS = {\r\n        includeSubcategories: 'input[name=category-subcategories]',\r\n        selectInput: 'select#filter-value-category',\r\n        selectInputOption: 'select#filter-value-category option',\r\n        validationInput: 'div[data-filter-type=\"category\"] div.form-autocomplete-input input',\r\n    };\r\n\r\n    /**\r\n     * Construct a new categoires filter\r\n     *\r\n     * @param {String} filterType The type of filter that this relates to (categories)\r\n     * @param {HTMLElement} rootNode The root node for the participants filterset\r\n     * @param {Array} initialValues The currently selected category IDs.\r\n     * @param {Object} filterOptions An object containing the additional options for the filter, currently \"includesubcategories\"\r\n     *     is supported, which if true will display the \"Also show questions from subcategories\" checkbox as checked.\r\n     */\r\n    constructor(filterType, rootNode, initialValues, filterOptions = {includesubcategories: false}) {\r\n        super(filterType, rootNode, initialValues);\r\n        this.addSubcategoryCheckbox(filterOptions.includesubcategories);\r\n    }\r\n\r\n    async addSubcategoryCheckbox(checked = null) {\r\n        const filterValueNode = this.getFilterValueNode();\r\n        if (checked === null || checked === undefined) {\r\n            checked = await getUserPreference('qbank_managecategories_includesubcategories_filter_default');\r\n        } else {\r\n            setUserPreference('qbank_managecategories_includesubcategories_filter_default', checked);\r\n        }\r\n        const {html} = await Templates.renderForPromise('qbank_managecategories/include_subcategories_checkbox', {\r\n            checked: checked && checked !== '0',\r\n        });\r\n        filterValueNode.insertAdjacentHTML('afterend', html);\r\n    }\r\n\r\n    get filterOptions() {\r\n        return [\r\n            {name: 'includesubcategories', value: this.filterRoot.querySelector(this.SELECTORS.includeSubcategories).checked}\r\n        ];\r\n    }\r\n\r\n    get filterValue() {\r\n        return {\r\n            name: this.name,\r\n            jointype: this.jointype,\r\n            values: this.values,\r\n            filteroptions: this.filterOptions,\r\n        };\r\n    }\r\n\r\n    validate() {\r\n\r\n        // Get the possible option values and filter out empty ones.\r\n        const nodelist = this.filterRoot.querySelectorAll(this.SELECTORS.selectInputOption);\r\n\r\n        // This gets all the values from the autocomplete's hidden select menu and filters out\r\n        // any which are not positive integers.\r\n        const validoptions = Array.from(nodelist).map(\r\n            option => (parseInt(option.value) > 0) ? parseInt(option.value) : false\r\n        ).filter(Boolean);\r\n\r\n        // Get the value supplied.\r\n        const value = parseInt(this.filterRoot.querySelector(this.SELECTORS.selectInput).value);\r\n\r\n        // Reset validation.\r\n        const node = this.filterRoot.querySelector(this.SELECTORS.validationInput);\r\n        node.setCustomValidity('');\r\n\r\n        // Make sure the value supplied is valid.\r\n        if (!validoptions.includes(value)) {\r\n            getStrings([\r\n                {\r\n                    key: 'error:category',\r\n                    component: 'qbank_managecategories',\r\n                },\r\n            ]).then((strings) => {\r\n                node.setCustomValidity(strings[0]);\r\n                node.reportValidity();\r\n                return strings;\r\n            }).catch(Notification.exception);\r\n\r\n            return false;\r\n        }\r\n\r\n        return true;\r\n\r\n    }\r\n\r\n}\r\n"],"names":["GenericFilter","constructor","filterType","rootNode","initialValues","filterOptions","includesubcategories","includeSubcategories","selectInput","selectInputOption","validationInput","addSubcategoryCheckbox","checked","filterValueNode","this","getFilterValueNode","html","Templates","renderForPromise","insertAdjacentHTML","name","value","filterRoot","querySelector","SELECTORS","filterValue","jointype","values","filteroptions","validate","nodelist","querySelectorAll","validoptions","Array","from","map","option","parseInt","filter","Boolean","node","setCustomValidity","includes","key","component","then","strings","reportValidity","catch","Notification","exception"],"mappings":"ukBA8B6BA,oBAkBzBC,YAAYC,WAAYC,SAAUC,mBAAeC,qEAAgB,CAACC,sBAAsB,2BAC9EJ,WAAYC,SAAUC,qBAjBpB,CACRG,qBAAsB,qCACtBC,YAAa,+BACbC,kBAAmB,sCACnBC,gBAAiB,+MAcZC,uBAAuBN,cAAcC,yDAGjBM,+DAAU,WAC7BC,gBAAkBC,KAAKC,qBACzBH,MAAAA,QACAA,cAAgB,iCAAkB,gGAEhB,6DAA8DA,eAE9EI,KAACA,YAAcC,mBAAUC,iBAAiB,wDAAyD,CACrGN,QAASA,SAAuB,MAAZA,UAExBC,gBAAgBM,mBAAmB,WAAYH,MAG/CX,0BACO,CACH,CAACe,KAAM,uBAAwBC,MAAOP,KAAKQ,WAAWC,cAAcT,KAAKU,UAAUjB,sBAAsBK,UAI7Ga,wBACO,CACHL,KAAMN,KAAKM,KACXM,SAAUZ,KAAKY,SACfC,OAAQb,KAAKa,OACbC,cAAed,KAAKT,eAI5BwB,iBAGUC,SAAWhB,KAAKQ,WAAWS,iBAAiBjB,KAAKU,UAAUf,mBAI3DuB,aAAeC,MAAMC,KAAKJ,UAAUK,KACtCC,QAAWC,SAASD,OAAOf,OAAS,GAAKgB,SAASD,OAAOf,SAC3DiB,OAAOC,SAGHlB,MAAQgB,SAASvB,KAAKQ,WAAWC,cAAcT,KAAKU,UAAUhB,aAAaa,OAG3EmB,KAAO1B,KAAKQ,WAAWC,cAAcT,KAAKU,UAAUd,wBAC1D8B,KAAKC,kBAAkB,MAGlBT,aAAaU,SAASrB,8BACZ,CACP,CACIsB,IAAK,iBACLC,UAAW,4BAEhBC,MAAMC,UACLN,KAAKC,kBAAkBK,QAAQ,IAC/BN,KAAKO,iBACED,WACRE,MAAMC,sBAAaC,YAEf"}