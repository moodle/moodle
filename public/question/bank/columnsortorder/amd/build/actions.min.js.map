{"version":3,"file":"actions.min.js","sources":["../src/actions.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Common javascript for handling actions on the admin page and the user's view of the question bank.\r\n *\r\n * @module     qbank_columnsortorder/actions\r\n * @copyright  2023 onwards Catalyst IT Europe Ltd\r\n * @author     Mark Johnson <mark.johnson@catalyst-eu.net>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport SortableList from 'core/sortable_list';\r\nimport $ from 'jquery';\r\nimport * as repository from 'qbank_columnsortorder/repository';\r\nimport Notification from \"core/notification\";\r\nimport RefreshUi from 'core_question/refresh_ui';\r\n\r\nexport const SELECTORS = {\r\n    columnList: '.qbank-column-list',\r\n    sortableColumn: '.qbank-sortable-column',\r\n    removeLink: '[data-action=remove]',\r\n    moveHandler: '[data-drag-type=move]',\r\n    addColumn: '.addcolumn',\r\n    addLink: '[data-action=add]',\r\n    actionLink: '.action-link',\r\n};\r\n\r\n/**\r\n * Sets up sortable list in the column sort order page.\r\n *\r\n * @param {Element} listRoot Element containing the sortable list.\r\n * @param {Boolean} vertical Is the list in vertical orientation, rather than horizonal?\r\n * @param {Boolean} global Should changes be saved to global config, rather than user preferences?\r\n * @return {jQuery} sortable column elements, for attaching additional event listeners.\r\n */\r\nexport const setupSortableLists = (listRoot, vertical = false, global = false) => {\r\n    const sortableList = new SortableList(listRoot, {\r\n        moveHandlerSelector: SELECTORS.moveHandler,\r\n        isHorizontal: !vertical,\r\n    });\r\n    sortableList.getElementName = element => Promise.resolve(element.data('name'));\r\n\r\n    const sortableColumns = $(SELECTORS.sortableColumn);\r\n\r\n    sortableColumns.on(SortableList.EVENTS.DROP, () => {\r\n        repository.setColumnbankOrder(getColumnOrder(listRoot), global).catch(Notification.exception);\r\n        listRoot.querySelectorAll(SELECTORS.sortableColumn).forEach(item => item.classList.remove('active'));\r\n    });\r\n\r\n    sortableColumns.on(SortableList.EVENTS.DRAGSTART, (event) => {\r\n        event.currentTarget.classList.add('active');\r\n    });\r\n\r\n    return sortableColumns;\r\n};\r\n\r\n/**\r\n * Set up event handlers for action buttons.\r\n *\r\n * For each action, call the web service to update the appropriate setting or user preference, then call the fragment to\r\n * refresh the view.\r\n *\r\n * @param {Element} uiRoot The root of the question bank UI.\r\n * @param {Boolean} global Should changes be saved to global config, rather than user preferences?\r\n */\r\nexport const setupActionButtons = (uiRoot, global = false) => {\r\n    uiRoot.addEventListener('click', async(e) => {\r\n        const actionLink = e.target.closest(SELECTORS.actionLink);\r\n        if (!actionLink) {\r\n            return;\r\n        }\r\n        try {\r\n            e.preventDefault();\r\n            const action = actionLink.dataset.action;\r\n            if (action === 'add' || action === 'remove') {\r\n                const hiddenColumns = [];\r\n                const addColumnList = document.querySelector(SELECTORS.addColumn);\r\n                if (addColumnList) {\r\n                    addColumnList.querySelectorAll(SELECTORS.addLink).forEach(item => {\r\n                        if (action === 'add' && item === actionLink) {\r\n                            return;\r\n                        }\r\n                        hiddenColumns.push(item.dataset.column);\r\n                    });\r\n                }\r\n                if (action === 'remove') {\r\n                    hiddenColumns.push(actionLink.dataset.column);\r\n                }\r\n                await repository.setHiddenColumns(hiddenColumns, global);\r\n            } else if (action === 'reset') {\r\n                await repository.resetColumns(global);\r\n            }\r\n            const actionUrl = new URL(actionLink.href);\r\n            const returnUrl = new URL(actionUrl.searchParams.get('returnurl').replaceAll('&amp;', '&'));\r\n            await RefreshUi.refresh(uiRoot, returnUrl);\r\n        } catch (ex) {\r\n            await Notification.exception(ex);\r\n        }\r\n    });\r\n};\r\n\r\n/**\r\n * Gets the newly reordered columns to display in the question bank view.\r\n * @param {Element} listRoot\r\n * @returns {Array}\r\n */\r\nexport const getColumnOrder = listRoot => {\r\n    const columns = Array.from(listRoot.querySelectorAll('[data-columnid]'))\r\n        .map(column => column.dataset.columnid);\r\n\r\n    return columns.filter((value, index) => columns.indexOf(value) === index);\r\n};\r\n"],"names":["SELECTORS","columnList","sortableColumn","removeLink","moveHandler","addColumn","addLink","actionLink","listRoot","vertical","global","sortableList","SortableList","moveHandlerSelector","isHorizontal","getElementName","element","Promise","resolve","data","sortableColumns","on","EVENTS","DROP","repository","setColumnbankOrder","getColumnOrder","catch","Notification","exception","querySelectorAll","forEach","item","classList","remove","DRAGSTART","event","currentTarget","add","uiRoot","addEventListener","async","e","target","closest","preventDefault","action","dataset","hiddenColumns","addColumnList","document","querySelector","push","column","setHiddenColumns","resetColumns","actionUrl","URL","href","returnUrl","searchParams","get","replaceAll","RefreshUi","refresh","ex","columns","Array","from","map","columnid","filter","value","index","indexOf"],"mappings":";;;;;;;;mhCA8BaA,UAAY,CACrBC,WAAY,qBACZC,eAAgB,yBAChBC,WAAY,uBACZC,YAAa,wBACbC,UAAW,aACXC,QAAS,oBACTC,WAAY,yEAWkB,SAACC,cAAUC,iEAAkBC,qEACrDC,aAAe,IAAIC,uBAAaJ,SAAU,CAC5CK,oBAAqBb,UAAUI,YAC/BU,cAAeL,WAEnBE,aAAaI,eAAiBC,SAAWC,QAAQC,QAAQF,QAAQG,KAAK,eAEhEC,iBAAkB,mBAAEpB,UAAUE,uBAEpCkB,gBAAgBC,GAAGT,uBAAaU,OAAOC,MAAM,KACzCC,WAAWC,mBAAmBC,eAAelB,UAAWE,QAAQiB,MAAMC,sBAAaC,WACnFrB,SAASsB,iBAAiB9B,UAAUE,gBAAgB6B,SAAQC,MAAQA,KAAKC,UAAUC,OAAO,eAG9Fd,gBAAgBC,GAAGT,uBAAaU,OAAOa,WAAYC,QAC/CA,MAAMC,cAAcJ,UAAUK,IAAI,aAG/BlB,6CAYuB,SAACmB,YAAQ7B,+DACvC6B,OAAOC,iBAAiB,SAASC,MAAAA,UACvBlC,WAAamC,EAAEC,OAAOC,QAAQ5C,UAAUO,eACzCA,eAIDmC,EAAEG,uBACIC,OAASvC,WAAWwC,QAAQD,UACnB,QAAXA,QAA+B,WAAXA,OAAqB,OACnCE,cAAgB,GAChBC,cAAgBC,SAASC,cAAcnD,UAAUK,WACnD4C,eACAA,cAAcnB,iBAAiB9B,UAAUM,SAASyB,SAAQC,OACvC,QAAXc,QAAoBd,OAASzB,YAGjCyC,cAAcI,KAAKpB,KAAKe,QAAQM,WAGzB,WAAXP,QACAE,cAAcI,KAAK7C,WAAWwC,QAAQM,cAEpC7B,WAAW8B,iBAAiBN,cAAetC,YAC/B,UAAXoC,cACDtB,WAAW+B,aAAa7C,cAE5B8C,UAAY,IAAIC,IAAIlD,WAAWmD,MAC/BC,UAAY,IAAIF,IAAID,UAAUI,aAAaC,IAAI,aAAaC,WAAW,QAAS,YAChFC,oBAAUC,QAAQzB,OAAQoB,WAClC,MAAOM,UACCrC,sBAAaC,UAAUoC,eAU5BvC,eAAiBlB,iBACpB0D,QAAUC,MAAMC,KAAK5D,SAASsB,iBAAiB,oBAChDuC,KAAIhB,QAAUA,OAAON,QAAQuB,kBAE3BJ,QAAQK,QAAO,CAACC,MAAOC,QAAUP,QAAQQ,QAAQF,SAAWC"}