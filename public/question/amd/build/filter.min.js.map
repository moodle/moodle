{"version":3,"file":"filter.min.js","sources":["../src/filter.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Question bank filter management.\r\n *\r\n * @module     core_question/filter\r\n * @copyright  2021 Tomo Tsuyuki <tomotsuyuki@catalyst-au.net>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport CoreFilter from 'core/datafilter';\r\nimport Notification from 'core/notification';\r\nimport Selectors from 'core/datafilter/selectors';\r\nimport Templates from 'core/templates';\r\nimport Fragment from 'core/fragment';\r\nimport {getString} from 'core/str';\r\nimport {addIconToContainerRemoveOnCompletion} from 'core/loadingicon';\r\n\r\n/**\r\n * Initialise the question bank filter on the element with the given id.\r\n *\r\n * @param {String} filterRegionId ID of the HTML element containing the filters.\r\n * @param {String} defaultcourseid Course ID for the default course to pass back to the view.\r\n * @param {String} defaultcategoryid Question bank category ID for the default course to pass back to the view.\r\n * @param {Number} perpage The number of questions to display per page.\r\n * @param {Number} bankContextId Context ID of the question bank being filtered.\r\n * @param {Number} quizCmId Course module ID of the quiz as the viewing context.\r\n * @param {string} component Frankenstyle name of the component for the fragment API callback (e.g. core_question)\r\n * @param {string} callback Name of the callback for the fragment API (e.g question_data)\r\n * @param {string} view The class name of the question bank view class used for this page.\r\n * @param {Number} cmid If we are in an activitiy, the course module ID.\r\n * @param {Object} pagevars JSON-encoded parameters from passed from the view, including filters and jointype.\r\n * @param {Object} extraparams JSON-encoded additional parameters specific to this view class, used for re-rendering the view.\r\n */\r\nexport const init = async(\r\n    filterRegionId,\r\n    defaultcourseid,\r\n    defaultcategoryid,\r\n    perpage,\r\n    bankContextId,\r\n    quizCmId,\r\n    component,\r\n    callback,\r\n    view,\r\n    cmid,\r\n    pagevars,\r\n    extraparams,\r\n) => {\r\n\r\n    const SELECTORS = {\r\n        QUESTION_CONTAINER_ID: '#questionscontainer',\r\n        QUESTION_TABLE: '#questionscontainer table',\r\n        SORT_LINK: '#questionscontainer div.sorters a',\r\n        PAGINATION_LINK: '#questionscontainer a[href].page-link',\r\n        LASTCHANGED_FIELD: '#questionsubmit input[name=lastchanged]',\r\n        BULK_ACTIONS: '#bulkactionsui-container input',\r\n        MENU_ACTIONS: '.menu-action',\r\n        EDIT_SWITCH: '.editmode-switch-form input[name=setmode]',\r\n        EDIT_SWITCH_URL: '.editmode-switch-form input[name=pageurl]',\r\n        SHOW_ALL_LINK: '[data-filteraction=\"showall\"]',\r\n    };\r\n\r\n    const filterSet = document.querySelector(`#${filterRegionId}`);\r\n\r\n    const viewData = {\r\n        extraparams: JSON.stringify(extraparams),\r\n        cmid,\r\n        view,\r\n        cat: defaultcategoryid,\r\n        courseid: defaultcourseid,\r\n        filter: {},\r\n        jointype: 0,\r\n        qpage: 0,\r\n        qperpage: perpage,\r\n        sortdata: {},\r\n        lastchanged: document.querySelector(SELECTORS.LASTCHANGED_FIELD)?.value ?? null,\r\n    };\r\n\r\n    let sortData = {};\r\n    const defaultSort = document.querySelector(SELECTORS.QUESTION_TABLE)?.dataset?.defaultsort;\r\n    if (defaultSort) {\r\n        sortData = JSON.parse(defaultSort);\r\n    }\r\n\r\n    const [\r\n        showAllText,\r\n        showPerPageText,\r\n    ] = await Promise.all([\r\n        getString('showall', 'core', ''),\r\n        getString('showperpage', 'core', extraparams.defaultqperpage),\r\n    ]);\r\n\r\n    /**\r\n     * Retrieve table data.\r\n     *\r\n     * @param {Object} filterdata data\r\n     * @param {Promise} pendingPromise pending promise\r\n     */\r\n    const applyFilter = (filterdata, pendingPromise) => {\r\n        // Reload the questions based on the specified filters. If no filters are provided,\r\n        // use the default category filter condition.\r\n        if (filterdata) {\r\n            // Main join types.\r\n            viewData.jointype = parseInt(filterSet.dataset.filterverb, 10);\r\n            delete filterdata.jointype;\r\n            // Retrieve filter info.\r\n            viewData.filter = filterdata;\r\n            if (Object.keys(filterdata).length !== 0) {\r\n                if (!isNaN(viewData.jointype)) {\r\n                    filterdata.jointype = viewData.jointype;\r\n                }\r\n            }\r\n        }\r\n        // Load questions for first page.\r\n        viewData.filter = JSON.stringify(filterdata);\r\n        viewData.sortdata = JSON.stringify(sortData);\r\n        viewData.quizcmid = quizCmId;\r\n\r\n        const questionscontainer = document.querySelector(SELECTORS.QUESTION_CONTAINER_ID);\r\n        // Clear the contents of the element, then append the loading icon.\r\n        questionscontainer.innerHTML = '';\r\n        addIconToContainerRemoveOnCompletion(questionscontainer, pendingPromise);\r\n\r\n        Fragment.loadFragment(component, callback, bankContextId, viewData)\r\n            // Render questions for first page and pagination.\r\n            .then((questionhtml, jsfooter) => {\r\n                updateUrlParams(filterdata);\r\n                if (questionhtml === undefined) {\r\n                    questionhtml = '';\r\n                }\r\n                if (jsfooter === undefined) {\r\n                    jsfooter = '';\r\n                }\r\n                Templates.replaceNode(questionscontainer, questionhtml, jsfooter);\r\n                // Resolve filter promise.\r\n                if (pendingPromise) {\r\n                    pendingPromise.resolve();\r\n                }\r\n                return {questionhtml, jsfooter};\r\n            })\r\n            .catch(Notification.exception);\r\n    };\r\n\r\n    // Init core filter processor with apply callback.\r\n    const coreFilter = new CoreFilter(filterSet, applyFilter);\r\n    coreFilter.activeFilters = {}; // Unset useless courseid filter.\r\n    coreFilter.init();\r\n\r\n    /**\r\n     * Update URL Param based upon the current filter.\r\n     *\r\n     * @param {Object} filters Active filters.\r\n     */\r\n    const updateUrlParams = (filters) => {\r\n        const url = new URL(location.href);\r\n        const filterQuery = JSON.stringify(filters);\r\n        url.searchParams.set('filter', filterQuery);\r\n        history.pushState(filters, '', url);\r\n        const editSwitch = document.querySelector(SELECTORS.EDIT_SWITCH);\r\n        if (editSwitch) {\r\n            const editSwitchUrlInput = document.querySelector(SELECTORS.EDIT_SWITCH_URL);\r\n            const editSwitchUrl = new URL(editSwitchUrlInput.value);\r\n            editSwitchUrl.searchParams.set('filter', filterQuery);\r\n            editSwitchUrlInput.value = editSwitchUrl;\r\n            editSwitch.dataset.pageurl = editSwitchUrl;\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Cleans URL parameters.\r\n     */\r\n    const cleanUrlParams = () => {\r\n        const queryString = location.search;\r\n        const urlParams = new URLSearchParams(queryString);\r\n        if (urlParams.has('cmid')) {\r\n            const cleanedUrl = new URL(location.href.replace(location.search, ''));\r\n            cleanedUrl.searchParams.set('cmid', urlParams.get('cmid'));\r\n            history.pushState({}, '', cleanedUrl);\r\n        }\r\n\r\n        if (urlParams.has('courseid')) {\r\n            const cleanedUrl = new URL(location.href.replace(location.search, ''));\r\n            cleanedUrl.searchParams.set('courseid', urlParams.get('courseid'));\r\n            history.pushState({}, '', cleanedUrl);\r\n        }\r\n    };\r\n\r\n    // Add listeners for the sorting, paging and clear actions.\r\n    document.querySelector('.questionbankwindow').addEventListener('click', e => {\r\n        const sortableLink = e.target.closest(SELECTORS.SORT_LINK);\r\n        const paginationLink = e.target.closest(SELECTORS.PAGINATION_LINK);\r\n        const clearLink = e.target.closest(Selectors.filterset.actions.resetFilters);\r\n        const showallLink = e.target.closest(SELECTORS.SHOW_ALL_LINK);\r\n        if (sortableLink) {\r\n            e.preventDefault();\r\n            const oldSort = sortData;\r\n            sortData = {};\r\n            sortData[sortableLink.dataset.sortname] = sortableLink.dataset.sortorder;\r\n            for (const sortname in oldSort) {\r\n                if (sortname !== sortableLink.dataset.sortname) {\r\n                    sortData[sortname] = oldSort[sortname];\r\n                }\r\n            }\r\n            viewData.qpage = 0;\r\n            coreFilter.updateTableFromFilter(false);\r\n        }\r\n        if (paginationLink) {\r\n            e.preventDefault();\r\n            const paginationURL = new URL(paginationLink.getAttribute(\"href\"));\r\n            const qpage = paginationURL.searchParams.get('qpage');\r\n            if (paginationURL.search !== null) {\r\n                viewData.qpage = qpage;\r\n                coreFilter.updateTableFromFilter(false);\r\n            }\r\n        }\r\n        if (clearLink) {\r\n            cleanUrlParams();\r\n        }\r\n        if (showallLink) {\r\n\r\n            e.preventDefault();\r\n\r\n            // Toggle between showing all and going back to the original qperpage.\r\n            if (Number(showallLink.dataset.status) === 0) {\r\n                viewData.qperpage = extraparams.maxqperpage;\r\n                showallLink.dataset.status = 1;\r\n                showallLink.innerText = showPerPageText;\r\n            } else {\r\n                viewData.qperpage = extraparams.defaultqperpage;\r\n                showallLink.dataset.status = 0;\r\n                showallLink.innerText = showAllText;\r\n            }\r\n            viewData.qpage = 0;\r\n            coreFilter.updateTableFromFilter();\r\n        }\r\n    });\r\n\r\n    // Run apply filter at page load.\r\n    let initialFilters;\r\n    let jointype = null;\r\n    if (pagevars.filter) {\r\n        // Load initial filter based on page vars.\r\n        initialFilters = pagevars.filter;\r\n        if (pagevars.jointype) {\r\n            jointype = pagevars.jointype;\r\n        }\r\n    }\r\n\r\n    if (Object.entries(initialFilters).length !== 0) {\r\n        // Remove the default empty filter row.\r\n        const emptyFilterRow = filterSet.querySelector(Selectors.filterset.regions.emptyFilterRow);\r\n        if (emptyFilterRow) {\r\n            emptyFilterRow.remove();\r\n        }\r\n\r\n        // Add filters.\r\n        let rowcount = 0;\r\n        for (const urlFilter in initialFilters) {\r\n            if (urlFilter === 'jointype') {\r\n                jointype = initialFilters[urlFilter];\r\n                continue;\r\n            }\r\n            // Add each filter row.\r\n            rowcount += 1;\r\n            const filterdata = {\r\n                filtertype: urlFilter,\r\n                values:  initialFilters[urlFilter].values,\r\n                jointype: initialFilters[urlFilter].jointype,\r\n                filteroptions: initialFilters[urlFilter].filteroptions,\r\n                rownum: rowcount\r\n            };\r\n            coreFilter.addFilterRow(filterdata);\r\n        }\r\n        coreFilter.filterSet.dataset.filterverb = jointype;\r\n\r\n        // Since we must filter by category, it does not make sense to allow the top-level \"match any\" or \"match none\" conditions,\r\n        // as this would exclude the category. Remove those options and disable the select.\r\n        const join = coreFilter.filterSet.querySelector(Selectors.filterset.fields.join);\r\n        join.querySelectorAll(`option:not([value=\"${jointype}\"])`).forEach((option) => option.remove());\r\n        join.disabled = true;\r\n    }\r\n};\r\n"],"names":["async","filterRegionId","defaultcourseid","defaultcategoryid","perpage","bankContextId","quizCmId","component","callback","view","cmid","pagevars","extraparams","SELECTORS","filterSet","document","querySelector","viewData","JSON","stringify","cat","courseid","filter","jointype","qpage","qperpage","sortdata","lastchanged","_document$querySelect2","value","sortData","defaultSort","_document$querySelect3","dataset","_document$querySelect4","defaultsort","parse","showAllText","showPerPageText","Promise","all","defaultqperpage","coreFilter","CoreFilter","filterdata","pendingPromise","parseInt","filterverb","Object","keys","length","isNaN","quizcmid","questionscontainer","innerHTML","loadFragment","then","questionhtml","jsfooter","updateUrlParams","undefined","replaceNode","resolve","catch","Notification","exception","activeFilters","init","filters","url","URL","location","href","filterQuery","searchParams","set","history","pushState","editSwitch","editSwitchUrlInput","editSwitchUrl","pageurl","initialFilters","addEventListener","e","sortableLink","target","closest","paginationLink","clearLink","Selectors","filterset","actions","resetFilters","showallLink","preventDefault","oldSort","sortname","sortorder","updateTableFromFilter","paginationURL","getAttribute","get","search","queryString","urlParams","URLSearchParams","has","cleanedUrl","replace","cleanUrlParams","Number","status","maxqperpage","innerText","entries","emptyFilterRow","regions","remove","rowcount","urlFilter","filtertype","values","filteroptions","rownum","addFilterRow","join","fields","querySelectorAll","forEach","option","disabled"],"mappings":"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"}