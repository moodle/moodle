{"version":3,"file":"change_user_visibility.min.js","sources":["../src/change_user_visibility.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * A javascript module that handles the change of the user's visibility in the\r\n * online users block.\r\n *\r\n * @module     block_online_users/change_user_visibility\r\n * @copyright  2018 Mihail Geshoski <mihail@moodle.com>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport {getString} from 'core/str';\r\nimport Notification from 'core/notification';\r\nimport {setUserPreference} from 'core_user/repository';\r\n\r\n/**\r\n * Selectors.\r\n *\r\n * @access private\r\n * @type {Object}\r\n */\r\nconst SELECTORS = {\r\n    CHANGE_VISIBILITY_LINK: '#change-user-visibility',\r\n    CHANGE_VISIBILITY_ICON: '#change-user-visibility .icon',\r\n};\r\n\r\n/**\r\n * Change user visibility in the online users block.\r\n *\r\n * @method changeVisibility\r\n * @param {String} action\r\n * @param {String} userid\r\n * @returns {Promise}\r\n * @private\r\n */\r\nconst changeVisibility = (action, userid) => setUserPreference(\r\n    'block_online_users_uservisibility',\r\n    action == \"show\" ? 1 : 0,\r\n    userid,\r\n)\r\n.then((data) => {\r\n    if (data.saved) {\r\n        const newAction = oppositeAction(action);\r\n        changeVisibilityLinkAttr(newAction);\r\n        changeVisibilityIconAttr(newAction);\r\n    }\r\n    return data;\r\n}).catch(Notification.exception);\r\n\r\n/**\r\n * Get the opposite action.\r\n *\r\n * @method oppositeAction\r\n * @param {String} action\r\n * @return {String}\r\n * @private\r\n */\r\nconst oppositeAction = (action) => action == 'show' ? 'hide' : 'show';\r\n\r\n/**\r\n * Change the attribute values of the user visibility link in the online users block.\r\n *\r\n * @method changeVisibilityLinkAttr\r\n * @param {String} action\r\n * @returns {Promise}\r\n * @private\r\n */\r\nconst changeVisibilityLinkAttr = (action) => getTitle(action)\r\n    .then((title) => {\r\n        const link = document.querySelector(SELECTORS.CHANGE_VISIBILITY_LINK);\r\n        link.dataset.action = action;\r\n        link.title = title;\r\n        return link;\r\n    });\r\n\r\n/**\r\n * Change the attribute values of the user visibility icon in the online users block.\r\n *\r\n * @method changeVisibilityIconAttr\r\n * @param {String} action\r\n * @returns {Promise}\r\n * @private\r\n */\r\nconst changeVisibilityIconAttr = (action) => getTitle(action)\r\n    .then((title) => {\r\n        const icon = document.querySelector(SELECTORS.CHANGE_VISIBILITY_ICON);\r\n\r\n        // Add the proper title to the icon.\r\n        icon.setAttribute('title', title);\r\n        icon.setAttribute('aria-label', title);\r\n\r\n        if (icon.closest(\"img\")) {\r\n            // If the icon is an image.\r\n            icon.setAttribute('src', M.util.image_url(`t/${action}`));\r\n            icon.setAttribute('alt', title);\r\n        } else {\r\n            // Add the new icon class and remove the old one.\r\n            icon.classList.add(getIconClass(action));\r\n            icon.classList.remove(getIconClass(oppositeAction(action)));\r\n        }\r\n        return title;\r\n    });\r\n\r\n/**\r\n * Get the proper class for the user visibility icon in the online users block.\r\n *\r\n * @method getIconClass\r\n * @param {String} action\r\n * @return {String}\r\n * @private\r\n */\r\nconst getIconClass = (action) => (action == 'show') ? 'fa-eye-slash' : 'fa-eye';\r\n\r\n/**\r\n * Get the title description of the user visibility link in the online users block.\r\n *\r\n * @method getTitle\r\n * @param {String} action\r\n * @return {object} jQuery promise\r\n * @private\r\n */\r\nconst getTitle = (action) => getString(`online_status:${action}`, 'block_online_users');\r\n\r\n/**\r\n * Initialise change user visibility function.\r\n *\r\n * @method init\r\n */\r\nexport const init = () => {\r\n    document.addEventListener('click', (e) => {\r\n        const link = e.target.closest(SELECTORS.CHANGE_VISIBILITY_LINK);\r\n        if (!link) {\r\n            return;\r\n        }\r\n        e.preventDefault();\r\n        changeVisibility(\r\n            link.dataset.action,\r\n            link.dataset.userid,\r\n        );\r\n    });\r\n};\r\n"],"names":["SELECTORS","oppositeAction","action","changeVisibilityLinkAttr","getTitle","then","title","link","document","querySelector","dataset","changeVisibilityIconAttr","icon","setAttribute","closest","M","util","image_url","classList","add","getIconClass","remove","addEventListener","e","target","userid","preventDefault","data","saved","newAction","catch","Notification","exception"],"mappings":";;;;;;;;4JAkCMA,iCACsB,0BADtBA,iCAEsB,gCAkCtBC,eAAkBC,QAAqB,QAAVA,OAAmB,OAAS,OAUzDC,yBAA4BD,QAAWE,SAASF,QACjDG,MAAMC,cACGC,KAAOC,SAASC,cAAcT,yCACpCO,KAAKG,QAAQR,OAASA,OACtBK,KAAKD,MAAQA,MACNC,QAWTI,yBAA4BT,QAAWE,SAASF,QACjDG,MAAMC,cACGM,KAAOJ,SAASC,cAAcT,yCAGpCY,KAAKC,aAAa,QAASP,OAC3BM,KAAKC,aAAa,aAAcP,OAE5BM,KAAKE,QAAQ,QAEbF,KAAKC,aAAa,MAAOE,EAAEC,KAAKC,sBAAef,UAC/CU,KAAKC,aAAa,MAAOP,SAGzBM,KAAKM,UAAUC,IAAIC,aAAalB,SAChCU,KAAKM,UAAUG,OAAOD,aAAanB,eAAeC,WAE/CI,SAWTc,aAAgBlB,QAAsB,QAAVA,OAAoB,eAAiB,SAUjEE,SAAYF,SAAW,0CAA2BA,QAAU,oCAO9C,KAChBM,SAASc,iBAAiB,SAAUC,UAC1BhB,KAAOgB,EAAEC,OAAOV,QAAQd,kCA/Fb,IAACE,OAAQuB,OAgGrBlB,OAGLgB,EAAEG,iBAnGgBxB,OAqGdK,KAAKG,QAAQR,OArGSuB,OAsGtBlB,KAAKG,QAAQe,QAtGoB,iCACzC,oCACU,QAAVvB,OAAmB,EAAI,EACvBuB,QAEHpB,MAAMsB,UACCA,KAAKC,MAAO,OACNC,UAAY5B,eAAeC,QACjCC,yBAAyB0B,WACzBlB,yBAAyBkB,kBAEtBF,QACRG,MAAMC,sBAAaC"}