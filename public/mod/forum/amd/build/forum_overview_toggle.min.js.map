{"version":3,"file":"forum_overview_toggle.min.js","sources":["../src/forum_overview_toggle.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Handle forum subscription/tracking toggling.\r\n *\r\n * @module     mod_forum/forum_overview_toggle\r\n * @copyright  2025 Sara Arjona <sara@moodle.com>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport Notification from 'core/notification';\r\nimport {getString} from 'core/str';\r\nimport SRLogger from 'core/local/reactive/srlogger';\r\nimport Repository from 'mod_forum/repository';\r\n\r\n/**\r\n * Register event listeners for the subscription/tracking toggles in the overview.\r\n * @param {HTMLElement} toggleElement The toggle root element\r\n */\r\nfunction registerEventListeners(toggleElement) {\r\n    toggleElement.addEventListener('change', () => {\r\n        if (toggleElement.dataset.type === 'forum-subscription-toggle') {\r\n            subscriptionToggleClickHandler(toggleElement);\r\n        }\r\n        if (toggleElement.dataset.type === 'forum-track-toggle') {\r\n            trackToggleClickHanldler(toggleElement);\r\n        }\r\n    });\r\n}\r\n\r\n/**\r\n * Toggle subscription element click handler.\r\n *\r\n * @param {HTMLElement} toggleElement The toggle element that was clicked\r\n * @return {Promise<void>}\r\n */\r\nasync function subscriptionToggleClickHandler(toggleElement) {\r\n    const forumId = toggleElement.dataset.forumid;\r\n    const forumName = toggleElement.dataset.forumname;\r\n    const newState = toggleElement.dataset.targetstate;\r\n    if (!forumId || !newState) {\r\n        return;\r\n    }\r\n    try {\r\n        const context = await Repository.setForumSubscriptionState(forumId, newState);\r\n        const newTargetState = !!context.userstate.subscribed;\r\n\r\n        await updateSwitchState(\r\n            toggleElement,\r\n            newTargetState,\r\n            newTargetState ? 'subscribe' : 'unsubscribe',\r\n        );\r\n\r\n        const feedbackMessage = await getString(\r\n            newTargetState ? 'subscribedtoforum' : 'unsubscribedfromforum',\r\n            'mod_forum',\r\n            forumName,\r\n        );\r\n        new SRLogger().add({feedbackMessage});\r\n    } catch (error) {\r\n        Notification.exception(error);\r\n    }\r\n}\r\n\r\n/**\r\n * Toggle track element click handler.\r\n *\r\n * @param {HTMLElement} toggleElement The toggle element that was clicked\r\n * @return {Promise<void>}\r\n */\r\nasync function trackToggleClickHanldler(toggleElement) {\r\n    const forumId = toggleElement.dataset.forumid;\r\n    const forumName = toggleElement.dataset.forumname;\r\n    const newState = toggleElement.dataset.targetstate;\r\n    if (!forumId || !newState) {\r\n        return;\r\n    }\r\n    try {\r\n        const context = await Repository.setForumTrackingState(forumId, newState);\r\n        const newTargetState = !!context.userstate.tracked;\r\n\r\n        await updateSwitchState(\r\n            toggleElement,\r\n            newTargetState,\r\n            newTargetState ? 'trackingon' : 'trackingoff',\r\n        );\r\n\r\n        const feedbackMessage = await getString(\r\n            newTargetState ? 'trackedforforum' : 'untrackedforforum',\r\n            'mod_forum',\r\n            forumName,\r\n        );\r\n        new SRLogger().add({feedbackMessage});\r\n    } catch (error) {\r\n        Notification.exception(error);\r\n    }\r\n}\r\n\r\n/**\r\n * Update the switch state of the toggle element.\r\n *\r\n * @param {HTMLElement} toggleElement The toggle element to update\r\n * @param {Boolean} newTargetState The new target state to set (true for subscribed, false for unsubscribed)\r\n * @param {string} stringKey The string key to retrieve the label text\r\n * @return {Promise<void>}\r\n */\r\nasync function updateSwitchState(toggleElement, newTargetState, stringKey) {\r\n    toggleElement.dataset.targetstate = newTargetState ? 0 : 1;\r\n    const string = await getString(stringKey, 'mod_forum');\r\n    const label = toggleElement.closest('td').querySelector(`label[for=\"${toggleElement.id}\"] span`);\r\n    label.textContent = string;\r\n}\r\n\r\n/**\r\n * Initialize the forum overview toggle functionality.\r\n *\r\n * @param {string} toggleSelector The CSS selector for the toggle element to initialize\r\n * @throws {Error} If no elements are found with the provided selector\r\n */\r\nexport const init = (toggleSelector) => {\r\n    const toggleElement = document.querySelector(toggleSelector);\r\n    if (!toggleElement) {\r\n        // If the user cannot track/subscribe to any course forum, the toggle will not be present.\r\n        return;\r\n    }\r\n    registerEventListeners(toggleElement);\r\n};\r\n"],"names":["registerEventListeners","toggleElement","addEventListener","dataset","type","forumId","forumid","forumName","forumname","newState","targetstate","newTargetState","Repository","setForumSubscriptionState","userstate","subscribed","updateSwitchState","feedbackMessage","SRLogger","add","error","exception","subscriptionToggleClickHandler","setForumTrackingState","tracked","trackToggleClickHanldler","stringKey","string","closest","querySelector","id","textContent","toggleSelector","document"],"mappings":";;;;;;;cAgCSA,uBAAuBC,eAC5BA,cAAcC,iBAAiB,UAAU,KACF,8BAA/BD,cAAcE,QAAQC,qBAeYH,qBACpCI,QAAUJ,cAAcE,QAAQG,QAChCC,UAAYN,cAAcE,QAAQK,UAClCC,SAAWR,cAAcE,QAAQO,gBAClCL,UAAYI,0BAKPE,wBADgBC,oBAAWC,0BAA0BR,QAASI,WACnCK,UAAUC,iBAErCC,kBACFf,cACAU,eACAA,eAAiB,YAAc,qBAG7BM,sBAAwB,kBAC1BN,eAAiB,oBAAsB,wBACvC,YACAJ,gBAEAW,mBAAWC,IAAI,CAACF,gBAAAA,kBACtB,MAAOG,6BACQC,UAAUD,QAtCnBE,CAA+BrB,eAEA,uBAA/BA,cAAcE,QAAQC,qBA8CMH,qBAC9BI,QAAUJ,cAAcE,QAAQG,QAChCC,UAAYN,cAAcE,QAAQK,UAClCC,SAAWR,cAAcE,QAAQO,gBAClCL,UAAYI,0BAKPE,wBADgBC,oBAAWW,sBAAsBlB,QAASI,WAC/BK,UAAUU,cAErCR,kBACFf,cACAU,eACAA,eAAiB,aAAe,qBAG9BM,sBAAwB,kBAC1BN,eAAiB,kBAAoB,oBACrC,YACAJ,gBAEAW,mBAAWC,IAAI,CAACF,gBAAAA,kBACtB,MAAOG,6BACQC,UAAUD,QArEnBK,CAAyBxB,iCAiFtBe,kBAAkBf,cAAeU,eAAgBe,WAC5DzB,cAAcE,QAAQO,YAAcC,eAAiB,EAAI,QACnDgB,aAAe,kBAAUD,UAAW,aAC5BzB,cAAc2B,QAAQ,MAAMC,mCAA4B5B,cAAc6B,eAC9EC,YAAcJ,kPASHK,uBACX/B,cAAgBgC,SAASJ,cAAcG,gBACxC/B,eAILD,uBAAuBC"}