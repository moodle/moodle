{"version":3,"file":"edit.min.js","sources":["../src/edit.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Edit items in feedback module\r\n *\r\n * @module     mod_feedback/edit\r\n * @copyright  2016 Marina Glancy\r\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\n\"use strict\";\r\n\r\nimport {addIconToContainerRemoveOnCompletion} from 'core/loadingicon';\r\nimport Notification from 'core/notification';\r\nimport Pending from 'core/pending';\r\nimport {prefetchStrings} from 'core/prefetch';\r\nimport SortableList from 'core/sortable_list';\r\nimport {getString, getStrings} from 'core/str';\r\nimport {add as addToast} from 'core/toast';\r\nimport {reorderQuestions} from 'mod_feedback/local/repository';\r\nimport Templates from 'core/templates';\r\n\r\nconst Selectors = {\r\n    deleteQuestionButton: '[data-action=\"delete\"]',\r\n    sortableListRegion: '[data-region=\"questions-sortable-list\"]',\r\n    sortableElement: '[data-region=\"questions-sortable-list\"] .feedback_itemlist[id]',\r\n    sortableElementTitle: '[data-region=\"item-title\"] span',\r\n    questionLabel: '[data-region=\"questions-sortable-list\"] .col-form-label',\r\n    actionsMenuData: '[data-item-actions-menu]',\r\n};\r\n\r\n/**\r\n * Returns the Feedback question item id from the DOM id of an item.\r\n *\r\n * @param {String} id The dom id, f.g.: feedback_item_22\r\n * @return int\r\n */\r\nconst getItemId = (id) => {\r\n    return Number(id.replace(/^.*feedback_item_/i, ''));\r\n};\r\n\r\n/**\r\n * Returns the order of the items in the sortable list.\r\n *\r\n * @param {Element} element The element to get the order from.\r\n * @return string\r\n */\r\nconst getItemOrder = (element) => {\r\n    const sortableList = element.closest(Selectors.sortableListRegion);\r\n    let itemOrder = [];\r\n    sortableList.querySelectorAll(Selectors.sortableElement).forEach((item) => {\r\n        itemOrder.push(getItemId(item.id));\r\n    });\r\n    return itemOrder.toString();\r\n};\r\n\r\nlet initialized = false;\r\nlet moduleId = null;\r\n\r\n/**\r\n * Initialise editor and all it's modules\r\n *\r\n * @param {Integer} cmId\r\n */\r\nexport const init = async(cmId) => {\r\n\r\n    moduleId = cmId;\r\n\r\n    // Ensure we only add our listeners once (can be called multiple times).\r\n    if (initialized) {\r\n        return;\r\n    }\r\n\r\n    prefetchStrings('core', [\r\n        'yes',\r\n        'no',\r\n    ]);\r\n    prefetchStrings('admin', [\r\n        'confirmation',\r\n    ]);\r\n    prefetchStrings('mod_feedback', [\r\n        'confirmdeleteitem',\r\n        'questionmoved',\r\n        'move_item',\r\n    ]);\r\n\r\n    await enhanceEditForm();\r\n\r\n    // Add event listeners.\r\n    document.addEventListener('click', async event => {\r\n\r\n        // Delete question.\r\n        const deleteButton = event.target.closest(Selectors.deleteQuestionButton);\r\n        if (deleteButton) {\r\n            event.preventDefault();\r\n            const confirmationStrings = await getStrings([\r\n                {key: 'confirmation', component: 'admin'},\r\n                {key: 'confirmdeleteitem', component: 'mod_feedback'},\r\n                {key: 'yes', component: 'core'},\r\n                {key: 'no', component: 'core'},\r\n            ]);\r\n            Notification.confirm(...confirmationStrings, () => {\r\n                window.location = deleteButton.getAttribute('href');\r\n            });\r\n            return;\r\n        }\r\n    });\r\n\r\n    // Initialize sortable list to handle active conditions moving.\r\n    const sortableList = new SortableList(document.querySelector(Selectors.sortableListRegion));\r\n    sortableList.getElementName = element => Promise.resolve(element[0].querySelector(Selectors.sortableElementTitle)?.textContent);\r\n\r\n    document.addEventListener(SortableList.EVENTS.elementDrop, event => {\r\n        if (!event.detail.positionChanged) {\r\n            return;\r\n        }\r\n        const pendingPromise = new Pending('mod_feedback/questions:reorder');\r\n        const itemOrder = getItemOrder(event.detail.element[0]);\r\n        addIconToContainerRemoveOnCompletion(event.detail.element[0], pendingPromise);\r\n        reorderQuestions(moduleId, itemOrder)\r\n            .then(() => getString('questionmoved', 'mod_feedback'))\r\n            .then(addToast)\r\n            .then(() => pendingPromise.resolve())\r\n            .catch(Notification.exception);\r\n    });\r\n\r\n    initialized = true;\r\n};\r\n\r\n/**\r\n * Enhance the edit form by adding a move item button and an action menu to each question.\r\n *\r\n * @returns {Promise<void>}\r\n */\r\nconst enhanceEditForm = async() => {\r\n    const questionLabels = document.querySelectorAll(Selectors.questionLabel);\r\n    const movetitle = await getString('move_item', 'mod_feedback');\r\n\r\n    const updates = Array.from(questionLabels).map(async(container) => {\r\n        const label = container.querySelector(Selectors.actionsMenuData);\r\n        if (!label) {\r\n            return;\r\n        }\r\n\r\n        try {\r\n            const contextData = {\r\n                movetitle,\r\n                label: label.parentElement.outerHTML,\r\n                actionsmenu: JSON.parse(label.dataset.itemActionsMenu || '{}'),\r\n            };\r\n            container.innerHTML = await Templates.render('mod_feedback/item_edit_enhanced_title', contextData);\r\n        } catch (error) {\r\n            await Notification.exception(error);\r\n        }\r\n    });\r\n    await Promise.all(updates);\r\n};\r\n"],"names":["Selectors","getItemOrder","element","sortableList","closest","itemOrder","querySelectorAll","forEach","item","id","push","Number","replace","toString","initialized","moduleId","async","cmId","enhanceEditForm","document","addEventListener","deleteButton","event","target","preventDefault","confirmationStrings","key","component","confirm","window","location","getAttribute","SortableList","querySelector","getElementName","Promise","resolve","_element$0$querySelec","textContent","EVENTS","elementDrop","detail","positionChanged","pendingPromise","Pending","then","addToast","catch","Notification","exception","questionLabels","movetitle","updates","Array","from","map","label","container","contextData","parentElement","outerHTML","actionsmenu","JSON","parse","dataset","itemActionsMenu","innerHTML","Templates","render","error","all"],"mappings":"sqBAmCMA,+BACoB,yBADpBA,6BAEkB,0CAFlBA,0BAGe,iEAHfA,+BAIoB,kCAJpBA,wBAKa,0DALbA,0BAMe,2BAmBfC,aAAgBC,gBACZC,aAAeD,QAAQE,QAAQJ,kCACjCK,UAAY,UAChBF,aAAaG,iBAAiBN,2BAA2BO,SAASC,OAbnDC,IAAAA,GAcXJ,UAAUK,MAdCD,GAccD,KAAKC,GAb3BE,OAAOF,GAAGG,QAAQ,qBAAsB,UAexCP,UAAUQ,gBAGjBC,aAAc,EACdC,SAAW,mBAOKC,MAAAA,UAEhBD,SAAWE,KAGPH,iDAIY,OAAQ,CACpB,MACA,qCAEY,QAAS,CACrB,+CAEY,eAAgB,CAC5B,oBACA,gBACA,oBAGEI,kBAGNC,SAASC,iBAAiB,SAASJ,MAAAA,cAGzBK,aAAeC,MAAMC,OAAOnB,QAAQJ,mCACtCqB,cACAC,MAAME,uBACAC,0BAA4B,mBAAW,CACzC,CAACC,IAAK,eAAgBC,UAAW,SACjC,CAACD,IAAK,oBAAqBC,UAAW,gBACtC,CAACD,IAAK,MAAOC,UAAW,QACxB,CAACD,IAAK,KAAMC,UAAW,gCAEdC,WAAWH,qBAAqB,KACzCI,OAAOC,SAAWT,aAAaU,aAAa,oBAOnC,IAAIC,uBAAab,SAASc,cAAcjC,+BAChDkC,eAAiBhC,2CAAWiC,QAAQC,sCAAQlC,QAAQ,GAAG+B,cAAcjC,wEAAzBqC,sBAA0DC,cAEnHnB,SAASC,iBAAiBY,uBAAaO,OAAOC,aAAalB,YAClDA,MAAMmB,OAAOC,6BAGZC,eAAiB,IAAIC,iBAAQ,kCAC7BvC,UAAYJ,aAAaqB,MAAMmB,OAAOvC,QAAQ,0DACfoB,MAAMmB,OAAOvC,QAAQ,GAAIyC,iDAC7C5B,SAAUV,WACtBwC,MAAK,KAAM,kBAAU,gBAAiB,kBACtCA,KAAKC,YACLD,MAAK,IAAMF,eAAeP,YAC1BW,MAAMC,sBAAaC,cAG5BnC,aAAc,SAQZI,gBAAkBF,gBACdkC,eAAiB/B,SAASb,iBAAiBN,yBAC3CmD,gBAAkB,kBAAU,YAAa,gBAEzCC,QAAUC,MAAMC,KAAKJ,gBAAgBK,KAAIvC,MAAAA,kBACrCwC,MAAQC,UAAUxB,cAAcjC,8BACjCwD,gBAKKE,YAAc,CAChBP,UAAAA,UACAK,MAAOA,MAAMG,cAAcC,UAC3BC,YAAaC,KAAKC,MAAMP,MAAMQ,QAAQC,iBAAmB,OAE7DR,UAAUS,gBAAkBC,mBAAUC,OAAO,wCAAyCV,aACxF,MAAOW,aACCrB,sBAAaC,UAAUoB,iBAG/BlC,QAAQmC,IAAIlB"}