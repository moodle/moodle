define(["jquery","core/notification","core/templates","core/custom_interaction_events","block_myoverview/calendar_events_repository"],function(a,b,c,d,e){var f=86400,g={EVENT_LIST:'[data-region="event-list"]',EVENT_LIST_GROUP_CONTAINER:'[data-region="event-list-group-container"]',LOADING_ICON_CONTAINER:'[data-region="loading-icon-container"]',VIEW_MORE_BUTTON:'[data-action="view-more"]'},h=function(a){a.attr("data-loaded-all",!0)},i=function(a){return!!a.attr("data-loaded-all")},j=function(a){var b=a.find(g.LOADING_ICON_CONTAINER),c=a.find(g.VIEW_MORE_BUTTON);a.addClass("loading"),b.removeClass("hidden"),c.prop("disabled",!0)},k=function(a){var b=a.find(g.LOADING_ICON_CONTAINER),c=a.find(g.VIEW_MORE_BUTTON);a.removeClass("loading"),b.addClass("hidden"),i(a)||c.prop("disabled",!1)},l=function(a){return a.hasClass("loading")},m=function(a,b){return a.removeClass("hidden"),c.render("block_myoverview/event-list-items",{events:b}).done(function(b,d){c.appendNodeContents(a.find(g.EVENT_LIST),b,d)})},n=function(a,b){var c=b.orderTime||0;return c-a},o=function(a,b){var c=Math.floor((new Date).setHours(0,0,0,0)/1e3),d=+b.attr("data-start-day")*f,e=+b.attr("data-end-day")*f,g=n(c,a);return e?d<=g&&g<e:d<=g},p=function(b){return function(c){return o(c,a(b))}},q=function(b,c){var d=0;return a.when.apply(a,a.map(b.find(g.EVENT_LIST_GROUP_CONTAINER),function(b){var e=c.filter(p(b));return e.length?(d+=e.length,m(a(b),e)):null})).then(function(){return d})},r=function(c){c=a(c);var d=+c.attr("data-limit"),f=+c.attr("data-offset"),g=+c.attr("data-course-id"),i=new Date,m=Math.floor(i.setHours(0,0,0,0)/1e3);if(l(c))return a.Deferred().resolve();j(c);var n=null;return n=g?e.queryFromTimeByCourse(g,m,d,f):e.queryFromTime(m,d,f),n.then(function(a){if((!a.length||a.length<d)&&h(c),a.length)return c.attr("data-offset",f+a.length),q(c,a).then(function(b){b<a.length&&h(c)})}).fail(b.exception).always(function(){k(c)})},s=function(a){d.define(a,[d.events.activate]),a.one(d.events.activate,g.VIEW_MORE_BUTTON,function(){r(a)})};return{init:function(b){b=a(b),r(b),s(b)},registerEventListeners:s,load:r}});