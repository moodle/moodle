{"version":3,"sources":["../src/ajax.js"],"names":["define","$","config","Log","ModalFactory","unloading","requestSuccess","response","request","error","cap","debuginfo","errorcode","msg","create","title","type","body","footer","done","modal","dialogue","show","deferred","reject","resolve","exception","Error","requestFail","jqXHR","textStatus","call","async","loginrequired","window","bind","ajaxRequestData","promise","args","Deferred","fail","JSON","stringify","settings","data","context","dataType","processData","global","contentType","beforeSend","loading","success","hide","ajax","url","sesskey"],"mappings":"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","sourcesContent":["/**\r\n * Standard Ajax wrapper for LearnerScript Reports. It calls the central Ajax script,\r\n *\r\n * @module     block_learnerscript/ajax\r\n * @class      ajax\r\n * @package    learnerscript\r\n * @copyright  2017 Naveen kumar <naveen@eabyas.in>\r\n */\r\ndefine(['jquery', 'core/config', 'core/log', 'core/modal_factory'], function($, config, Log, ModalFactory) {\r\n    // Keeps track of when the user leaves the page so we know not to show an error.\r\n    var unloading = false;\r\n    /**\r\n     * Success handler. Called when the ajax call succeeds. Checks each response and\r\n     * resolves or rejects the deferred from that request.\r\n     *\r\n     * @method requestSuccess\r\n     * @private\r\n     * @param response containing error, exception and data attributes.\r\n     */\r\n    var requestSuccess = function(response) {\r\n        // Call each of the success handlers.\r\n        var request = this;\r\n        if (response === null) {\r\n            return;\r\n        }\r\n        if (response.error) {\r\n            // There was an error with the request as a whole.\r\n            // We need to reject each promise.\r\n            // Unfortunately this may lead to duplicate dialogues, but each Promise must be rejected.\r\n            if (response.cap || response.debuginfo ||response.errorcode) {\r\n                var msg = response.msg || response.error;\r\n                ModalFactory.create({\r\n                    title: response.type || response.errorcode,\r\n                    body: '<p>' + msg + '</p>',\r\n                    footer: '',\r\n                }).done(function(modal) {\r\n                    dialogue = modal;\r\n                    // Display the dialogue.\r\n                    dialogue.show();\r\n                });\r\n            } else {\r\n                Log.error(response.type + ': ' + response.msg);\r\n            }\r\n            request.deferred.reject(response);\r\n            return;\r\n        }\r\n        // We may not have responses for all the requests.\r\n        if (typeof response !== \"undefined\") {\r\n            // if (response.error === false) {\r\n            // Call the done handler if it was provided.\r\n            request.deferred.resolve(response);\r\n            // } else {\r\n            //     exception = response.exception;\r\n            // }\r\n        } else {\r\n            // This is not an expected case.\r\n            exception = new Error('missing response');\r\n        }\r\n        // Something failed, reject the remaining promises.\r\n        if (typeof(exception) !== 'undefined' && exception !== null) {\r\n            request.deferred.reject(exception);\r\n        }\r\n    };\r\n    /**\r\n     * Fail handler. Called when the ajax call fails. Rejects all deferreds.\r\n     *\r\n     * @method requestFail\r\n     * @private\r\n     * @param {jqXHR} jqXHR The ajax object.\r\n     * @param {string} textStatus The status string.\r\n     * @param {Error|Object} exception The error thrown.\r\n     */\r\n    var requestFail = function(jqXHR, textStatus, exception) {\r\n        // Reject all the promises.\r\n        var request = this;\r\n        if (unloading) {\r\n            // No need to trigger an error because we are already navigating.\r\n            Log.error(\"Page unloaded.\");\r\n            Log.error(exception);\r\n        } else {\r\n            Log.error(\"Page Not Responding.\");\r\n            Log.error(exception);\r\n            request.deferred.reject(exception);\r\n        }\r\n    };\r\n    return /** @alias module:core/ajax */ {\r\n        // Public variables and functions.\r\n        /**\r\n         * Make a series of ajax requests and return all the responses.\r\n         *\r\n         * @method call\r\n         * @param {Object[]} requests Array of requests with each containing methodname and args properties.\r\n         *                   done and fail callbacks can be set for each element in the array, or the\r\n         *                   can be attached to the promises returned by this function.\r\n         * @param {Boolean} async Optional, defaults to true.\r\n         *                  If false - this function will not return until the promises are resolved.\r\n         * @param {Boolean} loginrequired Optional, defaults to true.\r\n         *                  If false - this function will call the faster nologin ajax script - but\r\n         *                  will fail unless all functions have been marked as 'loginrequired' => false\r\n         *                  in services.php\r\n         * @return {Promise[]} Array of promises that will be resolved when the ajax call returns.\r\n         */\r\n        call: function(request, async, loginrequired) {\r\n            $(window).bind('beforeunload', function() {\r\n                unloading = true;\r\n            });\r\n            var ajaxRequestData,\r\n                promise = {};\r\n            if (typeof loginrequired === \"undefined\") {\r\n                loginrequired = true;\r\n            }\r\n            if (typeof async === \"undefined\") {\r\n                async = true;\r\n            }\r\n            ajaxRequestData = request.args;\r\n            request.deferred = $.Deferred();\r\n            promise = request.deferred.promise();\r\n            // Allow setting done and fail handlers as arguments.\r\n            // This is just a shortcut for the calling code.\r\n            if (typeof request.done !== \"undefined\") {\r\n                request.deferred.done(request.done);\r\n            }\r\n            if (typeof request.fail !== \"undefined\") {\r\n                request.deferred.fail(request.fail);\r\n            }\r\n            ajaxRequestData = JSON.stringify(ajaxRequestData);\r\n            var settings = {\r\n                type: 'POST',\r\n                data: ajaxRequestData,\r\n                context: request,\r\n                dataType: 'json',\r\n                processData: false,\r\n                global: true,\r\n                async: async,\r\n                contentType: \"application/json\",\r\n                beforeSend: function() {\r\n                    // Handle the beforeSend event\r\n                    request.loading && $(request.loading).show();\r\n                },\r\n                success: function() {\r\n                    request.loading && $(request.loading).hide('fast');\r\n                    // Handle the complete event\r\n                }\r\n            };\r\n            // Jquery deprecated done and fail with async=false so we need to do this 2 ways.\r\n            if (async) {\r\n                $.ajax(request.url + '?sesskey=' + config.sesskey, settings).done(requestSuccess).fail(requestFail);\r\n            } else {\r\n                settings.success = requestSuccess;\r\n                settings.error = requestFail;\r\n                $.ajax(request.url + '?sesskey=' + config.sesskey, settings);\r\n            }\r\n            return promise;\r\n        }\r\n    };\r\n});"],"file":"ajax.min.js"}