define ("block_learnerscript/helper",["jquery","block_learnerscript/ajax","block_learnerscript/ajaxforms","core/str","core/modal_factory","core/modal_events","core/ajax","core/notification","block_learnerscript/smartfilter","block_learnerscript/bootstrapnotify"],function(a,b,c,d,e,f,g,h,i){return helper={sendmessage:function sendmessage(b,c){d.get_strings([{key:"sendmessage",component:"block_learnerscript"},{key:"messageconformation",component:"block_learnerscript"},{key:"messagesent",component:"block_learnerscript"}]).then(function(d){var e=b.userid,f=b.reportinstance,h="form_sendsms"+e,i=a("#sendsms_"+f+"_"+e).parents("table");if(1>a("#ls_sendsms_"+f+"_"+e).length){a("#sendsms_"+f+"_"+e).append("<div id=\"ls_sendsms_"+f+"_"+e+"\" class=\"sendmessage\"><div class=\"messageloading\"></div><form id=\""+h+"\" ><textarea id=\"text_"+h+"\" type=\"text\" name=\"message\"></textarea><input type=\"submit\" value = \"Submit\"></form></div>")}var j=a("#ls_sendsms_"+f+"_"+e).dialog({resizable:!0,autoOpen:!1,width:"20%",title:d[0],modal:!1,dialogClass:"sendsmsdialog",show:{effect:"slide",duration:1e3},position:{my:"left",at:"right",of:"#sendsms_"+f+"_"+e,within:i},open:function open(){a(this).closest(".ui-dialog").find(".ui-dialog-titlebar-close").removeClass("ui-dialog-titlebar-close").html("<span class='ui-button-icon-primary ui-icon ui-icon-closethick'></span>");var b=a(".ui-icon-closethick").parent();a(b).attr({title:"Close"});a(".sendmessage").not(this).each(function(){a(this).remove()})},close:function close(){a(this).dialog("destroy").remove()}});j.dialog("open");a("#"+h).submit(function(f){f.preventDefault();var e=require("block_learnerscript/helper"),i=document.getElementById("text_"+h).value;if(!i){a(".messageloading").html("<div class=\"alert alert-danger\">You must supply a value here</div>")}else{url=require("core/url");a(".messageloading").html("<center><img src=\""+url.imageUrl("loader","block_learnerscript")+"\" alt=\"Message Sending\" title=\"Message Sending\"/></center>");a("#"+h).hide();var k=g.call([{methodname:"core_message_send_instant_messages",args:{messages:[{touserid:b.userid,text:a("#"+h).serializeObject().message,textformat:0}]}}])}k[0].done(function(){var a=d[2]+c;e.notifications(a);j.dialog("close")}).fail(function(b){a(".messageloading").html("<div class=\"alert alert-warning\">"+b.message+"</div>")})})})},ViewReportFilters:function ViewReportFilters(b){a("."+b.activefilter).toggleClass("show");a("."+b.inactivefilter).removeClass("show")},deleteConfirm:function deleteConfirm(b){return d.get_strings([{key:"deleteconfirmation",component:"block_learnerscript"},{key:"deleteallconfirm",component:"block_learnerscript"},{key:"graphdeleted",component:"block_learnerscript"},{key:"graphcannotbedeleted",component:"block_learnerscript"}]).then(function(c){e.create({title:c[0],type:e.types.SAVE_CANCEL,body:c[1]}).done(function(d){this.modal=d;d.setSaveButtonText("Confirm");d.getRoot().on(f.save,function(f){f.preventDefault();var e=require("block_learnerscript/helper"),h=g.call([{methodname:"block_learnerscript_"+b.action,args:b}]);h[0].done(function(){a(".plotgraphcontainer").removeClass("show").addClass("hide");a("#plotreportcontainer"+b.reportid).html("");var d=a("#"+b.cid).attr("aria-controls");a("[data-cid='"+b.cid+"']").remove();a("#"+d).remove();if(1>a("#report_plottabs li:eq(0) a").length){a("#report_plottabs").remove()}e.notifications(c[2])}).fail(function(a){console.log(a)});d.hide();d.destroy()}.bind(this));d.show();a(".modal-header button.close").attr("title","Close")}.bind(this))}.bind(this))},validatebasicform:function validatebasicform(b){var c=[];if("undefined"==typeof b){a.each(a(".basicparamsform select"),function(b,d){var e=a(d).val();if(0==e){c.push(0)}})}return c},Preview:function Preview(b){a(b.container).dialog({dialogClass:"previewpopup",width:"95%",modal:!0,position:{my:"center",at:"center",within:".ls_components"},close:function close(){a(this).dialog("destroy")},open:function open(){a(this).closest(".ui-dialog").find(".ui-dialog-titlebar-close").removeClass("ui-dialog-titlebar-close").html("<span class='ui-button-icon-primary ui-icon ui-icon-closethick'></span>");var b=a(".ui-icon-closethick").parent();a(b).attr({title:"Close"})}})},Select2Ajax:function Select2Ajax(b){a("select[data-select2-ajax='1']").each(function(){var c=a(this).data("instanceid"),d=c?c:b.reportid;if("rolewiseusers"==b.action){b.reportid=a(this).data("reportid");b.courses=a("[name=\"filter_courses\"]").val()}if("userlist"===b.action){b.setminimumInputLength=2;b.courses=a("[name=\"filter_courses\"]").val()}if(!a(this).hasClass("select2-hidden-accessible")){a(this).select2({ajax:{data:function data(e){var f=a(this).data("action");if("filterusers"==f||"filtercourses"==f){b.action=f;b.basicparamdata=JSON.stringify(i.BasicparamsData(d));b.fiterdata=JSON.stringify(i.FilterData(d));b.reportinstanceid=c;b.courses=a("[name=\"filter_courses\"]").val()}if("rolewiseusers"==b.action){delete b.schuserslist;delete b.scheduleid;b.roleid=a("#id_role"+d).val();var g=b.roleid.split("_");b.roleid=g[0];b.contextlevel=g[1];b.courses=a("[name=\"filter_courses\"]").val()}a.extend(e,b);methodname2=b.action;if("userlist"===methodname2){$blockname="block_reportdashboard_"}else{$blockname="block_learnerscript_"}return e},transport:function transport(b,c){b.data.roleid=b.data.roleid;var d=g.call([{methodname:$blockname+methodname2,args:b.data}]);d[0].done(function(b){b=a.parseJSON(b);c(b)});d[0].fail(function(){})},processResults:function processResults(a,c){c.page=c.page||1;var d=!1;if("userlist"===b.action||"filtercourses"==b.action||"filterusers"==b.action){d=!1}else{d=10*c.page<a.total_count}return{results:a.items,pagination:{more:d}}}},escapeMarkup:function escapeMarkup(a){return a},minimumInputLength:b.setminimumInputLength||1,maximumSelectionLength:b.maximumSelectionLength,language:{maximumSelected:function maximumSelected(c){if("rolewiseusers"==b.action){b.roleid=a("#id_role"+d).val();b.schuserslist=a("#schuserslist"+d).val();b.scheduleid=a("#scheduleid").val()||-1;return"Click <a href='javascript:void(0);' class='seluser' id='addusers"+b.reportid+"'                                                      data-reportid="+b.reportid+" data-scheduleid = "+b.scheduleid+"                         onclick = '(function(e){ require(\"block_learnerscript/schedule\").manageschusers(                                                     {reportinstance:"+d+", reportid:"+b.reportid+",scheduleid:"+b.scheduleid+",selectedroleid:"+b.roleid+",                                                     schuserslist:\""+b.schuserslist+"\"}) })(event)' > here </a> to add more than "+c.maximum+" users."}}},templateResult:function(a){var b;if(a.loading){return a.text||"Values not supported"}b=a.text||"Values not supported";return b},templateSelection:function(a){var c;if(-1==a.id&&"rolewiseusers"==b.action){var e=a.element.form.dataset.reportid||0,f=a.element.form.dataset.scheduleid||-1;c="<a href='javascript:void(0)' class='viewschusers'onclick='(function(e){ require(\"block_learnerscript/schedule\").viewschusers(                                             {reportid:"+e+",scheduleid:"+f+", reportinstance:"+d+"}) })(event);'>"+a.text+"</a>"}else{c=a.text}return c}}).on("select2:select",function(){if("reportlist"==b.action){var c=a(this).val();window.location=M.cfg.wwwroot+"/blocks/learnerscript/viewreport.php?id="+c}})}})},getQueryParameters:function getQueryParameters(a){return(a||document.location.search).replace(/(\?)/,"&").split("&").map(function(a){return a=a.split("="),this[a[0]]=a[1],this}.bind({}))[0]},DrilldownReport:function DrilldownReport(){var b=this;a("td a").click(function(c){var d=a(this).attr("href"),e=b.getQueryParameters(d);if(0>=d.indexOf("viewreport.php")||"download"in e){return}c.preventDefault();b.ReportModelFromLink({container:a(this),url:d})})},ReportModelFromLink:function ReportModelFromLink(c){var d=c.container.parents().closest("table").attr("id"),e=a("#"+d+"").width(),f=this.getQueryParameters(c.url),g=parseInt(f.id),h=a(this).data(),i={};if(0>=c.url.indexOf("viewreport.php")||"download"in f){return}a.each(f,function(a,b){if(0<=a.indexOf("filter")){i[a]=b}});if(0==a("#reportcontainer"+g).length||0==a("#plotreportcontainer"+g).length){a("body").append("<div id=\"reportcontainer"+g+"\" style=\"display:none;\"></div>");a("body").append("<div id=\"plotreportcontainer"+g+"\" class=\"dialogplot\" style=\"display:none;\"></div>");var j=b.call({args:{action:"disablecolumnstatus",reportid:g},url:M.cfg.wwwroot+"/blocks/learnerscript/ajax.php"});j.done(function(b){reportwidget.CreateDashboardwidget({reportid:g,reporttype:b,basicparams:JSON.stringify(i),ls_fstartdate:0,ls_fenddate:a.now()});chart.SparkLineReport();if("table"==b){dialogid="reportcontainer"}else{dialogid="plotreportcontainer"}var f=a("#"+dialogid+g+"").dialog({resizable:!0,autoOpen:!1,dialogClass:"drilldown"+g,width:e,title:"",appendTo:"#"+d,modal:!0,position:{my:"center",at:"top",of:"#"+d},open:function open(){a(this).closest(".ui-dialog").find(".ui-dialog-titlebar-close").removeClass("ui-dialog-titlebar-close").html("<span class='ui-button-icon-primary ui-icon ui-icon-closethick'></span>");var b=a(".ui-icon-closethick").parent();a(b).attr({title:"Close"});a(".drilldown"+g).append("<a href="+c.url+"><span class=\"reportdashboard_right\">View more</span></a>")},close:function close(){a(this).dialog("destroy").remove()}});f.dialog("open").prev(".ui-dialog-titlebar").css("color","#0C75B6")})}},PlotForm:function PlotForm(a){url=M.cfg.wwwroot+"/blocks/learnerscript/ajax.php";a.title=!a.title?"Plot Graph":a.title;c.init(a,url)},reportCalculations:function reportCalculations(c){d.get_string("calcs","block_learnerscript").then(function(){var d="<img class='dialog_title_icon' alt='Calculations' src='"+M.util.image_url("schedule_icon","block_learnerscript")+"'/>",e=a(".reportcalculation"+c.reportid).dialog({dialogClass:"calculationspopup",resizable:!1,autoOpen:!1,width:"50%",title:"Calculations",modal:!0,position:{my:"center",at:"center",of:window},open:function open(){a(".reportcalculation"+c.reportid).append("<img src=\""+M.util.image_url("loading","block_learnerscript")+"\" id=\"loadingimage\" />");a(document).ajaxStop(function(){a("#loadingimage").remove()});a(this).closest(".ui-dialog").find(".ui-dialog-titlebar-close").removeClass("ui-dialog-titlebar-close").html("<span class='ui-button-icon-primary ui-icon ui-icon-closethick'></span>");var b=a(".ui-icon-closethick").parent();a(b).attr({title:"Close"});a(this).closest(".ui-dialog").find(".ui-dialog-title").html("Calculations")}});c.filters=i.FilterData(c.reportid);c.filters.ls_fstartdate=a("#ls_fstartdate").val();c.filters.ls_fenddate=a("#ls_fenddate").val();if("undefined"==typeof c.filters.filter_courses){var f=a("#ls_courseid").val();if(1!=f){c.filters.filter_courses=f}}c.filters=JSON.stringify(c.filters);c.action="reportcalculations";c.basicparams=c.basicparams||JSON.stringify(i.BasicparamsData(c.reportid));var g=b.call({args:c,url:M.cfg.wwwroot+"/blocks/learnerscript/ajax.php"});g.done(function(b){a(".reportcalculation"+c.reportid).closest(".ui-dialog").find(".ui-dialog-title").html(b.reportname+" : Calculations");a(".reportcalculation"+c.reportid).html(b.table)}).fail(function(){});e.dialog("open")}.bind(this))},dropdown:function dropdown(b){a("#"+b).toggle()},notifications:function notifications(b,c){c=c||"success";a.notify({message:b},{type:c})},tabsdraggable:function tabsdraggable(){a(".ls-plotgraphs_list").sortable({cursor:"move",axis:"y",update:function update(){var c=a(".ls-plotgraphs_list").sortable("toArray",{attribute:"data-cid"}).toString(),d=b.call({args:{action:"tabsposition",reportid:a(".ls-plotgraphs_list").data("reportid"),component:"plot",elementsorder:c},url:M.cfg.wwwroot+"/blocks/learnerscript/ajax.php"})}})},rolesforcontext:function rolesforcontext(c,d){var e=b.call({args:{action:"contextroles",contextlevel:c,reportid:d},url:M.cfg.wwwroot+"/blocks/learnerscript/ajax.php"});e.done(function(b){var c="";a.each(b,function(a,b){c+="<option value = "+a+">"+b+"</option>"});a("#id_roleid").find("option").remove().end().append(c)})}}});
//# sourceMappingURL=helper.min.js.map
