{"version":3,"file":"cm-resource-selector.min.js","sources":["../src/cm-resource-selector.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Course resource module selector.\n *\n * @copyright  2018 Frédéric Massart\n * @author     Frédéric Massart <fred@branchup.tech>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/ajax', 'block_xp/throttler', 'block_xp/resource-selector'], function($, Ajax, Throttler, ResourceSelector) {\n    /**\n     * Course module resource selector.\n     *\n     * @param {String|jQuery} container The container of the contents.\n     * @param {jQuery} searchTermFieldNode The input field in which the use searches.\n     */\n    function CmResourceSelector(container, searchTermFieldNode) {\n        ResourceSelector.prototype.constructor.apply(this, [container, this.filterFunction.bind(this), searchTermFieldNode]);\n        this.resources = [];\n        this.courseId = null;\n        this.throttler = new Throttler(100);\n        this.setMinChars(0);\n    }\n\n    CmResourceSelector.prototype = Object.create(ResourceSelector.prototype);\n    CmResourceSelector.prototype.constructor = CmResourceSelector;\n\n    CmResourceSelector.prototype.initForCourse = function(courseId) {\n        if (this.courseId == courseId) {\n            // The course has not changed, display the contents right away.\n            this.displayResults(this.resources);\n            return;\n        }\n\n        this.displaySearching();\n        this.courseId = courseId;\n        this.fetchAllForCourse(courseId)\n            .then(\n                function(resources) {\n                    if (this.courseId != courseId) {\n                        // We switched course in the meantime, ignore.\n                        return;\n                    }\n                    this.resources = resources;\n                    this.displayResults(this.resources);\n                }.bind(this)\n            )\n            .fail(function() {\n                this.resources = [];\n                this.displayEmptyResults();\n            }.bind(this));\n    };\n\n    CmResourceSelector.prototype.fetchAllForCourse = function(courseId) {\n        var searchargs = {\n            courseid: courseId,\n            query: '*'\n        };\n\n        var calls = [\n            {\n                methodname: 'block_xp_search_modules',\n                args: searchargs\n            }\n        ];\n\n        return Ajax.call(calls)[0].then(function(results) {\n            return results.reduce(function(carry, section) {\n                return carry.concat(\n                    section.modules.map(function(cm) {\n                        return {\n                            _iscm: true,\n                            subname: section.name,\n                            name: cm.name,\n                            cm: cm\n                        };\n                    })\n                );\n            }, []);\n        });\n    };\n\n    CmResourceSelector.prototype.filterFunction = function(term) {\n        term = (term || '').toLowerCase();\n        if (!term) {\n            return this.resources;\n        }\n        return this.resources.filter(function(cm) {\n            return cm.name.toLowerCase().indexOf(term) > -1;\n        });\n    };\n\n    return CmResourceSelector;\n});\n"],"names":["define","$","Ajax","Throttler","ResourceSelector","CmResourceSelector","container","searchTermFieldNode","prototype","constructor","apply","this","filterFunction","bind","resources","courseId","throttler","setMinChars","Object","create","initForCourse","displaySearching","fetchAllForCourse","then","displayResults","fail","displayEmptyResults","calls","methodname","args","courseid","query","call","results","reduce","carry","section","concat","modules","map","cm","_iscm","subname","name","term","toLowerCase","filter","indexOf"],"mappings":";;;;;;;AAuBAA,uCAAO,CAAC,SAAU,YAAa,qBAAsB,+BAA+B,SAASC,EAAGC,KAAMC,UAAWC,2BAOpGC,mBAAmBC,UAAWC,qBACnCH,iBAAiBI,UAAUC,YAAYC,MAAMC,KAAM,CAACL,UAAWK,KAAKC,eAAeC,KAAKF,MAAOJ,2BAC1FO,UAAY,QACZC,SAAW,UACXC,UAAY,IAAIb,UAAU,UAC1Bc,YAAY,UAGrBZ,mBAAmBG,UAAYU,OAAOC,OAAOf,iBAAiBI,WAC9DH,mBAAmBG,UAAUC,YAAcJ,mBAE3CA,mBAAmBG,UAAUY,cAAgB,SAASL,UAC9CJ,KAAKI,UAAYA,eAMhBM,wBACAN,SAAWA,cACXO,kBAAkBP,UAClBQ,KACG,SAAST,WACDH,KAAKI,UAAYA,gBAIhBD,UAAYA,eACZU,eAAeb,KAAKG,aAC3BD,KAAKF,OAEVc,KAAK,gBACGX,UAAY,QACZY,uBACPb,KAAKF,aApBFa,eAAeb,KAAKG,YAuBjCT,mBAAmBG,UAAUc,kBAAoB,SAASP,cAMlDY,MAAQ,CACR,CACIC,WAAY,0BACZC,KARS,CACbC,SAAUf,SACVgB,MAAO,cAUJ7B,KAAK8B,KAAKL,OAAO,GAAGJ,MAAK,SAASU,gBAC9BA,QAAQC,QAAO,SAASC,MAAOC,gBAC3BD,MAAME,OACTD,QAAQE,QAAQC,KAAI,SAASC,UAClB,CACHC,OAAO,EACPC,QAASN,QAAQO,KACjBA,KAAMH,GAAGG,KACTH,GAAIA,UAIjB,QAIXnC,mBAAmBG,UAAUI,eAAiB,SAASgC,aACnDA,MAAQA,MAAQ,IAAIC,eAIblC,KAAKG,UAAUgC,QAAO,SAASN,WAC3BA,GAAGG,KAAKE,cAAcE,QAAQH,OAAS,KAHvCjC,KAAKG,WAObT"}