YUI.add("moodle-gradereport_grader-gradereporttable",function(e,t){function i(){i.superclass.constructor.apply(this,arguments)}function u(){}function d(){}function v(){}var n={FOOTERTITLE:"#user-grades .avg .header",FOOTERCELLS:"#user-grades .avg .cell",FOOTERROW:"#user-grades .avg",GRADECELL:"td.grade",GRADERTABLE:".gradeparent table",GRADEPARENT:".gradeparent",HEADERCELLS:"#user-grades .heading .cell",HEADERCELL:".gradebook-header-cell",HEADERROW:"#user-grades tr.heading",STUDENTHEADER:"#studentheader",USERCELL:"#user-grades .user.cell",USERMAIL:"#user-grades .useremail"},r={OVERRIDDEN:"overridden",TOOLTIPACTIVE:"tooltipactive"};e.extend(i,e.Base,{_eventHandles:[],graderTable:null,initializer:function(){this.graderRegion=e.one(n.GRADEPARENT),this.graderTable=e.one(n.GRADERTABLE),this.setupFloatingHeaders(),this.setupTooltips()},getGradeUserName:function(e){var t=e.ancestor("tr"),n=t.one("th.user .username");return n?n.get("text"):""},getGradeItemName:function(t){var n=e.one("th.item[data-itemid='"+t.getData("itemid")+"']");return n?n.get("text"):""},getGradeFeedback:function(e){return e.getData("feedback")}}),e.namespace("M.gradereport_grader").ReportTable=i,e.namespace("M.gradereport_grader").init=function(t){return new e.M.gradereport_grader.ReportTable(t)};var s="vmarked",o="hmarked";u.ATTRS={};var a=".user.cell, th.userreport, th.userfield",f="tr[data-itemid] th.item, .heading .cell";u.prototype={setupHighlighter:function(){return this._eventHandles.push(this.graderRegion.delegate("click",this._highlightUser,a,this),this.graderRegion.delegate("click",this._highlightColumn,f,this)),this},_highlightColumn:function(e){var t=e.target.getData("itemid");if(typeof t=="undefined")return;this.graderRegion.all('td.cell[data-itemid="'+t+'"]').toggleClass(s)},_highlightUser:function(e){var t=e.target.ancestor("[data-uid]",!0),n,r;t&&(r=t.getData("uid"));if(typeof r=="undefined")return;n=this.graderRegion.one('tr[data-uid="'+r+'"]'),n&&n.toggleClass(o)}},e.Base.mix(e.M.gradereport_grader.ReportTable,[u]);var l="height",c="width",h="offsetWidth",p="offsetHeight";r.FLOATING="floating",d.ATTRS={},d.prototype={pageHeaderHeight:0,container:null,headerCell:null,headerRow:null,firstUserCell:null,firstNonUserCell:null,firstNonUserCellLeft:0,tableFooterRow:null,footerRow:null,gradeItemHeadingContainer:null,userColumnHeader:null,userColumn:null,floatingFooterTitleRow:null,firstUserCellBottom:0,firstUserCellLeft:0,lastUserCellTop:0,_eventHandles:[],setupFloatingHeaders:function(){return this.firstUserCell=e.one(n.USERCELL),this.container=e.one(n.GRADEPARENT),this.firstNonUserCell=e.one(n.USERMAIL).next(),this.firstUserCell?(this._setupFloatingUserColumn(),this._setupFloatingUserHeader(),this._setupFloatingAssignmentHeaders(),this._setupFloatingAssignmentFooter(),this._setupFloatingAssignmentFooterTitle(),this._calculateCellPositions(),this._handleScrollEvent(),this._setupEventHandlers(),this):this},_calculateCellPositions:function(){this.headerRowTop=this.headerRow.getY(),this.tableFooterRow&&(this.footerRowPosition=this.tableFooterRow.getY());var t=e.all(n.USERCELL);this.firstUserCellLeft=this.firstUserCell.getX(),this.firstNonUserCellLeft=this.firstNonUserCell.getX();if(t.size()>1){var r=t.item(1);this.firstUserCellBottom=r.getY()+parseInt(r.getComputedStyle(l),10),this.lastUserCellTop=t.item(t.size()-2).getY()}else{var i=t.item(0);this.lastUserCellTop=i.getY(),this.tableFooterRow?this.firstUserCellBottom=this.footerRowPosition+parseInt(this.tableFooterRow.getComputedStyle(l),10):this.firstUserCellBottom=i.getY()+i.get("offsetHeight")}var s=e.one("header");this.pageHeaderHeight=0,s&&s.getComputedStyle("position")==="fixed"&&(this.pageHeaderHeight=s.get(p))},_getRelativeXY:function(e){return this._getRelativeXYFromXY(e.getX(),e.getY())},_getRelativeXYFromXY:function(e,t){var n=this.container.getXY();return[e-n[0],t-n[1]]},_getRelativeXFromX:function(e){return this._getRelativeXYFromXY(e,0)[0]},_getRelativeYFromY:function(e){return this._getRelativeXYFromXY(0,e)[1]},_getScrollBarHeight:function(){return e.UA.ie&&e.UA.ie>=10?0:e.config.doc.body.scrollWidth>e.config.doc.body.clientWidth?e.DOM.getScrollbarWidth():0},_setupEventHandlers:function(){this._eventHandles.push(e.one(e.config.win).on("scroll",this._handleScrollEvent,this),e.one(e.config.win).on("resize",this._handleResizeEvent,this),e.one(e.config.win).on("orientationchange",this._handleResizeEvent,this))},_setupFloatingUserColumn:function(){var t=e.all(n.USERCELL),r=e.Node.create('<div aria-hidden="true" role="presentation" class="floater"></div>'),i=this._getRelativeXY(this.firstUserCell);t.each(function(t){var n=e.Node.create("<div></div>");n.set("innerHTML",t.get("innerHTML")).setAttribute("class",t.getAttribute("class")).setAttribute("data-uid",t.ancestor("tr").getData("uid")).setStyles({height:t.getComputedStyle(l),width:t.getComputedStyle(c)}),r.appendChild(n)},this),r.setStyles({left:i[0]+"px",position:"absolute",top:i[1]+"px"}),this.graderRegion.append(r),this.userColumn=r},_setupFloatingUserHeader:function(){this.headerRow=e.one(n.HEADERROW),this.headerCell=e.one(n.STUDENTHEADER);var t=e.Node.create('<div aria-hidden="true" role="presentation" class="floater heading"></div>'),r=e.Node.create("<div></div>"),i=this._getRelativeXY(this.headerCell)[0],s=this._getRelativeXY(this.headerRow),o=s[0];r.set("innerHTML",this.headerCell.getHTML()).setAttribute("class",this.headerCell.getAttribute("class")).setStyles({width:this.firstUserCell.getComputedStyle(c),left:i-o+"px"}),t.setStyles({left:s[0]+"px",position:"absolute",top:s[1]+"px"}),t.append(r),this.graderRegion.append(t),this.userColumnHeader=t},_setupFloatingAssignmentHeaders:function(){this.headerRow=e.one("#user-grades tr.heading");var t=e.all("#user-grades tr.heading .cell"),n=e.Node.create('<div aria-hidden="true" role="presentation" class="floater heading"></div>'),r=this._getRelativeXY(this.headerRow),i=0,s=0,o=r[0];t.each(function(t){var r=this._getRelativeXY(t)[0],u=e.Node.create("<div></div>"
);u.append(t.getHTML()).setAttribute("class",t.getAttribute("class")).setData("itemid",t.getData("itemid")).setStyles({height:t.getComputedStyle(l),left:r-o+"px",position:"absolute",width:t.getComputedStyle(c)}),i+=parseInt(t.get(h),10),s=t.get(p),n.appendChild(u)},this),n.setStyles({height:s+"px",left:r[0]+"px",position:"absolute",top:r[1]+"px",width:i+"px"}),this.userColumnHeader.insert(n,"before"),this.gradeItemHeadingContainer=n},_setupFloatingAssignmentFooter:function(){this.tableFooterRow=e.one("#user-grades .avg");if(!this.tableFooterRow)return;var t=this.tableFooterRow.all(".cell"),n=e.Node.create('<div aria-hidden="true" role="presentation" class="floater avg"></div>'),r=0,i=this._getRelativeXY(this.tableFooterRow),s=i[0],o=0;t.each(function(t){var i=e.Node.create("<div></div>"),u=this._getRelativeXY(t)[0];i.set("innerHTML",t.getHTML()).setAttribute("class",t.getAttribute("class")).setStyles({height:t.getComputedStyle(l),left:u-s+"px",position:"absolute",width:t.getComputedStyle(c)}),n.append(i),o=t.get(p),r+=parseInt(t.get(h),10)},this),n.setStyles({position:"absolute",left:i[0]+"px",bottom:"1px",height:o+"px",width:r+"px"}),this.graderRegion.append(n),this.footerRow=n},_setupFloatingAssignmentFooterTitle:function(){this.footerCell=e.one(n.FOOTERTITLE);var t=e.Node.create('<div aria-hidden="true" role="presentation" class="floater avg"></div>'),r=e.Node.create("<div></div>"),i=this._getRelativeXY(this.headerRow),s=this.firstUserCell.getComputedStyle(c),o=this.footerCell.get(p);r.set("innerHTML",this.footerCell.getHTML()).setAttribute("class",this.footerCell.getAttribute("class")).setStyles({width:s}),t.setStyles({position:"absolute",left:i[0]+"px",bottom:"1px",height:o+"px",width:s}),t.append(r),this.graderRegion.append(t),this.floatingFooterTitleRow=t},_handleScrollEvent:function(){var t={},n={},i={},s={},o={},u=0,a=0,f=0,c=0,p=!1,d=!1,v=!1,m=!1;t.left=this._getRelativeXFromX(this.headerRow.getX()),e.config.win.pageYOffset+this.pageHeaderHeight>this.headerRowTop?(p=!0,e.config.win.pageYOffset+this.pageHeaderHeight<this.lastUserCellTop?(u=this._getRelativeYFromY(e.config.win.pageYOffset+this.pageHeaderHeight),t.top=u+"px",n.top=u+"px"):(u=this._getRelativeYFromY(this.lastUserCellTop),t.top=u+"px",n.top=u+"px")):(p=!1,u=this._getRelativeYFromY(this.headerRowTop),t.top=u+"px",n.top=u+"px"),a=this.firstUserCell.get(h),right_to_left()?(f=e.config.win.innerWidth+e.config.win.pageXOffset,c=f-a,d=f<this.firstUserCellLeft+a,m=f<this.firstNonUserCellLeft+a):(f=e.config.win.pageXOffset,c=f,d=f>this.firstUserCellLeft,m=f>this.firstNonUserCellLeft-a),d?(u=this._getRelativeXFromX(c),i.left=u+"px",n.left=u+"px",o.left=i.left):(u=this._getRelativeXFromX(this.firstUserCellLeft),i.left=u+"px",n.left=u+"px");if(this.footerRow){s.left=this._getRelativeXFromX(this.headerRow.getX());var g=e.config.win.innerHeight,y=e.config.win.pageYOffset,b=g-this._getScrollBarHeight()+y,w=parseInt(this.footerRow.getComputedStyle(l),10),E=w+this.footerRowPosition;b<E&&b>this.firstUserCellBottom?(s.bottom=o.bottom=Math.ceil(E-b)+"px",v=!0):(s.bottom="1px",v=!1,o.bottom="1px")}this.gradeItemHeadingContainer.setStyles(t),this.userColumnHeader.setStyles(n),this.userColumn.setStyles(i),this.footerRow.setStyles(s),this.floatingFooterTitleRow.setStyles(o),p?this.gradeItemHeadingContainer.addClass(r.FLOATING):this.gradeItemHeadingContainer.removeClass(r.FLOATING),d?(this.userColumnHeader.addClass(r.FLOATING),this.userColumn.addClass(r.FLOATING)):(this.userColumnHeader.removeClass(r.FLOATING),this.userColumn.removeClass(r.FLOATING)),v?this.footerRow.addClass(r.FLOATING):this.footerRow.removeClass(r.FLOATING),this.footerRow&&m?this.floatingFooterTitleRow.addClass(r.FLOATING):this.floatingFooterTitleRow.removeClass(r.FLOATING)},_handleResizeEvent:function(){this._calculateCellPositions(),this._handleScrollEvent();var t=this.firstUserCell.getComputedStyle(c),r=e.all(n.USERCELL);this.userColumnHeader.one(".cell").setStyle("width",t),this.userColumn.all(".cell").each(function(e,n){e.setStyles({width:t,height:r.item(n).getComputedStyle(l)})},this);var i=this.gradeItemHeadingContainer.all(".cell"),s=e.all(n.HEADERCELLS),o=this.headerRow.getX(),u=0;s.each(function(e,t){var n=i.item(t);u+=e.get(h);var r={width:e.getComputedStyle(c),left:e.getX()-o+"px"};n.setStyles(r)});if(this.footerRow){var a=this.footerRow.all(".cell");if(a.size()!==0){var f=e.all(n.FOOTERCELLS);f.each(function(e,t){var n=a.item(t),r={width:e.getComputedStyle(c),left:e.getX()-o+"px"};n.setStyles(r)}),this.floatingFooterTitleRow.one("div").setStyle("width",t)}}this.gradeItemHeadingContainer.setStyle("width",u)}},e.Base.mix(e.M.gradereport_grader.ReportTable,[d]),v.ATTRS={};var m='<div class="graderreportoverlay {{overridden}}" role="tooltip" aria-describedby="{{id}}"><div class="fullname">{{username}}</div><div class="itemname">{{itemname}}</div>{{#if feedback}}<div class="feedback">{{feedback}}</div>{{/if}}</div>';v.prototype={_tooltip:null,_tooltipBoundingBox:null,_tooltipTemplate:null,setupTooltips:function(){return this._eventHandles.push(this.graderTable.delegate("hover",this._showTooltip,this._hideTooltip,n.GRADECELL,this),this.graderTable.delegate("click",this._toggleTooltip,n.GRADECELL,this)),this},_getTooltip:function(){return this._tooltip||(this._tooltip=new e.Overlay({visible:!1,render:e.one(n.GRADEPARENT)}),this._tooltipBoundingBox=this._tooltip.get("boundingBox"),this._tooltipTemplate=e.Handlebars.compile(m),this._tooltipBoundingBox.addClass("grader-information-tooltip")),this._tooltip},_showTooltip:function(e){var t=e.currentTarget,n=this._getTooltip();n.set("bodyContent",this._tooltipTemplate({cellid:t.get("id"),username:this.getGradeUserName(t),itemname:this.getGradeItemName(t),feedback:this.getGradeFeedback(t),overridden:t.hasClass(r.OVERRIDDEN)?r.OVERRIDDEN:""})).set("xy",[t.getX()+t.get("offsetWidth")/2,t.getY()+t.get("offsetHeight")/2]).show(),e.currentTarget.addClass(r.TOOLTIPACTIVE)},_hideTooltip:function(e){if(e.relatedTarget&&this._tooltipBoundingBox&&
this._tooltipBoundingBox.contains(e.relatedTarget))return;this._tooltip&&(e.currentTarget.removeClass(r.TOOLTIPACTIVE),this._tooltip.hide())},_toggleTooltip:function(e){e.currentTarget.hasClass(r.TOOLTIPACTIVE)?this._hideTooltip(e):this._showTooltip(e)}},e.Base.mix(e.M.gradereport_grader.ReportTable,[v])},"@VERSION@",{requires:["base","node","event","handlebars","overlay","event-hover"]});
