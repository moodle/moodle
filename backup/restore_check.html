<?php //$Id$
    //This page receive all the restore_form data. Then, if existing course
    //has been selected, shows a list of courses to select one.
    //It cheks that the parammeter from restore_form are coherent.
    //It puts all the restore info in the session.
    //Finally, it calls restore_execute to do the hard work
    //Get objects from session
    if ($SESSION) {
        $info = $SESSION->info;
        $course_header = $SESSION->course_header;
        if (isset($SESSION->restore)) {
            $restore = $SESSION->restore;
        }
    }

    //Detect if we are coming from the restore form
    $fromform = optional_param ('fromform', 0, PARAM_INT);

    if ($form1 = data_submitted()) {
        $currentcourseshortname = $course_header->course_shortname; //"store_ShortName";
        $course_header->course_shortname =  stripslashes_safe($form1->shortname);  //"update_ShortName";    
        $course_header->course_fullname =   stripslashes_safe($form1->fullname);   //"update_FullName";  
    /// Roll dates only if the backup course has a start date
    /// (some formats like main page, social..., haven't it and rolling dates
    /// from 0 produces crazy dates. MDL-10125
        if ($course_header->course_startdate) {
            $form1->startdate = make_timestamp($form1->startyear, $form1->startmonth, $form1->startday);
            $currentcoursestartdate = $course_header->course_startdate;
            $coursestartdatedateoffset = $form1->startdate - $currentcoursestartdate;
            $restore->course_startdateoffset = $coursestartdatedateoffset; //change to restore
        } else { // don't roll if the course hasn't start date
            $coursestartdatedateoffset = 0;
            $restore->course_startdateoffset = 0;
        }
    }

    ///Enforce SESSION->course_header rewrite (PHP 4.x needed because assigns are by value) MDL-8298
    $SESSION->course_header = $course_header;

    //If restore session info exists, but we are coming from the form
    //it has prioriry
    if (isset($restore) and !empty($fromform)) {
        unset($restore);
    }

    // check for session objects
    if (empty($info) or empty($course_header)) {
      error( 'important information missing from SESSION' );
    }

    //If the restore object doesn't exist, we are going
    //to check every variable individually and create it

    if (!isset($restore)) {
        //Check that we have all we need
        //backup_unique_code
        $backup_unique_code = required_param( 'backup_unique_code' );
        //file
        $file = required_param( 'file');
        //Checks for the required restoremod parameters
        if ($allmods = get_records("modules")) {
            foreach ($allmods as $mod) {
                $modname = $mod->name;
                $var = "restore_".$modname;
                $$var = optional_param( $var,0); 
                $var = "restore_user_info_".$modname;
                $$var = optional_param( $var,0);
                $instances = !empty($info->mods[$mod->name]->instances) ? $info->mods[$mod->name]->instances : NULL;
                if ($instances === NULL) {
                    continue;
                }
                foreach ($instances as $instance) {
                    $var = 'restore_'.$modname.'_instance_'.$instance->id;
                    $$var = optional_param($var,0);
                    $var = 'restore_user_info_'.$modname.'_instance_'.$instance->id;
                    $$var = optional_param($var,0);
                }
            }
        }
        //restoreto
        $restore_restoreto = required_param('restore_restoreto');
        //restore_metacourse
        $restore_metacourse = required_param('restore_metacourse');
        //restore_users
        $restore_users = required_param('restore_users');
        //restore_logs
        $restore_logs = required_param('restore_logs');
        //restore_user_files
        $restore_user_files = required_param('restore_user_files');
        //restore_course_files
        $restore_course_files = required_param('restore_course_files');
        //restore_messages
        $restore_messages = required_param('restore_messages');

        //Check we've selected a course to restore to
        $course_id = optional_param('course_id', 0, PARAM_INT);
 
        //We are here, having all we need !!
        //Create the restore object and put it in the session
        $restore->backup_unique_code = $backup_unique_code;
        $restore->file = $file;
        if ($allmods = get_records("modules")) {
            foreach ($allmods as $mod) {
                $modname = $mod->name;
                $var = "restore_".$modname;
                $restore->mods[$modname]->restore=$$var;
                $var = "restore_user_info_".$modname;
                $restore->mods[$modname]->userinfo=$$var;
                $instances = !empty($info->mods[$mod->name]->instances) ? $info->mods[$mod->name]->instances : NULL;
                if ($instances === NULL) {
                    continue;
                }
                foreach ($instances as $instance) {
                    $var = 'restore_'.$modname.'_instance_'.$instance->id;
                    $restore->mods[$modname]->instances[$instance->id]->restore = $$var;
                    $var = 'restore_user_info_'.$modname.'_instance_'.$instance->id;
                    $restore->mods[$modname]->instances[$instance->id]->userinfo = $$var;
                }
            }
        }
        $restore->restoreto=$restore_restoreto;
        $restore->metacourse=$restore_metacourse;
        $restore->users=$restore_users;
        $restore->logs=$restore_logs;
        $restore->user_files=$restore_user_files;
        $restore->course_files=$restore_course_files;
        $restore->messages=$restore_messages;
        $restore->course_id=$course_id;
        //add new vars to restore object 
        $restore->course_startdateoffset = $coursestartdatedateoffset;
        $restore->course_shortname = $currentcourseshortname;
   
        // create role mappings, not sure all should be here
        if ($data2 = data_submitted()) {
            foreach ($data2 as $tempname=>$tempdata) {
                if (strstr($tempname, 'roles_')) {
                    $temprole = explode('_', $tempname);
                    $oldroleid = $temprole[1];
                    $newroleid = $tempdata;
                    $restore->rolesmapping[$oldroleid] = $newroleid;
                }                     
            }       
        }
        
        // default role mapping for moodle < 1.7
        if ($defaultteacheredit = optional_param('defaultteacheredit', 0, PARAM_INT)) {
            $restore->rolesmapping['defaultteacheredit'] = $defaultteacheredit; 
        }
        if ($defaultteacher = optional_param('defaultteacher', 0, PARAM_INT)) {
            $restore->rolesmapping['defaultteacher'] = $defaultteacher; 
        }
        if ($defaultstudent = optional_param('defaultstudent', 0, PARAM_INT)) {
            $restore->rolesmapping['defaultstudent'] = $defaultstudent; 
        }
                
    } else {
        //We have the object, so check if we have a new course_id
        //passed as parammeter
        $course_id = optional_param('course_id', 0, PARAM_INT);
        if ($course_id) {
            $restore->course_id=$course_id;
        }
    } 
    
    // pass in the course category param
    $cat_id = optional_param('restore_restorecatto', 0, PARAM_INT);
    if ($cat_id) {
        $restore->restore_restorecatto = $cat_id;
    }
    
    //We have the object with data, put it in the session
    $SESSION->restore = $restore;

    //From here to the end of the script, only use the $restore object

    //Check login
    require_login();

    //Check admin
    if (!empty($id)) {
        if (!has_capability('moodle/site:restore', get_context_instance(CONTEXT_COURSE, $id))) {
            error("You need to be a teacher or admin user to use this page.", "$CFG->wwwroot/login/index.php");
        }
    } else {
        if (!has_capability('moodle/site:restore', get_context_instance(CONTEXT_SYSTEM, SITEID))) {
            error("You need to be an admin user to use this page.", "$CFG->wwwroot/login/index.php");
        }
    }

    //Check site
    if (!$site = get_site()) {
        error("Site not found!");
    }
 
    //Depending the selected restoreto:
    // If user is a teacher (and not creator):
    //    0-Current course, deleting: Put $restore->course_id and $restore->deleting (true), create the restore object
    //    1-Current course, adding: Put $restore->course_id and $restore->deleting (false), create the restore object
    // If the uses is a creator:
    //    0-Existing course, deleting: Select the destination course and launch the check again, then
    //        put $restore->course_id and $restore->deleting (true), create the restore object.
    //    1-Existing course, adding: Select the destination course and launch the check again, then
    //        put $restore->course_id and $restore->deleting (false), create the restore object.
    //    2-New course: Create the restore object and launch the execute.

    //If the user is a teacher and not a creator
    if (!user_can_create_courses()) {
        $restore->course_id = $id;
        if ($restore->restoreto == 0) {
            $restore->deleting = true;
        } else {
            $restore->deleting = false;
        }
    }

    //If the user is a creator (or admin)
    //if (has_capability('moodle/course:create', get_context_instance(CONTEXT_SYSTEM, SITEID))) {
    if (user_can_create_courses()) {    
        //Set restore->deleting as needed
        if ($restore->restoreto == 0) {
            $restore->deleting = true;
        } else {
            $restore->deleting = false;
        }
    }

    //Now, select the course if needed
    //if (($restore->restoreto == 0 or $restore->restoreto == 1) and ($restore->course_id == 0) and get_capability_courses('moodle/site:restore')) {
    if (($restore->restoreto == 0 or $restore->restoreto == 1) and ($restore->course_id == 0)) {
        if ($courses = get_courses("all","c.fullname","c.id,c.fullname,c.shortname,c.visible")) {
            print_heading(get_string("choosecourse"));
            print_simple_box_start("center");
            foreach ($courses as $course) {
                if (!has_capability('moodle/site:restore', get_context_instance(CONTEXT_COURSE, $course->id))) {
                    continue;
                }
                if (empty($course->visible)) {
                    $optdimmed = ' class="dimmed" ';
                } else {
                    $optdimmed = '';
                }
                echo "<a $optdimmed href=\"restore.php?course_id=$course->id&launch=check&id=$id&file=$file\">".format_string($course->fullname).' ('.format_string($course->shortname).')</a><br />'."\n";
            }
            print_simple_box_end();
        } else {
            print_heading(get_string("nocoursesyet"));
            print_continue("$CFG->wwwroot/$CFG->admin/index.php");
        }
    //Checks everything and execute restore
    } else if ((($restore->restoreto == 0 or $restore->restoreto == 1) and ($restore->course_id != 0)) or ($restore->restoreto == 2)) {
        //Final access control check
        if ($restore->course_id == 0 and !user_can_create_courses()) {
            error("You need to be a creator or admin to restore into new course!");
        } else if ($restore->course_id != 0 and !has_capability('moodle/site:backup', get_context_instance(CONTEXT_COURSE, $restore->course_id))) {
            error("You need to be an edit teacher or admin to restore into selected course!");
        }
        $show_continue_button = true;
        //Check if we've selected any mod's user info and restore->users 
        //is set to none. Change it to course and inform.
        if ($restore->users == 2) {
            $changed = false;
            $mods = $restore->mods;
            foreach ($mods as $mod) {
                if ($mod->userinfo) {
                    $changed = true;
                }
            }
            //If we have selected user files or messages, then users must be restored too
            if ($restore->user_files || $restore->messages) {
                $changed = 1;
            }
            if ($changed) {
                echo get_string ("noteuserschangednonetocourse");
                echo "<hr noshade size=\"1\">";
                $restore->users = 1;
            }
        }
        //Save the restore session object
        $SESSION->restore = $restore;
        if ($show_continue_button) {
            //Print the continue button to execute the restore NOW !!!!
            //All is prepared !!!
            echo "<div style='text-align:center'>";
            $hidden["launch"]             = "execute";
            $hidden["file"]               =  $file;
            $hidden["id"]                 =  $id;
            print_string('longtimewarning','admin');

            if ($restore->users && !empty($info->mnet_externalusers) 
                && $info->mnet_externalusers === 'true') {
                if ($info->original_wwwroot === $CFG->wwwroot) {
                    print '<p>'.get_string('mnetrestore_extusers','admin').'</p>';
                } else {
                    print '<p>'. get_string('mnetrestore_extusers_mismatch','admin').'</p>';
                }
            }
            print_single_button("restore.php", $hidden, get_string("restorecoursenow"),"post");
            echo "</div>";
        } else {
            //Show error
            error ("Something was wrong checking restore preferences");
        } 

    //If we are here. Something must be wrong. Debug !!!
    } else {
        print_object($restore);
        print_object($info);
        print_object($course_header);
        error ("Something must be wrong");
    }

?>
