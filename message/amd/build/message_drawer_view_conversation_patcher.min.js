define(["jquery","core/user_date","core_message/message_drawer_view_conversation_constants"],function(a,b,c){var d=function(a,c){var d=a.reduce(function(a,d){var e=d.timeCreated?d.timeCreated:c,f=b.getUserMidnightForTimestamp(e,c);return a.hasOwnProperty(f)?a[f].push(d):a[f]=[d],a},{});return Object.keys(d).map(function(a){return{timestamp:a,messages:d[a]}})},e=function(a,b,c){b=b.slice();var d=[],e=[],f=[];return a.forEach(function(a){for(var d=!1,g=0;g<b.length;g++){var h=b[g];if(c(a,h)){d=!0,f.push({a:a,b:h});break}}d?b.splice(g,1):e.push(a)}),d=b,{missingFromA:d,missingFromB:e,matches:f}},f=function(a,b){for(var c=null,d=0;d<a.length;d++){var e=a[d];if(b(e))return e}return c},g=function(a,b){a=a.slice(),b=b.slice(),a.sort(),b.sort();var c=a.length,d=b.length;return c<1&&d<1||c==d&&a.every(function(a,c){return a==b[c]})},h=function(a,b){var c=Object.keys(a),d=Object.keys(b);return c.length==d.length&&c.every(function(c){var d=a[c],e=b[c],f=typeof d,i=typeof e;if(f=null===d?"null":f,i=null===d?"null":i,f="object"===f&&Array.isArray(f)?"array":f,i="object"===i&&Array.isArray(i)?"array":i,f!==i)return!1;switch(f){case"object":return h(d,e);case"array":return g(d,e);default:return a[c]==b[c]}})},i=function(a,b){return h({id:a.id,state:a.sendState,text:a.text,timeCreated:a.timeCreated},{id:b.id,state:b.sendState,text:b.text,timeCreated:b.timeCreated})},j=function(a,b,c){return{remove:b,add:c.map(function(b){var c=f(a,function(a){return b.timestamp<a.timestamp});return{before:c,value:b}})}},k=function(a){var b=[],c=[],d=[];return a.forEach(function(a){var g=a.a,h=a.b,j=e(g.messages,h.messages,i),k=e(j.missingFromB,j.missingFromA,function(a,b){return a.id==b.id||a.sendState!=b.sendState&&a.timeAdded==b.timeAdded});b=b.concat(k.missingFromB),k.missingFromA.forEach(function(a){var b=null;a.timeCreated&&(b=f(g.messages,function(b){return a.timeCreated==b.timeCreated?a.id<b.id:a.timeCreated<b.timeCreated})),c.push({before:b,value:a,day:g})}),d=d.concat(k.matches.map(function(a){return{before:a.a,after:a.b}}))}),{add:c,remove:b,update:d}},l=function(a,b){var c=e(a.messages,b.messages,i);if(c.missingFromA.length||c.missingFromB.length){var f=d(a.messages,a.midnight),g=d(b.messages,b.midnight),h=e(f,g,function(a,b){return a.timestamp==b.timestamp});return{days:j(f,h.missingFromB,h.missingFromA),messages:k(h.matches)}}return null},m=function(a,b){var d=J(a,b),e=z(a,b),f=H(a),g=H(b),h=d&&d.show&&!d.hasMessages,i=d&&!d.show,j=!f&&g;return j=j||h||i,j=j||null!==e,j?{type:c.CONVERSATION_TYPES.PRIVATE,showControls:!h&&!e,context:{id:b.id,name:b.name,subname:b.subname,totalmembercount:b.totalMemberCount,imageurl:b.imageUrl,isfavourite:b.isFavourite,ismuted:b.isMuted,showfavourite:null!==b.id,userid:g.id,showonlinestatus:g.showonlinestatus,isonline:g.isonline,isblocked:g.isblocked,iscontact:g.iscontact}}:null},n=function(a,b){var d=null===a.name&&null!==b.name;return d?{type:c.CONVERSATION_TYPES.SELF,showControls:!1,context:{id:b.id,name:b.name,subname:b.subname,imageurl:b.imageUrl,isfavourite:b.isFavourite,showfavourite:null!==b.id,showonlinestatus:!0}}:null},o=function(a,b){var d=a.totalMemberCount,e=b.totalMemberCount;return d!=e?{type:c.CONVERSATION_TYPES.PUBLIC,showControls:!0,context:{id:b.id,name:b.name,subname:b.subname,totalmembercount:b.totalMemberCount,imageurl:b.imageUrl,isfavourite:b.isFavourite,ismuted:b.isMuted,showfavourite:null!==b.id}}:null},p=function(a,b){var c=a.messages,d=b.messages;if(d.length<1)return null;if(c.length<1)return d[d.length-1].id;var e=c[a.messages.length-1],f=d[d.length-1],g=c[0],h=d[0];return e.id!=f.id?f.id:g.id!=h.id?g.id:null},q=function(a,b){return!(a.loadingMembers||!b.loadingMembers)||!(a.loadingMembers&&!b.loadingMembers)&&null},r=function(a,b){return a.hasTriedToLoadMessages===b.hasTriedToLoadMessages?null:!(b.hasTriedToLoadMessages||!b.loadingMessages)||!(b.hasTriedToLoadMessages&&!b.loadingMessages)&&null},s=function(a,b){return!(a.loadingMessages||!b.loadingMessages)||!(a.loadingMessages&&!b.loadingMessages)&&null},t=function(a,b){if(b.pendingBlockUserIds.length){var c=b.pendingBlockUserIds[0];return b.members[c]}return!a.pendingBlockUserIds.length&&null},u=function(a,b){if(b.pendingUnblockUserIds.length){var c=b.pendingUnblockUserIds[0];return b.members[c]}return!a.pendingUnblockUserIds.length&&null},v=function(a,b){if(b.pendingAddContactIds.length){var c=b.pendingAddContactIds[0];return b.members[c]}return!a.pendingAddContactIds.length&&null},w=function(a,b){if(b.pendingRemoveContactIds.length){var c=b.pendingRemoveContactIds[0];return b.members[c]}return!a.pendingRemoveContactIds.length&&null},x=function(a,b){var c=a.pendingDeleteMessageIds.length,d=b.pendingDeleteMessageIds.length;return d&&!c?{show:!0,type:b.type,canDeleteMessagesForAllUsers:b.canDeleteMessagesForAllUsers}:c&&!d?{show:!1}:null},y=function(a,b){return!a.pendingDeleteConversation&&b.pendingDeleteConversation?b.type:!(a.pendingDeleteConversation&&!b.pendingDeleteConversation)&&null},z=function(a,b){var c=a.loggedInUserId,d=H(a),e=H(b),f=d?d.contactrequests.filter(function(a){return a.requesteduserid==c&&a.userid==d.id}):[],g=e?e.contactrequests.filter(function(a){return a.requesteduserid==c&&a.userid==e.id}):[],h=f.length?f[0]:null,i=g.length?g[0]:null;return!h&&i?e:!(h&&!i)&&null},A=function(a,b){var c=H(a),d=H(b);return c||d?!c&&d?!!d.isblocked||null:!d&&c?!c.isblocked&&null:!(c.isblocked&&!d.isblocked)&&(!(c.isblocked||!d.isblocked)||null):null},B=function(a,b){var c=a.isFavourite,d=b.isFavourite;return null===a.id&&null===b.id?null:null===a.id&&null!==b.id?"show-add":null!==a.id&&null===b.id?"hide":c==d?null:!c&&d?"show-remove":c&&!d?"show-add":null},C=function(a,b){var c=a.isMuted,d=b.isMuted;return null===a.id&&null===b.id?null:null===a.id&&null!==b.id?"show-mute":null!==a.id&&null===b.id?"hide":c==d?null:!c&&d?"show-unmute":c&&!d?"show-mute":null},D=function(a,b){var c=a.loggedInUserId,d=H(a),e=H(b),f=d?d.contactrequests.filter(function(a){return a.userid==c&&a.requesteduserid==d.id||a.userid==d.id&&a.requesteduserid==c}):[],g=e?e.contactrequests.filter(function(a){return a.userid==c&&a.requesteduserid==e.id||a.userid==e.id&&a.requesteduserid==c}):[],h=f.length>0,i=g.length>0;return d||e?h&&i?null:h||!i||e.iscontact?!d&&e?e.iscontact?"contact":null:!e&&d?d.iscontact?"non-contact":null:d.iscontact&&!e.iscontact?i?"pending-contact":"non-contact":!d.iscontact&&e.iscontact?"contact":null:"pending-contact":null},E=function(a,b){return!(a.loadingConfirmAction||!b.loadingConfirmAction)||!(a.loadingConfirmAction&&!b.loadingConfirmAction)&&null},F=function(a,b){var c=a.selectedMessageIds.length>0,d=b.selectedMessageIds.length>0,e=a.messages.length!=b.messages.length;return!(c||!d)||!(c&&!d)&&(!(!c||!e)||null)},G=function(a,b){var c=a.selectedMessageIds,d=b.selectedMessageIds;if(g(c,d))return null;var f=e(c,d,function(a,b){return a==b});return{count:d.length,add:f.missingFromA,remove:f.missingFromB}},H=function(a){return Object.keys(a.members).reduce(function(b,c){return c==a.loggedInUserId||b||(b=a.members[c]),b},null)},I=function(a,b){if(b.canmessage)return!1;var c=b.contactrequests.filter(function(b){return b.userid==a||b.requesteduserid}),d=c.length>0;return b.requirescontact&&!b.iscontact&&!d},J=function(a,b){var c=H(a),d=H(b),e=a.messages.length>0,f=b.messages.length>0,g=b.loggedInUserId,h=c&&I(g,c),i=d&&I(g,d),j=v(a,b),k=j===!1;if(!a.hasTriedToLoadMessages&&!b.hasTriedToLoadMessages)return null;if(!c&&!d)return null;if(!c&&i)return{show:!0,hasMessages:f,user:d};if(k&&i)return{show:!0,hasMessages:f,user:d};if(a.hasTriedToLoadMessages&&b.hasTriedToLoadMessages){if(!h&&i)return{show:!0,hasMessages:f,user:d};if(h&&!i)return{show:!1,hasMessages:f}}return!a.hasTriedToLoadMessages&&b.hasTriedToLoadMessages&&i?{show:!0,hasMessages:f,user:d}:a.hasTriedToLoadMessages&&!b.hasTriedToLoadMessages&&h?{show:!1,hasMessages:e}:null},K=function(a,b){var c=H(a),d=H(b);return c||d?c&&!d?!c.isblocked&&null:!c&&d?!!d.isblocked||null:!(c.isblocked||!d.isblocked)||!(c.isblocked&&!d.isblocked)&&null:null},L=function(a,b){var d=H(a),e=H(b);return b.type==c.CONVERSATION_TYPES.SELF?null:d||e?d&&!e?!d.canmessage||null:!d&&e?!e.canmessage||null:!(!d.canmessage&&e.canmessage)&&(!(!d.canmessage||e.canmessage)||null):null},M=function(a,b){var c=r(a,b),d=F(a,b),e=J(a,b),f=K(a,b),g=L(a,b),h=null!==e?e.show&&e.hasMessages:null,i=H(b),j=function(a,c){if(a)return c;if(null!==a&&!a){if(!i)return{type:"content"};if(i.isblocked)return{type:"unblock"};if(b.messages.length&&I(b.loggedInUserId,i))return{type:"add-contact",user:i};if(!i.canmessage&&i.requirescontact&&!i.iscontact)return{type:"unable-to-message"}}return null};if(null===c&&null===d&&null===e&&null===f)return null;for(var k=[[c,{type:"placeholder"}],[d,{type:"edit-mode"}],[g,{type:"unable-to-message"}],[f,{type:"unblock"}],[h,{type:"add-contact",user:i}]],l=0;l<k.length;l++){var m=k[l][0],n=k[l][1],o=j(m,n);if(null!==o)return o}return{type:"content"}},N=function(a,b){var c=r(a,b),d=F(a,b);return null===c&&null===d?null:c?{type:"placeholder"}:d?{type:"edit-mode"}:{type:"content"}},O=function(a,b){var c=a.type,d=b.type,e=a.id,f=b.id,g=Object.keys(a.members),h=Object.keys(b.members);g.sort(),h.sort();var i=g.every(function(a,b){return a==h[b]});return c!=d||(!(!e||f)||(!(!e||!f||e==f)||(!(e||f||i)||null)))},P=function(a,b){return a.type!=b.type?b.type==c.CONVERSATION_TYPES.SELF:null},Q=function(a,b){var c=b.loggedInUserId,d=H(a),e=H(b),f=d?d.contactrequests.filter(function(a){return a.userid==c}):[],g=e?e.contactrequests.filter(function(a){return a.userid==c}):[],h=f.length>0,i=g.length>0,j=a.messages.length>0,k=a.messages.length>0;return h||!i||e.iscontact||k?!(d&&!d.iscontact&&i&&e.iscontact)&&(!(h&&!i)&&(!(!j&&k)&&null)):e.fullname},R=function(b,d){var e={all:{reset:O,conversation:l,scrollToMessage:p,loadingMembers:q,loadingFirstMessages:r,loadingMessages:s,confirmDeleteSelectedMessages:x,inEditMode:F,selectedMessages:G,isFavourite:B,isMuted:C}};e[c.CONVERSATION_TYPES.PRIVATE]={header:m,footer:M,confirmBlockUser:t,confirmUnblockUser:u,confirmAddContact:v,confirmRemoveContact:w,confirmContactRequest:z,confirmDeleteConversation:y,isBlocked:A,isContact:D,loadingConfirmAction:E,requireAddContact:J,contactRequestSent:Q},e[c.CONVERSATION_TYPES.PUBLIC]={header:o,footer:N},e[c.CONVERSATION_TYPES.SELF]={header:n,footer:N,confirmDeleteConversation:y,selfConversationMessage:P};var f=a.extend({},e.all);return d.type&&d.type in e&&(f=a.extend(f,e[d.type])),Object.keys(f).reduce(function(a,c){var e=f[c],g=e(b,d);return null!==g&&(a[c]=g),a},{})};return{buildPatch:R}});