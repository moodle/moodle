define(["jquery","core/auto_rows","core/backoff_timer","core/custom_interaction_events","core/notification","core/pubsub","core/str","core_message/message_repository","core_message/message_drawer_events","core_message/message_drawer_view_conversation_constants","core_message/message_drawer_view_conversation_patcher","core_message/message_drawer_view_conversation_renderer","core_message/message_drawer_view_conversation_state_manager","core_message/message_drawer_router","core_message/message_drawer_routes"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){var p={},q=null,r=!1,s=0,t=null,u=!1,v=[],w=!0,x=!1,y=[],z=null,A=[],B=j.NEWEST_MESSAGES_FIRST,C=j.LOAD_MESSAGE_LIMIT,D=j.MILLISECONDS_IN_SEC,E=j.SELECTORS,F=j.CONVERSATION_TYPES,G=function(){if(!q||q.type==F.PUBLIC)return null;var a=q.loggedInUserId;if(q.type==F.SELF)return a;var b=Object.keys(q.members).filter(function(b){return a!=b});return b.length?b[0]:null},H=function(a){return Object.keys(p).reduce(function(b,c){if(!b){var d=p[c].state;d.type!=F.PUBLIC&&a in d.members&&(b=d.id)}return b},null)},I=function(a){return{id:parseInt(a.attr("data-user-id"),10),fullname:null,profileimageurl:null,profileimageurlsmall:null,isonline:null,showonlinestatus:null,isblocked:null,iscontact:null,isdeleted:null,canmessage:null,requirescontact:null,contactrequests:[]}},J=function(){return s},K=function(a){s=a,p[q.id].messagesOffset=a},L=function(){return r},M=function(a){r=a,p[q.id].loadedAllMessages=a},N=function(a){return a.find(E.MESSAGES_CONTAINER)},O=function(b){return{id:b.id,name:b.name,subname:b.subname,imageUrl:b.imageUrl,isFavourite:b.isFavourite,isMuted:b.isMuted,type:b.type,totalMemberCount:b.totalMemberCount,loggedInUserId:b.loggedInUserId,messages:b.messages.map(function(b){return a.extend({},b)}),members:Object.keys(b.members).map(function(c){var d=a.extend({},b.members[c]);return d.contactrequests=b.members[c].contactrequests.map(function(b){return a.extend({},b)}),d})}},P=function(a,b){var c=a.id,d=c==b?F.SELF:F.PRIVATE,f=m.setLoadingMembers(q,!0);return f=m.setLoadingMessages(f,!0),z(f),h.getMemberInfo(c,[b],!0,!0).then(function(a){if(a.length)return a[0];throw new Error("Unable to load other user profile")}).then(function(b){var c=d==F.SELF?[b]:[b,a],e=m.addMembers(q,c);return e=m.setLoadingMembers(e,!1),e=m.setLoadingMessages(e,!1),e=m.setName(e,b.fullname),e=m.setType(e,d),e=m.setImageUrl(e,b.profileimageurl),e=m.setTotalMemberCount(e,c.length),z(e),b})["catch"](function(a){var b=m.setLoadingMembers(q,!1);z(b),e.exception(a)})},Q=function(a,b){var c=null;if(a.type==F.PRIVATE){var d=a.members.filter(function(a){return a.id!=b});c=d.length?d[0]:null}else a.type==F.SELF&&(c=a.members[0]);var e=a.name,f=a.imageurl;a.type!=F.PUBLIC&&(e=e||c?c.fullname:"",f=f||c?c.profileimageurl:"");var g=m.addMembers(q,a.members);return g=m.setName(g,e),g=m.setSubname(g,a.subname),g=m.setType(g,a.type),g=m.setImageUrl(g,f),g=m.setTotalMemberCount(g,a.membercount),g=m.setIsFavourite(g,a.isfavourite),g=m.setIsMuted(g,a.ismuted),g=m.addMessages(g,a.messages),g=m.setCanDeleteMessagesForAllUsers(g,a.candeletemessagesforallusers)},R=function(a,b,c,d,f){var g=b.id,i=m.setLoadingMembers(q,!0);return i=m.setLoadingMessages(i,!0),z(i),h.getConversation(g,a,!0,!0,0,0,c+1,d,f).then(function(a){return a.messages.length>c?a.messages=a.messages.slice(1):M(!0),K(d+c),a}).then(function(a){var c=a.members.filter(function(a){return a.id==b.id});c.length<1&&(a.members=a.members.concat([b]));var d=Q(a,b.id);return d=m.setLoadingMembers(d,!1),d=m.setLoadingMessages(d,!1),z(d).then(function(){return a})}).then(function(){return V(a)})["catch"](function(a){var b=m.setLoadingMembers(q,!1);b=m.setLoadingMessages(b,!1),z(b),e.exception(a)})},S=function(a,b,c,d){var f=a.members.filter(function(a){return a.id==b.id});f.length<1&&(a.members=a.members.concat([b]));var g=a.messages.length,h=g>=c,i=Q(a,b.id);i=m.setLoadingMembers(i,!1),i=m.setLoadingMessages(i,!h);var j=z(i);return j.then(function(){return h?{messages:a.messages}:T(a.id,c,g,d,[])}).then(function(){var a=q.messages;return K(a.length),V(q.id),a})["catch"](e.exception)},T=function(a,b,c,d,e,f){return h.getMessages(q.loggedInUserId,a,b?b+1:b,c,d,f).then(function(a){return a.messages.length&&e.length&&(a.messages=a.messages.filter(function(a){return e.indexOf(parseInt(a.id,10))<0})),a}).then(function(a){return b?(a.messages.length>b?a.messages=a.messages.slice(0,-1):M(!0),a):a}).then(function(a){var b=a.members.filter(function(a){return!(a.id in q.members)}),c=m.addMembers(q,b);return c=m.addMessages(c,a.messages),c=m.setLoadingMessages(c,!1),z(c).then(function(){return a})})["catch"](function(a){var b=m.setLoadingMessages(q,!1);throw z(b),a})},U=function(b,c){return function(){var d=q.messages,e=d.length?d[d.length-1]:null,g=e?e.timeCreated:null;if(g&&!w&&!x){for(var h=[],j=d.length-1;j>=0;j--){var k=d[j];if(k.timeCreated!==g)break;h.push(k.id)}return T(b,0,0,c,h,g).then(function(a){if(a.messages.length){t.restart();var c=O(q);return f.publish(i.CONVERSATION_NEW_LAST_MESSAGE,c),V(b)}return a})}return a.Deferred().resolve().promise()}},V=function(a){var b=q.loggedInUserId;return h.markAllConversationMessagesAsRead(b,a).then(function(){var b=m.markMessagesAsRead(q,q.messages);return f.publish(i.CONVERSATION_READ,a),z(b)})},W=function(a){ka(a);var b=m.addPendingBlockUsersById(q,[a]);z(b)},X=function(a){var b=m.setLoadingConfirmAction(q,!0);return z(b),h.blockUser(q.loggedInUserId,a).then(function(b){var c=m.addMembers(q,[b]);return c=m.removePendingBlockUsersById(c,[a]),c=m.setLoadingConfirmAction(c,!1),f.publish(i.CONTACT_BLOCKED,a),z(c)})},Y=function(a){ka(a);var b=m.addPendingUnblockUsersById(q,[a]);z(b)},Z=function(a){var b=m.setLoadingConfirmAction(q,!0);return z(b),h.unblockUser(q.loggedInUserId,a).then(function(b){var c=m.addMembers(q,[b]);return c=m.removePendingUnblockUsersById(c,[a]),c=m.setLoadingConfirmAction(c,!1),f.publish(i.CONTACT_UNBLOCKED,a),z(c)})},$=function(a){ka(a);var b=m.addPendingRemoveContactsById(q,[a]);z(b)},_=function(a){var b=m.setLoadingConfirmAction(q,!0);return z(b),h.deleteContacts(q.loggedInUserId,[a]).then(function(b){var c=m.addMembers(q,b);return c=m.removePendingRemoveContactsById(c,[a]),c=m.setLoadingConfirmAction(c,!1),f.publish(i.CONTACT_REMOVED,a),z(c)})},aa=function(a){ka(a);var b=m.addPendingAddContactsById(q,[a]);z(b)},ba=function(a){var b=m.setLoadingConfirmAction(q,!0);return z(b),h.createContactRequest(q.loggedInUserId,a).then(function(a){if(!a.request)throw new Error(a.warnings[0].message);return a.request}).then(function(b){var c=m.removePendingAddContactsById(q,[a]);return c=m.addContactRequests(c,[b]),c=m.setLoadingConfirmAction(c,!1),z(c)})},ca=function(){var a=q.loggedInUserId,b=q.id;return h.setFavouriteConversations(a,[b]).then(function(){var a=m.setIsFavourite(q,!0);return z(a)}).then(function(){return f.publish(i.CONVERSATION_SET_FAVOURITE,O(q))})},da=function(){var a=q.loggedInUserId,b=q.id;return h.unsetFavouriteConversations(a,[b]).then(function(){var a=m.setIsFavourite(q,!1);return z(a)}).then(function(){return f.publish(i.CONVERSATION_UNSET_FAVOURITE,O(q))})},ea=function(){var a=q.loggedInUserId,b=q.id;return h.setMutedConversations(a,[b]).then(function(){var a=m.setIsMuted(q,!0);return z(a)}).then(function(){return f.publish(i.CONVERSATION_SET_MUTED,O(q))})},fa=function(){var a=q.loggedInUserId,b=q.id;return h.unsetMutedConversations(a,[b]).then(function(){var a=m.setIsMuted(q,!1);return z(a)}).then(function(){return f.publish(i.CONVERSATION_UNSET_MUTED,O(q))})},ga=function(a){var b=q.selectedMessageIds;ka(a);var c=m.addPendingDeleteMessagesById(q,b);z(c)},ha=function(){var b=q.pendingDeleteMessageIds,c=q.messages.filter(function(a){return b.indexOf(a.id)>=0&&("sent"==a.sendState||null===a.sendState)}),d=m.setLoadingConfirmAction(q,!0);z(d);var g=a.Deferred().resolve().promise();if(c.length){var j=c.map(function(a){return a.id});g=d.deleteMessagesForAllUsers?h.deleteMessagesForAllUsers(q.loggedInUserId,j):h.deleteMessages(q.loggedInUserId,j)}return g.then(function(){var a=m.removeMessagesById(q,b);a=m.removePendingDeleteMessagesById(a,b),a=m.removeSelectedMessagesById(a,b),a=m.setLoadingConfirmAction(a,!1),a=m.setDeleteMessagesForAllUsers(a,!1);var c=q.messages[q.messages.length-1],d=a.messages.length?a.messages[a.messages.length-1]:null;if(d&&d.id!=c.id){var e=O(a);f.publish(i.CONVERSATION_NEW_LAST_MESSAGE,e)}else a.messages.length||f.publish(i.CONVERSATION_DELETED,a.id);return z(a)})["catch"](e.exception)},ia=function(a){ka(a);var b=m.setPendingDeleteConversation(q,!0);z(b)},ja=function(){var a=m.setLoadingConfirmAction(q,!0);return z(a),h.deleteConversation(q.loggedInUserId,q.id).then(function(){var a=m.removeMessages(q,q.messages);return a=m.removeSelectedMessagesById(a,q.selectedMessageIds),a=m.setPendingDeleteConversation(a,!1),a=m.setLoadingConfirmAction(a,!1),f.publish(i.CONVERSATION_DELETED,a.id),z(a)})},ka=function(a){var b=q.pendingDeleteMessageIds,c=m.removePendingAddContactsById(q,[a]);c=m.removePendingRemoveContactsById(c,[a]),c=m.removePendingUnblockUsersById(c,[a]),c=m.removePendingBlockUsersById(c,[a]),c=m.removePendingDeleteMessagesById(c,b),c=m.setPendingDeleteConversation(c,!1),c=m.setDeleteMessagesForAllUsers(c,!1),z(c)},la=function(a){var b=q.loggedInUserId,c=q.members[a].contactrequests.filter(function(a){return a.requesteduserid==b}),d=c[0],e=m.setLoadingConfirmAction(q,!0);return z(e),h.acceptContactRequest(a,b).then(function(a){var b=m.removeContactRequests(q,[d]);return b=m.addMembers(q,[a]),b=m.setLoadingConfirmAction(b,!1),z(b)}).then(function(){f.publish(i.CONTACT_ADDED,q.members[a]),f.publish(i.CONTACT_REQUEST_ACCEPTED,d)})},ma=function(a){var b=q.loggedInUserId,c=q.members[a].contactrequests.filter(function(a){return a.requesteduserid==b}),d=c[0],e=m.setLoadingConfirmAction(q,!0);return z(e),h.declineContactRequest(a,b).then(function(a){var b=m.removeContactRequests(q,[d]);return b=m.addMembers(q,[a]),b=m.setLoadingConfirmAction(b,!1),z(b)}).then(function(){f.publish(i.CONTACT_REQUEST_DECLINED,d)})},na=function(){if(!x&&y.length){x=!0;var b=y.slice();y=[];var c=q.id,d=null,e=b.map(function(a){return a.text}),j=b.map(function(a){return a.id}),k=null,l=null;if(c||q.type==F.PUBLIC)k=h.sendMessagesToConversation(c,e);else{var n=G();k=h.sendMessagesToUser(n,e).then(function(a){return a.length&&(d=parseInt(a[0].conversationid,10),l=a[0].candeletemessagesforallusers),a})}k.then(function(a){var c=a.map(function(a){return a.id}),e=[],g=[],h=[];b.forEach(function(b,c){var d=a[c];e.push([b,d]),q.selectedMessageIds.indexOf(b.id)>=0&&(g.push(b.id),h.push(d.id))});var j=m.updateMessages(q,e);j=m.setMessagesSendSuccessById(j,c),g.length&&(j=m.removeSelectedMessagesById(j,g)),h.length&&(j=m.addSelectedMessagesById(j,h));var k=O(j);j.id||(j=m.setId(j,d),k.id=d,Ha(d),f.publish(i.CONVERSATION_CREATED,k),j=m.setCanDeleteMessagesForAllUsers(j,l)),z(j),x=!1,na(),f.publish(i.CONVERSATION_NEW_LAST_MESSAGE,k)})["catch"](function(b){if(b.message)var c=a.Deferred().resolve(b.message).promise();else var c=g.get_string("unknownerror","core");var d=function(a){var b=m.setMessagesSendFailById(q,j,a);z(b),x=!1,na()};c.then(d)["catch"](function(a){var b=a.message||"Something went wrong!";d(b)})})}},oa=function(a){var b="temp"+Date.now(),c={id:b,useridfrom:q.loggedInUserId,text:a,timecreated:null},d=m.addMessages(q,[c]);z(d),y.push(c),na()},pa=function(a){var b=m.setMessagesSendPendingById(q,[a.id]);z(b),y.push(a),na()},qa=function(a){var b=q;b=q.selectedMessageIds.indexOf(a)>-1?m.removeSelectedMessagesById(q,[a]):m.addSelectedMessagesById(q,[a]),z(b)},ra=function(){ka(G());var a=m.removeSelectedMessagesById(q,q.selectedMessageIds);z(a)},sa=function(b,c,d){if(!u&&v.length){u=!0;var f=v.shift(),g=A.map(function(a){return a(f.patch)});a.when.apply(null,g).then(function(){u=!1,f.deferred.resolve(!0),sa(b,c,d)})["catch"](function(a){u=!1,f.deferred.reject(a),e.exception(a)})}},ta=function(b,c,d,e){var f=function(a){return l.render(b,c,d,a)};if(!e){var g=m.buildInitialState(q.midnight,q.loggedInUserId,q.id),h=k.buildPatch(g,q);f(h)}return A.push(f),function(e){var f=k.buildPatch(q,e),g=a.Deferred();return Object.keys(f).length?v.push({patch:f,deferred:g}):g.resolve(!0),q=e,e.id&&(p[e.id]={state:e,messagesOffset:J(),loadedAllMessages:L()}),sa(b,c,d),g.promise()}},ua=function(a){return function(b,c){if(!q.loadingConfirmAction){a(G());var d=m.setLoadingConfirmAction(q,!1);z(d)}c.originalEvent.preventDefault()}},va=function(b,c){var d=a(b.target),e=d.closest(E.FOOTER_CONTAINER),f=e.find(E.MESSAGE_TEXT_AREA),g=f.val().trim();""!==g&&(oa(g),f.val(""),f.focus()),c.originalEvent.preventDefault()},wa=function(b,c){var d=window.getSelection(),e=a(b.target);if(""==d.toString()&&!e.is("a")){var f=e.closest(E.MESSAGE),g=f.attr("data-message-id");qa(g),c.originalEvent.preventDefault()}},xa=function(b,c){var d=a(b.target),e=d.closest(E.MESSAGE),f=e.attr("data-message-id"),g=q.messages.filter(function(a){return a.id==f}),h=g.length?g[0]:null;h&&pa(h),c.originalEvent.preventDefault(),c.originalEvent.stopPropagation(),b.stopPropagation()},ya=function(a,b){ra(),b.originalEvent.preventDefault()},za=function(a){return function(b,c){var d=G(),e=q.members[d];n.go(a,o.VIEW_CONTACT,e),c.originalEvent.preventDefault()}},Aa=function(a,b){ca()["catch"](e.exception),b.originalEvent.preventDefault()},Ba=function(a,b){da()["catch"](e.exception),b.originalEvent.preventDefault()},Ca=function(a,b){ea()["catch"](e.exception),b.originalEvent.preventDefault()},Da=function(a,b){fa()["catch"](e.exception),b.originalEvent.preventDefault()},Ea=function(b){var c=a(b.target).prop("checked"),d=m.setDeleteMessagesForAllUsers(q,c);z(d)},Fa=function(a){return function(b,c){n.go(a,o.VIEW_GROUP_INFO,{id:q.id,name:q.name,subname:q.subname,imageUrl:q.imageUrl,totalMemberCount:q.totalMemberCount},q.loggedInUserId),c.originalEvent.preventDefault()}},Ga=function(a,c,g,h){var j=!1,k=N(g),l=[[E.ACTION_REQUEST_BLOCK,ua(W)],[E.ACTION_REQUEST_UNBLOCK,ua(Y)],[E.ACTION_REQUEST_ADD_CONTACT,ua(aa)],[E.ACTION_REQUEST_REMOVE_CONTACT,ua($)],[E.ACTION_REQUEST_DELETE_CONVERSATION,ua(ia)],[E.ACTION_CANCEL_EDIT_MODE,ya],[E.ACTION_VIEW_CONTACT,za(a)],[E.ACTION_VIEW_GROUP_INFO,Fa(a)],[E.ACTION_CONFIRM_FAVOURITE,Aa],[E.ACTION_CONFIRM_MUTE,Ca],[E.ACTION_CONFIRM_UNFAVOURITE,Ba],[E.ACTION_CONFIRM_UNMUTE,Da]],n=[[E.ACTION_CANCEL_CONFIRM,ua(ka)],[E.ACTION_CONFIRM_BLOCK,ua(X)],[E.ACTION_CONFIRM_UNBLOCK,ua(Z)],[E.ACTION_CONFIRM_ADD_CONTACT,ua(ba)],[E.ACTION_CONFIRM_REMOVE_CONTACT,ua(_)],[E.ACTION_CONFIRM_DELETE_SELECTED_MESSAGES,ua(ha)],[E.ACTION_CONFIRM_DELETE_CONVERSATION,ua(ja)],[E.ACTION_REQUEST_ADD_CONTACT,ua(aa)],[E.ACTION_ACCEPT_CONTACT_REQUEST,ua(la)],[E.ACTION_DECLINE_CONTACT_REQUEST,ua(ma)],[E.MESSAGE,wa],[E.DELETE_MESSAGES_FOR_ALL_USERS_TOGGLE,Ea],[E.RETRY_SEND,xa]],p=[[E.SEND_MESSAGE_BUTTON,va],[E.ACTION_REQUEST_DELETE_SELECTED_MESSAGES,ua(ga)],[E.ACTION_REQUEST_ADD_CONTACT,ua(aa)],[E.ACTION_REQUEST_UNBLOCK,ua(Y)]];b.init(h),d.define(c,[d.events.activate]),d.define(g,[d.events.activate]),d.define(h,[d.events.activate,d.events.enter]),d.define(k,[d.events.scrollTop,d.events.scrollLock]),k.on(d.events.scrollTop,function(a,b){var c=Object.keys(q.members).length>1;if(!w&&!j&&!L()&&c){j=!0;var d=m.setLoadingMessages(q,!0);z(d),T(q.id,C,J(),B,[]).then(function(){j=!1,K(J()+C)})["catch"](function(a){j=!1,e.exception(a)})}b.originalEvent.preventDefault()}),l.forEach(function(a){var b=a[0],e=a[1];c.on(d.events.activate,b,e)}),n.forEach(function(a){var b=a[0],c=a[1];g.on(d.events.activate,b,c)}),p.forEach(function(a){var b=a[0],c=a[1];h.on(d.events.activate,b,c)}),h.on(d.events.enter,E.MESSAGE_TEXT_AREA,function(a,b){var c=h.attr("data-enter-to-send");c&&"false"!=c&&"0"!=c&&va(a,b)}),f.subscribe(i.ROUTE_CHANGED,function(a){t&&a.route!=o.VIEW_CONVERSATION&&t.stop()})},Ha=function(a){t&&t.stop(),t=new c(U(a,B),c.getIncrementalCallback(q.messagePollMin*D,D,q.messagePollMax*D,q.messagePollAfterMax*D)),t.start()},Ia=function(a,b,c){r=!1,s=0,t=null,u=!1,v=[],w=!0,x=!1,y=[];var d=c.id,e=parseInt(a.attr("data-midnight"),10),f=parseInt(a.attr("data-message-poll-min"),10),g=parseInt(a.attr("data-message-poll-max"),10),h=parseInt(a.attr("data-message-poll-after-max"),10),i=m.buildInitialState(e,d,b,f,g,h);q||(q=i),t&&t.stop(),z(i)},Ja=function(a,b,c){Ia(a,null,b);var d=null;return d=b.id!=c?h.getConversationBetweenUsers(b.id,c,!0,!0,0,0,C,0,B):h.getSelfConversation(b.id,C,0,B),d.then(function(c){return La(a,c,b)})["catch"](function(){return P(b,c)})},Ka=function(b,c,d){var e=null;c in p&&(e=p[c]),Ia(b,c,d);var f=a.Deferred().resolve({}).promise();if(e){var g=e.state;g=m.setLoadingMessages(g,!1),g=m.setLoadingMembers(g,!1),K(e.messagesOffset),M(e.loadedAllMessages),z(g)}else f=R(c,d,C,0,B);return f.then(function(){return Ha(c)})},La=function(b,c,d){var e=null;c.id in p&&(e=p[c.id]),Ia(b,c.id,d);var f=a.Deferred().resolve({}).promise();if(e){var g=e.state;g=m.setLoadingMessages(g,!1),g=m.setLoadingMembers(g,!1),K(e.messagesOffset),M(e.loadedAllMessages),z(g)}else f=S(c,d,C,B);return f.then(function(){return Ha(c.id)})},Ma=function(b,c,d,f,g,h,i){var k=null,l=null;g&&null!==g&&"object"==typeof g?(k=g,l=parseInt(k.id,10)):(k=null,l=parseInt(g,10),l=isNaN(l)?null:l),!l&&h&&i&&(l=H(i));var m=!q||q.id!=l||i&&i!=G();if(d.attr("data-init")||(z=ta(c,d,f,m),Ga(b,c,d,f),d.attr("data-init",!0)),m){var n=null,o=I(d);return n=k?La(d,k,o,i):l?Ka(d,l,o,i):Ja(d,o,i),n.then(function(){w=!1,c.find(j.SELECTORS.CAN_RECEIVE_FOCUS).first().focus()})["catch"](function(a){w=!1,e.exception(a)})}if(Ha(l),q.type==F.PRIVATE&&h){var p=G();switch(h){case"block":return W(p);case"unblock":return Y(p);case"add-contact":return aa(p);case"remove-contact":return $(p)}}return a.Deferred().resolve().promise()},Na=function(){return g.get_string("messagedrawerviewconversation","core_message",q.name)};return{show:Ma,description:Na}});