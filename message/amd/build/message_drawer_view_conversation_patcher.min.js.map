{"version":3,"sources":["../src/message_drawer_view_conversation_patcher.js"],"names":["define","$","UserDate","Constants","sortMessagesByDay","messages","midnight","messagesByDay","reduce","carry","message","timeCreated","dayTimestamp","getUserMidnightForTimestamp","hasOwnProperty","push","Object","keys","map","timestamp","diffArrays","a","b","matchFunction","slice","missingFromA","missingFromB","matches","forEach","current","found","index","length","next","splice","findPositionInArray","array","breakFunction","before","i","candidate","isArrayEqual","sort","aLength","bLength","every","item","isObjectEqual","aKeys","bKeys","key","aVal","bVal","aType","bType","Array","isArray","isMessageEqual","id","state","sendState","text","buildDaysPatch","remove","add","day","value","buildMessagesPatch","matchingDays","update","days","dayCurrent","dayNext","messagesDiff","patch","timeAdded","concat","after","buildConversationPatch","newState","diff","daysDiff","buildHeaderPatchTypePrivate","requireAddContact","buildRequireAddContact","confirmContactRequest","buildConfirmContactRequest","oldOtherUser","getOtherUserFromState","newOtherUser","requiresAddContact","show","hasMessages","requiredAddContact","shouldRenderHeader","type","CONVERSATION_TYPES","PRIVATE","showControls","context","name","subname","totalmembercount","totalMemberCount","imageurl","imageUrl","isfavourite","isFavourite","ismuted","isMuted","showfavourite","userid","showonlinestatus","isonline","isblocked","iscontact","buildHeaderPatchTypeSelf","SELF","buildHeaderPatchTypePublic","oldMemberCount","newMemberCount","PUBLIC","buildScrollToMessagePatch","oldMessages","newMessages","previousNewest","currentNewest","previousOldest","currentOldest","buildLoadingMembersPatch","loadingMembers","buildLoadingFirstMessages","hasTriedToLoadMessages","loadingMessages","buildLoadingMessages","buildConfirmBlockUser","pendingBlockUserIds","userId","members","buildConfirmUnblockUser","pendingUnblockUserIds","buildConfirmAddContact","pendingAddContactIds","buildConfirmRemoveContact","pendingRemoveContactIds","buildConfirmDeleteSelectedMessages","oldPendingCount","pendingDeleteMessageIds","newPendingCount","canDeleteMessagesForAllUsers","buildConfirmDeleteConversation","pendingDeleteConversation","loggedInUserId","oldReceivedRequests","contactrequests","filter","request","requesteduserid","newReceivedRequests","oldRequest","newRequest","buildIsBlocked","buildIsFavourite","oldIsFavourite","newIsFavourite","buildIsMuted","oldIsMuted","newIsMuted","buildIsContact","oldContactRequests","newContactRequests","oldHasContactRequests","newHasContactRequests","buildLoadingConfirmationAction","loadingConfirmAction","buildInEditMode","oldHasSelectedMessages","selectedMessageIds","newHasSelectedMessages","numberOfMessagesHasChanged","buildSelectedMessages","oldSelectedMessages","newSelectedMessages","count","requiresContactRequest","user","canmessage","contactRequests","hasSentContactRequest","requirescontact","hadMessages","prevRequiresContactRequest","nextRequiresContactRequest","confirmAddContact","buildRequireUnblock","buildUnableToMessage","buildFooterPatchTypePrivate","loadingFirstMessages","inEditMode","requireUnblock","unableToMessage","showRequireAddContact","otherUser","generateReturnValue","checkValue","successReturn","checks","result","buildFooterPatchTypePublic","buildReset","oldType","newType","oldConversationId","newConversationId","oldMemberIds","newMemberIds","membersUnchanged","buildSelfConversationMessage","buildContactRequestSent","oldSentRequests","newSentRequests","fullname","buildPatch","config","all","reset","conversation","scrollToMessage","confirmDeleteSelectedMessages","selectedMessages","header","footer","confirmBlockUser","confirmUnblockUser","confirmRemoveContact","confirmDeleteConversation","isBlocked","isContact","contactRequestSent","selfConversationMessage","patchConfig","extend","buildFunc"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module will take 2 view states from the message_drawer_view_conversation\n * module and generate a patch that can be given to the\n * message_drawer_view_conversation_renderer module to update the UI.\n *\n * This module should never modify either state. It's purely a read only\n * module.\n *\n * @module     core_message/message_drawer_view_conversation_patcher\n * @copyright  2018 Ryan Wyllie <ryan@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(\n[\n    'jquery',\n    'core/user_date',\n    'core_message/message_drawer_view_conversation_constants'\n],\nfunction(\n    $,\n    UserDate,\n    Constants\n) {\n    /**\n     * Sort messages by day.\n     *\n     * @param  {Array} messages The list of messages to sort.\n     * @param  {Number} midnight User's midnight timestamp.\n     * @return {Array} messages sorted by day.\n     */\n    var sortMessagesByDay = function(messages, midnight) {\n        var messagesByDay = messages.reduce(function(carry, message) {\n            var timeCreated = message.timeCreated ? message.timeCreated : midnight;\n            var dayTimestamp = UserDate.getUserMidnightForTimestamp(timeCreated, midnight);\n\n            if (carry.hasOwnProperty(dayTimestamp)) {\n                carry[dayTimestamp].push(message);\n            } else {\n                carry[dayTimestamp] = [message];\n            }\n\n            return carry;\n        }, {});\n\n        return Object.keys(messagesByDay).map(function(dayTimestamp) {\n            return {\n                timestamp: dayTimestamp,\n                messages: messagesByDay[dayTimestamp]\n            };\n        });\n    };\n\n    /**\n     * Diff 2 arrays using a match function\n     *\n     * @param  {Array} a The first array.\n     * @param  {Array} b The second array.\n     * @param  {Function} matchFunction Function used for matching array items.\n     * @return {Object} Object containing array items missing from a, array items missing from b\n     * and matches\n     */\n    var diffArrays = function(a, b, matchFunction) {\n        // Make copy of it.\n        b = b.slice();\n        var missingFromA = [];\n        var missingFromB = [];\n        var matches = [];\n\n        a.forEach(function(current) {\n            var found = false;\n            var index = 0;\n\n            for (; index < b.length; index++) {\n                var next = b[index];\n\n                if (matchFunction(current, next)) {\n                    found = true;\n                    matches.push({\n                        a: current,\n                        b: next\n                    });\n                    break;\n                }\n            }\n\n            if (found) {\n                // This day has been processed so removed it from the list.\n                b.splice(index, 1);\n            } else {\n                // If we couldn't find it in the next messages then it means\n                // it needs to be added.\n                missingFromB.push(current);\n            }\n        });\n\n        missingFromA = b;\n\n        return {\n            missingFromA: missingFromA,\n            missingFromB: missingFromB,\n            matches: matches\n        };\n    };\n\n    /**\n     * Find an element in a array based on a matching function.\n     *\n     * @param  {array} array Array to search.\n     * @param  {Function} breakFunction Function to run on array item.\n     * @return {*} The array item.\n     */\n    var findPositionInArray = function(array, breakFunction) {\n        var before = null;\n\n        for (var i = 0; i < array.length; i++) {\n            var candidate = array[i];\n\n            if (breakFunction(candidate)) {\n                return candidate;\n            }\n        }\n\n        return before;\n    };\n\n    /**\n     * Check if 2 arrays are equal.\n     *\n     * @param  {Array} a The first array.\n     * @param  {Array} b The second array.\n     * @return {Boolean} Are arrays equal.\n     */\n    var isArrayEqual = function(a, b) {\n        // Make shallow copies so that we don't mess with the array sorting.\n        a = a.slice();\n        b = b.slice();\n        a.sort();\n        b.sort();\n        var aLength = a.length;\n        var bLength = b.length;\n\n        if (aLength < 1 && bLength < 1) {\n            return true;\n        }\n\n        if (aLength != bLength) {\n            return false;\n        }\n\n        return a.every(function(item, index) {\n            return item == b[index];\n        });\n    };\n\n    /**\n     * Do a shallow check to see if two objects appear to be equal. This should\n     * only be used for pretty basic objects.\n     *\n     * @param {Object} a First object to compare.\n     * @param {Object} b Second object to compare\n     * @return {Bool}\n     */\n    var isObjectEqual = function(a, b) {\n        var aKeys = Object.keys(a);\n        var bKeys = Object.keys(b);\n\n        if (aKeys.length != bKeys.length) {\n            return false;\n        }\n\n        return aKeys.every(function(key) {\n            var aVal = a[key];\n            var bVal = b[key];\n            var aType = typeof aVal;\n            var bType = typeof bVal;\n            aType = (aVal === null) ? 'null' : aType;\n            bType = (aVal === null) ? 'null' : bType;\n            aType = (aType === 'object' && Array.isArray(aType)) ? 'array' : aType;\n            bType = (bType === 'object' && Array.isArray(bType)) ? 'array' : bType;\n\n            if (aType !== bType) {\n                return false;\n            }\n\n            switch (aType) {\n                case 'object':\n                    return isObjectEqual(aVal, bVal);\n                case 'array':\n                    return isArrayEqual(aVal, bVal);\n                default:\n                    return a[key] == b[key];\n            }\n        });\n    };\n\n    /**\n     * Compare two messages to check if they are equal. This function only checks a subset\n     * of the message properties which we know will change rather than all properties.\n     *\n     * @param {Object} a The first message\n     * @param {Object} b The second message\n     * @return {Bool}\n     */\n    var isMessageEqual = function(a, b) {\n        return isObjectEqual(\n            {\n                id: a.id,\n                state: a.sendState,\n                text: a.text,\n                timeCreated: a.timeCreated\n            },\n            {\n                id: b.id,\n                state: b.sendState,\n                text: b.text,\n                timeCreated: b.timeCreated\n            }\n        );\n    };\n\n    /**\n     * Build a patch based on days.\n     *\n     * @param  {Object} current Current list current items.\n     * @param  {Array} remove List of days to remove.\n     * @param  {Array} add List of days to add.\n     * @return {Object} Patch with elements to add and remove.\n     */\n    var buildDaysPatch = function(current, remove, add) {\n        return {\n            remove: remove,\n            add: add.map(function(day) {\n                // Any days left over in the \"next\" list weren't in the \"current\" list\n                // so they will need to be added.\n                var before = findPositionInArray(current, function(candidate) {\n                    return day.timestamp < candidate.timestamp;\n                });\n\n                return {\n                    before: before,\n                    value: day\n                };\n            })\n        };\n    };\n\n    /**\n     * Build the messages patch for each day.\n     *\n     * @param {Array} matchingDays Array of old and new messages sorted by day.\n     * @return {Object} patch.\n     */\n    var buildMessagesPatch = function(matchingDays) {\n        var remove = [];\n        var add = [];\n        var update = [];\n\n        // Iterate over the list of days and determine which messages in those days\n        // have been changed.\n        matchingDays.forEach(function(days) {\n            var dayCurrent = days.a;\n            var dayNext = days.b;\n            // Find out which messages have changed in this day. This will return a list of messages\n            // from the current state that couldn't be found in the next state and a list of messages in\n            // the next state which couldn't be count in the current state.\n            var messagesDiff = diffArrays(dayCurrent.messages, dayNext.messages, isMessageEqual);\n            // Take the two arrays (list of messages changed from dayNext and list of messages changed\n            // from dayCurrent) any work out which messages have been added/removed from the list and\n            // which messages were just updated.\n            var patch = diffArrays(\n                // The messages from dayCurrent.message that weren't in dayNext.messages.\n                messagesDiff.missingFromB,\n                // The messages from dayNext.message that weren't in dayCurrent.messages.\n                messagesDiff.missingFromA,\n                function(a, b) {\n                    // This function is going to determine if the messages were\n                    // added/removed from either list or if they were simply an updated.\n                    //\n                    // If the IDs match or it was a state change (i.e. message with a temp\n                    // ID goes from pending to sent and receives an actual id) then they are\n                    // the same message which should be an update not an add/remove.\n                    return a.id == b.id || (a.sendState != b.sendState && a.timeAdded == b.timeAdded);\n                }\n            );\n\n            // Any messages from the current state for this day which aren't in the next state\n            // for this day (i.e. the user deleted the message) means we need to remove them from\n            // the UI.\n            remove = remove.concat(patch.missingFromB);\n\n            // Any messages not in the current state for this day which are in the next state\n            // for this day (i.e. it's a new message) means we need to add it to the UI so work\n            // out where in the list of messages it should appear (it could be a new message the\n            // user has sent or older messages loaded as part of the conversation scroll back).\n            patch.missingFromA.forEach(function(message) {\n                // By default a null value for before will render the message at the bottom of\n                // the message UI (i.e. it's the newest message).\n                var before = null;\n\n                if (message.timeCreated) {\n                    // If this message has a time created then find where it sits in the list of\n                    // message to insert it into the correct position.\n                    before = findPositionInArray(dayCurrent.messages, function(candidate) {\n                        if (message.timeCreated == candidate.timeCreated) {\n                            return message.id < candidate.id;\n                        } else {\n                            return message.timeCreated < candidate.timeCreated;\n                        }\n                    });\n                }\n\n                add.push({\n                    before: before,\n                    value: message,\n                    day: dayCurrent\n                });\n            });\n\n            // Any message that appears in both the current state for this day and the next state\n            // for this day means something in the message was updated.\n            update = update.concat(patch.matches.map(function(message) {\n                return {\n                    before: message.a,\n                    after: message.b\n                };\n            }));\n        });\n\n        return {\n            add: add,\n            remove: remove,\n            update: update\n        };\n    };\n\n    /**\n     * Build a patch for this conversation.\n     *\n     * @param  {Object} state, The current state of this conversation.\n     * @param  {Object} newState, The new state of this conversation.\n     * @return {Object} Patch with days and messsages for each day.\n     */\n    var buildConversationPatch = function(state, newState) {\n        var diff = diffArrays(state.messages, newState.messages, isMessageEqual);\n\n        if (diff.missingFromA.length || diff.missingFromB.length) {\n            // Some messages have changed so let's work out which ones by sorting\n            // them into their respective days.\n            var current = sortMessagesByDay(state.messages, state.midnight);\n            var next = sortMessagesByDay(newState.messages, newState.midnight);\n            // This diffs the arrays to work out if there are any missing days that need\n            // to be added (i.e. we've got some new messages on a new day) or if there\n            // are any days that need to be deleted (i.e. the user has deleted some old messages).\n            var daysDiff = diffArrays(current, next, function(dayCurrent, dayNext) {\n                return dayCurrent.timestamp == dayNext.timestamp;\n            });\n\n            return {\n                // Handle adding or removing whole days.\n                days: buildDaysPatch(current, daysDiff.missingFromB, daysDiff.missingFromA),\n                // Handle updating messages that don't require adding/removing a whole day.\n                messages: buildMessagesPatch(daysDiff.matches)\n            };\n        } else {\n            return null;\n        }\n    };\n\n    /**\n     * Build a patch for the header of this conversation. Check if this conversation\n     * is a group conversation.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Object} patch\n     */\n    var buildHeaderPatchTypePrivate = function(state, newState) {\n        var requireAddContact = buildRequireAddContact(state, newState);\n        var confirmContactRequest = buildConfirmContactRequest(state, newState);\n        var oldOtherUser = getOtherUserFromState(state);\n        var newOtherUser = getOtherUserFromState(newState);\n        var requiresAddContact = requireAddContact && requireAddContact.show && !requireAddContact.hasMessages;\n        var requiredAddContact = requireAddContact && !requireAddContact.show;\n        // Render the header once we've got a user.\n        var shouldRenderHeader = !oldOtherUser && newOtherUser;\n        // We should also re-render the header if the other user requires\n        // being added as a contact or if they did but no longer do.\n        shouldRenderHeader = shouldRenderHeader || requiresAddContact || requiredAddContact;\n        // Finally, we should re-render if the other user has sent this user\n        // a contact request that is waiting for approval or if it's been approved/declined.\n        shouldRenderHeader = shouldRenderHeader || confirmContactRequest !== null;\n\n        if (shouldRenderHeader) {\n            return {\n                type: Constants.CONVERSATION_TYPES.PRIVATE,\n                // We can show controls if the other user doesn't require add contact\n                // and we aren't waiting for this user to respond to a contact request.\n                showControls: !requiresAddContact && !confirmContactRequest,\n                context: {\n                    id: newState.id,\n                    name: newState.name,\n                    subname: newState.subname,\n                    totalmembercount: newState.totalMemberCount,\n                    imageurl: newState.imageUrl,\n                    isfavourite: newState.isFavourite,\n                    ismuted: newState.isMuted,\n                    // Don't show favouriting if we don't have a conversation.\n                    showfavourite: newState.id !== null,\n                    userid: newOtherUser.id,\n                    showonlinestatus: newOtherUser.showonlinestatus,\n                    isonline: newOtherUser.isonline,\n                    isblocked: newOtherUser.isblocked,\n                    iscontact: newOtherUser.iscontact\n                }\n            };\n        }\n\n        return null;\n    };\n\n    /**\n     * Build a patch for the header of this conversation. Check if this conversation\n     * is a group conversation.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Object} patch\n     */\n    var buildHeaderPatchTypeSelf = function(state, newState) {\n        var shouldRenderHeader = (state.name === null && newState.name !== null);\n\n        if (shouldRenderHeader) {\n            return {\n                type: Constants.CONVERSATION_TYPES.SELF,\n                // Don't display the controls for the self-conversations.\n                showControls: false,\n                context: {\n                    id: newState.id,\n                    name: newState.name,\n                    subname: newState.subname,\n                    imageurl: newState.imageUrl,\n                    isfavourite: newState.isFavourite,\n                    // Don't show favouriting if we don't have a conversation.\n                    showfavourite: newState.id !== null,\n                    showonlinestatus: true,\n                }\n            };\n        }\n\n        return null;\n    };\n\n    /**\n     * Build a patch for the header of this conversation. Check if this conversation\n     * is a group conversation.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Object} patch\n     */\n    var buildHeaderPatchTypePublic = function(state, newState) {\n        var oldMemberCount = state.totalMemberCount;\n        var newMemberCount = newState.totalMemberCount;\n\n        if (oldMemberCount != newMemberCount) {\n            return {\n                type: Constants.CONVERSATION_TYPES.PUBLIC,\n                showControls: true,\n                context: {\n                    id: newState.id,\n                    name: newState.name,\n                    subname: newState.subname,\n                    totalmembercount: newState.totalMemberCount,\n                    imageurl: newState.imageUrl,\n                    isfavourite: newState.isFavourite,\n                    ismuted: newState.isMuted,\n                    // Don't show favouriting if we don't have a conversation.\n                    showfavourite: newState.id !== null\n                }\n            };\n        } else {\n            return null;\n        }\n    };\n\n    /**\n     * Find the newest or oldest message.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Number} Oldest or newest message id.\n     */\n    var buildScrollToMessagePatch = function(state, newState) {\n        var oldMessages = state.messages;\n        var newMessages = newState.messages;\n\n        if (newMessages.length < 1) {\n            return null;\n        }\n\n        if (oldMessages.length < 1) {\n            return newMessages[newMessages.length - 1].id;\n        }\n\n        var previousNewest = oldMessages[state.messages.length - 1];\n        var currentNewest = newMessages[newMessages.length - 1];\n        var previousOldest = oldMessages[0];\n        var currentOldest = newMessages[0];\n\n        if (previousNewest.id != currentNewest.id) {\n            return currentNewest.id;\n        } else if (previousOldest.id != currentOldest.id) {\n            return previousOldest.id;\n        }\n\n        return null;\n    };\n\n    /**\n     * Check if members should be loaded.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Bool|Null}\n     */\n    var buildLoadingMembersPatch = function(state, newState) {\n        if (!state.loadingMembers && newState.loadingMembers) {\n            return true;\n        } else if (state.loadingMembers && !newState.loadingMembers) {\n            return false;\n        } else {\n            return null;\n        }\n    };\n\n    /**\n     * Check if the messages are being loaded for the first time.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Bool|Null}\n     */\n    var buildLoadingFirstMessages = function(state, newState) {\n        if (state.hasTriedToLoadMessages === newState.hasTriedToLoadMessages) {\n            return null;\n        } else if (!newState.hasTriedToLoadMessages && newState.loadingMessages) {\n            return true;\n        } else if (newState.hasTriedToLoadMessages && !newState.loadingMessages) {\n            return false;\n        } else {\n            return null;\n        }\n    };\n\n    /**\n     * Check if the messages are still being loaded\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Bool|Null}\n     */\n    var buildLoadingMessages = function(state, newState) {\n        if (!state.loadingMessages && newState.loadingMessages) {\n            return true;\n        } else if (state.loadingMessages && !newState.loadingMessages) {\n            return false;\n        } else {\n            return null;\n        }\n    };\n\n    /**\n     * Get the user Object of user to be blocked if pending.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Object|Bool|Null} User Object if Object.\n     */\n    var buildConfirmBlockUser = function(state, newState) {\n        if (newState.pendingBlockUserIds.length) {\n            // We currently only support a single user;\n            var userId = newState.pendingBlockUserIds[0];\n            return newState.members[userId];\n        } else if (state.pendingBlockUserIds.length) {\n            return false;\n        }\n\n        return null;\n    };\n\n    /**\n     * Get the user Object of user to be unblocked if pending.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Object|Bool|Null} User Object if Object.\n     */\n    var buildConfirmUnblockUser = function(state, newState) {\n        if (newState.pendingUnblockUserIds.length) {\n            // We currently only support a single user;\n            var userId = newState.pendingUnblockUserIds[0];\n            return newState.members[userId];\n        } else if (state.pendingUnblockUserIds.length) {\n            return false;\n        }\n\n        return null;\n    };\n\n    /**\n     * Get the user Object of user to be added as contact if pending.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Object|Bool|Null} User Object if Object.\n     */\n    var buildConfirmAddContact = function(state, newState) {\n        if (newState.pendingAddContactIds.length) {\n            // We currently only support a single user;\n            var userId = newState.pendingAddContactIds[0];\n            return newState.members[userId];\n        } else if (state.pendingAddContactIds.length) {\n            return false;\n        }\n\n        return null;\n    };\n\n    /**\n     * Get the user Object of user to be removed as contact if pending.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Object|Bool|Null} User Object if Object.\n     */\n    var buildConfirmRemoveContact = function(state, newState) {\n        if (newState.pendingRemoveContactIds.length) {\n            // We currently only support a single user;\n            var userId = newState.pendingRemoveContactIds[0];\n            return newState.members[userId];\n        } else if (state.pendingRemoveContactIds.length) {\n            return false;\n        }\n\n        return null;\n    };\n\n    /**\n     * Check if there are any messages to be deleted.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Object|Null} The conversation type and if the user can delete  the messages for all users.\n     */\n    var buildConfirmDeleteSelectedMessages = function(state, newState) {\n        var oldPendingCount = state.pendingDeleteMessageIds.length;\n        var newPendingCount = newState.pendingDeleteMessageIds.length;\n\n        if (newPendingCount && !oldPendingCount) {\n            return {\n                show: true,\n                type: newState.type,\n                canDeleteMessagesForAllUsers: newState.canDeleteMessagesForAllUsers\n            };\n        } else if (oldPendingCount && !newPendingCount) {\n            return {\n                show: false\n            };\n        }\n\n        return null;\n    };\n\n    /**\n     * Check if there is a conversation to be deleted.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {int|Null} The conversation type to be deleted.\n     */\n    var buildConfirmDeleteConversation = function(state, newState) {\n        if (!state.pendingDeleteConversation && newState.pendingDeleteConversation) {\n            return newState.type;\n        } else if (state.pendingDeleteConversation && !newState.pendingDeleteConversation) {\n            return false;\n        }\n\n        return null;\n    };\n\n    /**\n     * Check if there is a pending contact request to accept or decline.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Bool|Null}\n     */\n    var buildConfirmContactRequest = function(state, newState) {\n        var loggedInUserId = state.loggedInUserId;\n        var oldOtherUser = getOtherUserFromState(state);\n        var newOtherUser = getOtherUserFromState(newState);\n        var oldReceivedRequests = !oldOtherUser ? [] : oldOtherUser.contactrequests.filter(function(request) {\n            return request.requesteduserid == loggedInUserId && request.userid == oldOtherUser.id;\n        });\n        var newReceivedRequests = !newOtherUser ? [] : newOtherUser.contactrequests.filter(function(request) {\n            return request.requesteduserid == loggedInUserId && request.userid == newOtherUser.id;\n        });\n        var oldRequest = oldReceivedRequests.length ? oldReceivedRequests[0] : null;\n        var newRequest = newReceivedRequests.length ? newReceivedRequests[0] : null;\n\n        if (!oldRequest && newRequest) {\n            return newOtherUser;\n        } else if (oldRequest && !newRequest) {\n            return false;\n        } else {\n            return null;\n        }\n    };\n\n    /**\n     * Check if there are any changes in blocked users.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Bool|Null}\n     */\n    var buildIsBlocked = function(state, newState) {\n        var oldOtherUser = getOtherUserFromState(state);\n        var newOtherUser = getOtherUserFromState(newState);\n\n        if (!oldOtherUser && !newOtherUser) {\n            return null;\n        } else if (!oldOtherUser && newOtherUser) {\n            return newOtherUser.isblocked ? true : null;\n        } else if (!newOtherUser && oldOtherUser) {\n            return oldOtherUser.isblocked ? false : null;\n        } else if (oldOtherUser.isblocked && !newOtherUser.isblocked) {\n            return false;\n        } else if (!oldOtherUser.isblocked && newOtherUser.isblocked) {\n            return true;\n        } else {\n            return null;\n        }\n    };\n\n    /**\n     * Check if there are any changes the conversation favourite state.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Bool|Null}\n     */\n    var buildIsFavourite = function(state, newState) {\n        var oldIsFavourite = state.isFavourite;\n        var newIsFavourite = newState.isFavourite;\n\n        if (state.id === null && newState.id === null) {\n            // The conversation isn't yet created so don't change anything.\n            return null;\n        } else if (state.id === null && newState.id !== null) {\n            // The conversation was created so we can show the add favourite button.\n            return 'show-add';\n        } else if (state.id !== null && newState.id === null) {\n            // We're changing from a created conversation to a new conversation so hide\n            // the favouriting functionality for now.\n            return 'hide';\n        } else if (oldIsFavourite == newIsFavourite) {\n            // No change.\n            return null;\n        } else if (!oldIsFavourite && newIsFavourite) {\n            return 'show-remove';\n        } else if (oldIsFavourite && !newIsFavourite) {\n            return 'show-add';\n        } else {\n            return null;\n        }\n    };\n\n    /**\n     * Check if there are any changes the conversation muted state.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {string|null}\n     */\n    var buildIsMuted = function(state, newState) {\n        var oldIsMuted = state.isMuted;\n        var newIsMuted = newState.isMuted;\n\n        if (state.id === null && newState.id === null) {\n            // The conversation isn't yet created so don't change anything.\n            return null;\n        } else if (state.id === null && newState.id !== null) {\n            // The conversation was created so we can show the mute button.\n            return 'show-mute';\n        } else if (state.id !== null && newState.id === null) {\n            // We're changing from a created conversation to a new conversation so hide\n            // the muting functionality for now.\n            return 'hide';\n        } else if (oldIsMuted == newIsMuted) {\n            // No change.\n            return null;\n        } else if (!oldIsMuted && newIsMuted) {\n            return 'show-unmute';\n        } else if (oldIsMuted && !newIsMuted) {\n            return 'show-mute';\n        } else {\n            return null;\n        }\n    };\n\n    /**\n     * Check if there are any changes in the contact status of the current user\n     * and other user.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Bool|Null}\n     */\n    var buildIsContact = function(state, newState) {\n        var loggedInUserId = state.loggedInUserId;\n        var oldOtherUser = getOtherUserFromState(state);\n        var newOtherUser = getOtherUserFromState(newState);\n        var oldContactRequests = !oldOtherUser ? [] : oldOtherUser.contactrequests.filter(function(request) {\n            return (request.userid == loggedInUserId && request.requesteduserid == oldOtherUser.id) ||\n                (request.userid == oldOtherUser.id && request.requesteduserid == loggedInUserId);\n        });\n        var newContactRequests = !newOtherUser ? [] : newOtherUser.contactrequests.filter(function(request) {\n            return (request.userid == loggedInUserId && request.requesteduserid == newOtherUser.id) ||\n                (request.userid == newOtherUser.id && request.requesteduserid == loggedInUserId);\n        });\n        var oldHasContactRequests = oldContactRequests.length > 0;\n        var newHasContactRequests = newContactRequests.length > 0;\n\n        if (!oldOtherUser && !newOtherUser) {\n            return null;\n        } else if (oldHasContactRequests && newHasContactRequests) {\n            return null;\n        } else if (!oldHasContactRequests && newHasContactRequests && !newOtherUser.iscontact) {\n            return 'pending-contact';\n        } else if (!oldOtherUser && newOtherUser) {\n            return newOtherUser.iscontact ? 'contact' : null;\n        } else if (!newOtherUser && oldOtherUser) {\n            return oldOtherUser.iscontact ? 'non-contact' : null;\n        } else if (oldOtherUser.iscontact && !newOtherUser.iscontact) {\n            return newHasContactRequests ? 'pending-contact' : 'non-contact';\n        } else if (!oldOtherUser.iscontact && newOtherUser.iscontact) {\n            return 'contact';\n        } else {\n            return null;\n        }\n    };\n\n    /**\n     * Check if a confirm action is active.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Bool|Null}\n     */\n    var buildLoadingConfirmationAction = function(state, newState) {\n        if (!state.loadingConfirmAction && newState.loadingConfirmAction) {\n            return true;\n        } else if (state.loadingConfirmAction && !newState.loadingConfirmAction) {\n            return false;\n        } else {\n            return null;\n        }\n    };\n\n    /**\n     * Check if a edit mode is active.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Bool|Null}\n     */\n    var buildInEditMode = function(state, newState) {\n        var oldHasSelectedMessages = state.selectedMessageIds.length > 0;\n        var newHasSelectedMessages = newState.selectedMessageIds.length > 0;\n        var numberOfMessagesHasChanged = state.messages.length != newState.messages.length;\n\n        if (!oldHasSelectedMessages && newHasSelectedMessages) {\n            return true;\n        } else if (oldHasSelectedMessages && !newHasSelectedMessages) {\n            return false;\n        } else if (oldHasSelectedMessages && numberOfMessagesHasChanged) {\n            return true;\n        } else {\n            return null;\n        }\n    };\n\n    /**\n     * Build a patch for the messages selected.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Object} patch\n     */\n    var buildSelectedMessages = function(state, newState) {\n        var oldSelectedMessages = state.selectedMessageIds;\n        var newSelectedMessages = newState.selectedMessageIds;\n\n        if (isArrayEqual(oldSelectedMessages, newSelectedMessages)) {\n            return null;\n        }\n\n        var diff = diffArrays(oldSelectedMessages, newSelectedMessages, function(a, b) {\n            return a == b;\n        });\n\n        return {\n            count: newSelectedMessages.length,\n            add: diff.missingFromA,\n            remove: diff.missingFromB\n        };\n    };\n\n    /**\n     * Get a list of users from the state that are not the logged in user. Use to find group\n     * message members or the other user in a conversation.\n     *\n     * @param  {Object} state State\n     * @return {Array} List of users.\n     */\n    var getOtherUserFromState = function(state) {\n        return Object.keys(state.members).reduce(function(carry, userId) {\n            if (userId != state.loggedInUserId && !carry) {\n                carry = state.members[userId];\n            }\n\n            return carry;\n        }, null);\n    };\n\n    /**\n     * Check if the given user requires a contact request from the logged in user.\n     *\n     * @param  {Integer} loggedInUserId The logged in user id\n     * @param  {Object} user User record\n     * @return {Bool}\n     */\n    var requiresContactRequest = function(loggedInUserId, user) {\n        // If a user can message then no contact request is required.\n        if (user.canmessage) {\n            return false;\n        }\n\n        var contactRequests = user.contactrequests.filter(function(request) {\n            return request.userid == loggedInUserId || request.requesteduserid;\n        });\n        var hasSentContactRequest = contactRequests.length > 0;\n        return user.requirescontact && !user.iscontact && !hasSentContactRequest;\n    };\n\n    /**\n     * Check if other users are required to be added as contact.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Object} Object controlling the required to add contact dialog variables.\n     */\n    var buildRequireAddContact = function(state, newState) {\n        var oldOtherUser = getOtherUserFromState(state);\n        var newOtherUser = getOtherUserFromState(newState);\n        var hadMessages = state.messages.length > 0;\n        var hasMessages = newState.messages.length > 0;\n        var loggedInUserId = newState.loggedInUserId;\n        var prevRequiresContactRequest = oldOtherUser && requiresContactRequest(loggedInUserId, oldOtherUser);\n        var nextRequiresContactRequest = newOtherUser && requiresContactRequest(loggedInUserId, newOtherUser);\n        var confirmAddContact = buildConfirmAddContact(state, newState);\n        var finishedAddContact = confirmAddContact === false;\n\n        // Still doing first load.\n        if (!state.hasTriedToLoadMessages && !newState.hasTriedToLoadMessages) {\n            return null;\n        }\n\n        // No users yet.\n        if (!oldOtherUser && !newOtherUser) {\n            return null;\n        }\n\n        // We've loaded a new user and they require a contact request.\n        if (!oldOtherUser && nextRequiresContactRequest) {\n            return {\n                show: true,\n                hasMessages: hasMessages,\n                user: newOtherUser\n            };\n        }\n\n        // The logged in user has completed the confirm contact request dialogue\n        // but the other user still requires a contact request which means the logged\n        // in user either declined the confirmation or it failed.\n        if (finishedAddContact && nextRequiresContactRequest) {\n            return {\n                show: true,\n                hasMessages: hasMessages,\n                user: newOtherUser\n            };\n        }\n\n        // Everything is loaded.\n        if (state.hasTriedToLoadMessages && newState.hasTriedToLoadMessages) {\n            if (!prevRequiresContactRequest && nextRequiresContactRequest) {\n                return {\n                    show: true,\n                    hasMessages: hasMessages,\n                    user: newOtherUser\n                };\n            }\n\n            if (prevRequiresContactRequest && !nextRequiresContactRequest) {\n                return {\n                    show: false,\n                    hasMessages: hasMessages\n                };\n            }\n        }\n\n        // First load just completed.\n        if (!state.hasTriedToLoadMessages && newState.hasTriedToLoadMessages) {\n            if (nextRequiresContactRequest) {\n                return {\n                    show: true,\n                    hasMessages: hasMessages,\n                    user: newOtherUser\n                };\n            }\n        }\n\n        // Being reset.\n        if (state.hasTriedToLoadMessages && !newState.hasTriedToLoadMessages) {\n            if (prevRequiresContactRequest) {\n                return {\n                    show: false,\n                    hasMessages: hadMessages\n                };\n            }\n        }\n\n        return null;\n    };\n\n    /**\n     * Check if other users are required to be unblocked.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Bool|Null}\n     */\n    var buildRequireUnblock = function(state, newState) {\n        var oldOtherUser = getOtherUserFromState(state);\n        var newOtherUser = getOtherUserFromState(newState);\n\n        if (!oldOtherUser && !newOtherUser) {\n            return null;\n        } else if (oldOtherUser && !newOtherUser) {\n            return oldOtherUser.isblocked ? false : null;\n        } else if (!oldOtherUser && newOtherUser) {\n            return newOtherUser.isblocked ? true : null;\n        } else if (!oldOtherUser.isblocked && newOtherUser.isblocked) {\n            return true;\n        } else if (oldOtherUser.isblocked && !newOtherUser.isblocked) {\n            return false;\n        }\n\n        return null;\n    };\n\n    /**\n     * Check if other users can be messaged.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Bool|Null}\n     */\n    var buildUnableToMessage = function(state, newState) {\n        var oldOtherUser = getOtherUserFromState(state);\n        var newOtherUser = getOtherUserFromState(newState);\n\n        if (newState.type == Constants.CONVERSATION_TYPES.SELF) {\n            // Users always can send message themselves on self-conversations.\n            return null;\n        }\n\n        if (!oldOtherUser && !newOtherUser) {\n            return null;\n        } else if (oldOtherUser && !newOtherUser) {\n            return oldOtherUser.canmessage ? null : true;\n        } else if (!oldOtherUser && newOtherUser) {\n            return newOtherUser.canmessage ? null : true;\n        } else if (!oldOtherUser.canmessage && newOtherUser.canmessage) {\n            return false;\n        } else if (oldOtherUser.canmessage && !newOtherUser.canmessage) {\n            return true;\n        }\n\n        return null;\n    };\n\n    /**\n     * Build patch for footer information for a private conversation.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Object} containing footer state type.\n     */\n    var buildFooterPatchTypePrivate = function(state, newState) {\n        var loadingFirstMessages = buildLoadingFirstMessages(state, newState);\n        var inEditMode = buildInEditMode(state, newState);\n        var requireAddContact = buildRequireAddContact(state, newState);\n        var requireUnblock = buildRequireUnblock(state, newState);\n        var unableToMessage = buildUnableToMessage(state, newState);\n        var showRequireAddContact = requireAddContact !== null ? requireAddContact.show && requireAddContact.hasMessages : null;\n        var otherUser = getOtherUserFromState(newState);\n        var generateReturnValue = function(checkValue, successReturn) {\n            if (checkValue) {\n                return successReturn;\n            } else if (checkValue !== null && !checkValue) {\n                if (!otherUser) {\n                    return {type: 'content'};\n                } else if (otherUser.isblocked) {\n                    return {type: 'unblock'};\n                } else if (newState.messages.length && requiresContactRequest(newState.loggedInUserId, otherUser)) {\n                    return {\n                        type: 'add-contact',\n                        user: otherUser\n                    };\n                } else if (!otherUser.canmessage && (otherUser.requirescontact && !otherUser.iscontact)) {\n                    return {type: 'unable-to-message'};\n                }\n            }\n\n            return null;\n        };\n\n        if (\n            loadingFirstMessages === null &&\n            inEditMode === null &&\n            requireAddContact === null &&\n            requireUnblock === null\n        ) {\n            return null;\n        }\n\n        var checks = [\n            [loadingFirstMessages, {type: 'placeholder'}],\n            [inEditMode, {type: 'edit-mode'}],\n            [unableToMessage, {type: 'unable-to-message'}],\n            [requireUnblock, {type: 'unblock'}],\n            [showRequireAddContact, {type: 'add-contact', user: otherUser}]\n        ];\n\n        for (var i = 0; i < checks.length; i++) {\n            var checkValue = checks[i][0];\n            var successReturn = checks[i][1];\n            var result = generateReturnValue(checkValue, successReturn);\n\n            if (result !== null) {\n                return result;\n            }\n        }\n\n        return {\n            type: 'content'\n        };\n    };\n\n    /**\n     * Build patch for footer information for a public conversation.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Object} containing footer state type.\n     */\n    var buildFooterPatchTypePublic = function(state, newState) {\n        var loadingFirstMessages = buildLoadingFirstMessages(state, newState);\n        var inEditMode = buildInEditMode(state, newState);\n\n        if (loadingFirstMessages === null && inEditMode === null) {\n            return null;\n        }\n\n        if (loadingFirstMessages) {\n            return {type: 'placeholder'};\n        }\n\n        if (inEditMode) {\n            return {type: 'edit-mode'};\n        }\n\n        return {\n            type: 'content'\n        };\n    };\n\n    /**\n     * Check if we're viewing a different conversation. If so then we need to\n     * reset the UI.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {bool|null} If a reset needs to occur\n     */\n    var buildReset = function(state, newState) {\n        var oldType = state.type;\n        var newType = newState.type;\n        var oldConversationId = state.id;\n        var newConversationId = newState.id;\n        var oldMemberIds = Object.keys(state.members);\n        var newMemberIds = Object.keys(newState.members);\n\n        oldMemberIds.sort();\n        newMemberIds.sort();\n\n        var membersUnchanged = oldMemberIds.every(function(id, index) {\n            return id == newMemberIds[index];\n        });\n\n        if (oldType != newType) {\n            // If we've changed conversation type then we need to reset.\n            return true;\n        } else if (oldConversationId && !newConversationId) {\n            // We previously had a conversation id but no longer do. This likely means\n            // the user is viewing the conversation with someone they've never spoken to\n            // before.\n            return true;\n        } else if (oldConversationId && newConversationId && oldConversationId != newConversationId) {\n            // If we had a conversation id and it's changed then we need to reset.\n            return true;\n        } else if (!oldConversationId && !newConversationId && !membersUnchanged) {\n            // If we never had a conversation id but the members of the conversation have\n            // changed then we need to reset. This can happen if the user goes from viewing\n            // a user they've never had a conversation with to viewing a different user that\n            // they've never had a conversation with.\n            return true;\n        }\n\n        return null;\n    };\n\n    /**\n     * We should show this message always, for all the self-conversations.\n     *\n     * The message should be hidden when it's not a self-conversation.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {bool}\n     */\n    var buildSelfConversationMessage = function(state, newState) {\n        if (state.type != newState.type) {\n            return (newState.type == Constants.CONVERSATION_TYPES.SELF);\n        }\n\n        return null;\n    };\n\n    /**\n     * We should show the contact request sent message if the user just sent\n     * a contact request to the other user and there are no messages in the\n     * conversation.\n     *\n     * The messages should be hidden when there are messages in the conversation.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {string|false|null}\n     */\n    var buildContactRequestSent = function(state, newState) {\n        var loggedInUserId = newState.loggedInUserId;\n        var oldOtherUser = getOtherUserFromState(state);\n        var newOtherUser = getOtherUserFromState(newState);\n        var oldSentRequests = !oldOtherUser ? [] : oldOtherUser.contactrequests.filter(function(request) {\n            return request.userid == loggedInUserId;\n        });\n        var newSentRequests = !newOtherUser ? [] : newOtherUser.contactrequests.filter(function(request) {\n            return request.userid == loggedInUserId;\n        });\n        var oldRequest = oldSentRequests.length > 0;\n        var newRequest = newSentRequests.length > 0;\n        var hadMessages = state.messages.length > 0;\n        var hasMessages = state.messages.length > 0;\n\n        if (!oldRequest && newRequest && !newOtherUser.iscontact && !hasMessages) {\n            return newOtherUser.fullname;\n        } else if (oldOtherUser && !oldOtherUser.iscontact && newRequest && newOtherUser.iscontact) {\n            // Contact request accepted.\n            return false;\n        } else if (oldRequest && !newRequest) {\n            return false;\n        } else if (!hadMessages && hasMessages) {\n            return false;\n        } else {\n            return null;\n        }\n    };\n\n    /**\n     * Build the full patch comparing the current state and the new state. This patch is used by\n     * the conversation renderer to render the UI on any update.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Object} Patch containing all information changed.\n     */\n    var buildPatch = function(state, newState) {\n        var config = {\n            all: {\n                reset: buildReset,\n                conversation: buildConversationPatch,\n                scrollToMessage: buildScrollToMessagePatch,\n                loadingMembers: buildLoadingMembersPatch,\n                loadingFirstMessages: buildLoadingFirstMessages,\n                loadingMessages: buildLoadingMessages,\n                confirmDeleteSelectedMessages: buildConfirmDeleteSelectedMessages,\n                inEditMode: buildInEditMode,\n                selectedMessages: buildSelectedMessages,\n                isFavourite: buildIsFavourite,\n                isMuted: buildIsMuted\n            }\n        };\n        // These build functions are only applicable to private conversations.\n        config[Constants.CONVERSATION_TYPES.PRIVATE] = {\n            header: buildHeaderPatchTypePrivate,\n            footer: buildFooterPatchTypePrivate,\n            confirmBlockUser: buildConfirmBlockUser,\n            confirmUnblockUser: buildConfirmUnblockUser,\n            confirmAddContact: buildConfirmAddContact,\n            confirmRemoveContact: buildConfirmRemoveContact,\n            confirmContactRequest: buildConfirmContactRequest,\n            confirmDeleteConversation: buildConfirmDeleteConversation,\n            isBlocked: buildIsBlocked,\n            isContact: buildIsContact,\n            loadingConfirmAction: buildLoadingConfirmationAction,\n            requireAddContact: buildRequireAddContact,\n            contactRequestSent: buildContactRequestSent\n        };\n        // These build functions are only applicable to public (group) conversations.\n        config[Constants.CONVERSATION_TYPES.PUBLIC] = {\n            header: buildHeaderPatchTypePublic,\n            footer: buildFooterPatchTypePublic,\n        };\n        // These build functions are only applicable to self-conversations.\n        config[Constants.CONVERSATION_TYPES.SELF] = {\n            header: buildHeaderPatchTypeSelf,\n            footer: buildFooterPatchTypePublic,\n            confirmDeleteConversation: buildConfirmDeleteConversation,\n            selfConversationMessage: buildSelfConversationMessage\n        };\n\n        var patchConfig = $.extend({}, config.all);\n        if (newState.type && newState.type in config) {\n            // Add the type specific builders to the patch config.\n            patchConfig = $.extend(patchConfig, config[newState.type]);\n        }\n\n        return Object.keys(patchConfig).reduce(function(patch, key) {\n            var buildFunc = patchConfig[key];\n            var value = buildFunc(state, newState);\n\n            if (value !== null) {\n                patch[key] = value;\n            }\n\n            return patch;\n        }, {});\n    };\n\n    return {\n        buildPatch: buildPatch\n    };\n});\n"],"file":"message_drawer_view_conversation_patcher.min.js"}