/*
 * Generic library to allow things in a vertical list to be re-ordered using drag and drop.
 *
 * To make a set of things draggable, create a new instance of this object passing the
 * necessary config, as explained in the comment on the constructor.
 *
 * @package   qtype_ordering
 * @copyright 2018 The Open University
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("qtype_ordering/drag_reorder",["jquery",require.specified("core/dragdrop")?"core/dragdrop":"qtype_ordering/dragdrop",require.specified("core/key_codes")?"core/key_codes":"qtype_ordering/key_codes"],(function($,drag,keys){return function(config){var outer,inner,combined,dragStart=null,originalOrder=null,itemDragging=null,itemMoving=null,proxy=null,orderList=null,dragMove=function(){var list=itemDragging.closest(config.list),closestItem=null,closestDistance=null;if(list.find(config.item).each((function(index,element){var distance=distanceBetweenElements(element,proxy);(null===closestItem||distance<closestDistance)&&(closestItem=$(element),closestDistance=distance)})),closestItem[0]!==itemDragging[0]){var offsetValue=0;midY(proxy)<midY(closestItem)?(offsetValue=20,window.console.log("For midY(proxy) < midY(closestItem) offset is: "+offsetValue)):(offsetValue=-20,window.console.log("For midY(proxy) < midY(closestItem) offset is: "+offsetValue)),midY(proxy)+offsetValue<midY(closestItem)?itemDragging.insertBefore(closestItem):itemDragging.insertAfter(closestItem),updateProxy(itemDragging)}},updateProxy=function(itemDragging){for(var items=itemDragging.closest("ol, ul").find("li"),count=items.length,i=0;i<count;++i)if(itemDragging[0]===items[i]){proxy.find("li").attr("value",i+1);break}},dragEnd=function(x,y){void 0!==config.reorderEnd&&config.reorderEnd(itemDragging.closest(config.list),itemDragging);var newOrder=getCurrentOrder();arrayEquals(originalOrder,newOrder)?(new Date).getTime()-dragStart.time<500&&Math.abs(dragStart.x-x)<10&&Math.abs(dragStart.y-y)<10&&itemDragging[0].focus():config.reorderDone(itemDragging.closest(config.list),itemDragging,newOrder),proxy.remove(),proxy=null,itemDragging.removeClass(config.itemMovingClass),itemDragging=null,dragStart=null},midX=function(jQuery){return jQuery.offset().left+jQuery.outerWidth()/2},midY=function(jQuery){return jQuery.offset().top+jQuery.outerHeight()/2},distanceBetweenElements=function(element1,element2){var e1=$(element1),e2=$(element2),dx=midX(e1)-midX(e2),dy=midY(e1)-midY(e2);return Math.sqrt(dx*dx+dy*dy)},getCurrentOrder=function(){return(itemDragging||itemMoving).closest(config.list).find(config.item).map((function(index,item){return config.idGetter(item)})).get()},arrayEquals=function(a1,a2){return a1.length===a2.length&&a1.every((function(v,i){return v===a2[i]}))};config.itemInPage=(outer=config.list,inner=config.item,combined=[],outer.split(",").forEach((function(firstSelector){inner.split(",").forEach((function(secondSelector){combined.push(firstSelector.trim()+" "+secondSelector.trim())}))})),combined.join(", ")),$(config.list).on("mousedown touchstart",config.item,(function(event){var details=drag.prepare(event);details.start&&function(event,details){orderList=$(config.list),dragStart={time:(new Date).getTime(),x:details.x,y:details.y},itemDragging=$(event.currentTarget).closest(config.itemInPage),void 0!==config.reorderStart&&config.reorderStart(itemDragging.closest(config.list),itemDragging),originalOrder=getCurrentOrder(),proxy=$(config.proxyHtml.replace("%%ITEM_HTML%%",itemDragging.html()).replace("%%ITEM_CLASS_NAME%%",itemDragging.attr("class")).replace("%%LIST_CLASS_NAME%%",orderList.attr("class"))),$(document.body).append(proxy),proxy.css("position","absolute"),proxy.css(itemDragging.offset()),proxy.width(itemDragging.outerWidth()),proxy.height(itemDragging.outerHeight()),itemDragging.addClass(config.itemMovingClass),updateProxy(itemDragging),drag.start(event,proxy,dragMove,dragEnd)}(event,details)})),$(config.list).on("keydown",config.item,(function(event){itemMoving=$(event.currentTarget).closest(config.itemInPage),originalOrder=getCurrentOrder(),function(e,current){switch(e.keyCode){case keys.space:case keys.arrowRight:case keys.arrowDown:e.preventDefault(),e.stopPropagation();var next=current.next();next.length&&next.insertBefore(current);break;case keys.arrowLeft:case keys.arrowUp:e.preventDefault(),e.stopPropagation();var prev=current.prev();prev.length&&prev.insertAfter(current)}}(event,itemMoving);var newOrder=getCurrentOrder();arrayEquals(originalOrder,newOrder)||config.reorderDone(itemMoving.closest(config.list),itemMoving,newOrder)})),$(config.itemInPage).attr("tabindex","0")}}));

//# sourceMappingURL=drag_reorder.min.js.map