YUI.add("moodle-qtype_ddmarker-dd",function(e,t){var n="moodle-qtype_ddmarker-dd",r=function(){r.superclass.constructor.apply(this,arguments)};e.extend(r,e.Base,{doc:null,polltimer:null,afterimageloaddone:!1,graphics:null,poll_for_image_load:function(t,n,r,i){if(this.afterimageloaddone)return;var s=this.doc.bg_img().get("complete");n&&(s=s&&this.doc.bg_img().hasClass("constrained"));if(s)this.polltimer!==null&&(this.polltimer.cancel(),this.polltimer=null),this.doc.bg_img().detach("load",this.poll_for_image_load),r!==0?e.later(r,this,i):i.call(this),this.afterimageloaddone=!0;else if(this.polltimer===null){var o=[null,n,r,i];this.polltimer=e.later(1e3,this,this.poll_for_image_load,o,!0)}},doc_structure:function(){var t=e.one(this.get("topnode")),n=t.one("div.dragitems"),r=t.one("div.droparea");return{top_node:function(){return t},bg_img:function(){return t.one(".dropbackground")},load_bg_img:function(e){r.setContent('<img class="dropbackground" src="'+e+'"/>'),this.bg_img().on("load",this.on_image_load,this,"bg_image")},drag_items:function(){return n.all(".dragitem")},drag_items_for_choice:function(e){return n.all("span.dragitem.choice"+e)},drag_item_for_choice:function(e,t){return n.one("span.dragitem.choice"+e+".item"+t)},drag_item_being_dragged:function(e){return n.one("span.dragitem.beingdragged.choice"+e)},drag_item_home:function(e){return n.one("span.draghome.choice"+e)},drag_item_homes:function(){return n.all("span.draghome")},get_classname_numeric_suffix:function(e,t){var n=e.getAttribute("class");if(n!==""){var r=n.split(" ");for(var i=0;i<r.length;i++){var s=new RegExp("^"+t+"([0-9])+$");if(s.test(r[i])){var o=new RegExp("([0-9])+$"),u=o.exec(r[i]);return Number(u[0])}}}return null},inputs_for_choices:function(){return t.all("input.choices")},input_for_choice:function(e){return t.one("input.choice"+e)},marker_texts:function(){return t.one("div.markertexts")}}},colours:["#FFFFFF","#B0C4DE","#DCDCDC","#D8BFD8","#87CEFA","#DAA520","#FFD700","#F0E68C"],nextcolourindex:0,restart_colours:function(){this.nextcolourindex=0},get_next_colour:function(){var e=this.colours[this.nextcolourindex];return this.nextcolourindex++,this.nextcolourindex===this.colours.length&&(this.nextcolourindex=0),e},convert_to_window_xy:function(e){return[Number(e[0])+this.doc.bg_img().getX()+1,Number(e[1])+this.doc.bg_img().getY()+1]},shapes:[],draw_drop_zone:function(e,t,n,r,i,s){var o;s?o=this.doc.marker_texts().one("span.markertext"+e+" a"):o=this.doc.marker_texts().one("span.markertext"+e);if(o)t!==""?o.setContent(t):o.remove(!0);else if(t!==""){var u="markertext markertext"+e;s?this.doc.marker_texts().append('<span class="'+u+'"><a href="#">'+t+"</a></span>"):this.doc.marker_texts().append('<span class="'+u+'">'+t+"</span>")}var a="draw_shape_"+n;if(this[a]instanceof Function){var f=this[a](e,r,i);if(f!==null){var l=this.doc.top_node().one("div.ddarea div.markertexts span.markertext"+e);if(l!==null){l.setStyle("opacity","0.6"),f[0]-=l.get("offsetWidth")/2,f[1]-=l.get("offsetHeight")/2,l.setXY(this.convert_to_window_xy(f));var c=l.one("a");c!==null&&(c.once("click",function(e,t){var n=this.shapes[t].get("fill");n.opacity=1,this.shapes[t].set("fill",n)},this,e),c.set("tabIndex",0))}}}},draw_shape_circle:function(e,t,n){var r=t.match(/(\d+),(\d+);(\d+)/);if(r&&r.length===4){var i=[Number(r[1])-r[3],Number(r[2])-r[3]];if(this.coords_in_img(i)){var s=[Number(r[3])*2,Number(r[3])*2],o=this.graphics.addShape({type:"circle",width:s[0],height:s[1],fill:{color:n,opacity:"0.5"},stroke:{weight:1,color:"black"}});return o.setXY(this.convert_to_window_xy(i)),this.shapes[e]=o,[Number(r[1]),Number(r[2])]}}return null},draw_shape_rectangle:function(e,t,n){var r=t.match(/(\d+),(\d+);(\d+),(\d+)/);if(r&&r.length===5){var i=[Number(r[1]),Number(r[2])],s=[Number(r[3]),Number(r[4])];if(this.coords_in_img([i[0]+s[0],i[1]+s[1]])){var o=this.graphics.addShape({type:"rect",width:s[0],height:s[1],fill:{color:n,opacity:"0.5"},stroke:{weight:1,color:"black"}});return o.setXY(this.convert_to_window_xy(i)),this.shapes[e]=o,[Number(i[0])+s[0]/2,Number(i[1])+s[1]/2]}}return null},draw_shape_polygon:function(e,t,n){var r=t.split(";"),i=[];for(var s in r){var o=r[s].match(/^(\d+),(\d+)$/);o!==null&&this.coords_in_img([o[1],o[2]])&&(i[i.length]=[o[1],o[2]])}if(i.length>2){var u=this.graphics.addShape({type:"path",stroke:{weight:1,color:"black"},fill:{color:n,opacity:"0.5"}}),a=[0,0],f=[this.doc.bg_img().get("width"),this.doc.bg_img().get("height")];for(s=0;s<i.length;s++)f[0]=Math.min(i[s][0],f[0]),f[1]=Math.min(i[s][1],f[1]),a[0]=Math.max(i[s][0],a[0]),a[1]=Math.max(i[s][1],a[1]),s===0?u.moveTo(i[s][0],i[s][1]):u.lineTo(i[s][0],i[s][1]);return(Number(i[0][0])!==Number(i[i.length-1][0])||Number(i[0][1])!==Number(i[i.length-1][1]))&&u.lineTo(i[0][0],i[0][1]),u.end(),u.setXY(this.doc.bg_img().getXY()),this.shapes[e]=u,[(f[0]+a[0])/2,(f[1]+a[1])/2]}return null},coords_in_img:function(e){return e[0]<=this.doc.bg_img().get("width")&&e[1]<=this.doc.bg_img().get("height")}},{NAME:n,ATTRS:{drops:{value:null},readonly:{value:!1},topnode:{value:null}}}),M.qtype_ddmarker=M.qtype_ddmarker||{},M.qtype_ddmarker.dd_base_class=r;var i="ddmarker_question",s=function(){s.superclass.constructor.apply(this,arguments)};e.extend(s,M.qtype_ddmarker.dd_base_class,{pendingid:"",initializer:function(){this.pendingid="qtype_ddmarker-"+Math.random().toString(36).slice(2),M.util.js_pending(this.pendingid),this.doc=this.doc_structure(this),this.poll_for_image_load(null,!1,0,this.after_image_load),this.doc.bg_img().after("load",this.poll_for_image_load,this,!1,0,this.after_image_load)},after_image_load:function(){this.redraw_drags_and_drops(),M.util.js_complete(this.pendingid),e.later(2e3,this,this.redraw_drags_and_drops,[],!0)},clone_new_drag_item:function(e,t){var n=e.cloneNode(!0);return n.removeClass("draghome"),n.addClass("dragitem"),n.addClass("item"+t),n.one("span.markertext").setStyle("opacity",.6),e.insert(n,"after"),this.get("readonly")||this.draggable(n),n},draggable
:function(t){var n=(new e.DD.Drag({node:t,dragMode:"intersect"})).plug(e.Plugin.DDConstrained,{constrain2node:this.doc.top_node()});n.after("drag:start",function(e){var t=e.target.get("node");t.addClass("beingdragged");var n=this.get_choiceno_for_node(t),r=this.get_itemno_for_node(t);r!==null&&t.removeClass("item"+t),this.save_all_xy_for_choice(n,null),this.redraw_drags_and_drops()},this),n.after("drag:end",function(e){var t=e.target.get("node");t.removeClass("beingdragged");var n=this.get_choiceno_for_node(t);this.save_all_xy_for_choice(n,t),this.redraw_drags_and_drops()},this),t.set("tabIndex",0),t.on("dragchange",this.drop_zone_key_press,this)},save_all_xy_for_choice:function(e,t){var n=[],r;for(var i=0;i<=this.doc.drag_items_for_choice(e).size();i++){var s=this.doc.drag_item_for_choice(e,i);s&&(s.removeClass("item"+i),s.hasClass("beingdragged")||(r=this.convert_to_bg_img_xy(s.getXY()),this.xy_in_bgimg(r)&&(s.removeClass("item"+i),s.addClass("item"+n.length),n[n.length]=r)))}t!==null&&(r=this.convert_to_bg_img_xy(t.getXY()),t.addClass("item"+n.length),this.xy_in_bgimg(r)&&(n[n.length]=r)),this.set_form_value(e,n.join(";"))},reset_drag_xy:function(e){this.set_form_value(e,"")},set_form_value:function(e,t){this.doc.input_for_choice(e).set("value",t)},xy_in_bgimg:function(e){return e[0]<0||e[1]<0||e[0]>this.doc.bg_img().get("width")||e[1]>this.doc.bg_img().get("height")?!1:!0},constrain_to_bgimg:function(e){var t=this.convert_to_bg_img_xy(e);return t[0]=Math.max(0,t[0]),t[1]=Math.max(0,t[1]),t[0]=Math.min(this.doc.bg_img().get("width"),t[0]),t[1]=Math.min(this.doc.bg_img().get("height"),t[1]),this.convert_to_window_xy(t)},convert_to_bg_img_xy:function(e){return[Number(e[0])-this.doc.bg_img().getX()-1,Number(e[1])-this.doc.bg_img().getY()-1]},redraw_drags_and_drops:function(){this.doc.drag_items().each(function(e){e.addClass("unneeded")},this),this.doc.inputs_for_choices().each(function(e){var t=this.get_choiceno_for_node(e),n=this.get_coords(e),r=this.doc.drag_item_home(t);for(var i=0;i<n.length;i++){var s=this.doc.drag_item_for_choice(t,i);!s||s.hasClass("beingdragged")?s=this.clone_new_drag_item(r,i):s.removeClass("unneeded"),s.setXY(n[i])}},this),this.doc.drag_items().each(function(e){e.hasClass("unneeded")&&!e.hasClass("beingdragged")&&e.remove(!0)},this),this.graphics!==null?this.graphics.clear():this.graphics=new e.Graphic({render:this.doc.top_node().one("div.ddarea div.dropzones")});if(this.get("dropzones").length!==0){this.restart_colours();for(var t in this.get("dropzones")){var n=this.get_next_colour(),r=this.get("dropzones")[t];this.draw_drop_zone(t,r.markertext,r.shape,r.coords,n,!0)}}},get_coords:function(e){var t=this.get_choiceno_for_node(e),n=e.get("value"),r=e.hasClass("infinite"),i=this.get_noofdrags_for_node(e),s=null!==this.doc.drag_item_being_dragged(t),o=[];if(n!==""){var u=n.split(";");for(var a=0;a<u.length;a++)o[o.length]=this.convert_to_window_xy(u[a].split(","))}var f=o.length+(s?1:0);if(r||f<i)o[o.length]=this.drag_home_xy(t);return o},drag_home_xy:function(e){var t=this.doc.drag_item_home(e);return[t.getX(),t.getY()-12]},get_choiceno_for_node:function(e){return Number(this.doc.get_classname_numeric_suffix(e,"choice"))},get_itemno_for_node:function(e){return Number(this.doc.get_classname_numeric_suffix(e,"item"))},get_noofdrags_for_node:function(e){return Number(this.doc.get_classname_numeric_suffix(e,"noofdrags"))},drop_zone_key_press:function(e){var t=e.target,n=t.getXY();switch(e.direction){case"left":n[0]-=1;break;case"right":n[0]+=1;break;case"down":n[1]+=1;break;case"up":n[1]-=1;break;case"remove":n=null}var r=this.get_choiceno_for_node(t);n!==null?n=this.constrain_to_bgimg(n):n=this.drag_home_xy(r),e.preventDefault(),t.setXY(n),this.save_all_xy_for_choice(r,null)}},{NAME:i,ATTRS:{dropzones:{value:[]}}}),e.Event.define("dragchange",{_event:e.UA.webkit||e.UA.ie?"keydown":"keypress",_keys:{32:"remove",37:"left",38:"up",39:"right",40:"down",65:"left",87:"up",68:"right",83:"down",27:"remove"},_keyHandler:function(e,t){this._keys[e.keyCode]&&(e.direction=this._keys[e.keyCode],t.fire(e))},on:function(e,t,n){t._detacher=e.on(this._event,this._keyHandler,this,n)}}),M.qtype_ddmarker.init_question=function(e){return new s(e)}},"@VERSION@",{requires:["node","event-resize","dd","dd-drop","dd-constrain","graphics"]});
